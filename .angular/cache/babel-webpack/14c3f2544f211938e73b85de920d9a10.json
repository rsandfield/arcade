{"ast":null,"code":"import { __extends } from \"tslib\";\nimport { Engine } from \"../Engines/engine\";\nimport { VertexBuffer } from \"../Meshes/buffer\";\nimport { InternalTexture, InternalTextureSource } from \"../Materials/Textures/internalTexture\";\nimport { Texture } from \"../Materials/Textures/texture\";\nimport { DataBuffer } from '../Meshes/dataBuffer';\nimport { Tools } from \"../Misc/tools\";\nimport { EnvironmentTextureTools } from \"../Misc/environmentTextureTools\";\nimport { RenderTargetCreationOptions } from \"../Materials/Textures/renderTargetCreationOptions\";\nimport { Logger } from \"../Misc/logger\";\nimport { ThinEngine } from './thinEngine';\nimport { EngineStore } from './engineStore';\nimport { ShaderCodeInliner } from \"./Processors/shaderCodeInliner\";\nimport { WebGL2ShaderProcessor } from '../Engines/WebGL/webGL2ShaderProcessors';\n\nvar NativePipelineContext =\n/** @class */\nfunction () {\n  function NativePipelineContext() {\n    // TODO: async should be true?\n    this.isAsync = false;\n    this.isReady = false;\n  }\n\n  NativePipelineContext.prototype._getVertexShaderCode = function () {\n    return null;\n  };\n\n  NativePipelineContext.prototype._getFragmentShaderCode = function () {\n    return null;\n  }; // TODO: what should this do?\n\n\n  NativePipelineContext.prototype._handlesSpectorRebuildCallback = function (onCompiled) {\n    throw new Error(\"Not implemented\");\n  };\n\n  return NativePipelineContext;\n}();\n/**\r\n * Container for accessors for natively-stored mesh data buffers.\r\n */\n\n\nvar NativeDataBuffer =\n/** @class */\nfunction (_super) {\n  __extends(NativeDataBuffer, _super);\n\n  function NativeDataBuffer() {\n    return _super !== null && _super.apply(this, arguments) || this;\n  }\n\n  return NativeDataBuffer;\n}(DataBuffer);\n/** @hidden */\n\n\nvar NativeTexture =\n/** @class */\nfunction (_super) {\n  __extends(NativeTexture, _super);\n\n  function NativeTexture() {\n    return _super !== null && _super.apply(this, arguments) || this;\n  }\n\n  NativeTexture.prototype.getInternalTexture = function () {\n    return this;\n  };\n\n  NativeTexture.prototype.getViewCount = function () {\n    return 1;\n  };\n\n  return NativeTexture;\n}(InternalTexture);\n/** @hidden */\n\n\nvar NativeEngine =\n/** @class */\nfunction (_super) {\n  __extends(NativeEngine, _super);\n\n  function NativeEngine() {\n    var _this = _super.call(this, null) || this;\n\n    _this._native = new _native.Engine();\n    /** Defines the invalid handle returned by bgfx when resource creation goes wrong */\n\n    _this.INVALID_HANDLE = 65535;\n    _this._boundBuffersVertexArray = null;\n    _this._currentDepthTest = _this._native.DEPTH_TEST_LEQUAL;\n    _this._webGLVersion = 2;\n    _this.disableUniformBuffers = true; // TODO: Initialize this more correctly based on the hardware capabilities.\n    // Init caps\n\n    _this._caps = {\n      maxTexturesImageUnits: 16,\n      maxVertexTextureImageUnits: 16,\n      maxCombinedTexturesImageUnits: 32,\n      maxTextureSize: 512,\n      maxCubemapTextureSize: 512,\n      maxRenderTextureSize: 512,\n      maxVertexAttribs: 16,\n      maxVaryingVectors: 16,\n      maxFragmentUniformVectors: 16,\n      maxVertexUniformVectors: 16,\n      standardDerivatives: true,\n      astc: null,\n      pvrtc: null,\n      etc1: null,\n      etc2: null,\n      bptc: null,\n      maxAnisotropy: 16,\n      uintIndices: true,\n      fragmentDepthSupported: false,\n      highPrecisionShaderSupported: true,\n      colorBufferFloat: false,\n      textureFloat: false,\n      textureFloatLinearFiltering: false,\n      textureFloatRender: false,\n      textureHalfFloat: false,\n      textureHalfFloatLinearFiltering: false,\n      textureHalfFloatRender: false,\n      textureLOD: true,\n      drawBuffersExtension: false,\n      depthTextureExtension: false,\n      vertexArrayObject: true,\n      instancedArrays: false,\n      canUseTimestampForTimerQuery: false,\n      blendMinMax: false,\n      maxMSAASamples: 1\n    };\n    Tools.Log(\"Babylon Native (v\" + Engine.Version + \") launched\");\n\n    Tools.LoadScript = function (scriptUrl, onSuccess, onError, scriptId) {\n      Tools.LoadFile(scriptUrl, function (data) {\n        Function(data).apply(null);\n\n        if (onSuccess) {\n          onSuccess();\n        }\n      }, undefined, undefined, false, function (request, exception) {\n        if (onError) {\n          onError(\"LoadScript Error\", exception);\n        }\n      });\n    }; // Wrappers\n\n\n    if (typeof URL === \"undefined\") {\n      window.URL = {\n        createObjectURL: function () {},\n        revokeObjectURL: function () {}\n      };\n    }\n\n    if (typeof Blob === \"undefined\") {\n      window.Blob = function () {};\n    } // Shader processor\n\n\n    _this._shaderProcessor = new WebGL2ShaderProcessor();\n    return _this;\n  }\n\n  NativeEngine.prototype.getHardwareScalingLevel = function () {\n    return 1.0;\n  };\n\n  NativeEngine.prototype.dispose = function () {\n    _super.prototype.dispose.call(this);\n\n    if (this._boundBuffersVertexArray) {\n      this._native.deleteVertexArray(this._boundBuffersVertexArray);\n    }\n\n    this._native.dispose();\n  };\n  /**\r\n   * Can be used to override the current requestAnimationFrame requester.\r\n   * @hidden\r\n   */\n\n\n  NativeEngine.prototype._queueNewFrame = function (bindedRenderFunction, requester) {\n    // Use the provided requestAnimationFrame, unless the requester is the window. In that case, we will default to the Babylon Native version of requestAnimationFrame.\n    if (requester.requestAnimationFrame && requester !== window) {\n      requester.requestAnimationFrame(bindedRenderFunction);\n    } else {\n      this._native.requestAnimationFrame(bindedRenderFunction);\n    }\n\n    return 0;\n  };\n  /**\r\n   * Override default engine behavior.\r\n   * @param color\r\n   * @param backBuffer\r\n   * @param depth\r\n   * @param stencil\r\n   */\n\n\n  NativeEngine.prototype._bindUnboundFramebuffer = function (framebuffer) {\n    if (this._currentFramebuffer !== framebuffer) {\n      if (this._currentFramebuffer) {\n        this._native.unbindFramebuffer(this._currentFramebuffer);\n      }\n\n      if (framebuffer) {\n        this._native.bindFramebuffer(framebuffer);\n      }\n\n      this._currentFramebuffer = framebuffer;\n    }\n  };\n  /**\r\n   * Gets host document\r\n   * @returns the host document object\r\n   */\n\n\n  NativeEngine.prototype.getHostDocument = function () {\n    return null;\n  };\n\n  NativeEngine.prototype.clear = function (color, backBuffer, depth, stencil) {\n    if (stencil === void 0) {\n      stencil = false;\n    }\n\n    var mode = 0;\n\n    if (backBuffer && color) {\n      this._native.clearColor(color.r, color.g, color.b, color.a !== undefined ? color.a : 1.0);\n\n      mode |= this._native.CLEAR_FLAG_COLOR;\n    }\n\n    if (depth) {\n      this._native.clearDepth(1.0);\n\n      mode |= this._native.CLEAR_FLAG_DEPTH;\n    }\n\n    if (stencil) {\n      this._native.clearStencil(0);\n\n      mode |= this._native.CLEAR_FLAG_STENCIL;\n    }\n\n    this._native.clear(mode);\n  };\n\n  NativeEngine.prototype.createIndexBuffer = function (indices, updateable) {\n    var data = this._normalizeIndexData(indices);\n\n    var buffer = new NativeDataBuffer();\n    buffer.references = 1;\n    buffer.is32Bits = data.BYTES_PER_ELEMENT === 4;\n\n    if (data.length) {\n      buffer.nativeIndexBuffer = this._native.createIndexBuffer(data, updateable !== null && updateable !== void 0 ? updateable : false);\n\n      if (buffer.nativeVertexBuffer === this.INVALID_HANDLE) {\n        throw new Error(\"Could not create a native index buffer.\");\n      }\n    } else {\n      buffer.nativeVertexBuffer = this.INVALID_HANDLE;\n    }\n\n    return buffer;\n  };\n\n  NativeEngine.prototype.createVertexBuffer = function (data, updateable) {\n    var buffer = new NativeDataBuffer();\n    buffer.references = 1;\n    buffer.nativeVertexBuffer = this._native.createVertexBuffer(ArrayBuffer.isView(data) ? data : new Float32Array(data), updateable !== null && updateable !== void 0 ? updateable : false);\n\n    if (buffer.nativeVertexBuffer === this.INVALID_HANDLE) {\n      throw new Error(\"Could not create a native vertex buffer.\");\n    }\n\n    return buffer;\n  };\n\n  NativeEngine.prototype._recordVertexArrayObject = function (vertexArray, vertexBuffers, indexBuffer, effect) {\n    if (indexBuffer) {\n      this._native.recordIndexBuffer(vertexArray, indexBuffer.nativeIndexBuffer);\n    }\n\n    var attributes = effect.getAttributesNames();\n\n    for (var index = 0; index < attributes.length; index++) {\n      var location_1 = effect.getAttributeLocation(index);\n\n      if (location_1 >= 0) {\n        var kind = attributes[index];\n        var vertexBuffer = vertexBuffers[kind];\n\n        if (vertexBuffer) {\n          var buffer = vertexBuffer.getBuffer();\n\n          if (buffer) {\n            this._native.recordVertexBuffer(vertexArray, buffer.nativeVertexBuffer, location_1, vertexBuffer.byteOffset, vertexBuffer.byteStride, vertexBuffer.getSize(), this._getNativeAttribType(vertexBuffer.type), vertexBuffer.normalized);\n          }\n        }\n      }\n    }\n  };\n\n  NativeEngine.prototype.bindBuffers = function (vertexBuffers, indexBuffer, effect) {\n    if (this._boundBuffersVertexArray) {\n      this._native.deleteVertexArray(this._boundBuffersVertexArray);\n    }\n\n    this._boundBuffersVertexArray = this._native.createVertexArray();\n\n    this._recordVertexArrayObject(this._boundBuffersVertexArray, vertexBuffers, indexBuffer, effect);\n\n    this._native.bindVertexArray(this._boundBuffersVertexArray);\n  };\n\n  NativeEngine.prototype.recordVertexArrayObject = function (vertexBuffers, indexBuffer, effect) {\n    var vertexArray = this._native.createVertexArray();\n\n    this._recordVertexArrayObject(vertexArray, vertexBuffers, indexBuffer, effect);\n\n    return vertexArray;\n  };\n\n  NativeEngine.prototype.bindVertexArrayObject = function (vertexArray) {\n    this._native.bindVertexArray(vertexArray);\n  };\n\n  NativeEngine.prototype.releaseVertexArrayObject = function (vertexArray) {\n    this._native.deleteVertexArray(vertexArray);\n  };\n\n  NativeEngine.prototype.getAttributes = function (pipelineContext, attributesNames) {\n    var nativePipelineContext = pipelineContext;\n    return this._native.getAttributes(nativePipelineContext.nativeProgram, attributesNames);\n  };\n  /**\r\n   * Draw a list of indexed primitives\r\n   * @param fillMode defines the primitive to use\r\n   * @param indexStart defines the starting index\r\n   * @param indexCount defines the number of index to draw\r\n   * @param instancesCount defines the number of instances to draw (if instanciation is enabled)\r\n   */\n\n\n  NativeEngine.prototype.drawElementsType = function (fillMode, indexStart, indexCount, instancesCount) {\n    // Apply states\n    this._drawCalls.addCount(1, false); // TODO: Make this implementation more robust like core Engine version.\n    // Render\n    //var indexFormat = this._uintIndicesCurrentlySet ? this._gl.UNSIGNED_INT : this._gl.UNSIGNED_SHORT;\n    //var mult = this._uintIndicesCurrentlySet ? 4 : 2;\n    // if (instancesCount) {\n    //     this._gl.drawElementsInstanced(drawMode, indexCount, indexFormat, indexStart * mult, instancesCount);\n    // } else {\n\n\n    this._native.drawIndexed(fillMode, indexStart, indexCount); // }\n\n  };\n  /**\r\n   * Draw a list of unindexed primitives\r\n   * @param fillMode defines the primitive to use\r\n   * @param verticesStart defines the index of first vertex to draw\r\n   * @param verticesCount defines the count of vertices to draw\r\n   * @param instancesCount defines the number of instances to draw (if instanciation is enabled)\r\n   */\n\n\n  NativeEngine.prototype.drawArraysType = function (fillMode, verticesStart, verticesCount, instancesCount) {\n    // Apply states\n    this._drawCalls.addCount(1, false); // TODO: Make this implementation more robust like core Engine version.\n    // if (instancesCount) {\n    //     this._gl.drawArraysInstanced(drawMode, verticesStart, verticesCount, instancesCount);\n    // } else {\n\n\n    this._native.draw(fillMode, verticesStart, verticesCount); // }\n\n  };\n\n  NativeEngine.prototype.createPipelineContext = function () {\n    return new NativePipelineContext();\n  };\n\n  NativeEngine.prototype._preparePipelineContext = function (pipelineContext, vertexSourceCode, fragmentSourceCode, createAsRaw, rebuildRebind, defines, transformFeedbackVaryings) {\n    var nativePipelineContext = pipelineContext;\n\n    if (createAsRaw) {\n      nativePipelineContext.nativeProgram = this.createRawShaderProgram(pipelineContext, vertexSourceCode, fragmentSourceCode, undefined, transformFeedbackVaryings);\n    } else {\n      nativePipelineContext.nativeProgram = this.createShaderProgram(pipelineContext, vertexSourceCode, fragmentSourceCode, defines, undefined, transformFeedbackVaryings);\n    }\n  };\n  /** @hidden */\n\n\n  NativeEngine.prototype._isRenderingStateCompiled = function (pipelineContext) {\n    // TODO: support async shader compilcation\n    return true;\n  };\n  /** @hidden */\n\n\n  NativeEngine.prototype._executeWhenRenderingStateIsCompiled = function (pipelineContext, action) {\n    // TODO: support async shader compilcation\n    action();\n  };\n\n  NativeEngine.prototype.createRawShaderProgram = function (pipelineContext, vertexCode, fragmentCode, context, transformFeedbackVaryings) {\n    if (transformFeedbackVaryings === void 0) {\n      transformFeedbackVaryings = null;\n    }\n\n    throw new Error(\"Not Supported\");\n  };\n\n  NativeEngine.prototype.createShaderProgram = function (pipelineContext, vertexCode, fragmentCode, defines, context, transformFeedbackVaryings) {\n    if (transformFeedbackVaryings === void 0) {\n      transformFeedbackVaryings = null;\n    }\n\n    this.onBeforeShaderCompilationObservable.notifyObservers(this);\n    var vertexInliner = new ShaderCodeInliner(vertexCode);\n    vertexInliner.processCode();\n    vertexCode = vertexInliner.code;\n    var fragmentInliner = new ShaderCodeInliner(fragmentCode);\n    fragmentInliner.processCode();\n    fragmentCode = fragmentInliner.code;\n    vertexCode = ThinEngine._ConcatenateShader(vertexCode, defines);\n    fragmentCode = ThinEngine._ConcatenateShader(fragmentCode, defines);\n\n    var program = this._native.createProgram(vertexCode, fragmentCode);\n\n    this.onAfterShaderCompilationObservable.notifyObservers(this);\n    return program;\n  };\n\n  NativeEngine.prototype._setProgram = function (program) {\n    if (this._currentProgram !== program) {\n      this._native.setProgram(program);\n\n      this._currentProgram = program;\n    }\n  };\n\n  NativeEngine.prototype._releaseEffect = function (effect) {// TODO\n  };\n\n  NativeEngine.prototype._deletePipelineContext = function (pipelineContext) {// TODO\n  };\n\n  NativeEngine.prototype.getUniforms = function (pipelineContext, uniformsNames) {\n    var nativePipelineContext = pipelineContext;\n    return this._native.getUniforms(nativePipelineContext.nativeProgram, uniformsNames);\n  };\n\n  NativeEngine.prototype.bindUniformBlock = function (pipelineContext, blockName, index) {\n    // TODO\n    throw new Error(\"Not Implemented\");\n  };\n\n  NativeEngine.prototype.bindSamplers = function (effect) {\n    var nativePipelineContext = effect.getPipelineContext();\n\n    this._setProgram(nativePipelineContext.nativeProgram); // TODO: share this with engine?\n\n\n    var samplers = effect.getSamplers();\n\n    for (var index = 0; index < samplers.length; index++) {\n      var uniform = effect.getUniform(samplers[index]);\n\n      if (uniform) {\n        this._boundUniforms[index] = uniform;\n      }\n    }\n\n    this._currentEffect = null;\n  };\n\n  NativeEngine.prototype.setMatrix = function (uniform, matrix) {\n    if (!uniform) {\n      return;\n    }\n\n    this._native.setMatrix(uniform, matrix.toArray());\n  };\n\n  NativeEngine.prototype.getRenderWidth = function (useScreen) {\n    if (useScreen === void 0) {\n      useScreen = false;\n    }\n\n    if (!useScreen && this._currentRenderTarget) {\n      return this._currentRenderTarget.width;\n    }\n\n    return this._native.getRenderWidth();\n  };\n\n  NativeEngine.prototype.getRenderHeight = function (useScreen) {\n    if (useScreen === void 0) {\n      useScreen = false;\n    }\n\n    if (!useScreen && this._currentRenderTarget) {\n      return this._currentRenderTarget.height;\n    }\n\n    return this._native.getRenderHeight();\n  };\n\n  NativeEngine.prototype.setViewport = function (viewport, requiredWidth, requiredHeight) {\n    this._cachedViewport = viewport;\n\n    this._native.setViewPort(viewport.x, viewport.y, viewport.width, viewport.height);\n  };\n\n  NativeEngine.prototype.setState = function (culling, zOffset, force, reverseSide) {\n    if (zOffset === void 0) {\n      zOffset = 0;\n    }\n\n    if (reverseSide === void 0) {\n      reverseSide = false;\n    }\n\n    this._native.setState(culling, zOffset, reverseSide);\n  };\n  /**\r\n   * Set the z offset to apply to current rendering\r\n   * @param value defines the offset to apply\r\n   */\n\n\n  NativeEngine.prototype.setZOffset = function (value) {\n    this._native.setZOffset(value);\n  };\n  /**\r\n   * Gets the current value of the zOffset\r\n   * @returns the current zOffset state\r\n   */\n\n\n  NativeEngine.prototype.getZOffset = function () {\n    return this._native.getZOffset();\n  };\n  /**\r\n   * Enable or disable depth buffering\r\n   * @param enable defines the state to set\r\n   */\n\n\n  NativeEngine.prototype.setDepthBuffer = function (enable) {\n    this._native.setDepthTest(enable ? this._currentDepthTest : this._native.DEPTH_TEST_ALWAYS);\n  };\n  /**\r\n   * Gets a boolean indicating if depth writing is enabled\r\n   * @returns the current depth writing state\r\n   */\n\n\n  NativeEngine.prototype.getDepthWrite = function () {\n    return this._native.getDepthWrite();\n  };\n\n  NativeEngine.prototype.setDepthFunctionToGreater = function () {\n    this._currentDepthTest = this._native.DEPTH_TEST_GREATER;\n\n    this._native.setDepthTest(this._currentDepthTest);\n  };\n\n  NativeEngine.prototype.setDepthFunctionToGreaterOrEqual = function () {\n    this._currentDepthTest = this._native.DEPTH_TEST_GEQUAL;\n\n    this._native.setDepthTest(this._currentDepthTest);\n  };\n\n  NativeEngine.prototype.setDepthFunctionToLess = function () {\n    this._currentDepthTest = this._native.DEPTH_TEST_LESS;\n\n    this._native.setDepthTest(this._currentDepthTest);\n  };\n\n  NativeEngine.prototype.setDepthFunctionToLessOrEqual = function () {\n    this._currentDepthTest = this._native.DEPTH_TEST_LEQUAL;\n\n    this._native.setDepthTest(this._currentDepthTest);\n  };\n  /**\r\n   * Enable or disable depth writing\r\n   * @param enable defines the state to set\r\n   */\n\n\n  NativeEngine.prototype.setDepthWrite = function (enable) {\n    this._native.setDepthWrite(enable);\n  };\n  /**\r\n   * Enable or disable color writing\r\n   * @param enable defines the state to set\r\n   */\n\n\n  NativeEngine.prototype.setColorWrite = function (enable) {\n    this._native.setColorWrite(enable);\n\n    this._colorWrite = enable;\n  };\n  /**\r\n   * Gets a boolean indicating if color writing is enabled\r\n   * @returns the current color writing state\r\n   */\n\n\n  NativeEngine.prototype.getColorWrite = function () {\n    return this._colorWrite;\n  };\n  /**\r\n   * Sets alpha constants used by some alpha blending modes\r\n   * @param r defines the red component\r\n   * @param g defines the green component\r\n   * @param b defines the blue component\r\n   * @param a defines the alpha component\r\n   */\n\n\n  NativeEngine.prototype.setAlphaConstants = function (r, g, b, a) {\n    throw new Error(\"Setting alpha blend constant color not yet implemented.\");\n  };\n  /**\r\n   * Sets the current alpha mode\r\n   * @param mode defines the mode to use (one of the BABYLON.undefined)\r\n   * @param noDepthWriteChange defines if depth writing state should remains unchanged (false by default)\r\n   * @see https://doc.babylonjs.com/resources/transparency_and_how_meshes_are_rendered\r\n   */\n\n\n  NativeEngine.prototype.setAlphaMode = function (mode, noDepthWriteChange) {\n    if (noDepthWriteChange === void 0) {\n      noDepthWriteChange = false;\n    }\n\n    if (this._alphaMode === mode) {\n      return;\n    }\n\n    mode = this._getNativeAlphaMode(mode);\n\n    this._native.setBlendMode(mode);\n\n    if (!noDepthWriteChange) {\n      this.setDepthWrite(mode === 0);\n    }\n\n    this._alphaMode = mode;\n  };\n  /**\r\n   * Gets the current alpha mode\r\n   * @see https://doc.babylonjs.com/resources/transparency_and_how_meshes_are_rendered\r\n   * @returns the current alpha mode\r\n   */\n\n\n  NativeEngine.prototype.getAlphaMode = function () {\n    return this._alphaMode;\n  };\n\n  NativeEngine.prototype.setInt = function (uniform, int) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._native.setInt(uniform, int);\n\n    return true;\n  };\n\n  NativeEngine.prototype.setIntArray = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._native.setIntArray(uniform, array);\n\n    return true;\n  };\n\n  NativeEngine.prototype.setIntArray2 = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._native.setIntArray2(uniform, array);\n\n    return true;\n  };\n\n  NativeEngine.prototype.setIntArray3 = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._native.setIntArray3(uniform, array);\n\n    return true;\n  };\n\n  NativeEngine.prototype.setIntArray4 = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._native.setIntArray4(uniform, array);\n\n    return true;\n  };\n\n  NativeEngine.prototype.setFloatArray = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._native.setFloatArray(uniform, array);\n\n    return true;\n  };\n\n  NativeEngine.prototype.setFloatArray2 = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._native.setFloatArray2(uniform, array);\n\n    return true;\n  };\n\n  NativeEngine.prototype.setFloatArray3 = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._native.setFloatArray3(uniform, array);\n\n    return true;\n  };\n\n  NativeEngine.prototype.setFloatArray4 = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._native.setFloatArray4(uniform, array);\n\n    return true;\n  };\n\n  NativeEngine.prototype.setArray = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._native.setFloatArray(uniform, array);\n\n    return true;\n  };\n\n  NativeEngine.prototype.setArray2 = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._native.setFloatArray2(uniform, array);\n\n    return true;\n  };\n\n  NativeEngine.prototype.setArray3 = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._native.setFloatArray3(uniform, array);\n\n    return true;\n  };\n\n  NativeEngine.prototype.setArray4 = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._native.setFloatArray4(uniform, array);\n\n    return true;\n  };\n\n  NativeEngine.prototype.setMatrices = function (uniform, matrices) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._native.setMatrices(uniform, matrices);\n\n    return true;\n  };\n\n  NativeEngine.prototype.setMatrix3x3 = function (uniform, matrix) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._native.setMatrix3x3(uniform, matrix);\n\n    return true;\n  };\n\n  NativeEngine.prototype.setMatrix2x2 = function (uniform, matrix) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._native.setMatrix2x2(uniform, matrix);\n\n    return true;\n  };\n\n  NativeEngine.prototype.setFloat = function (uniform, value) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._native.setFloat(uniform, value);\n\n    return true;\n  };\n\n  NativeEngine.prototype.setFloat2 = function (uniform, x, y) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._native.setFloat2(uniform, x, y);\n\n    return true;\n  };\n\n  NativeEngine.prototype.setFloat3 = function (uniform, x, y, z) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._native.setFloat3(uniform, x, y, z);\n\n    return true;\n  };\n\n  NativeEngine.prototype.setFloat4 = function (uniform, x, y, z, w) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._native.setFloat4(uniform, x, y, z, w);\n\n    return true;\n  };\n\n  NativeEngine.prototype.setColor3 = function (uniform, color3) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._native.setFloat3(uniform, color3.r, color3.g, color3.b);\n\n    return true;\n  };\n\n  NativeEngine.prototype.setColor4 = function (uniform, color3, alpha) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._native.setFloat4(uniform, color3.r, color3.g, color3.b, alpha);\n\n    return true;\n  };\n\n  NativeEngine.prototype.wipeCaches = function (bruteForce) {\n    if (this.preventCacheWipeBetweenFrames) {\n      return;\n    }\n\n    this.resetTextureCache();\n    this._currentEffect = null;\n\n    if (bruteForce) {\n      this._currentProgram = null;\n\n      this._stencilState.reset();\n\n      this._depthCullingState.reset();\n\n      this._alphaState.reset();\n    }\n\n    this._cachedVertexBuffers = null;\n    this._cachedIndexBuffer = null;\n    this._cachedEffectForVertexBuffers = null;\n  };\n\n  NativeEngine.prototype._createTexture = function () {\n    return this._native.createTexture();\n  };\n\n  NativeEngine.prototype._deleteTexture = function (texture) {\n    this._native.deleteTexture(texture);\n  };\n  /**\r\n   * Update the content of a dynamic texture\r\n   * @param texture defines the texture to update\r\n   * @param canvas defines the canvas containing the source\r\n   * @param invertY defines if data must be stored with Y axis inverted\r\n   * @param premulAlpha defines if alpha is stored as premultiplied\r\n   * @param format defines the format of the data\r\n   * @param forceBindTexture if the texture should be forced to be bound eg. after a graphics context loss (Default: false)\r\n   */\n\n\n  NativeEngine.prototype.updateDynamicTexture = function (texture, canvas, invertY, premulAlpha, format) {\n    if (premulAlpha === void 0) {\n      premulAlpha = false;\n    } // TODO: Stub! This function is needed for some GLTF validation tests.\n    // Loads a dummy 8x8 transparent png\n\n\n    var imageData = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAYSURBVChTY/z//z8DPsAEpXGC4aCAgQEAGGMDDWwwgqsAAAAASUVORK5CYII=';\n    this.createTexture('data:my_image_name', true, invertY, null, Texture.BILINEAR_SAMPLINGMODE, undefined, undefined, imageData, texture, NativeEngine.TEXTUREFORMAT_RGBA, null, undefined);\n  }; // TODO: Refactor to share more logic with babylon.engine.ts version.\n\n  /**\r\n   * Usually called from Texture.ts.\r\n   * Passed information to create a WebGLTexture\r\n   * @param url defines a value which contains one of the following:\r\n   * * A conventional http URL, e.g. 'http://...' or 'file://...'\r\n   * * A base64 string of in-line texture data, e.g. 'data:image/jpg;base64,/...'\r\n   * * An indicator that data being passed using the buffer parameter, e.g. 'data:mytexture.jpg'\r\n   * @param noMipmap defines a boolean indicating that no mipmaps shall be generated.  Ignored for compressed textures.  They must be in the file\r\n   * @param invertY when true, image is flipped when loaded.  You probably want true. Certain compressed textures may invert this if their default is inverted (eg. ktx)\r\n   * @param scene needed for loading to the correct scene\r\n   * @param samplingMode mode with should be used sample / access the texture (Default: Texture.TRILINEAR_SAMPLINGMODE)\r\n   * @param onLoad optional callback to be called upon successful completion\r\n   * @param onError optional callback to be called upon failure\r\n   * @param buffer a source of a file previously fetched as either a base64 string, an ArrayBuffer (compressed or image format), HTMLImageElement (image format), or a Blob\r\n   * @param fallback an internal argument in case the function must be called again, due to etc1 not having alpha capabilities\r\n   * @param format internal format.  Default: RGB when extension is '.jpg' else RGBA.  Ignored for compressed textures\r\n   * @param forcedExtension defines the extension to use to pick the right loader\r\n   * @param mimeType defines an optional mime type\r\n   * @param loaderOptions options to be passed to the loader\r\n   * @returns a InternalTexture for assignment back into BABYLON.Texture\r\n   */\n\n\n  NativeEngine.prototype.createTexture = function (url, noMipmap, invertY, scene, samplingMode, onLoad, onError, buffer, fallback, format, forcedExtension, mimeType, loaderOptions) {\n    var _this = this;\n\n    if (samplingMode === void 0) {\n      samplingMode = 3;\n    }\n\n    if (onLoad === void 0) {\n      onLoad = null;\n    }\n\n    if (onError === void 0) {\n      onError = null;\n    }\n\n    if (buffer === void 0) {\n      buffer = null;\n    }\n\n    if (fallback === void 0) {\n      fallback = null;\n    }\n\n    if (format === void 0) {\n      format = null;\n    }\n\n    if (forcedExtension === void 0) {\n      forcedExtension = null;\n    }\n\n    url = url || \"\";\n    var fromData = url.substr(0, 5) === \"data:\"; //const fromBlob = url.substr(0, 5) === \"blob:\";\n\n    var isBase64 = fromData && url.indexOf(\";base64,\") !== -1;\n    var texture = fallback ? fallback : new InternalTexture(this, InternalTextureSource.Url);\n    var originalUrl = url;\n\n    if (this._transformTextureUrl && !isBase64 && !fallback && !buffer) {\n      url = this._transformTextureUrl(url);\n    } // establish the file extension, if possible\n\n\n    var lastDot = url.lastIndexOf('.');\n    var extension = forcedExtension ? forcedExtension : lastDot > -1 ? url.substring(lastDot).toLowerCase() : \"\";\n    var loader = null;\n\n    for (var _i = 0, _a = Engine._TextureLoaders; _i < _a.length; _i++) {\n      var availableLoader = _a[_i];\n\n      if (availableLoader.canLoad(extension)) {\n        loader = availableLoader;\n        break;\n      }\n    }\n\n    if (scene) {\n      scene._addPendingData(texture);\n    }\n\n    texture.url = url;\n    texture.generateMipMaps = !noMipmap;\n    texture.samplingMode = samplingMode;\n    texture.invertY = invertY;\n\n    if (!this.doNotHandleContextLost) {\n      // Keep a link to the buffer only if we plan to handle context lost\n      texture._buffer = buffer;\n    }\n\n    var onLoadObserver = null;\n\n    if (onLoad && !fallback) {\n      onLoadObserver = texture.onLoadedObservable.add(onLoad);\n    }\n\n    if (!fallback) {\n      this._internalTexturesCache.push(texture);\n    }\n\n    var onInternalError = function (message, exception) {\n      if (scene) {\n        scene._removePendingData(texture);\n      }\n\n      if (url === originalUrl) {\n        if (onLoadObserver) {\n          texture.onLoadedObservable.remove(onLoadObserver);\n        }\n\n        if (EngineStore.UseFallbackTexture) {\n          _this.createTexture(EngineStore.FallbackTexture, noMipmap, texture.invertY, scene, samplingMode, null, onError, buffer, texture);\n        }\n\n        if (onError) {\n          onError((message || \"Unknown error\") + (EngineStore.UseFallbackTexture ? \" - Fallback texture was used\" : \"\"), exception);\n        }\n      } else {\n        // fall back to the original url if the transformed url fails to load\n        Logger.Warn(\"Failed to load \" + url + \", falling back to \" + originalUrl);\n\n        _this.createTexture(originalUrl, noMipmap, texture.invertY, scene, samplingMode, onLoad, onError, buffer, texture, format, forcedExtension, mimeType, loaderOptions);\n      }\n    }; // processing for non-image formats\n\n\n    if (loader) {\n      throw new Error(\"Loading textures from IInternalTextureLoader not yet implemented.\");\n    } else {\n      var onload_1 = function (data) {\n        var webGLTexture = texture._webGLTexture;\n\n        if (!webGLTexture) {\n          if (scene) {\n            scene._removePendingData(texture);\n          }\n\n          return;\n        }\n\n        _this._native.loadTexture(webGLTexture, data, !noMipmap, invertY, function () {\n          texture.baseWidth = _this._native.getTextureWidth(webGLTexture);\n          texture.baseHeight = _this._native.getTextureHeight(webGLTexture);\n          texture.width = texture.baseWidth;\n          texture.height = texture.baseHeight;\n          texture.isReady = true;\n\n          var filter = _this._getNativeSamplingMode(samplingMode);\n\n          _this._native.setTextureSampling(webGLTexture, filter);\n\n          if (scene) {\n            scene._removePendingData(texture);\n          }\n\n          texture.onLoadedObservable.notifyObservers(texture);\n          texture.onLoadedObservable.clear();\n        }, function () {\n          throw new Error(\"Could not load a native texture.\");\n        });\n      };\n\n      if (fromData) {\n        if (buffer instanceof ArrayBuffer) {\n          onload_1(new Uint8Array(buffer));\n        } else if (ArrayBuffer.isView(buffer)) {\n          onload_1(buffer);\n        } else if (typeof buffer === \"string\") {\n          onload_1(new Uint8Array(Tools.DecodeBase64(buffer)));\n        } else {\n          throw new Error(\"Unsupported buffer type\");\n        }\n      } else {\n        if (isBase64) {\n          onload_1(new Uint8Array(Tools.DecodeBase64(url)));\n        } else {\n          this._loadFile(url, function (data) {\n            return onload_1(new Uint8Array(data));\n          }, undefined, undefined, true, function (request, exception) {\n            onInternalError(\"Unable to load \" + (request ? request.responseURL : url, exception));\n          });\n        }\n      }\n    }\n\n    return texture;\n  };\n\n  NativeEngine.prototype._createDepthStencilTexture = function (size, options) {\n    var texture = new NativeTexture(this, InternalTextureSource.Depth);\n    var width = size.width || size;\n    var height = size.height || size;\n\n    var framebuffer = this._native.createDepthTexture(texture._webGLTexture, width, height);\n\n    texture._framebuffer = framebuffer;\n    return texture;\n  };\n\n  NativeEngine.prototype._releaseFramebufferObjects = function (texture) {// TODO\n  };\n  /**\r\n   * Creates a cube texture\r\n   * @param rootUrl defines the url where the files to load is located\r\n   * @param scene defines the current scene\r\n   * @param files defines the list of files to load (1 per face)\r\n   * @param noMipmap defines a boolean indicating that no mipmaps shall be generated (false by default)\r\n   * @param onLoad defines an optional callback raised when the texture is loaded\r\n   * @param onError defines an optional callback raised if there is an issue to load the texture\r\n   * @param format defines the format of the data\r\n   * @param forcedExtension defines the extension to use to pick the right loader\r\n   * @param createPolynomials if a polynomial sphere should be created for the cube texture\r\n   * @param lodScale defines the scale applied to environment texture. This manages the range of LOD level used for IBL according to the roughness\r\n   * @param lodOffset defines the offset applied to environment texture. This manages first LOD level used for IBL according to the roughness\r\n   * @param fallback defines texture to use while falling back when (compressed) texture file not found.\r\n   * @returns the cube texture as an InternalTexture\r\n   */\n\n\n  NativeEngine.prototype.createCubeTexture = function (rootUrl, scene, files, noMipmap, onLoad, onError, format, forcedExtension, createPolynomials, lodScale, lodOffset, fallback) {\n    var _this = this;\n\n    if (onLoad === void 0) {\n      onLoad = null;\n    }\n\n    if (onError === void 0) {\n      onError = null;\n    }\n\n    if (forcedExtension === void 0) {\n      forcedExtension = null;\n    }\n\n    if (createPolynomials === void 0) {\n      createPolynomials = false;\n    }\n\n    if (lodScale === void 0) {\n      lodScale = 0;\n    }\n\n    if (lodOffset === void 0) {\n      lodOffset = 0;\n    }\n\n    if (fallback === void 0) {\n      fallback = null;\n    }\n\n    var texture = fallback ? fallback : new InternalTexture(this, InternalTextureSource.Cube);\n    texture.isCube = true;\n    texture.url = rootUrl;\n    texture.generateMipMaps = !noMipmap;\n    texture._lodGenerationScale = lodScale;\n    texture._lodGenerationOffset = lodOffset;\n\n    if (!this._doNotHandleContextLost) {\n      texture._extension = forcedExtension;\n      texture._files = files;\n    }\n\n    var lastDot = rootUrl.lastIndexOf('.');\n    var extension = forcedExtension ? forcedExtension : lastDot > -1 ? rootUrl.substring(lastDot).toLowerCase() : \"\"; // TODO: use texture loader to load env files?\n\n    if (extension === \".env\") {\n      var onloaddata_1 = function (data) {\n        var info = EnvironmentTextureTools.GetEnvInfo(data);\n        texture.width = info.width;\n        texture.height = info.width;\n        EnvironmentTextureTools.UploadEnvSpherical(texture, info);\n\n        if (info.version !== 1) {\n          throw new Error(\"Unsupported babylon environment map version \\\"\" + info.version + \"\\\"\");\n        }\n\n        var specularInfo = info.specular;\n\n        if (!specularInfo) {\n          throw new Error(\"Nothing else parsed so far\");\n        }\n\n        texture._lodGenerationScale = specularInfo.lodGenerationScale;\n        var imageData = EnvironmentTextureTools.CreateImageDataArrayBufferViews(data, info);\n        texture.format = 5;\n        texture.type = 0;\n        texture.generateMipMaps = true;\n        texture.getEngine().updateTextureSamplingMode(Texture.TRILINEAR_SAMPLINGMODE, texture);\n        texture._isRGBD = true;\n        texture.invertY = true;\n\n        _this._native.loadCubeTextureWithMips(texture._webGLTexture, imageData, function () {\n          texture.isReady = true;\n\n          if (onLoad) {\n            onLoad();\n          }\n        }, function () {\n          throw new Error(\"Could not load a native cube texture.\");\n        });\n      };\n\n      if (files && files.length === 6) {\n        throw new Error(\"Multi-file loading not allowed on env files.\");\n      } else {\n        var onInternalError = function (request, exception) {\n          if (onError && request) {\n            onError(request.status + \" \" + request.statusText, exception);\n          }\n        };\n\n        this._loadFile(rootUrl, function (data) {\n          return onloaddata_1(new Uint8Array(data));\n        }, undefined, undefined, true, onInternalError);\n      }\n    } else {\n      if (!files || files.length !== 6) {\n        throw new Error(\"Cannot load cubemap because 6 files were not defined\");\n      } // Reorder from [+X, +Y, +Z, -X, -Y, -Z] to [+X, -X, +Y, -Y, +Z, -Z].\n\n\n      var reorderedFiles = [files[0], files[3], files[1], files[4], files[2], files[5]];\n      Promise.all(reorderedFiles.map(function (file) {\n        return Tools.LoadFileAsync(file).then(function (data) {\n          return new Uint8Array(data);\n        });\n      })).then(function (data) {\n        return new Promise(function (resolve, reject) {\n          _this._native.loadCubeTexture(texture._webGLTexture, data, !noMipmap, resolve, reject);\n        });\n      }).then(function () {\n        texture.isReady = true;\n\n        if (onLoad) {\n          onLoad();\n        }\n      }, function (error) {\n        if (onError) {\n          onError(\"Failed to load cubemap: \" + error.message, error);\n        }\n      });\n    }\n\n    this._internalTexturesCache.push(texture);\n\n    return texture;\n  };\n\n  NativeEngine.prototype.createRenderTargetTexture = function (size, options) {\n    var fullOptions = new RenderTargetCreationOptions();\n\n    if (options !== undefined && typeof options === \"object\") {\n      fullOptions.generateMipMaps = options.generateMipMaps;\n      fullOptions.generateDepthBuffer = options.generateDepthBuffer === undefined ? true : options.generateDepthBuffer;\n      fullOptions.generateStencilBuffer = fullOptions.generateDepthBuffer && options.generateStencilBuffer;\n      fullOptions.type = options.type === undefined ? 0 : options.type;\n      fullOptions.samplingMode = options.samplingMode === undefined ? 3 : options.samplingMode;\n      fullOptions.format = options.format === undefined ? 5 : options.format;\n    } else {\n      fullOptions.generateMipMaps = options;\n      fullOptions.generateDepthBuffer = true;\n      fullOptions.generateStencilBuffer = false;\n      fullOptions.type = 0;\n      fullOptions.samplingMode = 3;\n      fullOptions.format = 5;\n    }\n\n    if (fullOptions.type === 1 && !this._caps.textureFloatLinearFiltering) {\n      // if floating point linear (gl.FLOAT) then force to NEAREST_SAMPLINGMODE\n      fullOptions.samplingMode = 1;\n    } else if (fullOptions.type === 2 && !this._caps.textureHalfFloatLinearFiltering) {\n      // if floating point linear (HALF_FLOAT) then force to NEAREST_SAMPLINGMODE\n      fullOptions.samplingMode = 1;\n    }\n\n    var texture = new NativeTexture(this, InternalTextureSource.RenderTarget);\n    var width = size.width || size;\n    var height = size.height || size;\n\n    if (fullOptions.type === 1 && !this._caps.textureFloat) {\n      fullOptions.type = 0;\n      Logger.Warn(\"Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type\");\n    }\n\n    var framebuffer = this._native.createFramebuffer(texture._webGLTexture, width, height, this._getNativeTextureFormat(fullOptions.format, fullOptions.type), fullOptions.samplingMode, fullOptions.generateStencilBuffer ? true : false, fullOptions.generateDepthBuffer, fullOptions.generateMipMaps ? true : false);\n\n    texture._framebuffer = framebuffer;\n    texture.baseWidth = width;\n    texture.baseHeight = height;\n    texture.width = width;\n    texture.height = height;\n    texture.isReady = true;\n    texture.samples = 1;\n    texture.generateMipMaps = fullOptions.generateMipMaps ? true : false;\n    texture.samplingMode = fullOptions.samplingMode;\n    texture.type = fullOptions.type;\n    texture.format = fullOptions.format;\n    texture._generateDepthBuffer = fullOptions.generateDepthBuffer;\n    texture._generateStencilBuffer = fullOptions.generateStencilBuffer ? true : false;\n\n    this._internalTexturesCache.push(texture);\n\n    return texture;\n  };\n\n  NativeEngine.prototype.updateTextureSamplingMode = function (samplingMode, texture) {\n    if (texture._webGLTexture) {\n      var filter = this._getNativeSamplingMode(samplingMode);\n\n      this._native.setTextureSampling(texture._webGLTexture, filter);\n    }\n\n    texture.samplingMode = samplingMode;\n  };\n\n  NativeEngine.prototype.bindFramebuffer = function (texture, faceIndex, requiredWidth, requiredHeight, forceFullscreenViewport) {\n    if (faceIndex) {\n      throw new Error(\"Cuboid frame buffers are not yet supported in NativeEngine.\");\n    }\n\n    if (requiredWidth || requiredHeight) {\n      throw new Error(\"Required width/height for frame buffers not yet supported in NativeEngine.\");\n    }\n\n    if (forceFullscreenViewport) {//Not supported yet but don't stop rendering\n    }\n\n    if (texture._depthStencilTexture) {\n      this._bindUnboundFramebuffer(texture._depthStencilTexture._framebuffer);\n    } else {\n      this._bindUnboundFramebuffer(texture._framebuffer);\n    }\n  };\n\n  NativeEngine.prototype.unBindFramebuffer = function (texture, disableGenerateMipMaps, onBeforeUnbind) {\n    if (disableGenerateMipMaps === void 0) {\n      disableGenerateMipMaps = false;\n    }\n\n    if (disableGenerateMipMaps) {\n      Logger.Warn(\"Disabling mipmap generation not yet supported in NativeEngine. Ignoring.\");\n    }\n\n    if (onBeforeUnbind) {\n      onBeforeUnbind();\n    }\n\n    this._bindUnboundFramebuffer(null);\n  };\n\n  NativeEngine.prototype.createDynamicVertexBuffer = function (data) {\n    return this.createVertexBuffer(data, true);\n  };\n\n  NativeEngine.prototype.updateDynamicIndexBuffer = function (indexBuffer, indices, offset) {\n    if (offset === void 0) {\n      offset = 0;\n    }\n\n    var buffer = indexBuffer;\n\n    var data = this._normalizeIndexData(indices);\n\n    buffer.is32Bits = data.BYTES_PER_ELEMENT === 4;\n\n    this._native.updateDynamicIndexBuffer(buffer.nativeIndexBuffer, data, offset);\n  };\n  /**\r\n   * Updates a dynamic vertex buffer.\r\n   * @param vertexBuffer the vertex buffer to update\r\n   * @param data the data used to update the vertex buffer\r\n   * @param byteOffset the byte offset of the data (optional)\r\n   * @param byteLength the byte length of the data (optional)\r\n   */\n\n\n  NativeEngine.prototype.updateDynamicVertexBuffer = function (vertexBuffer, data, byteOffset, byteLength) {\n    var buffer = vertexBuffer;\n    var dataView = ArrayBuffer.isView(data) ? data : new Float32Array(data);\n\n    this._native.updateDynamicVertexBuffer(buffer.nativeVertexBuffer, dataView, byteOffset !== null && byteOffset !== void 0 ? byteOffset : 0, byteLength !== null && byteLength !== void 0 ? byteLength : dataView.byteLength);\n  }; // TODO: Refactor to share more logic with base Engine implementation.\n\n\n  NativeEngine.prototype._setTexture = function (channel, texture, isPartOfTextureArray, depthStencilTexture) {\n    if (isPartOfTextureArray === void 0) {\n      isPartOfTextureArray = false;\n    }\n\n    if (depthStencilTexture === void 0) {\n      depthStencilTexture = false;\n    }\n\n    var uniform = this._boundUniforms[channel];\n\n    if (!uniform) {\n      return false;\n    } // Not ready?\n\n\n    if (!texture) {\n      if (this._boundTexturesCache[channel] != null) {\n        this._activeChannel = channel;\n\n        this._native.setTexture(uniform, null);\n      }\n\n      return false;\n    } // Video\n\n\n    if (texture.video) {\n      this._activeChannel = channel;\n      texture.update();\n    } else if (texture.delayLoadState === 4) {\n      // Delay loading\n      texture.delayLoad();\n      return false;\n    }\n\n    var internalTexture;\n\n    if (depthStencilTexture) {\n      internalTexture = texture.depthStencilTexture;\n    } else if (texture.isReady()) {\n      internalTexture = texture.getInternalTexture();\n    } else if (texture.isCube) {\n      internalTexture = this.emptyCubeTexture;\n    } else if (texture.is3D) {\n      internalTexture = this.emptyTexture3D;\n    } else if (texture.is2DArray) {\n      internalTexture = this.emptyTexture2DArray;\n    } else {\n      internalTexture = this.emptyTexture;\n    }\n\n    this._activeChannel = channel;\n\n    if (!internalTexture || !internalTexture._webGLTexture) {\n      return false;\n    }\n\n    this._native.setTextureWrapMode(internalTexture._webGLTexture, this._getAddressMode(texture.wrapU), this._getAddressMode(texture.wrapV), this._getAddressMode(texture.wrapR));\n\n    this._updateAnisotropicLevel(texture);\n\n    this._native.setTexture(uniform, internalTexture._webGLTexture);\n\n    return true;\n  }; // TODO: Share more of this logic with the base implementation.\n  // TODO: Rename to match naming in base implementation once refactoring allows different parameters.\n\n\n  NativeEngine.prototype._updateAnisotropicLevel = function (texture) {\n    var internalTexture = texture.getInternalTexture();\n    var value = texture.anisotropicFilteringLevel;\n\n    if (!internalTexture || !internalTexture._webGLTexture) {\n      return;\n    }\n\n    if (internalTexture._cachedAnisotropicFilteringLevel !== value) {\n      this._native.setTextureAnisotropicLevel(internalTexture._webGLTexture, value);\n\n      internalTexture._cachedAnisotropicFilteringLevel = value;\n    }\n  }; // Returns a NativeAddressMode.XXX value.\n\n\n  NativeEngine.prototype._getAddressMode = function (wrapMode) {\n    switch (wrapMode) {\n      case 1:\n        return this._native.ADDRESS_MODE_WRAP;\n\n      case 0:\n        return this._native.ADDRESS_MODE_CLAMP;\n\n      case 2:\n        return this._native.ADDRESS_MODE_MIRROR;\n\n      default:\n        throw new Error(\"Unexpected wrap mode: \" + wrapMode + \".\");\n    }\n  };\n  /** @hidden */\n\n\n  NativeEngine.prototype._bindTexture = function (channel, texture) {\n    var uniform = this._boundUniforms[channel];\n\n    if (!uniform) {\n      return;\n    }\n\n    this._native.setTexture(uniform, texture._webGLTexture);\n  };\n\n  NativeEngine.prototype._deleteBuffer = function (buffer) {\n    if (buffer.nativeIndexBuffer) {\n      this._native.deleteIndexBuffer(buffer.nativeIndexBuffer);\n\n      delete buffer.nativeIndexBuffer;\n    }\n\n    if (buffer.nativeVertexBuffer) {\n      this._native.deleteVertexBuffer(buffer.nativeVertexBuffer);\n\n      delete buffer.nativeVertexBuffer;\n    }\n  };\n\n  NativeEngine.prototype.releaseEffects = function () {// TODO\n  };\n  /** @hidden */\n\n\n  NativeEngine.prototype._uploadCompressedDataToTextureDirectly = function (texture, internalFormat, width, height, data, faceIndex, lod) {\n    if (faceIndex === void 0) {\n      faceIndex = 0;\n    }\n\n    if (lod === void 0) {\n      lod = 0;\n    }\n\n    throw new Error(\"_uploadCompressedDataToTextureDirectly not implemented.\");\n  };\n  /** @hidden */\n\n\n  NativeEngine.prototype._uploadDataToTextureDirectly = function (texture, imageData, faceIndex, lod) {\n    if (faceIndex === void 0) {\n      faceIndex = 0;\n    }\n\n    if (lod === void 0) {\n      lod = 0;\n    }\n\n    throw new Error(\"_uploadDataToTextureDirectly not implemented.\");\n  };\n  /** @hidden */\n\n\n  NativeEngine.prototype._uploadArrayBufferViewToTexture = function (texture, imageData, faceIndex, lod) {\n    if (faceIndex === void 0) {\n      faceIndex = 0;\n    }\n\n    if (lod === void 0) {\n      lod = 0;\n    }\n\n    throw new Error(\"_uploadArrayBufferViewToTexture not implemented.\");\n  };\n  /** @hidden */\n\n\n  NativeEngine.prototype._uploadImageToTexture = function (texture, image, faceIndex, lod) {\n    if (faceIndex === void 0) {\n      faceIndex = 0;\n    }\n\n    if (lod === void 0) {\n      lod = 0;\n    }\n\n    throw new Error(\"_uploadArrayBufferViewToTexture not implemented.\");\n  }; // JavaScript-to-Native conversion helper functions.\n\n\n  NativeEngine.prototype._getNativeSamplingMode = function (samplingMode) {\n    switch (samplingMode) {\n      case 1:\n        return this._native.TEXTURE_NEAREST_NEAREST;\n\n      case 2:\n        return this._native.TEXTURE_LINEAR_LINEAR;\n\n      case 3:\n        return this._native.TEXTURE_LINEAR_LINEAR_MIPLINEAR;\n\n      case 4:\n        return this._native.TEXTURE_NEAREST_NEAREST_MIPNEAREST;\n\n      case 5:\n        return this._native.TEXTURE_NEAREST_LINEAR_MIPNEAREST;\n\n      case 6:\n        return this._native.TEXTURE_NEAREST_LINEAR_MIPLINEAR;\n\n      case 7:\n        return this._native.TEXTURE_NEAREST_LINEAR;\n\n      case 8:\n        return this._native.TEXTURE_NEAREST_NEAREST_MIPLINEAR;\n\n      case 9:\n        return this._native.TEXTURE_LINEAR_NEAREST_MIPNEAREST;\n\n      case 10:\n        return this._native.TEXTURE_LINEAR_NEAREST_MIPLINEAR;\n\n      case 11:\n        return this._native.TEXTURE_LINEAR_LINEAR_MIPNEAREST;\n\n      case 12:\n        return this._native.TEXTURE_LINEAR_NEAREST;\n\n      default:\n        throw new Error(\"Unsupported sampling mode: \" + samplingMode + \".\");\n    }\n  };\n\n  NativeEngine.prototype._getNativeTextureFormat = function (format, type) {\n    if (format == 5 && type == 0) {\n      return this._native.TEXTURE_FORMAT_RGBA8;\n    } else if (format == 5 && type == 1) {\n      return this._native.TEXTURE_FORMAT_RGBA32F;\n    } else {\n      throw new Error(\"Unsupported texture format or type: format \" + format + \", type \" + type + \".\");\n    }\n  };\n\n  NativeEngine.prototype._getNativeAlphaMode = function (mode) {\n    switch (mode) {\n      case 0:\n        return this._native.ALPHA_DISABLE;\n\n      case 1:\n        return this._native.ALPHA_ADD;\n\n      case 2:\n        return this._native.ALPHA_COMBINE;\n\n      case 3:\n        return this._native.ALPHA_SUBTRACT;\n\n      case 4:\n        return this._native.ALPHA_MULTIPLY;\n\n      case 5:\n        return this._native.ALPHA_MAXIMIZED;\n\n      case 6:\n        return this._native.ALPHA_ONEONE;\n\n      case 7:\n        return this._native.ALPHA_PREMULTIPLIED;\n\n      case 8:\n        return this._native.ALPHA_PREMULTIPLIED_PORTERDUFF;\n\n      case 9:\n        return this._native.ALPHA_INTERPOLATE;\n\n      case 10:\n        return this._native.ALPHA_SCREENMODE;\n\n      default:\n        throw new Error(\"Unsupported alpha mode: \" + mode + \".\");\n    }\n  };\n\n  NativeEngine.prototype._getNativeAttribType = function (type) {\n    switch (type) {\n      case VertexBuffer.UNSIGNED_BYTE:\n        return this._native.ATTRIB_TYPE_UINT8;\n\n      case VertexBuffer.SHORT:\n        return this._native.ATTRIB_TYPE_INT16;\n\n      case VertexBuffer.FLOAT:\n        return this._native.ATTRIB_TYPE_FLOAT;\n\n      default:\n        throw new Error(\"Unsupported attribute type: \" + type + \".\");\n    }\n  };\n\n  return NativeEngine;\n}(Engine);\n\nexport { NativeEngine };","map":{"version":3,"sources":["C:/Users/rober/Documents/Computer Science/Side Projects/arcade/node_modules/@babylonjs/core/Engines/nativeEngine.js"],"names":["__extends","Engine","VertexBuffer","InternalTexture","InternalTextureSource","Texture","DataBuffer","Tools","EnvironmentTextureTools","RenderTargetCreationOptions","Logger","ThinEngine","EngineStore","ShaderCodeInliner","WebGL2ShaderProcessor","NativePipelineContext","isAsync","isReady","prototype","_getVertexShaderCode","_getFragmentShaderCode","_handlesSpectorRebuildCallback","onCompiled","Error","NativeDataBuffer","_super","apply","arguments","NativeTexture","getInternalTexture","getViewCount","NativeEngine","_this","call","_native","INVALID_HANDLE","_boundBuffersVertexArray","_currentDepthTest","DEPTH_TEST_LEQUAL","_webGLVersion","disableUniformBuffers","_caps","maxTexturesImageUnits","maxVertexTextureImageUnits","maxCombinedTexturesImageUnits","maxTextureSize","maxCubemapTextureSize","maxRenderTextureSize","maxVertexAttribs","maxVaryingVectors","maxFragmentUniformVectors","maxVertexUniformVectors","standardDerivatives","astc","pvrtc","etc1","etc2","bptc","maxAnisotropy","uintIndices","fragmentDepthSupported","highPrecisionShaderSupported","colorBufferFloat","textureFloat","textureFloatLinearFiltering","textureFloatRender","textureHalfFloat","textureHalfFloatLinearFiltering","textureHalfFloatRender","textureLOD","drawBuffersExtension","depthTextureExtension","vertexArrayObject","instancedArrays","canUseTimestampForTimerQuery","blendMinMax","maxMSAASamples","Log","Version","LoadScript","scriptUrl","onSuccess","onError","scriptId","LoadFile","data","Function","undefined","request","exception","URL","window","createObjectURL","revokeObjectURL","Blob","_shaderProcessor","getHardwareScalingLevel","dispose","deleteVertexArray","_queueNewFrame","bindedRenderFunction","requester","requestAnimationFrame","_bindUnboundFramebuffer","framebuffer","_currentFramebuffer","unbindFramebuffer","bindFramebuffer","getHostDocument","clear","color","backBuffer","depth","stencil","mode","clearColor","r","g","b","a","CLEAR_FLAG_COLOR","clearDepth","CLEAR_FLAG_DEPTH","clearStencil","CLEAR_FLAG_STENCIL","createIndexBuffer","indices","updateable","_normalizeIndexData","buffer","references","is32Bits","BYTES_PER_ELEMENT","length","nativeIndexBuffer","nativeVertexBuffer","createVertexBuffer","ArrayBuffer","isView","Float32Array","_recordVertexArrayObject","vertexArray","vertexBuffers","indexBuffer","effect","recordIndexBuffer","attributes","getAttributesNames","index","location_1","getAttributeLocation","kind","vertexBuffer","getBuffer","recordVertexBuffer","byteOffset","byteStride","getSize","_getNativeAttribType","type","normalized","bindBuffers","createVertexArray","bindVertexArray","recordVertexArrayObject","bindVertexArrayObject","releaseVertexArrayObject","getAttributes","pipelineContext","attributesNames","nativePipelineContext","nativeProgram","drawElementsType","fillMode","indexStart","indexCount","instancesCount","_drawCalls","addCount","drawIndexed","drawArraysType","verticesStart","verticesCount","draw","createPipelineContext","_preparePipelineContext","vertexSourceCode","fragmentSourceCode","createAsRaw","rebuildRebind","defines","transformFeedbackVaryings","createRawShaderProgram","createShaderProgram","_isRenderingStateCompiled","_executeWhenRenderingStateIsCompiled","action","vertexCode","fragmentCode","context","onBeforeShaderCompilationObservable","notifyObservers","vertexInliner","processCode","code","fragmentInliner","_ConcatenateShader","program","createProgram","onAfterShaderCompilationObservable","_setProgram","_currentProgram","setProgram","_releaseEffect","_deletePipelineContext","getUniforms","uniformsNames","bindUniformBlock","blockName","bindSamplers","getPipelineContext","samplers","getSamplers","uniform","getUniform","_boundUniforms","_currentEffect","setMatrix","matrix","toArray","getRenderWidth","useScreen","_currentRenderTarget","width","getRenderHeight","height","setViewport","viewport","requiredWidth","requiredHeight","_cachedViewport","setViewPort","x","y","setState","culling","zOffset","force","reverseSide","setZOffset","value","getZOffset","setDepthBuffer","enable","setDepthTest","DEPTH_TEST_ALWAYS","getDepthWrite","setDepthFunctionToGreater","DEPTH_TEST_GREATER","setDepthFunctionToGreaterOrEqual","DEPTH_TEST_GEQUAL","setDepthFunctionToLess","DEPTH_TEST_LESS","setDepthFunctionToLessOrEqual","setDepthWrite","setColorWrite","_colorWrite","getColorWrite","setAlphaConstants","setAlphaMode","noDepthWriteChange","_alphaMode","_getNativeAlphaMode","setBlendMode","getAlphaMode","setInt","int","setIntArray","array","setIntArray2","setIntArray3","setIntArray4","setFloatArray","setFloatArray2","setFloatArray3","setFloatArray4","setArray","setArray2","setArray3","setArray4","setMatrices","matrices","setMatrix3x3","setMatrix2x2","setFloat","setFloat2","setFloat3","z","setFloat4","w","setColor3","color3","setColor4","alpha","wipeCaches","bruteForce","preventCacheWipeBetweenFrames","resetTextureCache","_stencilState","reset","_depthCullingState","_alphaState","_cachedVertexBuffers","_cachedIndexBuffer","_cachedEffectForVertexBuffers","_createTexture","createTexture","_deleteTexture","texture","deleteTexture","updateDynamicTexture","canvas","invertY","premulAlpha","format","imageData","BILINEAR_SAMPLINGMODE","TEXTUREFORMAT_RGBA","url","noMipmap","scene","samplingMode","onLoad","fallback","forcedExtension","mimeType","loaderOptions","fromData","substr","isBase64","indexOf","Url","originalUrl","_transformTextureUrl","lastDot","lastIndexOf","extension","substring","toLowerCase","loader","_i","_a","_TextureLoaders","availableLoader","canLoad","_addPendingData","generateMipMaps","doNotHandleContextLost","_buffer","onLoadObserver","onLoadedObservable","add","_internalTexturesCache","push","onInternalError","message","_removePendingData","remove","UseFallbackTexture","FallbackTexture","Warn","onload_1","webGLTexture","_webGLTexture","loadTexture","baseWidth","getTextureWidth","baseHeight","getTextureHeight","filter","_getNativeSamplingMode","setTextureSampling","Uint8Array","DecodeBase64","_loadFile","responseURL","_createDepthStencilTexture","size","options","Depth","createDepthTexture","_framebuffer","_releaseFramebufferObjects","createCubeTexture","rootUrl","files","createPolynomials","lodScale","lodOffset","Cube","isCube","_lodGenerationScale","_lodGenerationOffset","_doNotHandleContextLost","_extension","_files","onloaddata_1","info","GetEnvInfo","UploadEnvSpherical","version","specularInfo","specular","lodGenerationScale","CreateImageDataArrayBufferViews","getEngine","updateTextureSamplingMode","TRILINEAR_SAMPLINGMODE","_isRGBD","loadCubeTextureWithMips","status","statusText","reorderedFiles","Promise","all","map","file","LoadFileAsync","then","resolve","reject","loadCubeTexture","error","createRenderTargetTexture","fullOptions","generateDepthBuffer","generateStencilBuffer","RenderTarget","createFramebuffer","_getNativeTextureFormat","samples","_generateDepthBuffer","_generateStencilBuffer","faceIndex","forceFullscreenViewport","_depthStencilTexture","unBindFramebuffer","disableGenerateMipMaps","onBeforeUnbind","createDynamicVertexBuffer","updateDynamicIndexBuffer","offset","updateDynamicVertexBuffer","byteLength","dataView","_setTexture","channel","isPartOfTextureArray","depthStencilTexture","_boundTexturesCache","_activeChannel","setTexture","video","update","delayLoadState","delayLoad","internalTexture","emptyCubeTexture","is3D","emptyTexture3D","is2DArray","emptyTexture2DArray","emptyTexture","setTextureWrapMode","_getAddressMode","wrapU","wrapV","wrapR","_updateAnisotropicLevel","anisotropicFilteringLevel","_cachedAnisotropicFilteringLevel","setTextureAnisotropicLevel","wrapMode","ADDRESS_MODE_WRAP","ADDRESS_MODE_CLAMP","ADDRESS_MODE_MIRROR","_bindTexture","_deleteBuffer","deleteIndexBuffer","deleteVertexBuffer","releaseEffects","_uploadCompressedDataToTextureDirectly","internalFormat","lod","_uploadDataToTextureDirectly","_uploadArrayBufferViewToTexture","_uploadImageToTexture","image","TEXTURE_NEAREST_NEAREST","TEXTURE_LINEAR_LINEAR","TEXTURE_LINEAR_LINEAR_MIPLINEAR","TEXTURE_NEAREST_NEAREST_MIPNEAREST","TEXTURE_NEAREST_LINEAR_MIPNEAREST","TEXTURE_NEAREST_LINEAR_MIPLINEAR","TEXTURE_NEAREST_LINEAR","TEXTURE_NEAREST_NEAREST_MIPLINEAR","TEXTURE_LINEAR_NEAREST_MIPNEAREST","TEXTURE_LINEAR_NEAREST_MIPLINEAR","TEXTURE_LINEAR_LINEAR_MIPNEAREST","TEXTURE_LINEAR_NEAREST","TEXTURE_FORMAT_RGBA8","TEXTURE_FORMAT_RGBA32F","ALPHA_DISABLE","ALPHA_ADD","ALPHA_COMBINE","ALPHA_SUBTRACT","ALPHA_MULTIPLY","ALPHA_MAXIMIZED","ALPHA_ONEONE","ALPHA_PREMULTIPLIED","ALPHA_PREMULTIPLIED_PORTERDUFF","ALPHA_INTERPOLATE","ALPHA_SCREENMODE","UNSIGNED_BYTE","ATTRIB_TYPE_UINT8","SHORT","ATTRIB_TYPE_INT16","FLOAT","ATTRIB_TYPE_FLOAT"],"mappings":"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","sourcesContent":["import { __extends } from \"tslib\";\r\nimport { Engine } from \"../Engines/engine\";\r\nimport { VertexBuffer } from \"../Meshes/buffer\";\r\nimport { InternalTexture, InternalTextureSource } from \"../Materials/Textures/internalTexture\";\r\nimport { Texture } from \"../Materials/Textures/texture\";\r\nimport { DataBuffer } from '../Meshes/dataBuffer';\r\nimport { Tools } from \"../Misc/tools\";\r\nimport { EnvironmentTextureTools } from \"../Misc/environmentTextureTools\";\r\nimport { RenderTargetCreationOptions } from \"../Materials/Textures/renderTargetCreationOptions\";\r\nimport { Logger } from \"../Misc/logger\";\r\nimport { ThinEngine } from './thinEngine';\r\nimport { EngineStore } from './engineStore';\r\nimport { ShaderCodeInliner } from \"./Processors/shaderCodeInliner\";\r\nimport { WebGL2ShaderProcessor } from '../Engines/WebGL/webGL2ShaderProcessors';\r\nvar NativePipelineContext = /** @class */ (function () {\r\n    function NativePipelineContext() {\r\n        // TODO: async should be true?\r\n        this.isAsync = false;\r\n        this.isReady = false;\r\n    }\r\n    NativePipelineContext.prototype._getVertexShaderCode = function () {\r\n        return null;\r\n    };\r\n    NativePipelineContext.prototype._getFragmentShaderCode = function () {\r\n        return null;\r\n    };\r\n    // TODO: what should this do?\r\n    NativePipelineContext.prototype._handlesSpectorRebuildCallback = function (onCompiled) {\r\n        throw new Error(\"Not implemented\");\r\n    };\r\n    return NativePipelineContext;\r\n}());\r\n/**\r\n * Container for accessors for natively-stored mesh data buffers.\r\n */\r\nvar NativeDataBuffer = /** @class */ (function (_super) {\r\n    __extends(NativeDataBuffer, _super);\r\n    function NativeDataBuffer() {\r\n        return _super !== null && _super.apply(this, arguments) || this;\r\n    }\r\n    return NativeDataBuffer;\r\n}(DataBuffer));\r\n/** @hidden */\r\nvar NativeTexture = /** @class */ (function (_super) {\r\n    __extends(NativeTexture, _super);\r\n    function NativeTexture() {\r\n        return _super !== null && _super.apply(this, arguments) || this;\r\n    }\r\n    NativeTexture.prototype.getInternalTexture = function () {\r\n        return this;\r\n    };\r\n    NativeTexture.prototype.getViewCount = function () {\r\n        return 1;\r\n    };\r\n    return NativeTexture;\r\n}(InternalTexture));\r\n/** @hidden */\r\nvar NativeEngine = /** @class */ (function (_super) {\r\n    __extends(NativeEngine, _super);\r\n    function NativeEngine() {\r\n        var _this = _super.call(this, null) || this;\r\n        _this._native = new _native.Engine();\r\n        /** Defines the invalid handle returned by bgfx when resource creation goes wrong */\r\n        _this.INVALID_HANDLE = 65535;\r\n        _this._boundBuffersVertexArray = null;\r\n        _this._currentDepthTest = _this._native.DEPTH_TEST_LEQUAL;\r\n        _this._webGLVersion = 2;\r\n        _this.disableUniformBuffers = true;\r\n        // TODO: Initialize this more correctly based on the hardware capabilities.\r\n        // Init caps\r\n        _this._caps = {\r\n            maxTexturesImageUnits: 16,\r\n            maxVertexTextureImageUnits: 16,\r\n            maxCombinedTexturesImageUnits: 32,\r\n            maxTextureSize: 512,\r\n            maxCubemapTextureSize: 512,\r\n            maxRenderTextureSize: 512,\r\n            maxVertexAttribs: 16,\r\n            maxVaryingVectors: 16,\r\n            maxFragmentUniformVectors: 16,\r\n            maxVertexUniformVectors: 16,\r\n            standardDerivatives: true,\r\n            astc: null,\r\n            pvrtc: null,\r\n            etc1: null,\r\n            etc2: null,\r\n            bptc: null,\r\n            maxAnisotropy: 16,\r\n            uintIndices: true,\r\n            fragmentDepthSupported: false,\r\n            highPrecisionShaderSupported: true,\r\n            colorBufferFloat: false,\r\n            textureFloat: false,\r\n            textureFloatLinearFiltering: false,\r\n            textureFloatRender: false,\r\n            textureHalfFloat: false,\r\n            textureHalfFloatLinearFiltering: false,\r\n            textureHalfFloatRender: false,\r\n            textureLOD: true,\r\n            drawBuffersExtension: false,\r\n            depthTextureExtension: false,\r\n            vertexArrayObject: true,\r\n            instancedArrays: false,\r\n            canUseTimestampForTimerQuery: false,\r\n            blendMinMax: false,\r\n            maxMSAASamples: 1\r\n        };\r\n        Tools.Log(\"Babylon Native (v\" + Engine.Version + \") launched\");\r\n        Tools.LoadScript = function (scriptUrl, onSuccess, onError, scriptId) {\r\n            Tools.LoadFile(scriptUrl, function (data) {\r\n                Function(data).apply(null);\r\n                if (onSuccess) {\r\n                    onSuccess();\r\n                }\r\n            }, undefined, undefined, false, function (request, exception) {\r\n                if (onError) {\r\n                    onError(\"LoadScript Error\", exception);\r\n                }\r\n            });\r\n        };\r\n        // Wrappers\r\n        if (typeof URL === \"undefined\") {\r\n            window.URL = {\r\n                createObjectURL: function () { },\r\n                revokeObjectURL: function () { }\r\n            };\r\n        }\r\n        if (typeof Blob === \"undefined\") {\r\n            window.Blob = function () { };\r\n        }\r\n        // Shader processor\r\n        _this._shaderProcessor = new WebGL2ShaderProcessor();\r\n        return _this;\r\n    }\r\n    NativeEngine.prototype.getHardwareScalingLevel = function () {\r\n        return 1.0;\r\n    };\r\n    NativeEngine.prototype.dispose = function () {\r\n        _super.prototype.dispose.call(this);\r\n        if (this._boundBuffersVertexArray) {\r\n            this._native.deleteVertexArray(this._boundBuffersVertexArray);\r\n        }\r\n        this._native.dispose();\r\n    };\r\n    /**\r\n     * Can be used to override the current requestAnimationFrame requester.\r\n     * @hidden\r\n     */\r\n    NativeEngine.prototype._queueNewFrame = function (bindedRenderFunction, requester) {\r\n        // Use the provided requestAnimationFrame, unless the requester is the window. In that case, we will default to the Babylon Native version of requestAnimationFrame.\r\n        if (requester.requestAnimationFrame && requester !== window) {\r\n            requester.requestAnimationFrame(bindedRenderFunction);\r\n        }\r\n        else {\r\n            this._native.requestAnimationFrame(bindedRenderFunction);\r\n        }\r\n        return 0;\r\n    };\r\n    /**\r\n     * Override default engine behavior.\r\n     * @param color\r\n     * @param backBuffer\r\n     * @param depth\r\n     * @param stencil\r\n     */\r\n    NativeEngine.prototype._bindUnboundFramebuffer = function (framebuffer) {\r\n        if (this._currentFramebuffer !== framebuffer) {\r\n            if (this._currentFramebuffer) {\r\n                this._native.unbindFramebuffer(this._currentFramebuffer);\r\n            }\r\n            if (framebuffer) {\r\n                this._native.bindFramebuffer(framebuffer);\r\n            }\r\n            this._currentFramebuffer = framebuffer;\r\n        }\r\n    };\r\n    /**\r\n     * Gets host document\r\n     * @returns the host document object\r\n     */\r\n    NativeEngine.prototype.getHostDocument = function () {\r\n        return null;\r\n    };\r\n    NativeEngine.prototype.clear = function (color, backBuffer, depth, stencil) {\r\n        if (stencil === void 0) { stencil = false; }\r\n        var mode = 0;\r\n        if (backBuffer && color) {\r\n            this._native.clearColor(color.r, color.g, color.b, color.a !== undefined ? color.a : 1.0);\r\n            mode |= this._native.CLEAR_FLAG_COLOR;\r\n        }\r\n        if (depth) {\r\n            this._native.clearDepth(1.0);\r\n            mode |= this._native.CLEAR_FLAG_DEPTH;\r\n        }\r\n        if (stencil) {\r\n            this._native.clearStencil(0);\r\n            mode |= this._native.CLEAR_FLAG_STENCIL;\r\n        }\r\n        this._native.clear(mode);\r\n    };\r\n    NativeEngine.prototype.createIndexBuffer = function (indices, updateable) {\r\n        var data = this._normalizeIndexData(indices);\r\n        var buffer = new NativeDataBuffer();\r\n        buffer.references = 1;\r\n        buffer.is32Bits = (data.BYTES_PER_ELEMENT === 4);\r\n        if (data.length) {\r\n            buffer.nativeIndexBuffer = this._native.createIndexBuffer(data, updateable !== null && updateable !== void 0 ? updateable : false);\r\n            if (buffer.nativeVertexBuffer === this.INVALID_HANDLE) {\r\n                throw new Error(\"Could not create a native index buffer.\");\r\n            }\r\n        }\r\n        else {\r\n            buffer.nativeVertexBuffer = this.INVALID_HANDLE;\r\n        }\r\n        return buffer;\r\n    };\r\n    NativeEngine.prototype.createVertexBuffer = function (data, updateable) {\r\n        var buffer = new NativeDataBuffer();\r\n        buffer.references = 1;\r\n        buffer.nativeVertexBuffer = this._native.createVertexBuffer(ArrayBuffer.isView(data) ? data : new Float32Array(data), updateable !== null && updateable !== void 0 ? updateable : false);\r\n        if (buffer.nativeVertexBuffer === this.INVALID_HANDLE) {\r\n            throw new Error(\"Could not create a native vertex buffer.\");\r\n        }\r\n        return buffer;\r\n    };\r\n    NativeEngine.prototype._recordVertexArrayObject = function (vertexArray, vertexBuffers, indexBuffer, effect) {\r\n        if (indexBuffer) {\r\n            this._native.recordIndexBuffer(vertexArray, indexBuffer.nativeIndexBuffer);\r\n        }\r\n        var attributes = effect.getAttributesNames();\r\n        for (var index = 0; index < attributes.length; index++) {\r\n            var location_1 = effect.getAttributeLocation(index);\r\n            if (location_1 >= 0) {\r\n                var kind = attributes[index];\r\n                var vertexBuffer = vertexBuffers[kind];\r\n                if (vertexBuffer) {\r\n                    var buffer = vertexBuffer.getBuffer();\r\n                    if (buffer) {\r\n                        this._native.recordVertexBuffer(vertexArray, buffer.nativeVertexBuffer, location_1, vertexBuffer.byteOffset, vertexBuffer.byteStride, vertexBuffer.getSize(), this._getNativeAttribType(vertexBuffer.type), vertexBuffer.normalized);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    };\r\n    NativeEngine.prototype.bindBuffers = function (vertexBuffers, indexBuffer, effect) {\r\n        if (this._boundBuffersVertexArray) {\r\n            this._native.deleteVertexArray(this._boundBuffersVertexArray);\r\n        }\r\n        this._boundBuffersVertexArray = this._native.createVertexArray();\r\n        this._recordVertexArrayObject(this._boundBuffersVertexArray, vertexBuffers, indexBuffer, effect);\r\n        this._native.bindVertexArray(this._boundBuffersVertexArray);\r\n    };\r\n    NativeEngine.prototype.recordVertexArrayObject = function (vertexBuffers, indexBuffer, effect) {\r\n        var vertexArray = this._native.createVertexArray();\r\n        this._recordVertexArrayObject(vertexArray, vertexBuffers, indexBuffer, effect);\r\n        return vertexArray;\r\n    };\r\n    NativeEngine.prototype.bindVertexArrayObject = function (vertexArray) {\r\n        this._native.bindVertexArray(vertexArray);\r\n    };\r\n    NativeEngine.prototype.releaseVertexArrayObject = function (vertexArray) {\r\n        this._native.deleteVertexArray(vertexArray);\r\n    };\r\n    NativeEngine.prototype.getAttributes = function (pipelineContext, attributesNames) {\r\n        var nativePipelineContext = pipelineContext;\r\n        return this._native.getAttributes(nativePipelineContext.nativeProgram, attributesNames);\r\n    };\r\n    /**\r\n     * Draw a list of indexed primitives\r\n     * @param fillMode defines the primitive to use\r\n     * @param indexStart defines the starting index\r\n     * @param indexCount defines the number of index to draw\r\n     * @param instancesCount defines the number of instances to draw (if instanciation is enabled)\r\n     */\r\n    NativeEngine.prototype.drawElementsType = function (fillMode, indexStart, indexCount, instancesCount) {\r\n        // Apply states\r\n        this._drawCalls.addCount(1, false);\r\n        // TODO: Make this implementation more robust like core Engine version.\r\n        // Render\r\n        //var indexFormat = this._uintIndicesCurrentlySet ? this._gl.UNSIGNED_INT : this._gl.UNSIGNED_SHORT;\r\n        //var mult = this._uintIndicesCurrentlySet ? 4 : 2;\r\n        // if (instancesCount) {\r\n        //     this._gl.drawElementsInstanced(drawMode, indexCount, indexFormat, indexStart * mult, instancesCount);\r\n        // } else {\r\n        this._native.drawIndexed(fillMode, indexStart, indexCount);\r\n        // }\r\n    };\r\n    /**\r\n     * Draw a list of unindexed primitives\r\n     * @param fillMode defines the primitive to use\r\n     * @param verticesStart defines the index of first vertex to draw\r\n     * @param verticesCount defines the count of vertices to draw\r\n     * @param instancesCount defines the number of instances to draw (if instanciation is enabled)\r\n     */\r\n    NativeEngine.prototype.drawArraysType = function (fillMode, verticesStart, verticesCount, instancesCount) {\r\n        // Apply states\r\n        this._drawCalls.addCount(1, false);\r\n        // TODO: Make this implementation more robust like core Engine version.\r\n        // if (instancesCount) {\r\n        //     this._gl.drawArraysInstanced(drawMode, verticesStart, verticesCount, instancesCount);\r\n        // } else {\r\n        this._native.draw(fillMode, verticesStart, verticesCount);\r\n        // }\r\n    };\r\n    NativeEngine.prototype.createPipelineContext = function () {\r\n        return new NativePipelineContext();\r\n    };\r\n    NativeEngine.prototype._preparePipelineContext = function (pipelineContext, vertexSourceCode, fragmentSourceCode, createAsRaw, rebuildRebind, defines, transformFeedbackVaryings) {\r\n        var nativePipelineContext = pipelineContext;\r\n        if (createAsRaw) {\r\n            nativePipelineContext.nativeProgram = this.createRawShaderProgram(pipelineContext, vertexSourceCode, fragmentSourceCode, undefined, transformFeedbackVaryings);\r\n        }\r\n        else {\r\n            nativePipelineContext.nativeProgram = this.createShaderProgram(pipelineContext, vertexSourceCode, fragmentSourceCode, defines, undefined, transformFeedbackVaryings);\r\n        }\r\n    };\r\n    /** @hidden */\r\n    NativeEngine.prototype._isRenderingStateCompiled = function (pipelineContext) {\r\n        // TODO: support async shader compilcation\r\n        return true;\r\n    };\r\n    /** @hidden */\r\n    NativeEngine.prototype._executeWhenRenderingStateIsCompiled = function (pipelineContext, action) {\r\n        // TODO: support async shader compilcation\r\n        action();\r\n    };\r\n    NativeEngine.prototype.createRawShaderProgram = function (pipelineContext, vertexCode, fragmentCode, context, transformFeedbackVaryings) {\r\n        if (transformFeedbackVaryings === void 0) { transformFeedbackVaryings = null; }\r\n        throw new Error(\"Not Supported\");\r\n    };\r\n    NativeEngine.prototype.createShaderProgram = function (pipelineContext, vertexCode, fragmentCode, defines, context, transformFeedbackVaryings) {\r\n        if (transformFeedbackVaryings === void 0) { transformFeedbackVaryings = null; }\r\n        this.onBeforeShaderCompilationObservable.notifyObservers(this);\r\n        var vertexInliner = new ShaderCodeInliner(vertexCode);\r\n        vertexInliner.processCode();\r\n        vertexCode = vertexInliner.code;\r\n        var fragmentInliner = new ShaderCodeInliner(fragmentCode);\r\n        fragmentInliner.processCode();\r\n        fragmentCode = fragmentInliner.code;\r\n        vertexCode = ThinEngine._ConcatenateShader(vertexCode, defines);\r\n        fragmentCode = ThinEngine._ConcatenateShader(fragmentCode, defines);\r\n        var program = this._native.createProgram(vertexCode, fragmentCode);\r\n        this.onAfterShaderCompilationObservable.notifyObservers(this);\r\n        return program;\r\n    };\r\n    NativeEngine.prototype._setProgram = function (program) {\r\n        if (this._currentProgram !== program) {\r\n            this._native.setProgram(program);\r\n            this._currentProgram = program;\r\n        }\r\n    };\r\n    NativeEngine.prototype._releaseEffect = function (effect) {\r\n        // TODO\r\n    };\r\n    NativeEngine.prototype._deletePipelineContext = function (pipelineContext) {\r\n        // TODO\r\n    };\r\n    NativeEngine.prototype.getUniforms = function (pipelineContext, uniformsNames) {\r\n        var nativePipelineContext = pipelineContext;\r\n        return this._native.getUniforms(nativePipelineContext.nativeProgram, uniformsNames);\r\n    };\r\n    NativeEngine.prototype.bindUniformBlock = function (pipelineContext, blockName, index) {\r\n        // TODO\r\n        throw new Error(\"Not Implemented\");\r\n    };\r\n    NativeEngine.prototype.bindSamplers = function (effect) {\r\n        var nativePipelineContext = effect.getPipelineContext();\r\n        this._setProgram(nativePipelineContext.nativeProgram);\r\n        // TODO: share this with engine?\r\n        var samplers = effect.getSamplers();\r\n        for (var index = 0; index < samplers.length; index++) {\r\n            var uniform = effect.getUniform(samplers[index]);\r\n            if (uniform) {\r\n                this._boundUniforms[index] = uniform;\r\n            }\r\n        }\r\n        this._currentEffect = null;\r\n    };\r\n    NativeEngine.prototype.setMatrix = function (uniform, matrix) {\r\n        if (!uniform) {\r\n            return;\r\n        }\r\n        this._native.setMatrix(uniform, matrix.toArray());\r\n    };\r\n    NativeEngine.prototype.getRenderWidth = function (useScreen) {\r\n        if (useScreen === void 0) { useScreen = false; }\r\n        if (!useScreen && this._currentRenderTarget) {\r\n            return this._currentRenderTarget.width;\r\n        }\r\n        return this._native.getRenderWidth();\r\n    };\r\n    NativeEngine.prototype.getRenderHeight = function (useScreen) {\r\n        if (useScreen === void 0) { useScreen = false; }\r\n        if (!useScreen && this._currentRenderTarget) {\r\n            return this._currentRenderTarget.height;\r\n        }\r\n        return this._native.getRenderHeight();\r\n    };\r\n    NativeEngine.prototype.setViewport = function (viewport, requiredWidth, requiredHeight) {\r\n        this._cachedViewport = viewport;\r\n        this._native.setViewPort(viewport.x, viewport.y, viewport.width, viewport.height);\r\n    };\r\n    NativeEngine.prototype.setState = function (culling, zOffset, force, reverseSide) {\r\n        if (zOffset === void 0) { zOffset = 0; }\r\n        if (reverseSide === void 0) { reverseSide = false; }\r\n        this._native.setState(culling, zOffset, reverseSide);\r\n    };\r\n    /**\r\n     * Set the z offset to apply to current rendering\r\n     * @param value defines the offset to apply\r\n     */\r\n    NativeEngine.prototype.setZOffset = function (value) {\r\n        this._native.setZOffset(value);\r\n    };\r\n    /**\r\n     * Gets the current value of the zOffset\r\n     * @returns the current zOffset state\r\n     */\r\n    NativeEngine.prototype.getZOffset = function () {\r\n        return this._native.getZOffset();\r\n    };\r\n    /**\r\n     * Enable or disable depth buffering\r\n     * @param enable defines the state to set\r\n     */\r\n    NativeEngine.prototype.setDepthBuffer = function (enable) {\r\n        this._native.setDepthTest(enable ? this._currentDepthTest : this._native.DEPTH_TEST_ALWAYS);\r\n    };\r\n    /**\r\n     * Gets a boolean indicating if depth writing is enabled\r\n     * @returns the current depth writing state\r\n     */\r\n    NativeEngine.prototype.getDepthWrite = function () {\r\n        return this._native.getDepthWrite();\r\n    };\r\n    NativeEngine.prototype.setDepthFunctionToGreater = function () {\r\n        this._currentDepthTest = this._native.DEPTH_TEST_GREATER;\r\n        this._native.setDepthTest(this._currentDepthTest);\r\n    };\r\n    NativeEngine.prototype.setDepthFunctionToGreaterOrEqual = function () {\r\n        this._currentDepthTest = this._native.DEPTH_TEST_GEQUAL;\r\n        this._native.setDepthTest(this._currentDepthTest);\r\n    };\r\n    NativeEngine.prototype.setDepthFunctionToLess = function () {\r\n        this._currentDepthTest = this._native.DEPTH_TEST_LESS;\r\n        this._native.setDepthTest(this._currentDepthTest);\r\n    };\r\n    NativeEngine.prototype.setDepthFunctionToLessOrEqual = function () {\r\n        this._currentDepthTest = this._native.DEPTH_TEST_LEQUAL;\r\n        this._native.setDepthTest(this._currentDepthTest);\r\n    };\r\n    /**\r\n     * Enable or disable depth writing\r\n     * @param enable defines the state to set\r\n     */\r\n    NativeEngine.prototype.setDepthWrite = function (enable) {\r\n        this._native.setDepthWrite(enable);\r\n    };\r\n    /**\r\n     * Enable or disable color writing\r\n     * @param enable defines the state to set\r\n     */\r\n    NativeEngine.prototype.setColorWrite = function (enable) {\r\n        this._native.setColorWrite(enable);\r\n        this._colorWrite = enable;\r\n    };\r\n    /**\r\n     * Gets a boolean indicating if color writing is enabled\r\n     * @returns the current color writing state\r\n     */\r\n    NativeEngine.prototype.getColorWrite = function () {\r\n        return this._colorWrite;\r\n    };\r\n    /**\r\n     * Sets alpha constants used by some alpha blending modes\r\n     * @param r defines the red component\r\n     * @param g defines the green component\r\n     * @param b defines the blue component\r\n     * @param a defines the alpha component\r\n     */\r\n    NativeEngine.prototype.setAlphaConstants = function (r, g, b, a) {\r\n        throw new Error(\"Setting alpha blend constant color not yet implemented.\");\r\n    };\r\n    /**\r\n     * Sets the current alpha mode\r\n     * @param mode defines the mode to use (one of the BABYLON.undefined)\r\n     * @param noDepthWriteChange defines if depth writing state should remains unchanged (false by default)\r\n     * @see https://doc.babylonjs.com/resources/transparency_and_how_meshes_are_rendered\r\n     */\r\n    NativeEngine.prototype.setAlphaMode = function (mode, noDepthWriteChange) {\r\n        if (noDepthWriteChange === void 0) { noDepthWriteChange = false; }\r\n        if (this._alphaMode === mode) {\r\n            return;\r\n        }\r\n        mode = this._getNativeAlphaMode(mode);\r\n        this._native.setBlendMode(mode);\r\n        if (!noDepthWriteChange) {\r\n            this.setDepthWrite(mode === 0);\r\n        }\r\n        this._alphaMode = mode;\r\n    };\r\n    /**\r\n     * Gets the current alpha mode\r\n     * @see https://doc.babylonjs.com/resources/transparency_and_how_meshes_are_rendered\r\n     * @returns the current alpha mode\r\n     */\r\n    NativeEngine.prototype.getAlphaMode = function () {\r\n        return this._alphaMode;\r\n    };\r\n    NativeEngine.prototype.setInt = function (uniform, int) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._native.setInt(uniform, int);\r\n        return true;\r\n    };\r\n    NativeEngine.prototype.setIntArray = function (uniform, array) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._native.setIntArray(uniform, array);\r\n        return true;\r\n    };\r\n    NativeEngine.prototype.setIntArray2 = function (uniform, array) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._native.setIntArray2(uniform, array);\r\n        return true;\r\n    };\r\n    NativeEngine.prototype.setIntArray3 = function (uniform, array) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._native.setIntArray3(uniform, array);\r\n        return true;\r\n    };\r\n    NativeEngine.prototype.setIntArray4 = function (uniform, array) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._native.setIntArray4(uniform, array);\r\n        return true;\r\n    };\r\n    NativeEngine.prototype.setFloatArray = function (uniform, array) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._native.setFloatArray(uniform, array);\r\n        return true;\r\n    };\r\n    NativeEngine.prototype.setFloatArray2 = function (uniform, array) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._native.setFloatArray2(uniform, array);\r\n        return true;\r\n    };\r\n    NativeEngine.prototype.setFloatArray3 = function (uniform, array) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._native.setFloatArray3(uniform, array);\r\n        return true;\r\n    };\r\n    NativeEngine.prototype.setFloatArray4 = function (uniform, array) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._native.setFloatArray4(uniform, array);\r\n        return true;\r\n    };\r\n    NativeEngine.prototype.setArray = function (uniform, array) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._native.setFloatArray(uniform, array);\r\n        return true;\r\n    };\r\n    NativeEngine.prototype.setArray2 = function (uniform, array) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._native.setFloatArray2(uniform, array);\r\n        return true;\r\n    };\r\n    NativeEngine.prototype.setArray3 = function (uniform, array) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._native.setFloatArray3(uniform, array);\r\n        return true;\r\n    };\r\n    NativeEngine.prototype.setArray4 = function (uniform, array) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._native.setFloatArray4(uniform, array);\r\n        return true;\r\n    };\r\n    NativeEngine.prototype.setMatrices = function (uniform, matrices) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._native.setMatrices(uniform, matrices);\r\n        return true;\r\n    };\r\n    NativeEngine.prototype.setMatrix3x3 = function (uniform, matrix) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._native.setMatrix3x3(uniform, matrix);\r\n        return true;\r\n    };\r\n    NativeEngine.prototype.setMatrix2x2 = function (uniform, matrix) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._native.setMatrix2x2(uniform, matrix);\r\n        return true;\r\n    };\r\n    NativeEngine.prototype.setFloat = function (uniform, value) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._native.setFloat(uniform, value);\r\n        return true;\r\n    };\r\n    NativeEngine.prototype.setFloat2 = function (uniform, x, y) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._native.setFloat2(uniform, x, y);\r\n        return true;\r\n    };\r\n    NativeEngine.prototype.setFloat3 = function (uniform, x, y, z) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._native.setFloat3(uniform, x, y, z);\r\n        return true;\r\n    };\r\n    NativeEngine.prototype.setFloat4 = function (uniform, x, y, z, w) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._native.setFloat4(uniform, x, y, z, w);\r\n        return true;\r\n    };\r\n    NativeEngine.prototype.setColor3 = function (uniform, color3) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._native.setFloat3(uniform, color3.r, color3.g, color3.b);\r\n        return true;\r\n    };\r\n    NativeEngine.prototype.setColor4 = function (uniform, color3, alpha) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._native.setFloat4(uniform, color3.r, color3.g, color3.b, alpha);\r\n        return true;\r\n    };\r\n    NativeEngine.prototype.wipeCaches = function (bruteForce) {\r\n        if (this.preventCacheWipeBetweenFrames) {\r\n            return;\r\n        }\r\n        this.resetTextureCache();\r\n        this._currentEffect = null;\r\n        if (bruteForce) {\r\n            this._currentProgram = null;\r\n            this._stencilState.reset();\r\n            this._depthCullingState.reset();\r\n            this._alphaState.reset();\r\n        }\r\n        this._cachedVertexBuffers = null;\r\n        this._cachedIndexBuffer = null;\r\n        this._cachedEffectForVertexBuffers = null;\r\n    };\r\n    NativeEngine.prototype._createTexture = function () {\r\n        return this._native.createTexture();\r\n    };\r\n    NativeEngine.prototype._deleteTexture = function (texture) {\r\n        this._native.deleteTexture(texture);\r\n    };\r\n    /**\r\n     * Update the content of a dynamic texture\r\n     * @param texture defines the texture to update\r\n     * @param canvas defines the canvas containing the source\r\n     * @param invertY defines if data must be stored with Y axis inverted\r\n     * @param premulAlpha defines if alpha is stored as premultiplied\r\n     * @param format defines the format of the data\r\n     * @param forceBindTexture if the texture should be forced to be bound eg. after a graphics context loss (Default: false)\r\n     */\r\n    NativeEngine.prototype.updateDynamicTexture = function (texture, canvas, invertY, premulAlpha, format) {\r\n        if (premulAlpha === void 0) { premulAlpha = false; }\r\n        // TODO: Stub! This function is needed for some GLTF validation tests.\r\n        // Loads a dummy 8x8 transparent png\r\n        var imageData = 'data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAgAAAAICAYAAADED76LAAAAAXNSR0IArs4c6QAAAARnQU1BAACxjwv8YQUAAAAJcEhZcwAADsMAAA7DAcdvqGQAAAAYSURBVChTY/z//z8DPsAEpXGC4aCAgQEAGGMDDWwwgqsAAAAASUVORK5CYII=';\r\n        this.createTexture('data:my_image_name', true, invertY, null, Texture.BILINEAR_SAMPLINGMODE, undefined, undefined, imageData, texture, NativeEngine.TEXTUREFORMAT_RGBA, null, undefined);\r\n    };\r\n    // TODO: Refactor to share more logic with babylon.engine.ts version.\r\n    /**\r\n     * Usually called from Texture.ts.\r\n     * Passed information to create a WebGLTexture\r\n     * @param url defines a value which contains one of the following:\r\n     * * A conventional http URL, e.g. 'http://...' or 'file://...'\r\n     * * A base64 string of in-line texture data, e.g. 'data:image/jpg;base64,/...'\r\n     * * An indicator that data being passed using the buffer parameter, e.g. 'data:mytexture.jpg'\r\n     * @param noMipmap defines a boolean indicating that no mipmaps shall be generated.  Ignored for compressed textures.  They must be in the file\r\n     * @param invertY when true, image is flipped when loaded.  You probably want true. Certain compressed textures may invert this if their default is inverted (eg. ktx)\r\n     * @param scene needed for loading to the correct scene\r\n     * @param samplingMode mode with should be used sample / access the texture (Default: Texture.TRILINEAR_SAMPLINGMODE)\r\n     * @param onLoad optional callback to be called upon successful completion\r\n     * @param onError optional callback to be called upon failure\r\n     * @param buffer a source of a file previously fetched as either a base64 string, an ArrayBuffer (compressed or image format), HTMLImageElement (image format), or a Blob\r\n     * @param fallback an internal argument in case the function must be called again, due to etc1 not having alpha capabilities\r\n     * @param format internal format.  Default: RGB when extension is '.jpg' else RGBA.  Ignored for compressed textures\r\n     * @param forcedExtension defines the extension to use to pick the right loader\r\n     * @param mimeType defines an optional mime type\r\n     * @param loaderOptions options to be passed to the loader\r\n     * @returns a InternalTexture for assignment back into BABYLON.Texture\r\n     */\r\n    NativeEngine.prototype.createTexture = function (url, noMipmap, invertY, scene, samplingMode, onLoad, onError, buffer, fallback, format, forcedExtension, mimeType, loaderOptions) {\r\n        var _this = this;\r\n        if (samplingMode === void 0) { samplingMode = 3; }\r\n        if (onLoad === void 0) { onLoad = null; }\r\n        if (onError === void 0) { onError = null; }\r\n        if (buffer === void 0) { buffer = null; }\r\n        if (fallback === void 0) { fallback = null; }\r\n        if (format === void 0) { format = null; }\r\n        if (forcedExtension === void 0) { forcedExtension = null; }\r\n        url = url || \"\";\r\n        var fromData = url.substr(0, 5) === \"data:\";\r\n        //const fromBlob = url.substr(0, 5) === \"blob:\";\r\n        var isBase64 = fromData && url.indexOf(\";base64,\") !== -1;\r\n        var texture = fallback ? fallback : new InternalTexture(this, InternalTextureSource.Url);\r\n        var originalUrl = url;\r\n        if (this._transformTextureUrl && !isBase64 && !fallback && !buffer) {\r\n            url = this._transformTextureUrl(url);\r\n        }\r\n        // establish the file extension, if possible\r\n        var lastDot = url.lastIndexOf('.');\r\n        var extension = forcedExtension ? forcedExtension : (lastDot > -1 ? url.substring(lastDot).toLowerCase() : \"\");\r\n        var loader = null;\r\n        for (var _i = 0, _a = Engine._TextureLoaders; _i < _a.length; _i++) {\r\n            var availableLoader = _a[_i];\r\n            if (availableLoader.canLoad(extension)) {\r\n                loader = availableLoader;\r\n                break;\r\n            }\r\n        }\r\n        if (scene) {\r\n            scene._addPendingData(texture);\r\n        }\r\n        texture.url = url;\r\n        texture.generateMipMaps = !noMipmap;\r\n        texture.samplingMode = samplingMode;\r\n        texture.invertY = invertY;\r\n        if (!this.doNotHandleContextLost) {\r\n            // Keep a link to the buffer only if we plan to handle context lost\r\n            texture._buffer = buffer;\r\n        }\r\n        var onLoadObserver = null;\r\n        if (onLoad && !fallback) {\r\n            onLoadObserver = texture.onLoadedObservable.add(onLoad);\r\n        }\r\n        if (!fallback) {\r\n            this._internalTexturesCache.push(texture);\r\n        }\r\n        var onInternalError = function (message, exception) {\r\n            if (scene) {\r\n                scene._removePendingData(texture);\r\n            }\r\n            if (url === originalUrl) {\r\n                if (onLoadObserver) {\r\n                    texture.onLoadedObservable.remove(onLoadObserver);\r\n                }\r\n                if (EngineStore.UseFallbackTexture) {\r\n                    _this.createTexture(EngineStore.FallbackTexture, noMipmap, texture.invertY, scene, samplingMode, null, onError, buffer, texture);\r\n                }\r\n                if (onError) {\r\n                    onError((message || \"Unknown error\") + (EngineStore.UseFallbackTexture ? \" - Fallback texture was used\" : \"\"), exception);\r\n                }\r\n            }\r\n            else {\r\n                // fall back to the original url if the transformed url fails to load\r\n                Logger.Warn(\"Failed to load \" + url + \", falling back to \" + originalUrl);\r\n                _this.createTexture(originalUrl, noMipmap, texture.invertY, scene, samplingMode, onLoad, onError, buffer, texture, format, forcedExtension, mimeType, loaderOptions);\r\n            }\r\n        };\r\n        // processing for non-image formats\r\n        if (loader) {\r\n            throw new Error(\"Loading textures from IInternalTextureLoader not yet implemented.\");\r\n        }\r\n        else {\r\n            var onload_1 = function (data) {\r\n                var webGLTexture = texture._webGLTexture;\r\n                if (!webGLTexture) {\r\n                    if (scene) {\r\n                        scene._removePendingData(texture);\r\n                    }\r\n                    return;\r\n                }\r\n                _this._native.loadTexture(webGLTexture, data, !noMipmap, invertY, function () {\r\n                    texture.baseWidth = _this._native.getTextureWidth(webGLTexture);\r\n                    texture.baseHeight = _this._native.getTextureHeight(webGLTexture);\r\n                    texture.width = texture.baseWidth;\r\n                    texture.height = texture.baseHeight;\r\n                    texture.isReady = true;\r\n                    var filter = _this._getNativeSamplingMode(samplingMode);\r\n                    _this._native.setTextureSampling(webGLTexture, filter);\r\n                    if (scene) {\r\n                        scene._removePendingData(texture);\r\n                    }\r\n                    texture.onLoadedObservable.notifyObservers(texture);\r\n                    texture.onLoadedObservable.clear();\r\n                }, function () {\r\n                    throw new Error(\"Could not load a native texture.\");\r\n                });\r\n            };\r\n            if (fromData) {\r\n                if (buffer instanceof ArrayBuffer) {\r\n                    onload_1(new Uint8Array(buffer));\r\n                }\r\n                else if (ArrayBuffer.isView(buffer)) {\r\n                    onload_1(buffer);\r\n                }\r\n                else if (typeof buffer === \"string\") {\r\n                    onload_1(new Uint8Array(Tools.DecodeBase64(buffer)));\r\n                }\r\n                else {\r\n                    throw new Error(\"Unsupported buffer type\");\r\n                }\r\n            }\r\n            else {\r\n                if (isBase64) {\r\n                    onload_1(new Uint8Array(Tools.DecodeBase64(url)));\r\n                }\r\n                else {\r\n                    this._loadFile(url, function (data) { return onload_1(new Uint8Array(data)); }, undefined, undefined, true, function (request, exception) {\r\n                        onInternalError(\"Unable to load \" + (request ? request.responseURL : url, exception));\r\n                    });\r\n                }\r\n            }\r\n        }\r\n        return texture;\r\n    };\r\n    NativeEngine.prototype._createDepthStencilTexture = function (size, options) {\r\n        var texture = new NativeTexture(this, InternalTextureSource.Depth);\r\n        var width = size.width || size;\r\n        var height = size.height || size;\r\n        var framebuffer = this._native.createDepthTexture(texture._webGLTexture, width, height);\r\n        texture._framebuffer = framebuffer;\r\n        return texture;\r\n    };\r\n    NativeEngine.prototype._releaseFramebufferObjects = function (texture) {\r\n        // TODO\r\n    };\r\n    /**\r\n     * Creates a cube texture\r\n     * @param rootUrl defines the url where the files to load is located\r\n     * @param scene defines the current scene\r\n     * @param files defines the list of files to load (1 per face)\r\n     * @param noMipmap defines a boolean indicating that no mipmaps shall be generated (false by default)\r\n     * @param onLoad defines an optional callback raised when the texture is loaded\r\n     * @param onError defines an optional callback raised if there is an issue to load the texture\r\n     * @param format defines the format of the data\r\n     * @param forcedExtension defines the extension to use to pick the right loader\r\n     * @param createPolynomials if a polynomial sphere should be created for the cube texture\r\n     * @param lodScale defines the scale applied to environment texture. This manages the range of LOD level used for IBL according to the roughness\r\n     * @param lodOffset defines the offset applied to environment texture. This manages first LOD level used for IBL according to the roughness\r\n     * @param fallback defines texture to use while falling back when (compressed) texture file not found.\r\n     * @returns the cube texture as an InternalTexture\r\n     */\r\n    NativeEngine.prototype.createCubeTexture = function (rootUrl, scene, files, noMipmap, onLoad, onError, format, forcedExtension, createPolynomials, lodScale, lodOffset, fallback) {\r\n        var _this = this;\r\n        if (onLoad === void 0) { onLoad = null; }\r\n        if (onError === void 0) { onError = null; }\r\n        if (forcedExtension === void 0) { forcedExtension = null; }\r\n        if (createPolynomials === void 0) { createPolynomials = false; }\r\n        if (lodScale === void 0) { lodScale = 0; }\r\n        if (lodOffset === void 0) { lodOffset = 0; }\r\n        if (fallback === void 0) { fallback = null; }\r\n        var texture = fallback ? fallback : new InternalTexture(this, InternalTextureSource.Cube);\r\n        texture.isCube = true;\r\n        texture.url = rootUrl;\r\n        texture.generateMipMaps = !noMipmap;\r\n        texture._lodGenerationScale = lodScale;\r\n        texture._lodGenerationOffset = lodOffset;\r\n        if (!this._doNotHandleContextLost) {\r\n            texture._extension = forcedExtension;\r\n            texture._files = files;\r\n        }\r\n        var lastDot = rootUrl.lastIndexOf('.');\r\n        var extension = forcedExtension ? forcedExtension : (lastDot > -1 ? rootUrl.substring(lastDot).toLowerCase() : \"\");\r\n        // TODO: use texture loader to load env files?\r\n        if (extension === \".env\") {\r\n            var onloaddata_1 = function (data) {\r\n                var info = EnvironmentTextureTools.GetEnvInfo(data);\r\n                texture.width = info.width;\r\n                texture.height = info.width;\r\n                EnvironmentTextureTools.UploadEnvSpherical(texture, info);\r\n                if (info.version !== 1) {\r\n                    throw new Error(\"Unsupported babylon environment map version \\\"\" + info.version + \"\\\"\");\r\n                }\r\n                var specularInfo = info.specular;\r\n                if (!specularInfo) {\r\n                    throw new Error(\"Nothing else parsed so far\");\r\n                }\r\n                texture._lodGenerationScale = specularInfo.lodGenerationScale;\r\n                var imageData = EnvironmentTextureTools.CreateImageDataArrayBufferViews(data, info);\r\n                texture.format = 5;\r\n                texture.type = 0;\r\n                texture.generateMipMaps = true;\r\n                texture.getEngine().updateTextureSamplingMode(Texture.TRILINEAR_SAMPLINGMODE, texture);\r\n                texture._isRGBD = true;\r\n                texture.invertY = true;\r\n                _this._native.loadCubeTextureWithMips(texture._webGLTexture, imageData, function () {\r\n                    texture.isReady = true;\r\n                    if (onLoad) {\r\n                        onLoad();\r\n                    }\r\n                }, function () {\r\n                    throw new Error(\"Could not load a native cube texture.\");\r\n                });\r\n            };\r\n            if (files && files.length === 6) {\r\n                throw new Error(\"Multi-file loading not allowed on env files.\");\r\n            }\r\n            else {\r\n                var onInternalError = function (request, exception) {\r\n                    if (onError && request) {\r\n                        onError(request.status + \" \" + request.statusText, exception);\r\n                    }\r\n                };\r\n                this._loadFile(rootUrl, function (data) { return onloaddata_1(new Uint8Array(data)); }, undefined, undefined, true, onInternalError);\r\n            }\r\n        }\r\n        else {\r\n            if (!files || files.length !== 6) {\r\n                throw new Error(\"Cannot load cubemap because 6 files were not defined\");\r\n            }\r\n            // Reorder from [+X, +Y, +Z, -X, -Y, -Z] to [+X, -X, +Y, -Y, +Z, -Z].\r\n            var reorderedFiles = [files[0], files[3], files[1], files[4], files[2], files[5]];\r\n            Promise.all(reorderedFiles.map(function (file) { return Tools.LoadFileAsync(file).then(function (data) { return new Uint8Array(data); }); })).then(function (data) {\r\n                return new Promise(function (resolve, reject) {\r\n                    _this._native.loadCubeTexture(texture._webGLTexture, data, !noMipmap, resolve, reject);\r\n                });\r\n            }).then(function () {\r\n                texture.isReady = true;\r\n                if (onLoad) {\r\n                    onLoad();\r\n                }\r\n            }, function (error) {\r\n                if (onError) {\r\n                    onError(\"Failed to load cubemap: \" + error.message, error);\r\n                }\r\n            });\r\n        }\r\n        this._internalTexturesCache.push(texture);\r\n        return texture;\r\n    };\r\n    NativeEngine.prototype.createRenderTargetTexture = function (size, options) {\r\n        var fullOptions = new RenderTargetCreationOptions();\r\n        if (options !== undefined && typeof options === \"object\") {\r\n            fullOptions.generateMipMaps = options.generateMipMaps;\r\n            fullOptions.generateDepthBuffer = options.generateDepthBuffer === undefined ? true : options.generateDepthBuffer;\r\n            fullOptions.generateStencilBuffer = fullOptions.generateDepthBuffer && options.generateStencilBuffer;\r\n            fullOptions.type = options.type === undefined ? 0 : options.type;\r\n            fullOptions.samplingMode = options.samplingMode === undefined ? 3 : options.samplingMode;\r\n            fullOptions.format = options.format === undefined ? 5 : options.format;\r\n        }\r\n        else {\r\n            fullOptions.generateMipMaps = options;\r\n            fullOptions.generateDepthBuffer = true;\r\n            fullOptions.generateStencilBuffer = false;\r\n            fullOptions.type = 0;\r\n            fullOptions.samplingMode = 3;\r\n            fullOptions.format = 5;\r\n        }\r\n        if (fullOptions.type === 1 && !this._caps.textureFloatLinearFiltering) {\r\n            // if floating point linear (gl.FLOAT) then force to NEAREST_SAMPLINGMODE\r\n            fullOptions.samplingMode = 1;\r\n        }\r\n        else if (fullOptions.type === 2 && !this._caps.textureHalfFloatLinearFiltering) {\r\n            // if floating point linear (HALF_FLOAT) then force to NEAREST_SAMPLINGMODE\r\n            fullOptions.samplingMode = 1;\r\n        }\r\n        var texture = new NativeTexture(this, InternalTextureSource.RenderTarget);\r\n        var width = size.width || size;\r\n        var height = size.height || size;\r\n        if (fullOptions.type === 1 && !this._caps.textureFloat) {\r\n            fullOptions.type = 0;\r\n            Logger.Warn(\"Float textures are not supported. Render target forced to TEXTURETYPE_UNSIGNED_BYTE type\");\r\n        }\r\n        var framebuffer = this._native.createFramebuffer(texture._webGLTexture, width, height, this._getNativeTextureFormat(fullOptions.format, fullOptions.type), fullOptions.samplingMode, fullOptions.generateStencilBuffer ? true : false, fullOptions.generateDepthBuffer, fullOptions.generateMipMaps ? true : false);\r\n        texture._framebuffer = framebuffer;\r\n        texture.baseWidth = width;\r\n        texture.baseHeight = height;\r\n        texture.width = width;\r\n        texture.height = height;\r\n        texture.isReady = true;\r\n        texture.samples = 1;\r\n        texture.generateMipMaps = fullOptions.generateMipMaps ? true : false;\r\n        texture.samplingMode = fullOptions.samplingMode;\r\n        texture.type = fullOptions.type;\r\n        texture.format = fullOptions.format;\r\n        texture._generateDepthBuffer = fullOptions.generateDepthBuffer;\r\n        texture._generateStencilBuffer = fullOptions.generateStencilBuffer ? true : false;\r\n        this._internalTexturesCache.push(texture);\r\n        return texture;\r\n    };\r\n    NativeEngine.prototype.updateTextureSamplingMode = function (samplingMode, texture) {\r\n        if (texture._webGLTexture) {\r\n            var filter = this._getNativeSamplingMode(samplingMode);\r\n            this._native.setTextureSampling(texture._webGLTexture, filter);\r\n        }\r\n        texture.samplingMode = samplingMode;\r\n    };\r\n    NativeEngine.prototype.bindFramebuffer = function (texture, faceIndex, requiredWidth, requiredHeight, forceFullscreenViewport) {\r\n        if (faceIndex) {\r\n            throw new Error(\"Cuboid frame buffers are not yet supported in NativeEngine.\");\r\n        }\r\n        if (requiredWidth || requiredHeight) {\r\n            throw new Error(\"Required width/height for frame buffers not yet supported in NativeEngine.\");\r\n        }\r\n        if (forceFullscreenViewport) {\r\n            //Not supported yet but don't stop rendering\r\n        }\r\n        if (texture._depthStencilTexture) {\r\n            this._bindUnboundFramebuffer(texture._depthStencilTexture._framebuffer);\r\n        }\r\n        else {\r\n            this._bindUnboundFramebuffer(texture._framebuffer);\r\n        }\r\n    };\r\n    NativeEngine.prototype.unBindFramebuffer = function (texture, disableGenerateMipMaps, onBeforeUnbind) {\r\n        if (disableGenerateMipMaps === void 0) { disableGenerateMipMaps = false; }\r\n        if (disableGenerateMipMaps) {\r\n            Logger.Warn(\"Disabling mipmap generation not yet supported in NativeEngine. Ignoring.\");\r\n        }\r\n        if (onBeforeUnbind) {\r\n            onBeforeUnbind();\r\n        }\r\n        this._bindUnboundFramebuffer(null);\r\n    };\r\n    NativeEngine.prototype.createDynamicVertexBuffer = function (data) {\r\n        return this.createVertexBuffer(data, true);\r\n    };\r\n    NativeEngine.prototype.updateDynamicIndexBuffer = function (indexBuffer, indices, offset) {\r\n        if (offset === void 0) { offset = 0; }\r\n        var buffer = indexBuffer;\r\n        var data = this._normalizeIndexData(indices);\r\n        buffer.is32Bits = (data.BYTES_PER_ELEMENT === 4);\r\n        this._native.updateDynamicIndexBuffer(buffer.nativeIndexBuffer, data, offset);\r\n    };\r\n    /**\r\n     * Updates a dynamic vertex buffer.\r\n     * @param vertexBuffer the vertex buffer to update\r\n     * @param data the data used to update the vertex buffer\r\n     * @param byteOffset the byte offset of the data (optional)\r\n     * @param byteLength the byte length of the data (optional)\r\n     */\r\n    NativeEngine.prototype.updateDynamicVertexBuffer = function (vertexBuffer, data, byteOffset, byteLength) {\r\n        var buffer = vertexBuffer;\r\n        var dataView = ArrayBuffer.isView(data) ? data : new Float32Array(data);\r\n        this._native.updateDynamicVertexBuffer(buffer.nativeVertexBuffer, dataView, byteOffset !== null && byteOffset !== void 0 ? byteOffset : 0, byteLength !== null && byteLength !== void 0 ? byteLength : dataView.byteLength);\r\n    };\r\n    // TODO: Refactor to share more logic with base Engine implementation.\r\n    NativeEngine.prototype._setTexture = function (channel, texture, isPartOfTextureArray, depthStencilTexture) {\r\n        if (isPartOfTextureArray === void 0) { isPartOfTextureArray = false; }\r\n        if (depthStencilTexture === void 0) { depthStencilTexture = false; }\r\n        var uniform = this._boundUniforms[channel];\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        // Not ready?\r\n        if (!texture) {\r\n            if (this._boundTexturesCache[channel] != null) {\r\n                this._activeChannel = channel;\r\n                this._native.setTexture(uniform, null);\r\n            }\r\n            return false;\r\n        }\r\n        // Video\r\n        if (texture.video) {\r\n            this._activeChannel = channel;\r\n            texture.update();\r\n        }\r\n        else if (texture.delayLoadState === 4) { // Delay loading\r\n            texture.delayLoad();\r\n            return false;\r\n        }\r\n        var internalTexture;\r\n        if (depthStencilTexture) {\r\n            internalTexture = texture.depthStencilTexture;\r\n        }\r\n        else if (texture.isReady()) {\r\n            internalTexture = texture.getInternalTexture();\r\n        }\r\n        else if (texture.isCube) {\r\n            internalTexture = this.emptyCubeTexture;\r\n        }\r\n        else if (texture.is3D) {\r\n            internalTexture = this.emptyTexture3D;\r\n        }\r\n        else if (texture.is2DArray) {\r\n            internalTexture = this.emptyTexture2DArray;\r\n        }\r\n        else {\r\n            internalTexture = this.emptyTexture;\r\n        }\r\n        this._activeChannel = channel;\r\n        if (!internalTexture ||\r\n            !internalTexture._webGLTexture) {\r\n            return false;\r\n        }\r\n        this._native.setTextureWrapMode(internalTexture._webGLTexture, this._getAddressMode(texture.wrapU), this._getAddressMode(texture.wrapV), this._getAddressMode(texture.wrapR));\r\n        this._updateAnisotropicLevel(texture);\r\n        this._native.setTexture(uniform, internalTexture._webGLTexture);\r\n        return true;\r\n    };\r\n    // TODO: Share more of this logic with the base implementation.\r\n    // TODO: Rename to match naming in base implementation once refactoring allows different parameters.\r\n    NativeEngine.prototype._updateAnisotropicLevel = function (texture) {\r\n        var internalTexture = texture.getInternalTexture();\r\n        var value = texture.anisotropicFilteringLevel;\r\n        if (!internalTexture || !internalTexture._webGLTexture) {\r\n            return;\r\n        }\r\n        if (internalTexture._cachedAnisotropicFilteringLevel !== value) {\r\n            this._native.setTextureAnisotropicLevel(internalTexture._webGLTexture, value);\r\n            internalTexture._cachedAnisotropicFilteringLevel = value;\r\n        }\r\n    };\r\n    // Returns a NativeAddressMode.XXX value.\r\n    NativeEngine.prototype._getAddressMode = function (wrapMode) {\r\n        switch (wrapMode) {\r\n            case 1:\r\n                return this._native.ADDRESS_MODE_WRAP;\r\n            case 0:\r\n                return this._native.ADDRESS_MODE_CLAMP;\r\n            case 2:\r\n                return this._native.ADDRESS_MODE_MIRROR;\r\n            default:\r\n                throw new Error(\"Unexpected wrap mode: \" + wrapMode + \".\");\r\n        }\r\n    };\r\n    /** @hidden */\r\n    NativeEngine.prototype._bindTexture = function (channel, texture) {\r\n        var uniform = this._boundUniforms[channel];\r\n        if (!uniform) {\r\n            return;\r\n        }\r\n        this._native.setTexture(uniform, texture._webGLTexture);\r\n    };\r\n    NativeEngine.prototype._deleteBuffer = function (buffer) {\r\n        if (buffer.nativeIndexBuffer) {\r\n            this._native.deleteIndexBuffer(buffer.nativeIndexBuffer);\r\n            delete buffer.nativeIndexBuffer;\r\n        }\r\n        if (buffer.nativeVertexBuffer) {\r\n            this._native.deleteVertexBuffer(buffer.nativeVertexBuffer);\r\n            delete buffer.nativeVertexBuffer;\r\n        }\r\n    };\r\n    NativeEngine.prototype.releaseEffects = function () {\r\n        // TODO\r\n    };\r\n    /** @hidden */\r\n    NativeEngine.prototype._uploadCompressedDataToTextureDirectly = function (texture, internalFormat, width, height, data, faceIndex, lod) {\r\n        if (faceIndex === void 0) { faceIndex = 0; }\r\n        if (lod === void 0) { lod = 0; }\r\n        throw new Error(\"_uploadCompressedDataToTextureDirectly not implemented.\");\r\n    };\r\n    /** @hidden */\r\n    NativeEngine.prototype._uploadDataToTextureDirectly = function (texture, imageData, faceIndex, lod) {\r\n        if (faceIndex === void 0) { faceIndex = 0; }\r\n        if (lod === void 0) { lod = 0; }\r\n        throw new Error(\"_uploadDataToTextureDirectly not implemented.\");\r\n    };\r\n    /** @hidden */\r\n    NativeEngine.prototype._uploadArrayBufferViewToTexture = function (texture, imageData, faceIndex, lod) {\r\n        if (faceIndex === void 0) { faceIndex = 0; }\r\n        if (lod === void 0) { lod = 0; }\r\n        throw new Error(\"_uploadArrayBufferViewToTexture not implemented.\");\r\n    };\r\n    /** @hidden */\r\n    NativeEngine.prototype._uploadImageToTexture = function (texture, image, faceIndex, lod) {\r\n        if (faceIndex === void 0) { faceIndex = 0; }\r\n        if (lod === void 0) { lod = 0; }\r\n        throw new Error(\"_uploadArrayBufferViewToTexture not implemented.\");\r\n    };\r\n    // JavaScript-to-Native conversion helper functions.\r\n    NativeEngine.prototype._getNativeSamplingMode = function (samplingMode) {\r\n        switch (samplingMode) {\r\n            case 1:\r\n                return this._native.TEXTURE_NEAREST_NEAREST;\r\n            case 2:\r\n                return this._native.TEXTURE_LINEAR_LINEAR;\r\n            case 3:\r\n                return this._native.TEXTURE_LINEAR_LINEAR_MIPLINEAR;\r\n            case 4:\r\n                return this._native.TEXTURE_NEAREST_NEAREST_MIPNEAREST;\r\n            case 5:\r\n                return this._native.TEXTURE_NEAREST_LINEAR_MIPNEAREST;\r\n            case 6:\r\n                return this._native.TEXTURE_NEAREST_LINEAR_MIPLINEAR;\r\n            case 7:\r\n                return this._native.TEXTURE_NEAREST_LINEAR;\r\n            case 8:\r\n                return this._native.TEXTURE_NEAREST_NEAREST_MIPLINEAR;\r\n            case 9:\r\n                return this._native.TEXTURE_LINEAR_NEAREST_MIPNEAREST;\r\n            case 10:\r\n                return this._native.TEXTURE_LINEAR_NEAREST_MIPLINEAR;\r\n            case 11:\r\n                return this._native.TEXTURE_LINEAR_LINEAR_MIPNEAREST;\r\n            case 12:\r\n                return this._native.TEXTURE_LINEAR_NEAREST;\r\n            default:\r\n                throw new Error(\"Unsupported sampling mode: \" + samplingMode + \".\");\r\n        }\r\n    };\r\n    NativeEngine.prototype._getNativeTextureFormat = function (format, type) {\r\n        if (format == 5 && type == 0) {\r\n            return this._native.TEXTURE_FORMAT_RGBA8;\r\n        }\r\n        else if (format == 5 && type == 1) {\r\n            return this._native.TEXTURE_FORMAT_RGBA32F;\r\n        }\r\n        else {\r\n            throw new Error(\"Unsupported texture format or type: format \" + format + \", type \" + type + \".\");\r\n        }\r\n    };\r\n    NativeEngine.prototype._getNativeAlphaMode = function (mode) {\r\n        switch (mode) {\r\n            case 0:\r\n                return this._native.ALPHA_DISABLE;\r\n            case 1:\r\n                return this._native.ALPHA_ADD;\r\n            case 2:\r\n                return this._native.ALPHA_COMBINE;\r\n            case 3:\r\n                return this._native.ALPHA_SUBTRACT;\r\n            case 4:\r\n                return this._native.ALPHA_MULTIPLY;\r\n            case 5:\r\n                return this._native.ALPHA_MAXIMIZED;\r\n            case 6:\r\n                return this._native.ALPHA_ONEONE;\r\n            case 7:\r\n                return this._native.ALPHA_PREMULTIPLIED;\r\n            case 8:\r\n                return this._native.ALPHA_PREMULTIPLIED_PORTERDUFF;\r\n            case 9:\r\n                return this._native.ALPHA_INTERPOLATE;\r\n            case 10:\r\n                return this._native.ALPHA_SCREENMODE;\r\n            default:\r\n                throw new Error(\"Unsupported alpha mode: \" + mode + \".\");\r\n        }\r\n    };\r\n    NativeEngine.prototype._getNativeAttribType = function (type) {\r\n        switch (type) {\r\n            case VertexBuffer.UNSIGNED_BYTE:\r\n                return this._native.ATTRIB_TYPE_UINT8;\r\n            case VertexBuffer.SHORT:\r\n                return this._native.ATTRIB_TYPE_INT16;\r\n            case VertexBuffer.FLOAT:\r\n                return this._native.ATTRIB_TYPE_FLOAT;\r\n            default:\r\n                throw new Error(\"Unsupported attribute type: \" + type + \".\");\r\n        }\r\n    };\r\n    return NativeEngine;\r\n}(Engine));\r\nexport { NativeEngine };\r\n"]},"metadata":{},"sourceType":"module"}