{"ast":null,"code":"import { EngineStore } from './engineStore';\nimport { Effect } from '../Materials/effect';\nimport { _DevTools } from '../Misc/devTools';\nimport { Observable } from '../Misc/observable';\nimport { DepthCullingState } from '../States/depthCullingState';\nimport { StencilState } from '../States/stencilState';\nimport { AlphaState } from '../States/alphaCullingState';\nimport { InternalTexture, InternalTextureSource } from '../Materials/Textures/internalTexture';\nimport { Logger } from '../Misc/logger';\nimport { DomManagement } from '../Misc/domManagement';\nimport { WebGLShaderProcessor } from './WebGL/webGLShaderProcessors';\nimport { WebGL2ShaderProcessor } from './WebGL/webGL2ShaderProcessors';\nimport { WebGLDataBuffer } from '../Meshes/WebGL/webGLDataBuffer';\nimport { WebGLPipelineContext } from './WebGL/webGLPipelineContext';\nimport { CanvasGenerator } from '../Misc/canvasGenerator';\nimport { PerformanceConfigurator } from './performanceConfigurator';\n/**\r\n * Keeps track of all the buffer info used in engine.\r\n */\n\nvar BufferPointer =\n/** @class */\nfunction () {\n  function BufferPointer() {}\n\n  return BufferPointer;\n}();\n/**\r\n * The base engine class (root of all engines)\r\n */\n\n\nvar ThinEngine =\n/** @class */\nfunction () {\n  /**\r\n   * Creates a new engine\r\n   * @param canvasOrContext defines the canvas or WebGL context to use for rendering. If you provide a WebGL context, Babylon.js will not hook events on the canvas (like pointers, keyboards, etc...) so no event observables will be available. This is mostly used when Babylon.js is used as a plugin on a system which alreay used the WebGL context\r\n   * @param antialias defines enable antialiasing (default: false)\r\n   * @param options defines further options to be sent to the getContext() function\r\n   * @param adaptToDeviceRatio defines whether to adapt to the device's viewport characteristics (default: false)\r\n   */\n  function ThinEngine(canvasOrContext, antialias, options, adaptToDeviceRatio) {\n    var _this = this;\n\n    if (adaptToDeviceRatio === void 0) {\n      adaptToDeviceRatio = false;\n    }\n    /**\r\n     * Gets or sets a boolean that indicates if textures must be forced to power of 2 size even if not required\r\n     */\n\n\n    this.forcePOTTextures = false;\n    /**\r\n     * Gets a boolean indicating if the engine is currently rendering in fullscreen mode\r\n     */\n\n    this.isFullscreen = false;\n    /**\r\n     * Gets or sets a boolean indicating if back faces must be culled (true by default)\r\n     */\n\n    this.cullBackFaces = true;\n    /**\r\n     * Gets or sets a boolean indicating if the engine must keep rendering even if the window is not in foregroun\r\n     */\n\n    this.renderEvenInBackground = true;\n    /**\r\n     * Gets or sets a boolean indicating that cache can be kept between frames\r\n     */\n\n    this.preventCacheWipeBetweenFrames = false;\n    /** Gets or sets a boolean indicating if the engine should validate programs after compilation */\n\n    this.validateShaderPrograms = false;\n    /**\r\n     * Gets or sets a boolean indicating if depth buffer should be reverse, going from far to near.\r\n     * This can provide greater z depth for distant objects.\r\n     */\n\n    this.useReverseDepthBuffer = false; // Uniform buffers list\n\n    /**\r\n     * Gets or sets a boolean indicating that uniform buffers must be disabled even if they are supported\r\n     */\n\n    this.disableUniformBuffers = false;\n    /** @hidden */\n\n    this._uniformBuffers = new Array();\n    /** @hidden */\n\n    this._webGLVersion = 1.0;\n    this._windowIsBackground = false;\n    this._highPrecisionShadersAllowed = true;\n    /** @hidden */\n\n    this._badOS = false;\n    /** @hidden */\n\n    this._badDesktopOS = false;\n    this._renderingQueueLaunched = false;\n    this._activeRenderLoops = new Array(); // Lost context\n\n    /**\r\n     * Observable signaled when a context lost event is raised\r\n     */\n\n    this.onContextLostObservable = new Observable();\n    /**\r\n     * Observable signaled when a context restored event is raised\r\n     */\n\n    this.onContextRestoredObservable = new Observable();\n    this._contextWasLost = false;\n    /** @hidden */\n\n    this._doNotHandleContextLost = false;\n    /**\r\n     * Gets or sets a boolean indicating that vertex array object must be disabled even if they are supported\r\n     */\n\n    this.disableVertexArrayObjects = false; // States\n\n    /** @hidden */\n\n    this._colorWrite = true;\n    /** @hidden */\n\n    this._colorWriteChanged = true;\n    /** @hidden */\n\n    this._depthCullingState = new DepthCullingState();\n    /** @hidden */\n\n    this._stencilState = new StencilState();\n    /** @hidden */\n\n    this._alphaState = new AlphaState();\n    /** @hidden */\n\n    this._alphaMode = 1;\n    /** @hidden */\n\n    this._alphaEquation = 0; // Cache\n\n    /** @hidden */\n\n    this._internalTexturesCache = new Array();\n    /** @hidden */\n\n    this._activeChannel = 0;\n    this._currentTextureChannel = -1;\n    /** @hidden */\n\n    this._boundTexturesCache = {};\n    this._compiledEffects = {};\n    this._vertexAttribArraysEnabled = [];\n    this._uintIndicesCurrentlySet = false;\n    this._currentBoundBuffer = new Array();\n    /** @hidden */\n\n    this._currentFramebuffer = null;\n    /** @hidden */\n\n    this._dummyFramebuffer = null;\n    this._currentBufferPointers = new Array();\n    this._currentInstanceLocations = new Array();\n    this._currentInstanceBuffers = new Array();\n    this._vaoRecordInProgress = false;\n    this._mustWipeVertexAttributes = false;\n    this._nextFreeTextureSlots = new Array();\n    this._maxSimultaneousTextures = 0;\n    this._activeRequests = new Array();\n    /** @hidden */\n\n    this._transformTextureUrl = null;\n    /**\r\n     * Gets information about the current host\r\n     */\n\n    this.hostInformation = {\n      isMobile: false\n    };\n    /**\r\n     * Defines whether the engine has been created with the premultipliedAlpha option on or not.\r\n     */\n\n    this.premultipliedAlpha = true;\n    /**\r\n     * Observable event triggered before each texture is initialized\r\n     */\n\n    this.onBeforeTextureInitObservable = new Observable();\n    this._viewportCached = {\n      x: 0,\n      y: 0,\n      z: 0,\n      w: 0\n    };\n    this._unpackFlipYCached = null;\n    /**\r\n     * In case you are sharing the context with other applications, it might\r\n     * be interested to not cache the unpack flip y state to ensure a consistent\r\n     * value would be set.\r\n     */\n\n    this.enableUnpackFlipYCached = true;\n\n    this._getDepthStencilBuffer = function (width, height, samples, internalFormat, msInternalFormat, attachment) {\n      var gl = _this._gl;\n      var depthStencilBuffer = gl.createRenderbuffer();\n      gl.bindRenderbuffer(gl.RENDERBUFFER, depthStencilBuffer);\n\n      if (samples > 1 && gl.renderbufferStorageMultisample) {\n        gl.renderbufferStorageMultisample(gl.RENDERBUFFER, samples, msInternalFormat, width, height);\n      } else {\n        gl.renderbufferStorage(gl.RENDERBUFFER, internalFormat, width, height);\n      }\n\n      gl.framebufferRenderbuffer(gl.FRAMEBUFFER, attachment, gl.RENDERBUFFER, depthStencilBuffer);\n      gl.bindRenderbuffer(gl.RENDERBUFFER, null);\n      return depthStencilBuffer;\n    };\n\n    this._boundUniforms = {};\n    var canvas = null;\n\n    if (!canvasOrContext) {\n      return;\n    }\n\n    options = options || {};\n    PerformanceConfigurator.SetMatrixPrecision(!!options.useHighPrecisionMatrix);\n\n    if (canvasOrContext.getContext) {\n      canvas = canvasOrContext;\n      this._renderingCanvas = canvas;\n\n      if (antialias != null) {\n        options.antialias = antialias;\n      }\n\n      if (options.deterministicLockstep === undefined) {\n        options.deterministicLockstep = false;\n      }\n\n      if (options.lockstepMaxSteps === undefined) {\n        options.lockstepMaxSteps = 4;\n      }\n\n      if (options.timeStep === undefined) {\n        options.timeStep = 1 / 60;\n      }\n\n      if (options.preserveDrawingBuffer === undefined) {\n        options.preserveDrawingBuffer = false;\n      }\n\n      if (options.audioEngine === undefined) {\n        options.audioEngine = true;\n      }\n\n      if (options.stencil === undefined) {\n        options.stencil = true;\n      }\n\n      if (options.premultipliedAlpha === false) {\n        this.premultipliedAlpha = false;\n      }\n\n      if (options.xrCompatible === undefined) {\n        options.xrCompatible = true;\n      }\n\n      this._doNotHandleContextLost = options.doNotHandleContextLost ? true : false; // Exceptions\n\n      if (navigator && navigator.userAgent) {\n        var ua = navigator.userAgent;\n        this.hostInformation.isMobile = ua.indexOf(\"Mobile\") !== -1;\n\n        for (var _i = 0, _a = ThinEngine.ExceptionList; _i < _a.length; _i++) {\n          var exception = _a[_i];\n          var key = exception.key;\n          var targets = exception.targets;\n          var check = new RegExp(key);\n\n          if (check.test(ua)) {\n            if (exception.capture && exception.captureConstraint) {\n              var capture = exception.capture;\n              var constraint = exception.captureConstraint;\n              var regex = new RegExp(capture);\n              var matches = regex.exec(ua);\n\n              if (matches && matches.length > 0) {\n                var capturedValue = parseInt(matches[matches.length - 1]);\n\n                if (capturedValue >= constraint) {\n                  continue;\n                }\n              }\n            }\n\n            for (var _b = 0, targets_1 = targets; _b < targets_1.length; _b++) {\n              var target = targets_1[_b];\n\n              switch (target) {\n                case \"uniformBuffer\":\n                  this.disableUniformBuffers = true;\n                  break;\n\n                case \"vao\":\n                  this.disableVertexArrayObjects = true;\n                  break;\n              }\n            }\n          }\n        }\n      } // Context lost\n\n\n      if (!this._doNotHandleContextLost) {\n        this._onContextLost = function (evt) {\n          evt.preventDefault();\n          _this._contextWasLost = true;\n          Logger.Warn(\"WebGL context lost.\");\n\n          _this.onContextLostObservable.notifyObservers(_this);\n        };\n\n        this._onContextRestored = function () {\n          // Adding a timeout to avoid race condition at browser level\n          setTimeout(function () {\n            // Rebuild gl context\n            _this._initGLContext(); // Rebuild effects\n\n\n            _this._rebuildEffects(); // Rebuild textures\n\n\n            _this._rebuildInternalTextures(); // Rebuild buffers\n\n\n            _this._rebuildBuffers(); // Cache\n\n\n            _this.wipeCaches(true);\n\n            Logger.Warn(\"WebGL context successfully restored.\");\n\n            _this.onContextRestoredObservable.notifyObservers(_this);\n\n            _this._contextWasLost = false;\n          }, 0);\n        };\n\n        canvas.addEventListener(\"webglcontextlost\", this._onContextLost, false);\n        canvas.addEventListener(\"webglcontextrestored\", this._onContextRestored, false);\n        options.powerPreference = \"high-performance\";\n      } // GL\n\n\n      if (!options.disableWebGL2Support) {\n        try {\n          this._gl = canvas.getContext(\"webgl2\", options) || canvas.getContext(\"experimental-webgl2\", options);\n\n          if (this._gl) {\n            this._webGLVersion = 2.0; // Prevent weird browsers to lie (yeah that happens!)\n\n            if (!this._gl.deleteQuery) {\n              this._webGLVersion = 1.0;\n            }\n          }\n        } catch (e) {// Do nothing\n        }\n      }\n\n      if (!this._gl) {\n        if (!canvas) {\n          throw new Error(\"The provided canvas is null or undefined.\");\n        }\n\n        try {\n          this._gl = canvas.getContext(\"webgl\", options) || canvas.getContext(\"experimental-webgl\", options);\n        } catch (e) {\n          throw new Error(\"WebGL not supported\");\n        }\n      }\n\n      if (!this._gl) {\n        throw new Error(\"WebGL not supported\");\n      }\n    } else {\n      this._gl = canvasOrContext;\n      this._renderingCanvas = this._gl.canvas;\n\n      if (this._gl.renderbufferStorageMultisample) {\n        this._webGLVersion = 2.0;\n      }\n\n      var attributes = this._gl.getContextAttributes();\n\n      if (attributes) {\n        options.stencil = attributes.stencil;\n      }\n    } // Ensures a consistent color space unpacking of textures cross browser.\n\n\n    this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL, this._gl.NONE);\n\n    if (options.useHighPrecisionFloats !== undefined) {\n      this._highPrecisionShadersAllowed = options.useHighPrecisionFloats;\n    } // Viewport\n\n\n    var devicePixelRatio = DomManagement.IsWindowObjectExist() ? window.devicePixelRatio || 1.0 : 1.0;\n    var limitDeviceRatio = options.limitDeviceRatio || devicePixelRatio;\n    this._hardwareScalingLevel = adaptToDeviceRatio ? 1.0 / Math.min(limitDeviceRatio, devicePixelRatio) : 1.0;\n    this.resize();\n    this._isStencilEnable = options.stencil ? true : false;\n\n    this._initGLContext(); // Prepare buffer pointers\n\n\n    for (var i = 0; i < this._caps.maxVertexAttribs; i++) {\n      this._currentBufferPointers[i] = new BufferPointer();\n    } // Shader processor\n\n\n    if (this.webGLVersion > 1) {\n      this._shaderProcessor = new WebGL2ShaderProcessor();\n    } else {\n      this._shaderProcessor = new WebGLShaderProcessor();\n    } // Detect if we are running on a faulty buggy OS.\n\n\n    this._badOS = /iPad/i.test(navigator.userAgent) || /iPhone/i.test(navigator.userAgent); // Starting with iOS 14, we can trust the browser\n    // let matches = navigator.userAgent.match(/Version\\/(\\d+)/);\n    // if (matches && matches.length === 2) {\n    //     if (parseInt(matches[1]) >= 14) {\n    //         this._badOS = false;\n    //     }\n    // }\n    // Detect if we are running on a faulty buggy desktop OS.\n\n    this._badDesktopOS = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);\n    this._creationOptions = options;\n    console.log(\"Babylon.js v\" + ThinEngine.Version + \" - \" + this.description);\n  }\n\n  Object.defineProperty(ThinEngine, \"NpmPackage\", {\n    /**\r\n     * Returns the current npm package of the sdk\r\n     */\n    // Not mixed with Version for tooling purpose.\n    get: function () {\n      return \"babylonjs@4.2.0\";\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine, \"Version\", {\n    /**\r\n     * Returns the current version of the framework\r\n     */\n    get: function () {\n      return \"4.2.0\";\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"description\", {\n    /**\r\n     * Returns a string describing the current engine\r\n     */\n    get: function () {\n      var description = \"WebGL\" + this.webGLVersion;\n\n      if (this._caps.parallelShaderCompile) {\n        description += \" - Parallel shader compilation\";\n      }\n\n      return description;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine, \"ShadersRepository\", {\n    /**\r\n     * Gets or sets the relative url used to load shaders if using the engine in non-minified mode\r\n     */\n    get: function () {\n      return Effect.ShadersRepository;\n    },\n    set: function (value) {\n      Effect.ShadersRepository = value;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"supportsUniformBuffers\", {\n    /**\r\n     * Gets a boolean indicating that the engine supports uniform buffers\r\n     * @see https://doc.babylonjs.com/features/webgl2#uniform-buffer-objets\r\n     */\n    get: function () {\n      return this.webGLVersion > 1 && !this.disableUniformBuffers;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"_shouldUseHighPrecisionShader\", {\n    /** @hidden */\n    get: function () {\n      return !!(this._caps.highPrecisionShaderSupported && this._highPrecisionShadersAllowed);\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"needPOTTextures\", {\n    /**\r\n     * Gets a boolean indicating that only power of 2 textures are supported\r\n     * Please note that you can still use non power of 2 textures but in this case the engine will forcefully convert them\r\n     */\n    get: function () {\n      return this._webGLVersion < 2 || this.forcePOTTextures;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"doNotHandleContextLost\", {\n    /**\r\n     * Gets or sets a boolean indicating if resources should be retained to be able to handle context lost events\r\n     * @see https://doc.babylonjs.com/how_to/optimizing_your_scene#handling-webgl-context-lost\r\n     */\n    get: function () {\n      return this._doNotHandleContextLost;\n    },\n    set: function (value) {\n      this._doNotHandleContextLost = value;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"_supportsHardwareTextureRescaling\", {\n    get: function () {\n      return false;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"framebufferDimensionsObject\", {\n    /**\r\n     * sets the object from which width and height will be taken from when getting render width and height\r\n     * Will fallback to the gl object\r\n     * @param dimensions the framebuffer width and height that will be used.\r\n     */\n    set: function (dimensions) {\n      this._framebufferDimensionsObject = dimensions;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"currentViewport\", {\n    /**\r\n     * Gets the current viewport\r\n     */\n    get: function () {\n      return this._cachedViewport;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"emptyTexture\", {\n    /**\r\n     * Gets the default empty texture\r\n     */\n    get: function () {\n      if (!this._emptyTexture) {\n        this._emptyTexture = this.createRawTexture(new Uint8Array(4), 1, 1, 5, false, false, 1);\n      }\n\n      return this._emptyTexture;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"emptyTexture3D\", {\n    /**\r\n     * Gets the default empty 3D texture\r\n     */\n    get: function () {\n      if (!this._emptyTexture3D) {\n        this._emptyTexture3D = this.createRawTexture3D(new Uint8Array(4), 1, 1, 1, 5, false, false, 1);\n      }\n\n      return this._emptyTexture3D;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"emptyTexture2DArray\", {\n    /**\r\n     * Gets the default empty 2D array texture\r\n     */\n    get: function () {\n      if (!this._emptyTexture2DArray) {\n        this._emptyTexture2DArray = this.createRawTexture2DArray(new Uint8Array(4), 1, 1, 1, 5, false, false, 1);\n      }\n\n      return this._emptyTexture2DArray;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"emptyCubeTexture\", {\n    /**\r\n     * Gets the default empty cube texture\r\n     */\n    get: function () {\n      if (!this._emptyCubeTexture) {\n        var faceData = new Uint8Array(4);\n        var cubeData = [faceData, faceData, faceData, faceData, faceData, faceData];\n        this._emptyCubeTexture = this.createRawCubeTexture(cubeData, 1, 5, 0, false, false, 1);\n      }\n\n      return this._emptyCubeTexture;\n    },\n    enumerable: false,\n    configurable: true\n  });\n\n  ThinEngine.prototype._rebuildInternalTextures = function () {\n    var currentState = this._internalTexturesCache.slice(); // Do a copy because the rebuild will add proxies\n\n\n    for (var _i = 0, currentState_1 = currentState; _i < currentState_1.length; _i++) {\n      var internalTexture = currentState_1[_i];\n\n      internalTexture._rebuild();\n    }\n  };\n\n  ThinEngine.prototype._rebuildEffects = function () {\n    for (var key in this._compiledEffects) {\n      var effect = this._compiledEffects[key];\n\n      effect._prepareEffect();\n    }\n\n    Effect.ResetCache();\n  };\n  /**\r\n   * Gets a boolean indicating if all created effects are ready\r\n   * @returns true if all effects are ready\r\n   */\n\n\n  ThinEngine.prototype.areAllEffectsReady = function () {\n    for (var key in this._compiledEffects) {\n      var effect = this._compiledEffects[key];\n\n      if (!effect.isReady()) {\n        return false;\n      }\n    }\n\n    return true;\n  };\n\n  ThinEngine.prototype._rebuildBuffers = function () {\n    // Uniforms\n    for (var _i = 0, _a = this._uniformBuffers; _i < _a.length; _i++) {\n      var uniformBuffer = _a[_i];\n\n      uniformBuffer._rebuild();\n    }\n  };\n\n  ThinEngine.prototype._initGLContext = function () {\n    // Caps\n    this._caps = {\n      maxTexturesImageUnits: this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),\n      maxCombinedTexturesImageUnits: this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),\n      maxVertexTextureImageUnits: this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),\n      maxTextureSize: this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),\n      maxSamples: this._webGLVersion > 1 ? this._gl.getParameter(this._gl.MAX_SAMPLES) : 1,\n      maxCubemapTextureSize: this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),\n      maxRenderTextureSize: this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),\n      maxVertexAttribs: this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),\n      maxVaryingVectors: this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),\n      maxFragmentUniformVectors: this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),\n      maxVertexUniformVectors: this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),\n      parallelShaderCompile: this._gl.getExtension('KHR_parallel_shader_compile'),\n      standardDerivatives: this._webGLVersion > 1 || this._gl.getExtension('OES_standard_derivatives') !== null,\n      maxAnisotropy: 1,\n      astc: this._gl.getExtension('WEBGL_compressed_texture_astc') || this._gl.getExtension('WEBKIT_WEBGL_compressed_texture_astc'),\n      bptc: this._gl.getExtension('EXT_texture_compression_bptc') || this._gl.getExtension('WEBKIT_EXT_texture_compression_bptc'),\n      s3tc: this._gl.getExtension('WEBGL_compressed_texture_s3tc') || this._gl.getExtension('WEBKIT_WEBGL_compressed_texture_s3tc'),\n      pvrtc: this._gl.getExtension('WEBGL_compressed_texture_pvrtc') || this._gl.getExtension('WEBKIT_WEBGL_compressed_texture_pvrtc'),\n      etc1: this._gl.getExtension('WEBGL_compressed_texture_etc1') || this._gl.getExtension('WEBKIT_WEBGL_compressed_texture_etc1'),\n      etc2: this._gl.getExtension('WEBGL_compressed_texture_etc') || this._gl.getExtension('WEBKIT_WEBGL_compressed_texture_etc') || this._gl.getExtension('WEBGL_compressed_texture_es3_0'),\n      textureAnisotropicFilterExtension: this._gl.getExtension('EXT_texture_filter_anisotropic') || this._gl.getExtension('WEBKIT_EXT_texture_filter_anisotropic') || this._gl.getExtension('MOZ_EXT_texture_filter_anisotropic'),\n      uintIndices: this._webGLVersion > 1 || this._gl.getExtension('OES_element_index_uint') !== null,\n      fragmentDepthSupported: this._webGLVersion > 1 || this._gl.getExtension('EXT_frag_depth') !== null,\n      highPrecisionShaderSupported: false,\n      timerQuery: this._gl.getExtension('EXT_disjoint_timer_query_webgl2') || this._gl.getExtension(\"EXT_disjoint_timer_query\"),\n      canUseTimestampForTimerQuery: false,\n      drawBuffersExtension: false,\n      maxMSAASamples: 1,\n      colorBufferFloat: this._webGLVersion > 1 && this._gl.getExtension('EXT_color_buffer_float'),\n      textureFloat: this._webGLVersion > 1 || this._gl.getExtension('OES_texture_float') ? true : false,\n      textureHalfFloat: this._webGLVersion > 1 || this._gl.getExtension('OES_texture_half_float') ? true : false,\n      textureHalfFloatRender: false,\n      textureFloatLinearFiltering: false,\n      textureFloatRender: false,\n      textureHalfFloatLinearFiltering: false,\n      vertexArrayObject: false,\n      instancedArrays: false,\n      textureLOD: this._webGLVersion > 1 || this._gl.getExtension('EXT_shader_texture_lod') ? true : false,\n      blendMinMax: false,\n      multiview: this._gl.getExtension('OVR_multiview2'),\n      oculusMultiview: this._gl.getExtension('OCULUS_multiview'),\n      depthTextureExtension: false\n    }; // Infos\n\n    this._glVersion = this._gl.getParameter(this._gl.VERSION);\n\n    var rendererInfo = this._gl.getExtension(\"WEBGL_debug_renderer_info\");\n\n    if (rendererInfo != null) {\n      this._glRenderer = this._gl.getParameter(rendererInfo.UNMASKED_RENDERER_WEBGL);\n      this._glVendor = this._gl.getParameter(rendererInfo.UNMASKED_VENDOR_WEBGL);\n    }\n\n    if (!this._glVendor) {\n      this._glVendor = \"Unknown vendor\";\n    }\n\n    if (!this._glRenderer) {\n      this._glRenderer = \"Unknown renderer\";\n    } // Constants\n\n\n    if (this._gl.HALF_FLOAT_OES !== 0x8D61) {\n      this._gl.HALF_FLOAT_OES = 0x8D61; // Half floating-point type (16-bit).\n    }\n\n    if (this._gl.RGBA16F !== 0x881A) {\n      this._gl.RGBA16F = 0x881A; // RGBA 16-bit floating-point color-renderable internal sized format.\n    }\n\n    if (this._gl.RGBA32F !== 0x8814) {\n      this._gl.RGBA32F = 0x8814; // RGBA 32-bit floating-point color-renderable internal sized format.\n    }\n\n    if (this._gl.DEPTH24_STENCIL8 !== 35056) {\n      this._gl.DEPTH24_STENCIL8 = 35056;\n    } // Extensions\n\n\n    if (this._caps.timerQuery) {\n      if (this._webGLVersion === 1) {\n        this._gl.getQuery = this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery);\n      }\n\n      this._caps.canUseTimestampForTimerQuery = this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT, this._caps.timerQuery.QUERY_COUNTER_BITS_EXT) > 0;\n    }\n\n    this._caps.maxAnisotropy = this._caps.textureAnisotropicFilterExtension ? this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT) : 0;\n    this._caps.textureFloatLinearFiltering = this._caps.textureFloat && this._gl.getExtension('OES_texture_float_linear') ? true : false;\n    this._caps.textureFloatRender = this._caps.textureFloat && this._canRenderToFloatFramebuffer() ? true : false;\n    this._caps.textureHalfFloatLinearFiltering = this._webGLVersion > 1 || this._caps.textureHalfFloat && this._gl.getExtension('OES_texture_half_float_linear') ? true : false; // Checks if some of the format renders first to allow the use of webgl inspector.\n\n    if (this._webGLVersion > 1) {\n      if (this._gl.HALF_FLOAT_OES !== 0x140B) {\n        this._gl.HALF_FLOAT_OES = 0x140B;\n      }\n    }\n\n    this._caps.textureHalfFloatRender = this._caps.textureHalfFloat && this._canRenderToHalfFloatFramebuffer(); // Draw buffers\n\n    if (this._webGLVersion > 1) {\n      this._caps.drawBuffersExtension = true;\n      this._caps.maxMSAASamples = this._gl.getParameter(this._gl.MAX_SAMPLES);\n    } else {\n      var drawBuffersExtension = this._gl.getExtension('WEBGL_draw_buffers');\n\n      if (drawBuffersExtension !== null) {\n        this._caps.drawBuffersExtension = true;\n        this._gl.drawBuffers = drawBuffersExtension.drawBuffersWEBGL.bind(drawBuffersExtension);\n        this._gl.DRAW_FRAMEBUFFER = this._gl.FRAMEBUFFER;\n\n        for (var i = 0; i < 16; i++) {\n          this._gl[\"COLOR_ATTACHMENT\" + i + \"_WEBGL\"] = drawBuffersExtension[\"COLOR_ATTACHMENT\" + i + \"_WEBGL\"];\n        }\n      }\n    } // Depth Texture\n\n\n    if (this._webGLVersion > 1) {\n      this._caps.depthTextureExtension = true;\n    } else {\n      var depthTextureExtension = this._gl.getExtension('WEBGL_depth_texture');\n\n      if (depthTextureExtension != null) {\n        this._caps.depthTextureExtension = true;\n        this._gl.UNSIGNED_INT_24_8 = depthTextureExtension.UNSIGNED_INT_24_8_WEBGL;\n      }\n    } // Vertex array object\n\n\n    if (this.disableVertexArrayObjects) {\n      this._caps.vertexArrayObject = false;\n    } else if (this._webGLVersion > 1) {\n      this._caps.vertexArrayObject = true;\n    } else {\n      var vertexArrayObjectExtension = this._gl.getExtension('OES_vertex_array_object');\n\n      if (vertexArrayObjectExtension != null) {\n        this._caps.vertexArrayObject = true;\n        this._gl.createVertexArray = vertexArrayObjectExtension.createVertexArrayOES.bind(vertexArrayObjectExtension);\n        this._gl.bindVertexArray = vertexArrayObjectExtension.bindVertexArrayOES.bind(vertexArrayObjectExtension);\n        this._gl.deleteVertexArray = vertexArrayObjectExtension.deleteVertexArrayOES.bind(vertexArrayObjectExtension);\n      }\n    } // Instances count\n\n\n    if (this._webGLVersion > 1) {\n      this._caps.instancedArrays = true;\n    } else {\n      var instanceExtension = this._gl.getExtension('ANGLE_instanced_arrays');\n\n      if (instanceExtension != null) {\n        this._caps.instancedArrays = true;\n        this._gl.drawArraysInstanced = instanceExtension.drawArraysInstancedANGLE.bind(instanceExtension);\n        this._gl.drawElementsInstanced = instanceExtension.drawElementsInstancedANGLE.bind(instanceExtension);\n        this._gl.vertexAttribDivisor = instanceExtension.vertexAttribDivisorANGLE.bind(instanceExtension);\n      } else {\n        this._caps.instancedArrays = false;\n      }\n    }\n\n    if (this._gl.getShaderPrecisionFormat) {\n      var vertex_highp = this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER, this._gl.HIGH_FLOAT);\n\n      var fragment_highp = this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER, this._gl.HIGH_FLOAT);\n\n      if (vertex_highp && fragment_highp) {\n        this._caps.highPrecisionShaderSupported = vertex_highp.precision !== 0 && fragment_highp.precision !== 0;\n      }\n    }\n\n    if (this._webGLVersion > 1) {\n      this._caps.blendMinMax = true;\n    } else {\n      var blendMinMaxExtension = this._gl.getExtension('EXT_blend_minmax');\n\n      if (blendMinMaxExtension != null) {\n        this._caps.blendMinMax = true;\n        this._gl.MAX = blendMinMaxExtension.MAX_EXT;\n        this._gl.MIN = blendMinMaxExtension.MIN_EXT;\n      }\n    } // Depth buffer\n\n\n    this._depthCullingState.depthTest = true;\n    this._depthCullingState.depthFunc = this._gl.LEQUAL;\n    this._depthCullingState.depthMask = true; // Texture maps\n\n    this._maxSimultaneousTextures = this._caps.maxCombinedTexturesImageUnits;\n\n    for (var slot = 0; slot < this._maxSimultaneousTextures; slot++) {\n      this._nextFreeTextureSlots.push(slot);\n    }\n  };\n\n  Object.defineProperty(ThinEngine.prototype, \"webGLVersion\", {\n    /**\r\n     * Gets version of the current webGL context\r\n     */\n    get: function () {\n      return this._webGLVersion;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  /**\r\n   * Gets a string identifying the name of the class\r\n   * @returns \"Engine\" string\r\n   */\n\n  ThinEngine.prototype.getClassName = function () {\n    return \"ThinEngine\";\n  };\n\n  Object.defineProperty(ThinEngine.prototype, \"isStencilEnable\", {\n    /**\r\n     * Returns true if the stencil buffer has been enabled through the creation option of the context.\r\n     */\n    get: function () {\n      return this._isStencilEnable;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  /** @hidden */\n\n  ThinEngine.prototype._prepareWorkingCanvas = function () {\n    if (this._workingCanvas) {\n      return;\n    }\n\n    this._workingCanvas = CanvasGenerator.CreateCanvas(1, 1);\n\n    var context = this._workingCanvas.getContext(\"2d\");\n\n    if (context) {\n      this._workingContext = context;\n    }\n  };\n  /**\r\n   * Reset the texture cache to empty state\r\n   */\n\n\n  ThinEngine.prototype.resetTextureCache = function () {\n    for (var key in this._boundTexturesCache) {\n      if (!this._boundTexturesCache.hasOwnProperty(key)) {\n        continue;\n      }\n\n      this._boundTexturesCache[key] = null;\n    }\n\n    this._currentTextureChannel = -1;\n  };\n  /**\r\n   * Gets an object containing information about the current webGL context\r\n   * @returns an object containing the vender, the renderer and the version of the current webGL context\r\n   */\n\n\n  ThinEngine.prototype.getGlInfo = function () {\n    return {\n      vendor: this._glVendor,\n      renderer: this._glRenderer,\n      version: this._glVersion\n    };\n  };\n  /**\r\n   * Defines the hardware scaling level.\r\n   * By default the hardware scaling level is computed from the window device ratio.\r\n   * if level = 1 then the engine will render at the exact resolution of the canvas. If level = 0.5 then the engine will render at twice the size of the canvas.\r\n   * @param level defines the level to use\r\n   */\n\n\n  ThinEngine.prototype.setHardwareScalingLevel = function (level) {\n    this._hardwareScalingLevel = level;\n    this.resize();\n  };\n  /**\r\n   * Gets the current hardware scaling level.\r\n   * By default the hardware scaling level is computed from the window device ratio.\r\n   * if level = 1 then the engine will render at the exact resolution of the canvas. If level = 0.5 then the engine will render at twice the size of the canvas.\r\n   * @returns a number indicating the current hardware scaling level\r\n   */\n\n\n  ThinEngine.prototype.getHardwareScalingLevel = function () {\n    return this._hardwareScalingLevel;\n  };\n  /**\r\n   * Gets the list of loaded textures\r\n   * @returns an array containing all loaded textures\r\n   */\n\n\n  ThinEngine.prototype.getLoadedTexturesCache = function () {\n    return this._internalTexturesCache;\n  };\n  /**\r\n   * Gets the object containing all engine capabilities\r\n   * @returns the EngineCapabilities object\r\n   */\n\n\n  ThinEngine.prototype.getCaps = function () {\n    return this._caps;\n  };\n  /**\r\n   * stop executing a render loop function and remove it from the execution array\r\n   * @param renderFunction defines the function to be removed. If not provided all functions will be removed.\r\n   */\n\n\n  ThinEngine.prototype.stopRenderLoop = function (renderFunction) {\n    if (!renderFunction) {\n      this._activeRenderLoops = [];\n      return;\n    }\n\n    var index = this._activeRenderLoops.indexOf(renderFunction);\n\n    if (index >= 0) {\n      this._activeRenderLoops.splice(index, 1);\n    }\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._renderLoop = function () {\n    if (!this._contextWasLost) {\n      var shouldRender = true;\n\n      if (!this.renderEvenInBackground && this._windowIsBackground) {\n        shouldRender = false;\n      }\n\n      if (shouldRender) {\n        // Start new frame\n        this.beginFrame();\n\n        for (var index = 0; index < this._activeRenderLoops.length; index++) {\n          var renderFunction = this._activeRenderLoops[index];\n          renderFunction();\n        } // Present\n\n\n        this.endFrame();\n      }\n    }\n\n    if (this._activeRenderLoops.length > 0) {\n      this._frameHandler = this._queueNewFrame(this._boundRenderFunction, this.getHostWindow());\n    } else {\n      this._renderingQueueLaunched = false;\n    }\n  };\n  /**\r\n   * Gets the HTML canvas attached with the current webGL context\r\n   * @returns a HTML canvas\r\n   */\n\n\n  ThinEngine.prototype.getRenderingCanvas = function () {\n    return this._renderingCanvas;\n  };\n  /**\r\n   * Gets host window\r\n   * @returns the host window object\r\n   */\n\n\n  ThinEngine.prototype.getHostWindow = function () {\n    if (!DomManagement.IsWindowObjectExist()) {\n      return null;\n    }\n\n    if (this._renderingCanvas && this._renderingCanvas.ownerDocument && this._renderingCanvas.ownerDocument.defaultView) {\n      return this._renderingCanvas.ownerDocument.defaultView;\n    }\n\n    return window;\n  };\n  /**\r\n   * Gets the current render width\r\n   * @param useScreen defines if screen size must be used (or the current render target if any)\r\n   * @returns a number defining the current render width\r\n   */\n\n\n  ThinEngine.prototype.getRenderWidth = function (useScreen) {\n    if (useScreen === void 0) {\n      useScreen = false;\n    }\n\n    if (!useScreen && this._currentRenderTarget) {\n      return this._currentRenderTarget.width;\n    }\n\n    return this._framebufferDimensionsObject ? this._framebufferDimensionsObject.framebufferWidth : this._gl.drawingBufferWidth;\n  };\n  /**\r\n   * Gets the current render height\r\n   * @param useScreen defines if screen size must be used (or the current render target if any)\r\n   * @returns a number defining the current render height\r\n   */\n\n\n  ThinEngine.prototype.getRenderHeight = function (useScreen) {\n    if (useScreen === void 0) {\n      useScreen = false;\n    }\n\n    if (!useScreen && this._currentRenderTarget) {\n      return this._currentRenderTarget.height;\n    }\n\n    return this._framebufferDimensionsObject ? this._framebufferDimensionsObject.framebufferHeight : this._gl.drawingBufferHeight;\n  };\n  /**\r\n   * Can be used to override the current requestAnimationFrame requester.\r\n   * @hidden\r\n   */\n\n\n  ThinEngine.prototype._queueNewFrame = function (bindedRenderFunction, requester) {\n    return ThinEngine.QueueNewFrame(bindedRenderFunction, requester);\n  };\n  /**\r\n   * Register and execute a render loop. The engine can have more than one render function\r\n   * @param renderFunction defines the function to continuously execute\r\n   */\n\n\n  ThinEngine.prototype.runRenderLoop = function (renderFunction) {\n    if (this._activeRenderLoops.indexOf(renderFunction) !== -1) {\n      return;\n    }\n\n    this._activeRenderLoops.push(renderFunction);\n\n    if (!this._renderingQueueLaunched) {\n      this._renderingQueueLaunched = true;\n      this._boundRenderFunction = this._renderLoop.bind(this);\n      this._frameHandler = this._queueNewFrame(this._boundRenderFunction, this.getHostWindow());\n    }\n  };\n  /**\r\n   * Clear the current render buffer or the current render target (if any is set up)\r\n   * @param color defines the color to use\r\n   * @param backBuffer defines if the back buffer must be cleared\r\n   * @param depth defines if the depth buffer must be cleared\r\n   * @param stencil defines if the stencil buffer must be cleared\r\n   */\n\n\n  ThinEngine.prototype.clear = function (color, backBuffer, depth, stencil) {\n    if (stencil === void 0) {\n      stencil = false;\n    }\n\n    this.applyStates();\n    var mode = 0;\n\n    if (backBuffer && color) {\n      this._gl.clearColor(color.r, color.g, color.b, color.a !== undefined ? color.a : 1.0);\n\n      mode |= this._gl.COLOR_BUFFER_BIT;\n    }\n\n    if (depth) {\n      if (this.useReverseDepthBuffer) {\n        this._depthCullingState.depthFunc = this._gl.GREATER;\n\n        this._gl.clearDepth(0.0);\n      } else {\n        this._gl.clearDepth(1.0);\n      }\n\n      mode |= this._gl.DEPTH_BUFFER_BIT;\n    }\n\n    if (stencil) {\n      this._gl.clearStencil(0);\n\n      mode |= this._gl.STENCIL_BUFFER_BIT;\n    }\n\n    this._gl.clear(mode);\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._viewport = function (x, y, width, height) {\n    if (x !== this._viewportCached.x || y !== this._viewportCached.y || width !== this._viewportCached.z || height !== this._viewportCached.w) {\n      this._viewportCached.x = x;\n      this._viewportCached.y = y;\n      this._viewportCached.z = width;\n      this._viewportCached.w = height;\n\n      this._gl.viewport(x, y, width, height);\n    }\n  };\n  /**\r\n   * Set the WebGL's viewport\r\n   * @param viewport defines the viewport element to be used\r\n   * @param requiredWidth defines the width required for rendering. If not provided the rendering canvas' width is used\r\n   * @param requiredHeight defines the height required for rendering. If not provided the rendering canvas' height is used\r\n   */\n\n\n  ThinEngine.prototype.setViewport = function (viewport, requiredWidth, requiredHeight) {\n    var width = requiredWidth || this.getRenderWidth();\n    var height = requiredHeight || this.getRenderHeight();\n    var x = viewport.x || 0;\n    var y = viewport.y || 0;\n    this._cachedViewport = viewport;\n\n    this._viewport(x * width, y * height, width * viewport.width, height * viewport.height);\n  };\n  /**\r\n   * Begin a new frame\r\n   */\n\n\n  ThinEngine.prototype.beginFrame = function () {};\n  /**\r\n   * Enf the current frame\r\n   */\n\n\n  ThinEngine.prototype.endFrame = function () {\n    // Force a flush in case we are using a bad OS.\n    if (this._badOS) {\n      this.flushFramebuffer();\n    }\n  };\n  /**\r\n   * Resize the view according to the canvas' size\r\n   */\n\n\n  ThinEngine.prototype.resize = function () {\n    var width;\n    var height;\n\n    if (DomManagement.IsWindowObjectExist()) {\n      width = this._renderingCanvas ? this._renderingCanvas.clientWidth || this._renderingCanvas.width : window.innerWidth;\n      height = this._renderingCanvas ? this._renderingCanvas.clientHeight || this._renderingCanvas.height : window.innerHeight;\n    } else {\n      width = this._renderingCanvas ? this._renderingCanvas.width : 100;\n      height = this._renderingCanvas ? this._renderingCanvas.height : 100;\n    }\n\n    this.setSize(width / this._hardwareScalingLevel, height / this._hardwareScalingLevel);\n  };\n  /**\r\n   * Force a specific size of the canvas\r\n   * @param width defines the new canvas' width\r\n   * @param height defines the new canvas' height\r\n   * @returns true if the size was changed\r\n   */\n\n\n  ThinEngine.prototype.setSize = function (width, height) {\n    if (!this._renderingCanvas) {\n      return false;\n    }\n\n    width = width | 0;\n    height = height | 0;\n\n    if (this._renderingCanvas.width === width && this._renderingCanvas.height === height) {\n      return false;\n    }\n\n    this._renderingCanvas.width = width;\n    this._renderingCanvas.height = height;\n    return true;\n  };\n  /**\r\n   * Binds the frame buffer to the specified texture.\r\n   * @param texture The texture to render to or null for the default canvas\r\n   * @param faceIndex The face of the texture to render to in case of cube texture\r\n   * @param requiredWidth The width of the target to render to\r\n   * @param requiredHeight The height of the target to render to\r\n   * @param forceFullscreenViewport Forces the viewport to be the entire texture/screen if true\r\n   * @param lodLevel defines the lod level to bind to the frame buffer\r\n   * @param layer defines the 2d array index to bind to frame buffer to\r\n   */\n\n\n  ThinEngine.prototype.bindFramebuffer = function (texture, faceIndex, requiredWidth, requiredHeight, forceFullscreenViewport, lodLevel, layer) {\n    if (faceIndex === void 0) {\n      faceIndex = 0;\n    }\n\n    if (lodLevel === void 0) {\n      lodLevel = 0;\n    }\n\n    if (layer === void 0) {\n      layer = 0;\n    }\n\n    if (this._currentRenderTarget) {\n      this.unBindFramebuffer(this._currentRenderTarget);\n    }\n\n    this._currentRenderTarget = texture;\n\n    this._bindUnboundFramebuffer(texture._MSAAFramebuffer ? texture._MSAAFramebuffer : texture._framebuffer);\n\n    var gl = this._gl;\n\n    if (texture.is2DArray) {\n      gl.framebufferTextureLayer(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, texture._webGLTexture, lodLevel, layer);\n    } else if (texture.isCube) {\n      gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex, texture._webGLTexture, lodLevel);\n    }\n\n    var depthStencilTexture = texture._depthStencilTexture;\n\n    if (depthStencilTexture) {\n      var attachment = depthStencilTexture._generateStencilBuffer ? gl.DEPTH_STENCIL_ATTACHMENT : gl.DEPTH_ATTACHMENT;\n\n      if (texture.is2DArray) {\n        gl.framebufferTextureLayer(gl.FRAMEBUFFER, attachment, depthStencilTexture._webGLTexture, lodLevel, layer);\n      } else if (texture.isCube) {\n        gl.framebufferTexture2D(gl.FRAMEBUFFER, attachment, gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex, depthStencilTexture._webGLTexture, lodLevel);\n      } else {\n        gl.framebufferTexture2D(gl.FRAMEBUFFER, attachment, gl.TEXTURE_2D, depthStencilTexture._webGLTexture, lodLevel);\n      }\n    }\n\n    if (this._cachedViewport && !forceFullscreenViewport) {\n      this.setViewport(this._cachedViewport, requiredWidth, requiredHeight);\n    } else {\n      if (!requiredWidth) {\n        requiredWidth = texture.width;\n\n        if (lodLevel) {\n          requiredWidth = requiredWidth / Math.pow(2, lodLevel);\n        }\n      }\n\n      if (!requiredHeight) {\n        requiredHeight = texture.height;\n\n        if (lodLevel) {\n          requiredHeight = requiredHeight / Math.pow(2, lodLevel);\n        }\n      }\n\n      this._viewport(0, 0, requiredWidth, requiredHeight);\n    }\n\n    this.wipeCaches();\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._bindUnboundFramebuffer = function (framebuffer) {\n    if (this._currentFramebuffer !== framebuffer) {\n      this._gl.bindFramebuffer(this._gl.FRAMEBUFFER, framebuffer);\n\n      this._currentFramebuffer = framebuffer;\n    }\n  };\n  /**\r\n   * Unbind the current render target texture from the webGL context\r\n   * @param texture defines the render target texture to unbind\r\n   * @param disableGenerateMipMaps defines a boolean indicating that mipmaps must not be generated\r\n   * @param onBeforeUnbind defines a function which will be called before the effective unbind\r\n   */\n\n\n  ThinEngine.prototype.unBindFramebuffer = function (texture, disableGenerateMipMaps, onBeforeUnbind) {\n    if (disableGenerateMipMaps === void 0) {\n      disableGenerateMipMaps = false;\n    }\n\n    this._currentRenderTarget = null; // If MSAA, we need to bitblt back to main texture\n\n    var gl = this._gl;\n\n    if (texture._MSAAFramebuffer) {\n      if (texture._textureArray) {\n        // This texture is part of a MRT texture, we need to treat all attachments\n        this.unBindMultiColorAttachmentFramebuffer(texture._textureArray, disableGenerateMipMaps, onBeforeUnbind);\n        return;\n      }\n\n      gl.bindFramebuffer(gl.READ_FRAMEBUFFER, texture._MSAAFramebuffer);\n      gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER, texture._framebuffer);\n      gl.blitFramebuffer(0, 0, texture.width, texture.height, 0, 0, texture.width, texture.height, gl.COLOR_BUFFER_BIT, gl.NEAREST);\n    }\n\n    if (texture.generateMipMaps && !disableGenerateMipMaps && !texture.isCube) {\n      this._bindTextureDirectly(gl.TEXTURE_2D, texture, true);\n\n      gl.generateMipmap(gl.TEXTURE_2D);\n\n      this._bindTextureDirectly(gl.TEXTURE_2D, null);\n    }\n\n    if (onBeforeUnbind) {\n      if (texture._MSAAFramebuffer) {\n        // Bind the correct framebuffer\n        this._bindUnboundFramebuffer(texture._framebuffer);\n      }\n\n      onBeforeUnbind();\n    }\n\n    this._bindUnboundFramebuffer(null);\n  };\n  /**\r\n   * Force a webGL flush (ie. a flush of all waiting webGL commands)\r\n   */\n\n\n  ThinEngine.prototype.flushFramebuffer = function () {\n    this._gl.flush();\n  };\n  /**\r\n   * Unbind the current render target and bind the default framebuffer\r\n   */\n\n\n  ThinEngine.prototype.restoreDefaultFramebuffer = function () {\n    if (this._currentRenderTarget) {\n      this.unBindFramebuffer(this._currentRenderTarget);\n    } else {\n      this._bindUnboundFramebuffer(null);\n    }\n\n    if (this._cachedViewport) {\n      this.setViewport(this._cachedViewport);\n    }\n\n    this.wipeCaches();\n  }; // VBOs\n\n  /** @hidden */\n\n\n  ThinEngine.prototype._resetVertexBufferBinding = function () {\n    this.bindArrayBuffer(null);\n    this._cachedVertexBuffers = null;\n  };\n  /**\r\n   * Creates a vertex buffer\r\n   * @param data the data for the vertex buffer\r\n   * @returns the new WebGL static buffer\r\n   */\n\n\n  ThinEngine.prototype.createVertexBuffer = function (data) {\n    return this._createVertexBuffer(data, this._gl.STATIC_DRAW);\n  };\n\n  ThinEngine.prototype._createVertexBuffer = function (data, usage) {\n    var vbo = this._gl.createBuffer();\n\n    if (!vbo) {\n      throw new Error(\"Unable to create vertex buffer\");\n    }\n\n    var dataBuffer = new WebGLDataBuffer(vbo);\n    this.bindArrayBuffer(dataBuffer);\n\n    if (data instanceof Array) {\n      this._gl.bufferData(this._gl.ARRAY_BUFFER, new Float32Array(data), this._gl.STATIC_DRAW);\n    } else {\n      this._gl.bufferData(this._gl.ARRAY_BUFFER, data, this._gl.STATIC_DRAW);\n    }\n\n    this._resetVertexBufferBinding();\n\n    dataBuffer.references = 1;\n    return dataBuffer;\n  };\n  /**\r\n   * Creates a dynamic vertex buffer\r\n   * @param data the data for the dynamic vertex buffer\r\n   * @returns the new WebGL dynamic buffer\r\n   */\n\n\n  ThinEngine.prototype.createDynamicVertexBuffer = function (data) {\n    return this._createVertexBuffer(data, this._gl.DYNAMIC_DRAW);\n  };\n\n  ThinEngine.prototype._resetIndexBufferBinding = function () {\n    this.bindIndexBuffer(null);\n    this._cachedIndexBuffer = null;\n  };\n  /**\r\n   * Creates a new index buffer\r\n   * @param indices defines the content of the index buffer\r\n   * @param updatable defines if the index buffer must be updatable\r\n   * @returns a new webGL buffer\r\n   */\n\n\n  ThinEngine.prototype.createIndexBuffer = function (indices, updatable) {\n    var vbo = this._gl.createBuffer();\n\n    var dataBuffer = new WebGLDataBuffer(vbo);\n\n    if (!vbo) {\n      throw new Error(\"Unable to create index buffer\");\n    }\n\n    this.bindIndexBuffer(dataBuffer);\n\n    var data = this._normalizeIndexData(indices);\n\n    this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER, data, updatable ? this._gl.DYNAMIC_DRAW : this._gl.STATIC_DRAW);\n\n    this._resetIndexBufferBinding();\n\n    dataBuffer.references = 1;\n    dataBuffer.is32Bits = data.BYTES_PER_ELEMENT === 4;\n    return dataBuffer;\n  };\n\n  ThinEngine.prototype._normalizeIndexData = function (indices) {\n    if (indices instanceof Uint16Array) {\n      return indices;\n    } // Check 32 bit support\n\n\n    if (this._caps.uintIndices) {\n      if (indices instanceof Uint32Array) {\n        return indices;\n      } else {\n        // number[] or Int32Array, check if 32 bit is necessary\n        for (var index = 0; index < indices.length; index++) {\n          if (indices[index] >= 65535) {\n            return new Uint32Array(indices);\n          }\n        }\n\n        return new Uint16Array(indices);\n      }\n    } // No 32 bit support, force conversion to 16 bit (values greater 16 bit are lost)\n\n\n    return new Uint16Array(indices);\n  };\n  /**\r\n   * Bind a webGL buffer to the webGL context\r\n   * @param buffer defines the buffer to bind\r\n   */\n\n\n  ThinEngine.prototype.bindArrayBuffer = function (buffer) {\n    if (!this._vaoRecordInProgress) {\n      this._unbindVertexArrayObject();\n    }\n\n    this.bindBuffer(buffer, this._gl.ARRAY_BUFFER);\n  };\n  /**\r\n   * Bind a specific block at a given index in a specific shader program\r\n   * @param pipelineContext defines the pipeline context to use\r\n   * @param blockName defines the block name\r\n   * @param index defines the index where to bind the block\r\n   */\n\n\n  ThinEngine.prototype.bindUniformBlock = function (pipelineContext, blockName, index) {\n    var program = pipelineContext.program;\n\n    var uniformLocation = this._gl.getUniformBlockIndex(program, blockName);\n\n    this._gl.uniformBlockBinding(program, uniformLocation, index);\n  };\n\n  ThinEngine.prototype.bindIndexBuffer = function (buffer) {\n    if (!this._vaoRecordInProgress) {\n      this._unbindVertexArrayObject();\n    }\n\n    this.bindBuffer(buffer, this._gl.ELEMENT_ARRAY_BUFFER);\n  };\n\n  ThinEngine.prototype.bindBuffer = function (buffer, target) {\n    if (this._vaoRecordInProgress || this._currentBoundBuffer[target] !== buffer) {\n      this._gl.bindBuffer(target, buffer ? buffer.underlyingResource : null);\n\n      this._currentBoundBuffer[target] = buffer;\n    }\n  };\n  /**\r\n   * update the bound buffer with the given data\r\n   * @param data defines the data to update\r\n   */\n\n\n  ThinEngine.prototype.updateArrayBuffer = function (data) {\n    this._gl.bufferSubData(this._gl.ARRAY_BUFFER, 0, data);\n  };\n\n  ThinEngine.prototype._vertexAttribPointer = function (buffer, indx, size, type, normalized, stride, offset) {\n    var pointer = this._currentBufferPointers[indx];\n\n    if (!pointer) {\n      return;\n    }\n\n    var changed = false;\n\n    if (!pointer.active) {\n      changed = true;\n      pointer.active = true;\n      pointer.index = indx;\n      pointer.size = size;\n      pointer.type = type;\n      pointer.normalized = normalized;\n      pointer.stride = stride;\n      pointer.offset = offset;\n      pointer.buffer = buffer;\n    } else {\n      if (pointer.buffer !== buffer) {\n        pointer.buffer = buffer;\n        changed = true;\n      }\n\n      if (pointer.size !== size) {\n        pointer.size = size;\n        changed = true;\n      }\n\n      if (pointer.type !== type) {\n        pointer.type = type;\n        changed = true;\n      }\n\n      if (pointer.normalized !== normalized) {\n        pointer.normalized = normalized;\n        changed = true;\n      }\n\n      if (pointer.stride !== stride) {\n        pointer.stride = stride;\n        changed = true;\n      }\n\n      if (pointer.offset !== offset) {\n        pointer.offset = offset;\n        changed = true;\n      }\n    }\n\n    if (changed || this._vaoRecordInProgress) {\n      this.bindArrayBuffer(buffer);\n\n      this._gl.vertexAttribPointer(indx, size, type, normalized, stride, offset);\n    }\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._bindIndexBufferWithCache = function (indexBuffer) {\n    if (indexBuffer == null) {\n      return;\n    }\n\n    if (this._cachedIndexBuffer !== indexBuffer) {\n      this._cachedIndexBuffer = indexBuffer;\n      this.bindIndexBuffer(indexBuffer);\n      this._uintIndicesCurrentlySet = indexBuffer.is32Bits;\n    }\n  };\n\n  ThinEngine.prototype._bindVertexBuffersAttributes = function (vertexBuffers, effect) {\n    var attributes = effect.getAttributesNames();\n\n    if (!this._vaoRecordInProgress) {\n      this._unbindVertexArrayObject();\n    }\n\n    this.unbindAllAttributes();\n\n    for (var index = 0; index < attributes.length; index++) {\n      var order = effect.getAttributeLocation(index);\n\n      if (order >= 0) {\n        var vertexBuffer = vertexBuffers[attributes[index]];\n\n        if (!vertexBuffer) {\n          continue;\n        }\n\n        this._gl.enableVertexAttribArray(order);\n\n        if (!this._vaoRecordInProgress) {\n          this._vertexAttribArraysEnabled[order] = true;\n        }\n\n        var buffer = vertexBuffer.getBuffer();\n\n        if (buffer) {\n          this._vertexAttribPointer(buffer, order, vertexBuffer.getSize(), vertexBuffer.type, vertexBuffer.normalized, vertexBuffer.byteStride, vertexBuffer.byteOffset);\n\n          if (vertexBuffer.getIsInstanced()) {\n            this._gl.vertexAttribDivisor(order, vertexBuffer.getInstanceDivisor());\n\n            if (!this._vaoRecordInProgress) {\n              this._currentInstanceLocations.push(order);\n\n              this._currentInstanceBuffers.push(buffer);\n            }\n          }\n        }\n      }\n    }\n  };\n  /**\r\n   * Records a vertex array object\r\n   * @see https://doc.babylonjs.com/features/webgl2#vertex-array-objects\r\n   * @param vertexBuffers defines the list of vertex buffers to store\r\n   * @param indexBuffer defines the index buffer to store\r\n   * @param effect defines the effect to store\r\n   * @returns the new vertex array object\r\n   */\n\n\n  ThinEngine.prototype.recordVertexArrayObject = function (vertexBuffers, indexBuffer, effect) {\n    var vao = this._gl.createVertexArray();\n\n    this._vaoRecordInProgress = true;\n\n    this._gl.bindVertexArray(vao);\n\n    this._mustWipeVertexAttributes = true;\n\n    this._bindVertexBuffersAttributes(vertexBuffers, effect);\n\n    this.bindIndexBuffer(indexBuffer);\n    this._vaoRecordInProgress = false;\n\n    this._gl.bindVertexArray(null);\n\n    return vao;\n  };\n  /**\r\n   * Bind a specific vertex array object\r\n   * @see https://doc.babylonjs.com/features/webgl2#vertex-array-objects\r\n   * @param vertexArrayObject defines the vertex array object to bind\r\n   * @param indexBuffer defines the index buffer to bind\r\n   */\n\n\n  ThinEngine.prototype.bindVertexArrayObject = function (vertexArrayObject, indexBuffer) {\n    if (this._cachedVertexArrayObject !== vertexArrayObject) {\n      this._cachedVertexArrayObject = vertexArrayObject;\n\n      this._gl.bindVertexArray(vertexArrayObject);\n\n      this._cachedVertexBuffers = null;\n      this._cachedIndexBuffer = null;\n      this._uintIndicesCurrentlySet = indexBuffer != null && indexBuffer.is32Bits;\n      this._mustWipeVertexAttributes = true;\n    }\n  };\n  /**\r\n   * Bind webGl buffers directly to the webGL context\r\n   * @param vertexBuffer defines the vertex buffer to bind\r\n   * @param indexBuffer defines the index buffer to bind\r\n   * @param vertexDeclaration defines the vertex declaration to use with the vertex buffer\r\n   * @param vertexStrideSize defines the vertex stride of the vertex buffer\r\n   * @param effect defines the effect associated with the vertex buffer\r\n   */\n\n\n  ThinEngine.prototype.bindBuffersDirectly = function (vertexBuffer, indexBuffer, vertexDeclaration, vertexStrideSize, effect) {\n    if (this._cachedVertexBuffers !== vertexBuffer || this._cachedEffectForVertexBuffers !== effect) {\n      this._cachedVertexBuffers = vertexBuffer;\n      this._cachedEffectForVertexBuffers = effect;\n      var attributesCount = effect.getAttributesCount();\n\n      this._unbindVertexArrayObject();\n\n      this.unbindAllAttributes();\n      var offset = 0;\n\n      for (var index = 0; index < attributesCount; index++) {\n        if (index < vertexDeclaration.length) {\n          var order = effect.getAttributeLocation(index);\n\n          if (order >= 0) {\n            this._gl.enableVertexAttribArray(order);\n\n            this._vertexAttribArraysEnabled[order] = true;\n\n            this._vertexAttribPointer(vertexBuffer, order, vertexDeclaration[index], this._gl.FLOAT, false, vertexStrideSize, offset);\n          }\n\n          offset += vertexDeclaration[index] * 4;\n        }\n      }\n    }\n\n    this._bindIndexBufferWithCache(indexBuffer);\n  };\n\n  ThinEngine.prototype._unbindVertexArrayObject = function () {\n    if (!this._cachedVertexArrayObject) {\n      return;\n    }\n\n    this._cachedVertexArrayObject = null;\n\n    this._gl.bindVertexArray(null);\n  };\n  /**\r\n   * Bind a list of vertex buffers to the webGL context\r\n   * @param vertexBuffers defines the list of vertex buffers to bind\r\n   * @param indexBuffer defines the index buffer to bind\r\n   * @param effect defines the effect associated with the vertex buffers\r\n   */\n\n\n  ThinEngine.prototype.bindBuffers = function (vertexBuffers, indexBuffer, effect) {\n    if (this._cachedVertexBuffers !== vertexBuffers || this._cachedEffectForVertexBuffers !== effect) {\n      this._cachedVertexBuffers = vertexBuffers;\n      this._cachedEffectForVertexBuffers = effect;\n\n      this._bindVertexBuffersAttributes(vertexBuffers, effect);\n    }\n\n    this._bindIndexBufferWithCache(indexBuffer);\n  };\n  /**\r\n   * Unbind all instance attributes\r\n   */\n\n\n  ThinEngine.prototype.unbindInstanceAttributes = function () {\n    var boundBuffer;\n\n    for (var i = 0, ul = this._currentInstanceLocations.length; i < ul; i++) {\n      var instancesBuffer = this._currentInstanceBuffers[i];\n\n      if (boundBuffer != instancesBuffer && instancesBuffer.references) {\n        boundBuffer = instancesBuffer;\n        this.bindArrayBuffer(instancesBuffer);\n      }\n\n      var offsetLocation = this._currentInstanceLocations[i];\n\n      this._gl.vertexAttribDivisor(offsetLocation, 0);\n    }\n\n    this._currentInstanceBuffers.length = 0;\n    this._currentInstanceLocations.length = 0;\n  };\n  /**\r\n   * Release and free the memory of a vertex array object\r\n   * @param vao defines the vertex array object to delete\r\n   */\n\n\n  ThinEngine.prototype.releaseVertexArrayObject = function (vao) {\n    this._gl.deleteVertexArray(vao);\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._releaseBuffer = function (buffer) {\n    buffer.references--;\n\n    if (buffer.references === 0) {\n      this._deleteBuffer(buffer);\n\n      return true;\n    }\n\n    return false;\n  };\n\n  ThinEngine.prototype._deleteBuffer = function (buffer) {\n    this._gl.deleteBuffer(buffer.underlyingResource);\n  };\n  /**\r\n   * Update the content of a webGL buffer used with instanciation and bind it to the webGL context\r\n   * @param instancesBuffer defines the webGL buffer to update and bind\r\n   * @param data defines the data to store in the buffer\r\n   * @param offsetLocations defines the offsets or attributes information used to determine where data must be stored in the buffer\r\n   */\n\n\n  ThinEngine.prototype.updateAndBindInstancesBuffer = function (instancesBuffer, data, offsetLocations) {\n    this.bindArrayBuffer(instancesBuffer);\n\n    if (data) {\n      this._gl.bufferSubData(this._gl.ARRAY_BUFFER, 0, data);\n    }\n\n    if (offsetLocations[0].index !== undefined) {\n      this.bindInstancesBuffer(instancesBuffer, offsetLocations, true);\n    } else {\n      for (var index = 0; index < 4; index++) {\n        var offsetLocation = offsetLocations[index];\n\n        if (!this._vertexAttribArraysEnabled[offsetLocation]) {\n          this._gl.enableVertexAttribArray(offsetLocation);\n\n          this._vertexAttribArraysEnabled[offsetLocation] = true;\n        }\n\n        this._vertexAttribPointer(instancesBuffer, offsetLocation, 4, this._gl.FLOAT, false, 64, index * 16);\n\n        this._gl.vertexAttribDivisor(offsetLocation, 1);\n\n        this._currentInstanceLocations.push(offsetLocation);\n\n        this._currentInstanceBuffers.push(instancesBuffer);\n      }\n    }\n  };\n  /**\r\n   * Bind the content of a webGL buffer used with instantiation\r\n   * @param instancesBuffer defines the webGL buffer to bind\r\n   * @param attributesInfo defines the offsets or attributes information used to determine where data must be stored in the buffer\r\n   * @param computeStride defines Whether to compute the strides from the info or use the default 0\r\n   */\n\n\n  ThinEngine.prototype.bindInstancesBuffer = function (instancesBuffer, attributesInfo, computeStride) {\n    if (computeStride === void 0) {\n      computeStride = true;\n    }\n\n    this.bindArrayBuffer(instancesBuffer);\n    var stride = 0;\n\n    if (computeStride) {\n      for (var i = 0; i < attributesInfo.length; i++) {\n        var ai = attributesInfo[i];\n        stride += ai.attributeSize * 4;\n      }\n    }\n\n    for (var i = 0; i < attributesInfo.length; i++) {\n      var ai = attributesInfo[i];\n\n      if (ai.index === undefined) {\n        ai.index = this._currentEffect.getAttributeLocationByName(ai.attributeName);\n      }\n\n      if (ai.index < 0) {\n        continue;\n      }\n\n      if (!this._vertexAttribArraysEnabled[ai.index]) {\n        this._gl.enableVertexAttribArray(ai.index);\n\n        this._vertexAttribArraysEnabled[ai.index] = true;\n      }\n\n      this._vertexAttribPointer(instancesBuffer, ai.index, ai.attributeSize, ai.attributeType || this._gl.FLOAT, ai.normalized || false, stride, ai.offset);\n\n      this._gl.vertexAttribDivisor(ai.index, ai.divisor === undefined ? 1 : ai.divisor);\n\n      this._currentInstanceLocations.push(ai.index);\n\n      this._currentInstanceBuffers.push(instancesBuffer);\n    }\n  };\n  /**\r\n   * Disable the instance attribute corresponding to the name in parameter\r\n   * @param name defines the name of the attribute to disable\r\n   */\n\n\n  ThinEngine.prototype.disableInstanceAttributeByName = function (name) {\n    if (!this._currentEffect) {\n      return;\n    }\n\n    var attributeLocation = this._currentEffect.getAttributeLocationByName(name);\n\n    this.disableInstanceAttribute(attributeLocation);\n  };\n  /**\r\n   * Disable the instance attribute corresponding to the location in parameter\r\n   * @param attributeLocation defines the attribute location of the attribute to disable\r\n   */\n\n\n  ThinEngine.prototype.disableInstanceAttribute = function (attributeLocation) {\n    var shouldClean = false;\n    var index;\n\n    while ((index = this._currentInstanceLocations.indexOf(attributeLocation)) !== -1) {\n      this._currentInstanceLocations.splice(index, 1);\n\n      this._currentInstanceBuffers.splice(index, 1);\n\n      shouldClean = true;\n      index = this._currentInstanceLocations.indexOf(attributeLocation);\n    }\n\n    if (shouldClean) {\n      this._gl.vertexAttribDivisor(attributeLocation, 0);\n\n      this.disableAttributeByIndex(attributeLocation);\n    }\n  };\n  /**\r\n   * Disable the attribute corresponding to the location in parameter\r\n   * @param attributeLocation defines the attribute location of the attribute to disable\r\n   */\n\n\n  ThinEngine.prototype.disableAttributeByIndex = function (attributeLocation) {\n    this._gl.disableVertexAttribArray(attributeLocation);\n\n    this._vertexAttribArraysEnabled[attributeLocation] = false;\n    this._currentBufferPointers[attributeLocation].active = false;\n  };\n  /**\r\n   * Send a draw order\r\n   * @param useTriangles defines if triangles must be used to draw (else wireframe will be used)\r\n   * @param indexStart defines the starting index\r\n   * @param indexCount defines the number of index to draw\r\n   * @param instancesCount defines the number of instances to draw (if instanciation is enabled)\r\n   */\n\n\n  ThinEngine.prototype.draw = function (useTriangles, indexStart, indexCount, instancesCount) {\n    this.drawElementsType(useTriangles ? 0 : 1, indexStart, indexCount, instancesCount);\n  };\n  /**\r\n   * Draw a list of points\r\n   * @param verticesStart defines the index of first vertex to draw\r\n   * @param verticesCount defines the count of vertices to draw\r\n   * @param instancesCount defines the number of instances to draw (if instanciation is enabled)\r\n   */\n\n\n  ThinEngine.prototype.drawPointClouds = function (verticesStart, verticesCount, instancesCount) {\n    this.drawArraysType(2, verticesStart, verticesCount, instancesCount);\n  };\n  /**\r\n   * Draw a list of unindexed primitives\r\n   * @param useTriangles defines if triangles must be used to draw (else wireframe will be used)\r\n   * @param verticesStart defines the index of first vertex to draw\r\n   * @param verticesCount defines the count of vertices to draw\r\n   * @param instancesCount defines the number of instances to draw (if instanciation is enabled)\r\n   */\n\n\n  ThinEngine.prototype.drawUnIndexed = function (useTriangles, verticesStart, verticesCount, instancesCount) {\n    this.drawArraysType(useTriangles ? 0 : 1, verticesStart, verticesCount, instancesCount);\n  };\n  /**\r\n   * Draw a list of indexed primitives\r\n   * @param fillMode defines the primitive to use\r\n   * @param indexStart defines the starting index\r\n   * @param indexCount defines the number of index to draw\r\n   * @param instancesCount defines the number of instances to draw (if instanciation is enabled)\r\n   */\n\n\n  ThinEngine.prototype.drawElementsType = function (fillMode, indexStart, indexCount, instancesCount) {\n    // Apply states\n    this.applyStates();\n\n    this._reportDrawCall(); // Render\n\n\n    var drawMode = this._drawMode(fillMode);\n\n    var indexFormat = this._uintIndicesCurrentlySet ? this._gl.UNSIGNED_INT : this._gl.UNSIGNED_SHORT;\n    var mult = this._uintIndicesCurrentlySet ? 4 : 2;\n\n    if (instancesCount) {\n      this._gl.drawElementsInstanced(drawMode, indexCount, indexFormat, indexStart * mult, instancesCount);\n    } else {\n      this._gl.drawElements(drawMode, indexCount, indexFormat, indexStart * mult);\n    }\n  };\n  /**\r\n   * Draw a list of unindexed primitives\r\n   * @param fillMode defines the primitive to use\r\n   * @param verticesStart defines the index of first vertex to draw\r\n   * @param verticesCount defines the count of vertices to draw\r\n   * @param instancesCount defines the number of instances to draw (if instanciation is enabled)\r\n   */\n\n\n  ThinEngine.prototype.drawArraysType = function (fillMode, verticesStart, verticesCount, instancesCount) {\n    // Apply states\n    this.applyStates();\n\n    this._reportDrawCall();\n\n    var drawMode = this._drawMode(fillMode);\n\n    if (instancesCount) {\n      this._gl.drawArraysInstanced(drawMode, verticesStart, verticesCount, instancesCount);\n    } else {\n      this._gl.drawArrays(drawMode, verticesStart, verticesCount);\n    }\n  };\n\n  ThinEngine.prototype._drawMode = function (fillMode) {\n    switch (fillMode) {\n      // Triangle views\n      case 0:\n        return this._gl.TRIANGLES;\n\n      case 2:\n        return this._gl.POINTS;\n\n      case 1:\n        return this._gl.LINES;\n      // Draw modes\n\n      case 3:\n        return this._gl.POINTS;\n\n      case 4:\n        return this._gl.LINES;\n\n      case 5:\n        return this._gl.LINE_LOOP;\n\n      case 6:\n        return this._gl.LINE_STRIP;\n\n      case 7:\n        return this._gl.TRIANGLE_STRIP;\n\n      case 8:\n        return this._gl.TRIANGLE_FAN;\n\n      default:\n        return this._gl.TRIANGLES;\n    }\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._reportDrawCall = function () {// Will be implemented by children\n  }; // Shaders\n\n  /** @hidden */\n\n\n  ThinEngine.prototype._releaseEffect = function (effect) {\n    if (this._compiledEffects[effect._key]) {\n      delete this._compiledEffects[effect._key];\n\n      this._deletePipelineContext(effect.getPipelineContext());\n    }\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._deletePipelineContext = function (pipelineContext) {\n    var webGLPipelineContext = pipelineContext;\n\n    if (webGLPipelineContext && webGLPipelineContext.program) {\n      webGLPipelineContext.program.__SPECTOR_rebuildProgram = null;\n\n      this._gl.deleteProgram(webGLPipelineContext.program);\n    }\n  };\n  /**\r\n   * Create a new effect (used to store vertex/fragment shaders)\r\n   * @param baseName defines the base name of the effect (The name of file without .fragment.fx or .vertex.fx)\r\n   * @param attributesNamesOrOptions defines either a list of attribute names or an IEffectCreationOptions object\r\n   * @param uniformsNamesOrEngine defines either a list of uniform names or the engine to use\r\n   * @param samplers defines an array of string used to represent textures\r\n   * @param defines defines the string containing the defines to use to compile the shaders\r\n   * @param fallbacks defines the list of potential fallbacks to use if shader conmpilation fails\r\n   * @param onCompiled defines a function to call when the effect creation is successful\r\n   * @param onError defines a function to call when the effect creation has failed\r\n   * @param indexParameters defines an object containing the index values to use to compile shaders (like the maximum number of simultaneous lights)\r\n   * @returns the new Effect\r\n   */\n\n\n  ThinEngine.prototype.createEffect = function (baseName, attributesNamesOrOptions, uniformsNamesOrEngine, samplers, defines, fallbacks, onCompiled, onError, indexParameters) {\n    var vertex = baseName.vertexElement || baseName.vertex || baseName.vertexToken || baseName.vertexSource || baseName;\n    var fragment = baseName.fragmentElement || baseName.fragment || baseName.fragmentToken || baseName.fragmentSource || baseName;\n    var name = vertex + \"+\" + fragment + \"@\" + (defines ? defines : attributesNamesOrOptions.defines);\n\n    if (this._compiledEffects[name]) {\n      var compiledEffect = this._compiledEffects[name];\n\n      if (onCompiled && compiledEffect.isReady()) {\n        onCompiled(compiledEffect);\n      }\n\n      return compiledEffect;\n    }\n\n    var effect = new Effect(baseName, attributesNamesOrOptions, uniformsNamesOrEngine, samplers, this, defines, fallbacks, onCompiled, onError, indexParameters);\n    effect._key = name;\n    this._compiledEffects[name] = effect;\n    return effect;\n  };\n\n  ThinEngine._ConcatenateShader = function (source, defines, shaderVersion) {\n    if (shaderVersion === void 0) {\n      shaderVersion = \"\";\n    }\n\n    return shaderVersion + (defines ? defines + \"\\n\" : \"\") + source;\n  };\n\n  ThinEngine.prototype._compileShader = function (source, type, defines, shaderVersion) {\n    return this._compileRawShader(ThinEngine._ConcatenateShader(source, defines, shaderVersion), type);\n  };\n\n  ThinEngine.prototype._compileRawShader = function (source, type) {\n    var gl = this._gl;\n    var shader = gl.createShader(type === \"vertex\" ? gl.VERTEX_SHADER : gl.FRAGMENT_SHADER);\n\n    if (!shader) {\n      throw new Error(\"Something went wrong while compile the shader.\");\n    }\n\n    gl.shaderSource(shader, source);\n    gl.compileShader(shader);\n    return shader;\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._getShaderSource = function (shader) {\n    return this._gl.getShaderSource(shader);\n  };\n  /**\r\n   * Directly creates a webGL program\r\n   * @param pipelineContext  defines the pipeline context to attach to\r\n   * @param vertexCode defines the vertex shader code to use\r\n   * @param fragmentCode defines the fragment shader code to use\r\n   * @param context defines the webGL context to use (if not set, the current one will be used)\r\n   * @param transformFeedbackVaryings defines the list of transform feedback varyings to use\r\n   * @returns the new webGL program\r\n   */\n\n\n  ThinEngine.prototype.createRawShaderProgram = function (pipelineContext, vertexCode, fragmentCode, context, transformFeedbackVaryings) {\n    if (transformFeedbackVaryings === void 0) {\n      transformFeedbackVaryings = null;\n    }\n\n    context = context || this._gl;\n\n    var vertexShader = this._compileRawShader(vertexCode, \"vertex\");\n\n    var fragmentShader = this._compileRawShader(fragmentCode, \"fragment\");\n\n    return this._createShaderProgram(pipelineContext, vertexShader, fragmentShader, context, transformFeedbackVaryings);\n  };\n  /**\r\n   * Creates a webGL program\r\n   * @param pipelineContext  defines the pipeline context to attach to\r\n   * @param vertexCode  defines the vertex shader code to use\r\n   * @param fragmentCode defines the fragment shader code to use\r\n   * @param defines defines the string containing the defines to use to compile the shaders\r\n   * @param context defines the webGL context to use (if not set, the current one will be used)\r\n   * @param transformFeedbackVaryings defines the list of transform feedback varyings to use\r\n   * @returns the new webGL program\r\n   */\n\n\n  ThinEngine.prototype.createShaderProgram = function (pipelineContext, vertexCode, fragmentCode, defines, context, transformFeedbackVaryings) {\n    if (transformFeedbackVaryings === void 0) {\n      transformFeedbackVaryings = null;\n    }\n\n    context = context || this._gl;\n    var shaderVersion = this._webGLVersion > 1 ? \"#version 300 es\\n#define WEBGL2 \\n\" : \"\";\n\n    var vertexShader = this._compileShader(vertexCode, \"vertex\", defines, shaderVersion);\n\n    var fragmentShader = this._compileShader(fragmentCode, \"fragment\", defines, shaderVersion);\n\n    return this._createShaderProgram(pipelineContext, vertexShader, fragmentShader, context, transformFeedbackVaryings);\n  };\n  /**\r\n   * Creates a new pipeline context\r\n   * @returns the new pipeline\r\n   */\n\n\n  ThinEngine.prototype.createPipelineContext = function () {\n    var pipelineContext = new WebGLPipelineContext();\n    pipelineContext.engine = this;\n\n    if (this._caps.parallelShaderCompile) {\n      pipelineContext.isParallelCompiled = true;\n    }\n\n    return pipelineContext;\n  };\n\n  ThinEngine.prototype._createShaderProgram = function (pipelineContext, vertexShader, fragmentShader, context, transformFeedbackVaryings) {\n    if (transformFeedbackVaryings === void 0) {\n      transformFeedbackVaryings = null;\n    }\n\n    var shaderProgram = context.createProgram();\n    pipelineContext.program = shaderProgram;\n\n    if (!shaderProgram) {\n      throw new Error(\"Unable to create program\");\n    }\n\n    context.attachShader(shaderProgram, vertexShader);\n    context.attachShader(shaderProgram, fragmentShader);\n    context.linkProgram(shaderProgram);\n    pipelineContext.context = context;\n    pipelineContext.vertexShader = vertexShader;\n    pipelineContext.fragmentShader = fragmentShader;\n\n    if (!pipelineContext.isParallelCompiled) {\n      this._finalizePipelineContext(pipelineContext);\n    }\n\n    return shaderProgram;\n  };\n\n  ThinEngine.prototype._finalizePipelineContext = function (pipelineContext) {\n    var context = pipelineContext.context;\n    var vertexShader = pipelineContext.vertexShader;\n    var fragmentShader = pipelineContext.fragmentShader;\n    var program = pipelineContext.program;\n    var linked = context.getProgramParameter(program, context.LINK_STATUS);\n\n    if (!linked) {\n      // Get more info\n      // Vertex\n      if (!this._gl.getShaderParameter(vertexShader, this._gl.COMPILE_STATUS)) {\n        var log = this._gl.getShaderInfoLog(vertexShader);\n\n        if (log) {\n          pipelineContext.vertexCompilationError = log;\n          throw new Error(\"VERTEX SHADER \" + log);\n        }\n      } // Fragment\n\n\n      if (!this._gl.getShaderParameter(fragmentShader, this._gl.COMPILE_STATUS)) {\n        var log = this._gl.getShaderInfoLog(fragmentShader);\n\n        if (log) {\n          pipelineContext.fragmentCompilationError = log;\n          throw new Error(\"FRAGMENT SHADER \" + log);\n        }\n      }\n\n      var error = context.getProgramInfoLog(program);\n\n      if (error) {\n        pipelineContext.programLinkError = error;\n        throw new Error(error);\n      }\n    }\n\n    if (this.validateShaderPrograms) {\n      context.validateProgram(program);\n      var validated = context.getProgramParameter(program, context.VALIDATE_STATUS);\n\n      if (!validated) {\n        var error = context.getProgramInfoLog(program);\n\n        if (error) {\n          pipelineContext.programValidationError = error;\n          throw new Error(error);\n        }\n      }\n    }\n\n    context.deleteShader(vertexShader);\n    context.deleteShader(fragmentShader);\n    pipelineContext.vertexShader = undefined;\n    pipelineContext.fragmentShader = undefined;\n\n    if (pipelineContext.onCompiled) {\n      pipelineContext.onCompiled();\n      pipelineContext.onCompiled = undefined;\n    }\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._preparePipelineContext = function (pipelineContext, vertexSourceCode, fragmentSourceCode, createAsRaw, rebuildRebind, defines, transformFeedbackVaryings) {\n    var webGLRenderingState = pipelineContext;\n\n    if (createAsRaw) {\n      webGLRenderingState.program = this.createRawShaderProgram(webGLRenderingState, vertexSourceCode, fragmentSourceCode, undefined, transformFeedbackVaryings);\n    } else {\n      webGLRenderingState.program = this.createShaderProgram(webGLRenderingState, vertexSourceCode, fragmentSourceCode, defines, undefined, transformFeedbackVaryings);\n    }\n\n    webGLRenderingState.program.__SPECTOR_rebuildProgram = rebuildRebind;\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._isRenderingStateCompiled = function (pipelineContext) {\n    var webGLPipelineContext = pipelineContext;\n\n    if (this._gl.getProgramParameter(webGLPipelineContext.program, this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)) {\n      this._finalizePipelineContext(webGLPipelineContext);\n\n      return true;\n    }\n\n    return false;\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._executeWhenRenderingStateIsCompiled = function (pipelineContext, action) {\n    var webGLPipelineContext = pipelineContext;\n\n    if (!webGLPipelineContext.isParallelCompiled) {\n      action();\n      return;\n    }\n\n    var oldHandler = webGLPipelineContext.onCompiled;\n\n    if (oldHandler) {\n      webGLPipelineContext.onCompiled = function () {\n        oldHandler();\n        action();\n      };\n    } else {\n      webGLPipelineContext.onCompiled = action;\n    }\n  };\n  /**\r\n   * Gets the list of webGL uniform locations associated with a specific program based on a list of uniform names\r\n   * @param pipelineContext defines the pipeline context to use\r\n   * @param uniformsNames defines the list of uniform names\r\n   * @returns an array of webGL uniform locations\r\n   */\n\n\n  ThinEngine.prototype.getUniforms = function (pipelineContext, uniformsNames) {\n    var results = new Array();\n    var webGLPipelineContext = pipelineContext;\n\n    for (var index = 0; index < uniformsNames.length; index++) {\n      results.push(this._gl.getUniformLocation(webGLPipelineContext.program, uniformsNames[index]));\n    }\n\n    return results;\n  };\n  /**\r\n   * Gets the lsit of active attributes for a given webGL program\r\n   * @param pipelineContext defines the pipeline context to use\r\n   * @param attributesNames defines the list of attribute names to get\r\n   * @returns an array of indices indicating the offset of each attribute\r\n   */\n\n\n  ThinEngine.prototype.getAttributes = function (pipelineContext, attributesNames) {\n    var results = [];\n    var webGLPipelineContext = pipelineContext;\n\n    for (var index = 0; index < attributesNames.length; index++) {\n      try {\n        results.push(this._gl.getAttribLocation(webGLPipelineContext.program, attributesNames[index]));\n      } catch (e) {\n        results.push(-1);\n      }\n    }\n\n    return results;\n  };\n  /**\r\n   * Activates an effect, mkaing it the current one (ie. the one used for rendering)\r\n   * @param effect defines the effect to activate\r\n   */\n\n\n  ThinEngine.prototype.enableEffect = function (effect) {\n    if (!effect || effect === this._currentEffect) {\n      return;\n    } // Use program\n\n\n    this.bindSamplers(effect);\n    this._currentEffect = effect;\n\n    if (effect.onBind) {\n      effect.onBind(effect);\n    }\n\n    if (effect._onBindObservable) {\n      effect._onBindObservable.notifyObservers(effect);\n    }\n  };\n  /**\r\n   * Set the value of an uniform to a number (int)\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param value defines the int number to store\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setInt = function (uniform, value) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniform1i(uniform, value);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to an array of int32\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param array defines the array of int32 to store\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setIntArray = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniform1iv(uniform, array);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to an array of int32 (stored as vec2)\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param array defines the array of int32 to store\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setIntArray2 = function (uniform, array) {\n    if (!uniform || array.length % 2 !== 0) {\n      return false;\n    }\n\n    this._gl.uniform2iv(uniform, array);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to an array of int32 (stored as vec3)\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param array defines the array of int32 to store\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setIntArray3 = function (uniform, array) {\n    if (!uniform || array.length % 3 !== 0) {\n      return false;\n    }\n\n    this._gl.uniform3iv(uniform, array);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to an array of int32 (stored as vec4)\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param array defines the array of int32 to store\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setIntArray4 = function (uniform, array) {\n    if (!uniform || array.length % 4 !== 0) {\n      return false;\n    }\n\n    this._gl.uniform4iv(uniform, array);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to an array of number\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param array defines the array of number to store\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setArray = function (uniform, array) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniform1fv(uniform, array);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to an array of number (stored as vec2)\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param array defines the array of number to store\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setArray2 = function (uniform, array) {\n    if (!uniform || array.length % 2 !== 0) {\n      return false;\n    }\n\n    this._gl.uniform2fv(uniform, array);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to an array of number (stored as vec3)\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param array defines the array of number to store\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setArray3 = function (uniform, array) {\n    if (!uniform || array.length % 3 !== 0) {\n      return false;\n    }\n\n    this._gl.uniform3fv(uniform, array);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to an array of number (stored as vec4)\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param array defines the array of number to store\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setArray4 = function (uniform, array) {\n    if (!uniform || array.length % 4 !== 0) {\n      return false;\n    }\n\n    this._gl.uniform4fv(uniform, array);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to an array of float32 (stored as matrices)\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param matrices defines the array of float32 to store\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setMatrices = function (uniform, matrices) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniformMatrix4fv(uniform, false, matrices);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to a matrix (3x3)\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param matrix defines the Float32Array representing the 3x3 matrix to store\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setMatrix3x3 = function (uniform, matrix) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniformMatrix3fv(uniform, false, matrix);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to a matrix (2x2)\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param matrix defines the Float32Array representing the 2x2 matrix to store\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setMatrix2x2 = function (uniform, matrix) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniformMatrix2fv(uniform, false, matrix);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to a number (float)\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param value defines the float number to store\r\n   * @returns true if the value was transfered\r\n   */\n\n\n  ThinEngine.prototype.setFloat = function (uniform, value) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniform1f(uniform, value);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to a vec2\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param x defines the 1st component of the value\r\n   * @param y defines the 2nd component of the value\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setFloat2 = function (uniform, x, y) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniform2f(uniform, x, y);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to a vec3\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param x defines the 1st component of the value\r\n   * @param y defines the 2nd component of the value\r\n   * @param z defines the 3rd component of the value\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setFloat3 = function (uniform, x, y, z) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniform3f(uniform, x, y, z);\n\n    return true;\n  };\n  /**\r\n   * Set the value of an uniform to a vec4\r\n   * @param uniform defines the webGL uniform location where to store the value\r\n   * @param x defines the 1st component of the value\r\n   * @param y defines the 2nd component of the value\r\n   * @param z defines the 3rd component of the value\r\n   * @param w defines the 4th component of the value\r\n   * @returns true if the value was set\r\n   */\n\n\n  ThinEngine.prototype.setFloat4 = function (uniform, x, y, z, w) {\n    if (!uniform) {\n      return false;\n    }\n\n    this._gl.uniform4f(uniform, x, y, z, w);\n\n    return true;\n  }; // States\n\n  /**\r\n   * Apply all cached states (depth, culling, stencil and alpha)\r\n   */\n\n\n  ThinEngine.prototype.applyStates = function () {\n    this._depthCullingState.apply(this._gl);\n\n    this._stencilState.apply(this._gl);\n\n    this._alphaState.apply(this._gl);\n\n    if (this._colorWriteChanged) {\n      this._colorWriteChanged = false;\n      var enable = this._colorWrite;\n\n      this._gl.colorMask(enable, enable, enable, enable);\n    }\n  };\n  /**\r\n   * Enable or disable color writing\r\n   * @param enable defines the state to set\r\n   */\n\n\n  ThinEngine.prototype.setColorWrite = function (enable) {\n    if (enable !== this._colorWrite) {\n      this._colorWriteChanged = true;\n      this._colorWrite = enable;\n    }\n  };\n  /**\r\n   * Gets a boolean indicating if color writing is enabled\r\n   * @returns the current color writing state\r\n   */\n\n\n  ThinEngine.prototype.getColorWrite = function () {\n    return this._colorWrite;\n  };\n\n  Object.defineProperty(ThinEngine.prototype, \"depthCullingState\", {\n    /**\r\n     * Gets the depth culling state manager\r\n     */\n    get: function () {\n      return this._depthCullingState;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"alphaState\", {\n    /**\r\n     * Gets the alpha state manager\r\n     */\n    get: function () {\n      return this._alphaState;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  Object.defineProperty(ThinEngine.prototype, \"stencilState\", {\n    /**\r\n     * Gets the stencil state manager\r\n     */\n    get: function () {\n      return this._stencilState;\n    },\n    enumerable: false,\n    configurable: true\n  }); // Textures\n\n  /**\r\n   * Clears the list of texture accessible through engine.\r\n   * This can help preventing texture load conflict due to name collision.\r\n   */\n\n  ThinEngine.prototype.clearInternalTexturesCache = function () {\n    this._internalTexturesCache = [];\n  };\n  /**\r\n   * Force the entire cache to be cleared\r\n   * You should not have to use this function unless your engine needs to share the webGL context with another engine\r\n   * @param bruteForce defines a boolean to force clearing ALL caches (including stencil, detoh and alpha states)\r\n   */\n\n\n  ThinEngine.prototype.wipeCaches = function (bruteForce) {\n    if (this.preventCacheWipeBetweenFrames && !bruteForce) {\n      return;\n    }\n\n    this._currentEffect = null;\n    this._viewportCached.x = 0;\n    this._viewportCached.y = 0;\n    this._viewportCached.z = 0;\n    this._viewportCached.w = 0; // Done before in case we clean the attributes\n\n    this._unbindVertexArrayObject();\n\n    if (bruteForce) {\n      this._currentProgram = null;\n      this.resetTextureCache();\n\n      this._stencilState.reset();\n\n      this._depthCullingState.reset();\n\n      this._depthCullingState.depthFunc = this._gl.LEQUAL;\n\n      this._alphaState.reset();\n\n      this._alphaMode = 1;\n      this._alphaEquation = 0;\n      this._colorWrite = true;\n      this._colorWriteChanged = true;\n      this._unpackFlipYCached = null;\n\n      this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL, this._gl.NONE);\n\n      this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, 0);\n\n      this._mustWipeVertexAttributes = true;\n      this.unbindAllAttributes();\n    }\n\n    this._resetVertexBufferBinding();\n\n    this._cachedIndexBuffer = null;\n    this._cachedEffectForVertexBuffers = null;\n    this.bindIndexBuffer(null);\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._getSamplingParameters = function (samplingMode, generateMipMaps) {\n    var gl = this._gl;\n    var magFilter = gl.NEAREST;\n    var minFilter = gl.NEAREST;\n\n    switch (samplingMode) {\n      case 11:\n        magFilter = gl.LINEAR;\n\n        if (generateMipMaps) {\n          minFilter = gl.LINEAR_MIPMAP_NEAREST;\n        } else {\n          minFilter = gl.LINEAR;\n        }\n\n        break;\n\n      case 3:\n        magFilter = gl.LINEAR;\n\n        if (generateMipMaps) {\n          minFilter = gl.LINEAR_MIPMAP_LINEAR;\n        } else {\n          minFilter = gl.LINEAR;\n        }\n\n        break;\n\n      case 8:\n        magFilter = gl.NEAREST;\n\n        if (generateMipMaps) {\n          minFilter = gl.NEAREST_MIPMAP_LINEAR;\n        } else {\n          minFilter = gl.NEAREST;\n        }\n\n        break;\n\n      case 4:\n        magFilter = gl.NEAREST;\n\n        if (generateMipMaps) {\n          minFilter = gl.NEAREST_MIPMAP_NEAREST;\n        } else {\n          minFilter = gl.NEAREST;\n        }\n\n        break;\n\n      case 5:\n        magFilter = gl.NEAREST;\n\n        if (generateMipMaps) {\n          minFilter = gl.LINEAR_MIPMAP_NEAREST;\n        } else {\n          minFilter = gl.LINEAR;\n        }\n\n        break;\n\n      case 6:\n        magFilter = gl.NEAREST;\n\n        if (generateMipMaps) {\n          minFilter = gl.LINEAR_MIPMAP_LINEAR;\n        } else {\n          minFilter = gl.LINEAR;\n        }\n\n        break;\n\n      case 7:\n        magFilter = gl.NEAREST;\n        minFilter = gl.LINEAR;\n        break;\n\n      case 1:\n        magFilter = gl.NEAREST;\n        minFilter = gl.NEAREST;\n        break;\n\n      case 9:\n        magFilter = gl.LINEAR;\n\n        if (generateMipMaps) {\n          minFilter = gl.NEAREST_MIPMAP_NEAREST;\n        } else {\n          minFilter = gl.NEAREST;\n        }\n\n        break;\n\n      case 10:\n        magFilter = gl.LINEAR;\n\n        if (generateMipMaps) {\n          minFilter = gl.NEAREST_MIPMAP_LINEAR;\n        } else {\n          minFilter = gl.NEAREST;\n        }\n\n        break;\n\n      case 2:\n        magFilter = gl.LINEAR;\n        minFilter = gl.LINEAR;\n        break;\n\n      case 12:\n        magFilter = gl.LINEAR;\n        minFilter = gl.NEAREST;\n        break;\n    }\n\n    return {\n      min: minFilter,\n      mag: magFilter\n    };\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._createTexture = function () {\n    var texture = this._gl.createTexture();\n\n    if (!texture) {\n      throw new Error(\"Unable to create texture\");\n    }\n\n    return texture;\n  };\n  /**\r\n   * Usually called from Texture.ts.\r\n   * Passed information to create a WebGLTexture\r\n   * @param url defines a value which contains one of the following:\r\n   * * A conventional http URL, e.g. 'http://...' or 'file://...'\r\n   * * A base64 string of in-line texture data, e.g. 'data:image/jpg;base64,/...'\r\n   * * An indicator that data being passed using the buffer parameter, e.g. 'data:mytexture.jpg'\r\n   * @param noMipmap defines a boolean indicating that no mipmaps shall be generated.  Ignored for compressed textures.  They must be in the file\r\n   * @param invertY when true, image is flipped when loaded.  You probably want true. Certain compressed textures may invert this if their default is inverted (eg. ktx)\r\n   * @param scene needed for loading to the correct scene\r\n   * @param samplingMode mode with should be used sample / access the texture (Default: Texture.TRILINEAR_SAMPLINGMODE)\r\n   * @param onLoad optional callback to be called upon successful completion\r\n   * @param onError optional callback to be called upon failure\r\n   * @param buffer a source of a file previously fetched as either a base64 string, an ArrayBuffer (compressed or image format), HTMLImageElement (image format), or a Blob\r\n   * @param fallback an internal argument in case the function must be called again, due to etc1 not having alpha capabilities\r\n   * @param format internal format.  Default: RGB when extension is '.jpg' else RGBA.  Ignored for compressed textures\r\n   * @param forcedExtension defines the extension to use to pick the right loader\r\n   * @param mimeType defines an optional mime type\r\n   * @param loaderOptions options to be passed to the loader\r\n   * @returns a InternalTexture for assignment back into BABYLON.Texture\r\n   */\n\n\n  ThinEngine.prototype.createTexture = function (url, noMipmap, invertY, scene, samplingMode, onLoad, onError, buffer, fallback, format, forcedExtension, mimeType, loaderOptions) {\n    var _this = this;\n\n    if (samplingMode === void 0) {\n      samplingMode = 3;\n    }\n\n    if (onLoad === void 0) {\n      onLoad = null;\n    }\n\n    if (onError === void 0) {\n      onError = null;\n    }\n\n    if (buffer === void 0) {\n      buffer = null;\n    }\n\n    if (fallback === void 0) {\n      fallback = null;\n    }\n\n    if (format === void 0) {\n      format = null;\n    }\n\n    if (forcedExtension === void 0) {\n      forcedExtension = null;\n    }\n\n    url = url || \"\";\n    var fromData = url.substr(0, 5) === \"data:\";\n    var fromBlob = url.substr(0, 5) === \"blob:\";\n    var isBase64 = fromData && url.indexOf(\";base64,\") !== -1;\n    var texture = fallback ? fallback : new InternalTexture(this, InternalTextureSource.Url);\n    var originalUrl = url;\n\n    if (this._transformTextureUrl && !isBase64 && !fallback && !buffer) {\n      url = this._transformTextureUrl(url);\n    }\n\n    if (originalUrl !== url) {\n      texture._originalUrl = originalUrl;\n    } // establish the file extension, if possible\n\n\n    var lastDot = url.lastIndexOf('.');\n    var extension = forcedExtension ? forcedExtension : lastDot > -1 ? url.substring(lastDot).toLowerCase() : \"\";\n    var loader = null; // Remove query string\n\n    var queryStringIndex = extension.indexOf(\"?\");\n\n    if (queryStringIndex > -1) {\n      extension = extension.split(\"?\")[0];\n    }\n\n    for (var _i = 0, _a = ThinEngine._TextureLoaders; _i < _a.length; _i++) {\n      var availableLoader = _a[_i];\n\n      if (availableLoader.canLoad(extension, mimeType)) {\n        loader = availableLoader;\n        break;\n      }\n    }\n\n    if (scene) {\n      scene._addPendingData(texture);\n    }\n\n    texture.url = url;\n    texture.generateMipMaps = !noMipmap;\n    texture.samplingMode = samplingMode;\n    texture.invertY = invertY;\n\n    if (!this._doNotHandleContextLost) {\n      // Keep a link to the buffer only if we plan to handle context lost\n      texture._buffer = buffer;\n    }\n\n    var onLoadObserver = null;\n\n    if (onLoad && !fallback) {\n      onLoadObserver = texture.onLoadedObservable.add(onLoad);\n    }\n\n    if (!fallback) {\n      this._internalTexturesCache.push(texture);\n    }\n\n    var onInternalError = function (message, exception) {\n      if (scene) {\n        scene._removePendingData(texture);\n      }\n\n      if (url === originalUrl) {\n        if (onLoadObserver) {\n          texture.onLoadedObservable.remove(onLoadObserver);\n        }\n\n        if (EngineStore.UseFallbackTexture) {\n          _this.createTexture(EngineStore.FallbackTexture, noMipmap, texture.invertY, scene, samplingMode, null, onError, buffer, texture);\n        }\n\n        if (onError) {\n          onError((message || \"Unknown error\") + (EngineStore.UseFallbackTexture ? \" - Fallback texture was used\" : \"\"), exception);\n        }\n      } else {\n        // fall back to the original url if the transformed url fails to load\n        Logger.Warn(\"Failed to load \" + url + \", falling back to \" + originalUrl);\n\n        _this.createTexture(originalUrl, noMipmap, texture.invertY, scene, samplingMode, onLoad, onError, buffer, texture, format, forcedExtension, mimeType, loaderOptions);\n      }\n    }; // processing for non-image formats\n\n\n    if (loader) {\n      var callback_1 = function (data) {\n        loader.loadData(data, texture, function (width, height, loadMipmap, isCompressed, done, loadFailed) {\n          if (loadFailed) {\n            onInternalError(\"TextureLoader failed to load data\");\n          } else {\n            _this._prepareWebGLTexture(texture, scene, width, height, texture.invertY, !loadMipmap, isCompressed, function () {\n              done();\n              return false;\n            }, samplingMode);\n          }\n        }, loaderOptions);\n      };\n\n      if (!buffer) {\n        this._loadFile(url, function (data) {\n          return callback_1(new Uint8Array(data));\n        }, undefined, scene ? scene.offlineProvider : undefined, true, function (request, exception) {\n          onInternalError(\"Unable to load \" + (request ? request.responseURL : url, exception));\n        });\n      } else {\n        if (buffer instanceof ArrayBuffer) {\n          callback_1(new Uint8Array(buffer));\n        } else if (ArrayBuffer.isView(buffer)) {\n          callback_1(buffer);\n        } else {\n          if (onError) {\n            onError(\"Unable to load: only ArrayBuffer or ArrayBufferView is supported\", null);\n          }\n        }\n      }\n    } else {\n      var onload_1 = function (img) {\n        if (fromBlob && !_this._doNotHandleContextLost) {\n          // We need to store the image if we need to rebuild the texture\n          // in case of a webgl context lost\n          texture._buffer = img;\n        }\n\n        _this._prepareWebGLTexture(texture, scene, img.width, img.height, texture.invertY, noMipmap, false, function (potWidth, potHeight, continuationCallback) {\n          var gl = _this._gl;\n          var isPot = img.width === potWidth && img.height === potHeight;\n          var internalFormat = format ? _this._getInternalFormat(format) : extension === \".jpg\" ? gl.RGB : gl.RGBA;\n\n          if (isPot) {\n            gl.texImage2D(gl.TEXTURE_2D, 0, internalFormat, internalFormat, gl.UNSIGNED_BYTE, img);\n            return false;\n          }\n\n          var maxTextureSize = _this._caps.maxTextureSize;\n\n          if (img.width > maxTextureSize || img.height > maxTextureSize || !_this._supportsHardwareTextureRescaling) {\n            _this._prepareWorkingCanvas();\n\n            if (!_this._workingCanvas || !_this._workingContext) {\n              return false;\n            }\n\n            _this._workingCanvas.width = potWidth;\n            _this._workingCanvas.height = potHeight;\n\n            _this._workingContext.drawImage(img, 0, 0, img.width, img.height, 0, 0, potWidth, potHeight);\n\n            gl.texImage2D(gl.TEXTURE_2D, 0, internalFormat, internalFormat, gl.UNSIGNED_BYTE, _this._workingCanvas);\n            texture.width = potWidth;\n            texture.height = potHeight;\n            return false;\n          } else {\n            // Using shaders when possible to rescale because canvas.drawImage is lossy\n            var source_1 = new InternalTexture(_this, InternalTextureSource.Temp);\n\n            _this._bindTextureDirectly(gl.TEXTURE_2D, source_1, true);\n\n            gl.texImage2D(gl.TEXTURE_2D, 0, internalFormat, internalFormat, gl.UNSIGNED_BYTE, img);\n\n            _this._rescaleTexture(source_1, texture, scene, internalFormat, function () {\n              _this._releaseTexture(source_1);\n\n              _this._bindTextureDirectly(gl.TEXTURE_2D, texture, true);\n\n              continuationCallback();\n            });\n          }\n\n          return true;\n        }, samplingMode);\n      };\n\n      if (!fromData || isBase64) {\n        if (buffer && (buffer.decoding || buffer.close)) {\n          onload_1(buffer);\n        } else {\n          ThinEngine._FileToolsLoadImage(url, onload_1, onInternalError, scene ? scene.offlineProvider : null, mimeType);\n        }\n      } else if (typeof buffer === \"string\" || buffer instanceof ArrayBuffer || ArrayBuffer.isView(buffer) || buffer instanceof Blob) {\n        ThinEngine._FileToolsLoadImage(buffer, onload_1, onInternalError, scene ? scene.offlineProvider : null, mimeType);\n      } else if (buffer) {\n        onload_1(buffer);\n      }\n    }\n\n    return texture;\n  };\n  /**\r\n   * Loads an image as an HTMLImageElement.\r\n   * @param input url string, ArrayBuffer, or Blob to load\r\n   * @param onLoad callback called when the image successfully loads\r\n   * @param onError callback called when the image fails to load\r\n   * @param offlineProvider offline provider for caching\r\n   * @param mimeType optional mime type\r\n   * @returns the HTMLImageElement of the loaded image\r\n   * @hidden\r\n   */\n\n\n  ThinEngine._FileToolsLoadImage = function (input, onLoad, onError, offlineProvider, mimeType) {\n    throw _DevTools.WarnImport(\"FileTools\");\n  };\n  /**\r\n   * @hidden\r\n   */\n\n\n  ThinEngine.prototype._rescaleTexture = function (source, destination, scene, internalFormat, onComplete) {};\n  /**\r\n   * Creates a raw texture\r\n   * @param data defines the data to store in the texture\r\n   * @param width defines the width of the texture\r\n   * @param height defines the height of the texture\r\n   * @param format defines the format of the data\r\n   * @param generateMipMaps defines if the engine should generate the mip levels\r\n   * @param invertY defines if data must be stored with Y axis inverted\r\n   * @param samplingMode defines the required sampling mode (Texture.NEAREST_SAMPLINGMODE by default)\r\n   * @param compression defines the compression used (null by default)\r\n   * @param type defines the type fo the data (Engine.TEXTURETYPE_UNSIGNED_INT by default)\r\n   * @returns the raw texture inside an InternalTexture\r\n   */\n\n\n  ThinEngine.prototype.createRawTexture = function (data, width, height, format, generateMipMaps, invertY, samplingMode, compression, type) {\n    if (compression === void 0) {\n      compression = null;\n    }\n\n    if (type === void 0) {\n      type = 0;\n    }\n\n    throw _DevTools.WarnImport(\"Engine.RawTexture\");\n  };\n  /**\r\n   * Creates a new raw cube texture\r\n   * @param data defines the array of data to use to create each face\r\n   * @param size defines the size of the textures\r\n   * @param format defines the format of the data\r\n   * @param type defines the type of the data (like Engine.TEXTURETYPE_UNSIGNED_INT)\r\n   * @param generateMipMaps  defines if the engine should generate the mip levels\r\n   * @param invertY defines if data must be stored with Y axis inverted\r\n   * @param samplingMode defines the required sampling mode (like Texture.NEAREST_SAMPLINGMODE)\r\n   * @param compression defines the compression used (null by default)\r\n   * @returns the cube texture as an InternalTexture\r\n   */\n\n\n  ThinEngine.prototype.createRawCubeTexture = function (data, size, format, type, generateMipMaps, invertY, samplingMode, compression) {\n    if (compression === void 0) {\n      compression = null;\n    }\n\n    throw _DevTools.WarnImport(\"Engine.RawTexture\");\n  };\n  /**\r\n   * Creates a new raw 3D texture\r\n   * @param data defines the data used to create the texture\r\n   * @param width defines the width of the texture\r\n   * @param height defines the height of the texture\r\n   * @param depth defines the depth of the texture\r\n   * @param format defines the format of the texture\r\n   * @param generateMipMaps defines if the engine must generate mip levels\r\n   * @param invertY defines if data must be stored with Y axis inverted\r\n   * @param samplingMode defines the required sampling mode (like Texture.NEAREST_SAMPLINGMODE)\r\n   * @param compression defines the compressed used (can be null)\r\n   * @param textureType defines the compressed used (can be null)\r\n   * @returns a new raw 3D texture (stored in an InternalTexture)\r\n   */\n\n\n  ThinEngine.prototype.createRawTexture3D = function (data, width, height, depth, format, generateMipMaps, invertY, samplingMode, compression, textureType) {\n    if (compression === void 0) {\n      compression = null;\n    }\n\n    if (textureType === void 0) {\n      textureType = 0;\n    }\n\n    throw _DevTools.WarnImport(\"Engine.RawTexture\");\n  };\n  /**\r\n   * Creates a new raw 2D array texture\r\n   * @param data defines the data used to create the texture\r\n   * @param width defines the width of the texture\r\n   * @param height defines the height of the texture\r\n   * @param depth defines the number of layers of the texture\r\n   * @param format defines the format of the texture\r\n   * @param generateMipMaps defines if the engine must generate mip levels\r\n   * @param invertY defines if data must be stored with Y axis inverted\r\n   * @param samplingMode defines the required sampling mode (like Texture.NEAREST_SAMPLINGMODE)\r\n   * @param compression defines the compressed used (can be null)\r\n   * @param textureType defines the compressed used (can be null)\r\n   * @returns a new raw 2D array texture (stored in an InternalTexture)\r\n   */\n\n\n  ThinEngine.prototype.createRawTexture2DArray = function (data, width, height, depth, format, generateMipMaps, invertY, samplingMode, compression, textureType) {\n    if (compression === void 0) {\n      compression = null;\n    }\n\n    if (textureType === void 0) {\n      textureType = 0;\n    }\n\n    throw _DevTools.WarnImport(\"Engine.RawTexture\");\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._unpackFlipY = function (value) {\n    if (this._unpackFlipYCached !== value) {\n      this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL, value ? 1 : 0);\n\n      if (this.enableUnpackFlipYCached) {\n        this._unpackFlipYCached = value;\n      }\n    }\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._getUnpackAlignement = function () {\n    return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT);\n  };\n\n  ThinEngine.prototype._getTextureTarget = function (texture) {\n    if (texture.isCube) {\n      return this._gl.TEXTURE_CUBE_MAP;\n    } else if (texture.is3D) {\n      return this._gl.TEXTURE_3D;\n    } else if (texture.is2DArray || texture.isMultiview) {\n      return this._gl.TEXTURE_2D_ARRAY;\n    }\n\n    return this._gl.TEXTURE_2D;\n  };\n  /**\r\n   * Update the sampling mode of a given texture\r\n   * @param samplingMode defines the required sampling mode\r\n   * @param texture defines the texture to update\r\n   * @param generateMipMaps defines whether to generate mipmaps for the texture\r\n   */\n\n\n  ThinEngine.prototype.updateTextureSamplingMode = function (samplingMode, texture, generateMipMaps) {\n    if (generateMipMaps === void 0) {\n      generateMipMaps = false;\n    }\n\n    var target = this._getTextureTarget(texture);\n\n    var filters = this._getSamplingParameters(samplingMode, texture.generateMipMaps || generateMipMaps);\n\n    this._setTextureParameterInteger(target, this._gl.TEXTURE_MAG_FILTER, filters.mag, texture);\n\n    this._setTextureParameterInteger(target, this._gl.TEXTURE_MIN_FILTER, filters.min);\n\n    if (generateMipMaps) {\n      texture.generateMipMaps = true;\n\n      this._gl.generateMipmap(target);\n    }\n\n    this._bindTextureDirectly(target, null);\n\n    texture.samplingMode = samplingMode;\n  };\n  /**\r\n   * Update the sampling mode of a given texture\r\n   * @param texture defines the texture to update\r\n   * @param wrapU defines the texture wrap mode of the u coordinates\r\n   * @param wrapV defines the texture wrap mode of the v coordinates\r\n   * @param wrapR defines the texture wrap mode of the r coordinates\r\n   */\n\n\n  ThinEngine.prototype.updateTextureWrappingMode = function (texture, wrapU, wrapV, wrapR) {\n    if (wrapV === void 0) {\n      wrapV = null;\n    }\n\n    if (wrapR === void 0) {\n      wrapR = null;\n    }\n\n    var target = this._getTextureTarget(texture);\n\n    if (wrapU !== null) {\n      this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_S, this._getTextureWrapMode(wrapU), texture);\n\n      texture._cachedWrapU = wrapU;\n    }\n\n    if (wrapV !== null) {\n      this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_T, this._getTextureWrapMode(wrapV), texture);\n\n      texture._cachedWrapV = wrapV;\n    }\n\n    if ((texture.is2DArray || texture.is3D) && wrapR !== null) {\n      this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_R, this._getTextureWrapMode(wrapR), texture);\n\n      texture._cachedWrapR = wrapR;\n    }\n\n    this._bindTextureDirectly(target, null);\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._setupDepthStencilTexture = function (internalTexture, size, generateStencil, bilinearFiltering, comparisonFunction) {\n    var width = size.width || size;\n    var height = size.height || size;\n    var layers = size.layers || 0;\n    internalTexture.baseWidth = width;\n    internalTexture.baseHeight = height;\n    internalTexture.width = width;\n    internalTexture.height = height;\n    internalTexture.is2DArray = layers > 0;\n    internalTexture.depth = layers;\n    internalTexture.isReady = true;\n    internalTexture.samples = 1;\n    internalTexture.generateMipMaps = false;\n    internalTexture._generateDepthBuffer = true;\n    internalTexture._generateStencilBuffer = generateStencil;\n    internalTexture.samplingMode = bilinearFiltering ? 2 : 1;\n    internalTexture.type = 0;\n    internalTexture._comparisonFunction = comparisonFunction;\n    var gl = this._gl;\n\n    var target = this._getTextureTarget(internalTexture);\n\n    var samplingParameters = this._getSamplingParameters(internalTexture.samplingMode, false);\n\n    gl.texParameteri(target, gl.TEXTURE_MAG_FILTER, samplingParameters.mag);\n    gl.texParameteri(target, gl.TEXTURE_MIN_FILTER, samplingParameters.min);\n    gl.texParameteri(target, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\n    gl.texParameteri(target, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\n\n    if (comparisonFunction === 0) {\n      gl.texParameteri(target, gl.TEXTURE_COMPARE_FUNC, 515);\n      gl.texParameteri(target, gl.TEXTURE_COMPARE_MODE, gl.NONE);\n    } else {\n      gl.texParameteri(target, gl.TEXTURE_COMPARE_FUNC, comparisonFunction);\n      gl.texParameteri(target, gl.TEXTURE_COMPARE_MODE, gl.COMPARE_REF_TO_TEXTURE);\n    }\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._uploadCompressedDataToTextureDirectly = function (texture, internalFormat, width, height, data, faceIndex, lod) {\n    if (faceIndex === void 0) {\n      faceIndex = 0;\n    }\n\n    if (lod === void 0) {\n      lod = 0;\n    }\n\n    var gl = this._gl;\n    var target = gl.TEXTURE_2D;\n\n    if (texture.isCube) {\n      target = gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex;\n    }\n\n    this._gl.compressedTexImage2D(target, lod, internalFormat, width, height, 0, data);\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._uploadDataToTextureDirectly = function (texture, imageData, faceIndex, lod, babylonInternalFormat, useTextureWidthAndHeight) {\n    if (faceIndex === void 0) {\n      faceIndex = 0;\n    }\n\n    if (lod === void 0) {\n      lod = 0;\n    }\n\n    if (useTextureWidthAndHeight === void 0) {\n      useTextureWidthAndHeight = false;\n    }\n\n    var gl = this._gl;\n\n    var textureType = this._getWebGLTextureType(texture.type);\n\n    var format = this._getInternalFormat(texture.format);\n\n    var internalFormat = babylonInternalFormat === undefined ? this._getRGBABufferInternalSizedFormat(texture.type, texture.format) : this._getInternalFormat(babylonInternalFormat);\n\n    this._unpackFlipY(texture.invertY);\n\n    var target = gl.TEXTURE_2D;\n\n    if (texture.isCube) {\n      target = gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex;\n    }\n\n    var lodMaxWidth = Math.round(Math.log(texture.width) * Math.LOG2E);\n    var lodMaxHeight = Math.round(Math.log(texture.height) * Math.LOG2E);\n    var width = useTextureWidthAndHeight ? texture.width : Math.pow(2, Math.max(lodMaxWidth - lod, 0));\n    var height = useTextureWidthAndHeight ? texture.height : Math.pow(2, Math.max(lodMaxHeight - lod, 0));\n    gl.texImage2D(target, lod, internalFormat, width, height, 0, format, textureType, imageData);\n  };\n  /**\r\n   * Update a portion of an internal texture\r\n   * @param texture defines the texture to update\r\n   * @param imageData defines the data to store into the texture\r\n   * @param xOffset defines the x coordinates of the update rectangle\r\n   * @param yOffset defines the y coordinates of the update rectangle\r\n   * @param width defines the width of the update rectangle\r\n   * @param height defines the height of the update rectangle\r\n   * @param faceIndex defines the face index if texture is a cube (0 by default)\r\n   * @param lod defines the lod level to update (0 by default)\r\n   */\n\n\n  ThinEngine.prototype.updateTextureData = function (texture, imageData, xOffset, yOffset, width, height, faceIndex, lod) {\n    if (faceIndex === void 0) {\n      faceIndex = 0;\n    }\n\n    if (lod === void 0) {\n      lod = 0;\n    }\n\n    var gl = this._gl;\n\n    var textureType = this._getWebGLTextureType(texture.type);\n\n    var format = this._getInternalFormat(texture.format);\n\n    this._unpackFlipY(texture.invertY);\n\n    var target = gl.TEXTURE_2D;\n\n    if (texture.isCube) {\n      target = gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex;\n    }\n\n    gl.texSubImage2D(target, lod, xOffset, yOffset, width, height, format, textureType, imageData);\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._uploadArrayBufferViewToTexture = function (texture, imageData, faceIndex, lod) {\n    if (faceIndex === void 0) {\n      faceIndex = 0;\n    }\n\n    if (lod === void 0) {\n      lod = 0;\n    }\n\n    var gl = this._gl;\n    var bindTarget = texture.isCube ? gl.TEXTURE_CUBE_MAP : gl.TEXTURE_2D;\n\n    this._bindTextureDirectly(bindTarget, texture, true);\n\n    this._uploadDataToTextureDirectly(texture, imageData, faceIndex, lod);\n\n    this._bindTextureDirectly(bindTarget, null, true);\n  };\n\n  ThinEngine.prototype._prepareWebGLTextureContinuation = function (texture, scene, noMipmap, isCompressed, samplingMode) {\n    var gl = this._gl;\n\n    if (!gl) {\n      return;\n    }\n\n    var filters = this._getSamplingParameters(samplingMode, !noMipmap);\n\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, filters.mag);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, filters.min);\n\n    if (!noMipmap && !isCompressed) {\n      gl.generateMipmap(gl.TEXTURE_2D);\n    }\n\n    this._bindTextureDirectly(gl.TEXTURE_2D, null); // this.resetTextureCache();\n\n\n    if (scene) {\n      scene._removePendingData(texture);\n    }\n\n    texture.onLoadedObservable.notifyObservers(texture);\n    texture.onLoadedObservable.clear();\n  };\n\n  ThinEngine.prototype._prepareWebGLTexture = function (texture, scene, width, height, invertY, noMipmap, isCompressed, processFunction, samplingMode) {\n    var _this = this;\n\n    if (samplingMode === void 0) {\n      samplingMode = 3;\n    }\n\n    var maxTextureSize = this.getCaps().maxTextureSize;\n    var potWidth = Math.min(maxTextureSize, this.needPOTTextures ? ThinEngine.GetExponentOfTwo(width, maxTextureSize) : width);\n    var potHeight = Math.min(maxTextureSize, this.needPOTTextures ? ThinEngine.GetExponentOfTwo(height, maxTextureSize) : height);\n    var gl = this._gl;\n\n    if (!gl) {\n      return;\n    }\n\n    if (!texture._webGLTexture) {\n      //  this.resetTextureCache();\n      if (scene) {\n        scene._removePendingData(texture);\n      }\n\n      return;\n    }\n\n    this._bindTextureDirectly(gl.TEXTURE_2D, texture, true);\n\n    this._unpackFlipY(invertY === undefined ? true : invertY ? true : false);\n\n    texture.baseWidth = width;\n    texture.baseHeight = height;\n    texture.width = potWidth;\n    texture.height = potHeight;\n    texture.isReady = true;\n\n    if (processFunction(potWidth, potHeight, function () {\n      _this._prepareWebGLTextureContinuation(texture, scene, noMipmap, isCompressed, samplingMode);\n    })) {\n      // Returning as texture needs extra async steps\n      return;\n    }\n\n    this._prepareWebGLTextureContinuation(texture, scene, noMipmap, isCompressed, samplingMode);\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._setupFramebufferDepthAttachments = function (generateStencilBuffer, generateDepthBuffer, width, height, samples) {\n    if (samples === void 0) {\n      samples = 1;\n    }\n\n    var gl = this._gl; // Create the depth/stencil buffer\n\n    if (generateStencilBuffer && generateDepthBuffer) {\n      return this._getDepthStencilBuffer(width, height, samples, gl.DEPTH_STENCIL, gl.DEPTH24_STENCIL8, gl.DEPTH_STENCIL_ATTACHMENT);\n    }\n\n    if (generateDepthBuffer) {\n      var depthFormat = gl.DEPTH_COMPONENT16;\n\n      if (this._webGLVersion > 1) {\n        depthFormat = gl.DEPTH_COMPONENT32F;\n      }\n\n      return this._getDepthStencilBuffer(width, height, samples, depthFormat, depthFormat, gl.DEPTH_ATTACHMENT);\n    }\n\n    if (generateStencilBuffer) {\n      return this._getDepthStencilBuffer(width, height, samples, gl.STENCIL_INDEX8, gl.STENCIL_INDEX8, gl.STENCIL_ATTACHMENT);\n    }\n\n    return null;\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._releaseFramebufferObjects = function (texture) {\n    var gl = this._gl;\n\n    if (texture._framebuffer) {\n      gl.deleteFramebuffer(texture._framebuffer);\n      texture._framebuffer = null;\n    }\n\n    if (texture._depthStencilBuffer) {\n      gl.deleteRenderbuffer(texture._depthStencilBuffer);\n      texture._depthStencilBuffer = null;\n    }\n\n    if (texture._MSAAFramebuffer) {\n      gl.deleteFramebuffer(texture._MSAAFramebuffer);\n      texture._MSAAFramebuffer = null;\n    }\n\n    if (texture._MSAARenderBuffer) {\n      gl.deleteRenderbuffer(texture._MSAARenderBuffer);\n      texture._MSAARenderBuffer = null;\n    }\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._releaseTexture = function (texture) {\n    this._releaseFramebufferObjects(texture);\n\n    this._deleteTexture(texture._webGLTexture); // Unbind channels\n\n\n    this.unbindAllTextures();\n\n    var index = this._internalTexturesCache.indexOf(texture);\n\n    if (index !== -1) {\n      this._internalTexturesCache.splice(index, 1);\n    } // Integrated fixed lod samplers.\n\n\n    if (texture._lodTextureHigh) {\n      texture._lodTextureHigh.dispose();\n    }\n\n    if (texture._lodTextureMid) {\n      texture._lodTextureMid.dispose();\n    }\n\n    if (texture._lodTextureLow) {\n      texture._lodTextureLow.dispose();\n    } // Integrated irradiance map.\n\n\n    if (texture._irradianceTexture) {\n      texture._irradianceTexture.dispose();\n    }\n  };\n\n  ThinEngine.prototype._deleteTexture = function (texture) {\n    this._gl.deleteTexture(texture);\n  };\n\n  ThinEngine.prototype._setProgram = function (program) {\n    if (this._currentProgram !== program) {\n      this._gl.useProgram(program);\n\n      this._currentProgram = program;\n    }\n  };\n  /**\r\n   * Binds an effect to the webGL context\r\n   * @param effect defines the effect to bind\r\n   */\n\n\n  ThinEngine.prototype.bindSamplers = function (effect) {\n    var webGLPipelineContext = effect.getPipelineContext();\n\n    this._setProgram(webGLPipelineContext.program);\n\n    var samplers = effect.getSamplers();\n\n    for (var index = 0; index < samplers.length; index++) {\n      var uniform = effect.getUniform(samplers[index]);\n\n      if (uniform) {\n        this._boundUniforms[index] = uniform;\n      }\n    }\n\n    this._currentEffect = null;\n  };\n\n  ThinEngine.prototype._activateCurrentTexture = function () {\n    if (this._currentTextureChannel !== this._activeChannel) {\n      this._gl.activeTexture(this._gl.TEXTURE0 + this._activeChannel);\n\n      this._currentTextureChannel = this._activeChannel;\n    }\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._bindTextureDirectly = function (target, texture, forTextureDataUpdate, force) {\n    if (forTextureDataUpdate === void 0) {\n      forTextureDataUpdate = false;\n    }\n\n    if (force === void 0) {\n      force = false;\n    }\n\n    var wasPreviouslyBound = false;\n    var isTextureForRendering = texture && texture._associatedChannel > -1;\n\n    if (forTextureDataUpdate && isTextureForRendering) {\n      this._activeChannel = texture._associatedChannel;\n    }\n\n    var currentTextureBound = this._boundTexturesCache[this._activeChannel];\n\n    if (currentTextureBound !== texture || force) {\n      this._activateCurrentTexture();\n\n      if (texture && texture.isMultiview) {\n        this._gl.bindTexture(target, texture ? texture._colorTextureArray : null);\n      } else {\n        this._gl.bindTexture(target, texture ? texture._webGLTexture : null);\n      }\n\n      this._boundTexturesCache[this._activeChannel] = texture;\n\n      if (texture) {\n        texture._associatedChannel = this._activeChannel;\n      }\n    } else if (forTextureDataUpdate) {\n      wasPreviouslyBound = true;\n\n      this._activateCurrentTexture();\n    }\n\n    if (isTextureForRendering && !forTextureDataUpdate) {\n      this._bindSamplerUniformToChannel(texture._associatedChannel, this._activeChannel);\n    }\n\n    return wasPreviouslyBound;\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._bindTexture = function (channel, texture) {\n    if (channel === undefined) {\n      return;\n    }\n\n    if (texture) {\n      texture._associatedChannel = channel;\n    }\n\n    this._activeChannel = channel;\n    var target = texture ? this._getTextureTarget(texture) : this._gl.TEXTURE_2D;\n\n    this._bindTextureDirectly(target, texture);\n  };\n  /**\r\n   * Unbind all textures from the webGL context\r\n   */\n\n\n  ThinEngine.prototype.unbindAllTextures = function () {\n    for (var channel = 0; channel < this._maxSimultaneousTextures; channel++) {\n      this._activeChannel = channel;\n\n      this._bindTextureDirectly(this._gl.TEXTURE_2D, null);\n\n      this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP, null);\n\n      if (this.webGLVersion > 1) {\n        this._bindTextureDirectly(this._gl.TEXTURE_3D, null);\n\n        this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY, null);\n      }\n    }\n  };\n  /**\r\n   * Sets a texture to the according uniform.\r\n   * @param channel The texture channel\r\n   * @param uniform The uniform to set\r\n   * @param texture The texture to apply\r\n   */\n\n\n  ThinEngine.prototype.setTexture = function (channel, uniform, texture) {\n    if (channel === undefined) {\n      return;\n    }\n\n    if (uniform) {\n      this._boundUniforms[channel] = uniform;\n    }\n\n    this._setTexture(channel, texture);\n  };\n\n  ThinEngine.prototype._bindSamplerUniformToChannel = function (sourceSlot, destination) {\n    var uniform = this._boundUniforms[sourceSlot];\n\n    if (!uniform || uniform._currentState === destination) {\n      return;\n    }\n\n    this._gl.uniform1i(uniform, destination);\n\n    uniform._currentState = destination;\n  };\n\n  ThinEngine.prototype._getTextureWrapMode = function (mode) {\n    switch (mode) {\n      case 1:\n        return this._gl.REPEAT;\n\n      case 0:\n        return this._gl.CLAMP_TO_EDGE;\n\n      case 2:\n        return this._gl.MIRRORED_REPEAT;\n    }\n\n    return this._gl.REPEAT;\n  };\n\n  ThinEngine.prototype._setTexture = function (channel, texture, isPartOfTextureArray, depthStencilTexture) {\n    if (isPartOfTextureArray === void 0) {\n      isPartOfTextureArray = false;\n    }\n\n    if (depthStencilTexture === void 0) {\n      depthStencilTexture = false;\n    } // Not ready?\n\n\n    if (!texture) {\n      if (this._boundTexturesCache[channel] != null) {\n        this._activeChannel = channel;\n\n        this._bindTextureDirectly(this._gl.TEXTURE_2D, null);\n\n        this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP, null);\n\n        if (this.webGLVersion > 1) {\n          this._bindTextureDirectly(this._gl.TEXTURE_3D, null);\n\n          this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY, null);\n        }\n      }\n\n      return false;\n    } // Video\n\n\n    if (texture.video) {\n      this._activeChannel = channel;\n      texture.update();\n    } else if (texture.delayLoadState === 4) {\n      // Delay loading\n      texture.delayLoad();\n      return false;\n    }\n\n    var internalTexture;\n\n    if (depthStencilTexture) {\n      internalTexture = texture.depthStencilTexture;\n    } else if (texture.isReady()) {\n      internalTexture = texture.getInternalTexture();\n    } else if (texture.isCube) {\n      internalTexture = this.emptyCubeTexture;\n    } else if (texture.is3D) {\n      internalTexture = this.emptyTexture3D;\n    } else if (texture.is2DArray) {\n      internalTexture = this.emptyTexture2DArray;\n    } else {\n      internalTexture = this.emptyTexture;\n    }\n\n    if (!isPartOfTextureArray && internalTexture) {\n      internalTexture._associatedChannel = channel;\n    }\n\n    var needToBind = true;\n\n    if (this._boundTexturesCache[channel] === internalTexture) {\n      if (!isPartOfTextureArray) {\n        this._bindSamplerUniformToChannel(internalTexture._associatedChannel, channel);\n      }\n\n      needToBind = false;\n    }\n\n    this._activeChannel = channel;\n\n    var target = this._getTextureTarget(internalTexture);\n\n    if (needToBind) {\n      this._bindTextureDirectly(target, internalTexture, isPartOfTextureArray);\n    }\n\n    if (internalTexture && !internalTexture.isMultiview) {\n      // CUBIC_MODE and SKYBOX_MODE both require CLAMP_TO_EDGE.  All other modes use REPEAT.\n      if (internalTexture.isCube && internalTexture._cachedCoordinatesMode !== texture.coordinatesMode) {\n        internalTexture._cachedCoordinatesMode = texture.coordinatesMode;\n        var textureWrapMode = texture.coordinatesMode !== 3 && texture.coordinatesMode !== 5 ? 1 : 0;\n        texture.wrapU = textureWrapMode;\n        texture.wrapV = textureWrapMode;\n      }\n\n      if (internalTexture._cachedWrapU !== texture.wrapU) {\n        internalTexture._cachedWrapU = texture.wrapU;\n\n        this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_S, this._getTextureWrapMode(texture.wrapU), internalTexture);\n      }\n\n      if (internalTexture._cachedWrapV !== texture.wrapV) {\n        internalTexture._cachedWrapV = texture.wrapV;\n\n        this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_T, this._getTextureWrapMode(texture.wrapV), internalTexture);\n      }\n\n      if (internalTexture.is3D && internalTexture._cachedWrapR !== texture.wrapR) {\n        internalTexture._cachedWrapR = texture.wrapR;\n\n        this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_R, this._getTextureWrapMode(texture.wrapR), internalTexture);\n      }\n\n      this._setAnisotropicLevel(target, internalTexture, texture.anisotropicFilteringLevel);\n    }\n\n    return true;\n  };\n  /**\r\n   * Sets an array of texture to the webGL context\r\n   * @param channel defines the channel where the texture array must be set\r\n   * @param uniform defines the associated uniform location\r\n   * @param textures defines the array of textures to bind\r\n   */\n\n\n  ThinEngine.prototype.setTextureArray = function (channel, uniform, textures) {\n    if (channel === undefined || !uniform) {\n      return;\n    }\n\n    if (!this._textureUnits || this._textureUnits.length !== textures.length) {\n      this._textureUnits = new Int32Array(textures.length);\n    }\n\n    for (var i = 0; i < textures.length; i++) {\n      var texture = textures[i].getInternalTexture();\n\n      if (texture) {\n        this._textureUnits[i] = channel + i;\n        texture._associatedChannel = channel + i;\n      } else {\n        this._textureUnits[i] = -1;\n      }\n    }\n\n    this._gl.uniform1iv(uniform, this._textureUnits);\n\n    for (var index = 0; index < textures.length; index++) {\n      this._setTexture(this._textureUnits[index], textures[index], true);\n    }\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._setAnisotropicLevel = function (target, internalTexture, anisotropicFilteringLevel) {\n    var anisotropicFilterExtension = this._caps.textureAnisotropicFilterExtension;\n\n    if (internalTexture.samplingMode !== 11 && internalTexture.samplingMode !== 3 && internalTexture.samplingMode !== 2) {\n      anisotropicFilteringLevel = 1; // Forcing the anisotropic to 1 because else webgl will force filters to linear\n    }\n\n    if (anisotropicFilterExtension && internalTexture._cachedAnisotropicFilteringLevel !== anisotropicFilteringLevel) {\n      this._setTextureParameterFloat(target, anisotropicFilterExtension.TEXTURE_MAX_ANISOTROPY_EXT, Math.min(anisotropicFilteringLevel, this._caps.maxAnisotropy), internalTexture);\n\n      internalTexture._cachedAnisotropicFilteringLevel = anisotropicFilteringLevel;\n    }\n  };\n\n  ThinEngine.prototype._setTextureParameterFloat = function (target, parameter, value, texture) {\n    this._bindTextureDirectly(target, texture, true, true);\n\n    this._gl.texParameterf(target, parameter, value);\n  };\n\n  ThinEngine.prototype._setTextureParameterInteger = function (target, parameter, value, texture) {\n    if (texture) {\n      this._bindTextureDirectly(target, texture, true, true);\n    }\n\n    this._gl.texParameteri(target, parameter, value);\n  };\n  /**\r\n   * Unbind all vertex attributes from the webGL context\r\n   */\n\n\n  ThinEngine.prototype.unbindAllAttributes = function () {\n    if (this._mustWipeVertexAttributes) {\n      this._mustWipeVertexAttributes = false;\n\n      for (var i = 0; i < this._caps.maxVertexAttribs; i++) {\n        this.disableAttributeByIndex(i);\n      }\n\n      return;\n    }\n\n    for (var i = 0, ul = this._vertexAttribArraysEnabled.length; i < ul; i++) {\n      if (i >= this._caps.maxVertexAttribs || !this._vertexAttribArraysEnabled[i]) {\n        continue;\n      }\n\n      this.disableAttributeByIndex(i);\n    }\n  };\n  /**\r\n   * Force the engine to release all cached effects. This means that next effect compilation will have to be done completely even if a similar effect was already compiled\r\n   */\n\n\n  ThinEngine.prototype.releaseEffects = function () {\n    for (var name in this._compiledEffects) {\n      var webGLPipelineContext = this._compiledEffects[name].getPipelineContext();\n\n      this._deletePipelineContext(webGLPipelineContext);\n    }\n\n    this._compiledEffects = {};\n  };\n  /**\r\n   * Dispose and release all associated resources\r\n   */\n\n\n  ThinEngine.prototype.dispose = function () {\n    this.stopRenderLoop(); // Clear observables\n\n    if (this.onBeforeTextureInitObservable) {\n      this.onBeforeTextureInitObservable.clear();\n    } // Empty texture\n\n\n    if (this._emptyTexture) {\n      this._releaseTexture(this._emptyTexture);\n\n      this._emptyTexture = null;\n    }\n\n    if (this._emptyCubeTexture) {\n      this._releaseTexture(this._emptyCubeTexture);\n\n      this._emptyCubeTexture = null;\n    }\n\n    if (this._dummyFramebuffer) {\n      this._gl.deleteFramebuffer(this._dummyFramebuffer);\n    } // Release effects\n\n\n    this.releaseEffects(); // Unbind\n\n    this.unbindAllAttributes();\n    this._boundUniforms = []; // Events\n\n    if (DomManagement.IsWindowObjectExist()) {\n      if (this._renderingCanvas) {\n        if (!this._doNotHandleContextLost) {\n          this._renderingCanvas.removeEventListener(\"webglcontextlost\", this._onContextLost);\n\n          this._renderingCanvas.removeEventListener(\"webglcontextrestored\", this._onContextRestored);\n        }\n      }\n    }\n\n    this._workingCanvas = null;\n    this._workingContext = null;\n    this._currentBufferPointers = [];\n    this._renderingCanvas = null;\n    this._currentProgram = null;\n    this._boundRenderFunction = null;\n    Effect.ResetCache(); // Abort active requests\n\n    for (var _i = 0, _a = this._activeRequests; _i < _a.length; _i++) {\n      var request = _a[_i];\n      request.abort();\n    }\n  };\n  /**\r\n   * Attach a new callback raised when context lost event is fired\r\n   * @param callback defines the callback to call\r\n   */\n\n\n  ThinEngine.prototype.attachContextLostEvent = function (callback) {\n    if (this._renderingCanvas) {\n      this._renderingCanvas.addEventListener(\"webglcontextlost\", callback, false);\n    }\n  };\n  /**\r\n   * Attach a new callback raised when context restored event is fired\r\n   * @param callback defines the callback to call\r\n   */\n\n\n  ThinEngine.prototype.attachContextRestoredEvent = function (callback) {\n    if (this._renderingCanvas) {\n      this._renderingCanvas.addEventListener(\"webglcontextrestored\", callback, false);\n    }\n  };\n  /**\r\n   * Get the current error code of the webGL context\r\n   * @returns the error code\r\n   * @see https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/getError\r\n   */\n\n\n  ThinEngine.prototype.getError = function () {\n    return this._gl.getError();\n  };\n\n  ThinEngine.prototype._canRenderToFloatFramebuffer = function () {\n    if (this._webGLVersion > 1) {\n      return this._caps.colorBufferFloat;\n    }\n\n    return this._canRenderToFramebuffer(1);\n  };\n\n  ThinEngine.prototype._canRenderToHalfFloatFramebuffer = function () {\n    if (this._webGLVersion > 1) {\n      return this._caps.colorBufferFloat;\n    }\n\n    return this._canRenderToFramebuffer(2);\n  }; // Thank you : http://stackoverflow.com/questions/28827511/webgl-ios-render-to-floating-point-texture\n\n\n  ThinEngine.prototype._canRenderToFramebuffer = function (type) {\n    var gl = this._gl; //clear existing errors\n\n    while (gl.getError() !== gl.NO_ERROR) {}\n\n    var successful = true;\n    var texture = gl.createTexture();\n    gl.bindTexture(gl.TEXTURE_2D, texture);\n    gl.texImage2D(gl.TEXTURE_2D, 0, this._getRGBABufferInternalSizedFormat(type), 1, 1, 0, gl.RGBA, this._getWebGLTextureType(type), null);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\n    gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\n    var fb = gl.createFramebuffer();\n    gl.bindFramebuffer(gl.FRAMEBUFFER, fb);\n    gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture, 0);\n    var status = gl.checkFramebufferStatus(gl.FRAMEBUFFER);\n    successful = successful && status === gl.FRAMEBUFFER_COMPLETE;\n    successful = successful && gl.getError() === gl.NO_ERROR; //try render by clearing frame buffer's color buffer\n\n    if (successful) {\n      gl.clear(gl.COLOR_BUFFER_BIT);\n      successful = successful && gl.getError() === gl.NO_ERROR;\n    } //try reading from frame to ensure render occurs (just creating the FBO is not sufficient to determine if rendering is supported)\n\n\n    if (successful) {\n      //in practice it's sufficient to just read from the backbuffer rather than handle potentially issues reading from the texture\n      gl.bindFramebuffer(gl.FRAMEBUFFER, null);\n      var readFormat = gl.RGBA;\n      var readType = gl.UNSIGNED_BYTE;\n      var buffer = new Uint8Array(4);\n      gl.readPixels(0, 0, 1, 1, readFormat, readType, buffer);\n      successful = successful && gl.getError() === gl.NO_ERROR;\n    } //clean up\n\n\n    gl.deleteTexture(texture);\n    gl.deleteFramebuffer(fb);\n    gl.bindFramebuffer(gl.FRAMEBUFFER, null); //clear accumulated errors\n\n    while (!successful && gl.getError() !== gl.NO_ERROR) {}\n\n    return successful;\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._getWebGLTextureType = function (type) {\n    if (this._webGLVersion === 1) {\n      switch (type) {\n        case 1:\n          return this._gl.FLOAT;\n\n        case 2:\n          return this._gl.HALF_FLOAT_OES;\n\n        case 0:\n          return this._gl.UNSIGNED_BYTE;\n\n        case 8:\n          return this._gl.UNSIGNED_SHORT_4_4_4_4;\n\n        case 9:\n          return this._gl.UNSIGNED_SHORT_5_5_5_1;\n\n        case 10:\n          return this._gl.UNSIGNED_SHORT_5_6_5;\n      }\n\n      return this._gl.UNSIGNED_BYTE;\n    }\n\n    switch (type) {\n      case 3:\n        return this._gl.BYTE;\n\n      case 0:\n        return this._gl.UNSIGNED_BYTE;\n\n      case 4:\n        return this._gl.SHORT;\n\n      case 5:\n        return this._gl.UNSIGNED_SHORT;\n\n      case 6:\n        return this._gl.INT;\n\n      case 7:\n        // Refers to UNSIGNED_INT\n        return this._gl.UNSIGNED_INT;\n\n      case 1:\n        return this._gl.FLOAT;\n\n      case 2:\n        return this._gl.HALF_FLOAT;\n\n      case 8:\n        return this._gl.UNSIGNED_SHORT_4_4_4_4;\n\n      case 9:\n        return this._gl.UNSIGNED_SHORT_5_5_5_1;\n\n      case 10:\n        return this._gl.UNSIGNED_SHORT_5_6_5;\n\n      case 11:\n        return this._gl.UNSIGNED_INT_2_10_10_10_REV;\n\n      case 12:\n        return this._gl.UNSIGNED_INT_24_8;\n\n      case 13:\n        return this._gl.UNSIGNED_INT_10F_11F_11F_REV;\n\n      case 14:\n        return this._gl.UNSIGNED_INT_5_9_9_9_REV;\n\n      case 15:\n        return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV;\n    }\n\n    return this._gl.UNSIGNED_BYTE;\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._getInternalFormat = function (format) {\n    var internalFormat = this._gl.RGBA;\n\n    switch (format) {\n      case 0:\n        internalFormat = this._gl.ALPHA;\n        break;\n\n      case 1:\n        internalFormat = this._gl.LUMINANCE;\n        break;\n\n      case 2:\n        internalFormat = this._gl.LUMINANCE_ALPHA;\n        break;\n\n      case 6:\n        internalFormat = this._gl.RED;\n        break;\n\n      case 7:\n        internalFormat = this._gl.RG;\n        break;\n\n      case 4:\n        internalFormat = this._gl.RGB;\n        break;\n\n      case 5:\n        internalFormat = this._gl.RGBA;\n        break;\n    }\n\n    if (this._webGLVersion > 1) {\n      switch (format) {\n        case 8:\n          internalFormat = this._gl.RED_INTEGER;\n          break;\n\n        case 9:\n          internalFormat = this._gl.RG_INTEGER;\n          break;\n\n        case 10:\n          internalFormat = this._gl.RGB_INTEGER;\n          break;\n\n        case 11:\n          internalFormat = this._gl.RGBA_INTEGER;\n          break;\n      }\n    }\n\n    return internalFormat;\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._getRGBABufferInternalSizedFormat = function (type, format) {\n    if (this._webGLVersion === 1) {\n      if (format !== undefined) {\n        switch (format) {\n          case 0:\n            return this._gl.ALPHA;\n\n          case 1:\n            return this._gl.LUMINANCE;\n\n          case 2:\n            return this._gl.LUMINANCE_ALPHA;\n\n          case 4:\n            return this._gl.RGB;\n        }\n      }\n\n      return this._gl.RGBA;\n    }\n\n    switch (type) {\n      case 3:\n        switch (format) {\n          case 6:\n            return this._gl.R8_SNORM;\n\n          case 7:\n            return this._gl.RG8_SNORM;\n\n          case 4:\n            return this._gl.RGB8_SNORM;\n\n          case 8:\n            return this._gl.R8I;\n\n          case 9:\n            return this._gl.RG8I;\n\n          case 10:\n            return this._gl.RGB8I;\n\n          case 11:\n            return this._gl.RGBA8I;\n\n          default:\n            return this._gl.RGBA8_SNORM;\n        }\n\n      case 0:\n        switch (format) {\n          case 6:\n            return this._gl.R8;\n\n          case 7:\n            return this._gl.RG8;\n\n          case 4:\n            return this._gl.RGB8;\n          // By default. Other possibilities are RGB565, SRGB8.\n\n          case 5:\n            return this._gl.RGBA8;\n          // By default. Other possibilities are RGB5_A1, RGBA4, SRGB8_ALPHA8.\n\n          case 8:\n            return this._gl.R8UI;\n\n          case 9:\n            return this._gl.RG8UI;\n\n          case 10:\n            return this._gl.RGB8UI;\n\n          case 11:\n            return this._gl.RGBA8UI;\n\n          case 0:\n            return this._gl.ALPHA;\n\n          case 1:\n            return this._gl.LUMINANCE;\n\n          case 2:\n            return this._gl.LUMINANCE_ALPHA;\n\n          default:\n            return this._gl.RGBA8;\n        }\n\n      case 4:\n        switch (format) {\n          case 8:\n            return this._gl.R16I;\n\n          case 9:\n            return this._gl.RG16I;\n\n          case 10:\n            return this._gl.RGB16I;\n\n          case 11:\n            return this._gl.RGBA16I;\n\n          default:\n            return this._gl.RGBA16I;\n        }\n\n      case 5:\n        switch (format) {\n          case 8:\n            return this._gl.R16UI;\n\n          case 9:\n            return this._gl.RG16UI;\n\n          case 10:\n            return this._gl.RGB16UI;\n\n          case 11:\n            return this._gl.RGBA16UI;\n\n          default:\n            return this._gl.RGBA16UI;\n        }\n\n      case 6:\n        switch (format) {\n          case 8:\n            return this._gl.R32I;\n\n          case 9:\n            return this._gl.RG32I;\n\n          case 10:\n            return this._gl.RGB32I;\n\n          case 11:\n            return this._gl.RGBA32I;\n\n          default:\n            return this._gl.RGBA32I;\n        }\n\n      case 7:\n        // Refers to UNSIGNED_INT\n        switch (format) {\n          case 8:\n            return this._gl.R32UI;\n\n          case 9:\n            return this._gl.RG32UI;\n\n          case 10:\n            return this._gl.RGB32UI;\n\n          case 11:\n            return this._gl.RGBA32UI;\n\n          default:\n            return this._gl.RGBA32UI;\n        }\n\n      case 1:\n        switch (format) {\n          case 6:\n            return this._gl.R32F;\n          // By default. Other possibility is R16F.\n\n          case 7:\n            return this._gl.RG32F;\n          // By default. Other possibility is RG16F.\n\n          case 4:\n            return this._gl.RGB32F;\n          // By default. Other possibilities are RGB16F, R11F_G11F_B10F, RGB9_E5.\n\n          case 5:\n            return this._gl.RGBA32F;\n          // By default. Other possibility is RGBA16F.\n\n          default:\n            return this._gl.RGBA32F;\n        }\n\n      case 2:\n        switch (format) {\n          case 6:\n            return this._gl.R16F;\n\n          case 7:\n            return this._gl.RG16F;\n\n          case 4:\n            return this._gl.RGB16F;\n          // By default. Other possibilities are R11F_G11F_B10F, RGB9_E5.\n\n          case 5:\n            return this._gl.RGBA16F;\n\n          default:\n            return this._gl.RGBA16F;\n        }\n\n      case 10:\n        return this._gl.RGB565;\n\n      case 13:\n        return this._gl.R11F_G11F_B10F;\n\n      case 14:\n        return this._gl.RGB9_E5;\n\n      case 8:\n        return this._gl.RGBA4;\n\n      case 9:\n        return this._gl.RGB5_A1;\n\n      case 11:\n        switch (format) {\n          case 5:\n            return this._gl.RGB10_A2;\n          // By default. Other possibility is RGB5_A1.\n\n          case 11:\n            return this._gl.RGB10_A2UI;\n\n          default:\n            return this._gl.RGB10_A2;\n        }\n\n    }\n\n    return this._gl.RGBA8;\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._getRGBAMultiSampleBufferFormat = function (type) {\n    if (type === 1) {\n      return this._gl.RGBA32F;\n    } else if (type === 2) {\n      return this._gl.RGBA16F;\n    }\n\n    return this._gl.RGBA8;\n  };\n  /** @hidden */\n\n\n  ThinEngine.prototype._loadFile = function (url, onSuccess, onProgress, offlineProvider, useArrayBuffer, onError) {\n    var _this = this;\n\n    var request = ThinEngine._FileToolsLoadFile(url, onSuccess, onProgress, offlineProvider, useArrayBuffer, onError);\n\n    this._activeRequests.push(request);\n\n    request.onCompleteObservable.add(function (request) {\n      _this._activeRequests.splice(_this._activeRequests.indexOf(request), 1);\n    });\n    return request;\n  };\n  /**\r\n   * Loads a file from a url\r\n   * @param url url to load\r\n   * @param onSuccess callback called when the file successfully loads\r\n   * @param onProgress callback called while file is loading (if the server supports this mode)\r\n   * @param offlineProvider defines the offline provider for caching\r\n   * @param useArrayBuffer defines a boolean indicating that date must be returned as ArrayBuffer\r\n   * @param onError callback called when the file fails to load\r\n   * @returns a file request object\r\n   * @hidden\r\n   */\n\n\n  ThinEngine._FileToolsLoadFile = function (url, onSuccess, onProgress, offlineProvider, useArrayBuffer, onError) {\n    throw _DevTools.WarnImport(\"FileTools\");\n  };\n  /**\r\n   * Reads pixels from the current frame buffer. Please note that this function can be slow\r\n   * @param x defines the x coordinate of the rectangle where pixels must be read\r\n   * @param y defines the y coordinate of the rectangle where pixels must be read\r\n   * @param width defines the width of the rectangle where pixels must be read\r\n   * @param height defines the height of the rectangle where pixels must be read\r\n   * @param hasAlpha defines whether the output should have alpha or not (defaults to true)\r\n   * @returns a Uint8Array containing RGBA colors\r\n   */\n\n\n  ThinEngine.prototype.readPixels = function (x, y, width, height, hasAlpha) {\n    if (hasAlpha === void 0) {\n      hasAlpha = true;\n    }\n\n    var numChannels = hasAlpha ? 4 : 3;\n    var format = hasAlpha ? this._gl.RGBA : this._gl.RGB;\n    var data = new Uint8Array(height * width * numChannels);\n\n    this._gl.readPixels(x, y, width, height, format, this._gl.UNSIGNED_BYTE, data);\n\n    return data;\n  };\n\n  Object.defineProperty(ThinEngine, \"IsSupported\", {\n    /**\r\n     * Gets a boolean indicating if the engine can be instanciated (ie. if a webGL context can be found)\r\n     */\n    get: function () {\n      return this.isSupported(); // Backward compat\n    },\n    enumerable: false,\n    configurable: true\n  });\n  /**\r\n   * Gets a boolean indicating if the engine can be instanciated (ie. if a webGL context can be found)\r\n   * @returns true if the engine can be created\r\n   * @ignorenaming\r\n   */\n\n  ThinEngine.isSupported = function () {\n    if (this._HasMajorPerformanceCaveat !== null) {\n      return !this._HasMajorPerformanceCaveat; // We know it is performant so WebGL is supported\n    }\n\n    if (this._IsSupported === null) {\n      try {\n        var tempcanvas = CanvasGenerator.CreateCanvas(1, 1);\n        var gl = tempcanvas.getContext(\"webgl\") || tempcanvas.getContext(\"experimental-webgl\");\n        this._IsSupported = gl != null && !!window.WebGLRenderingContext;\n      } catch (e) {\n        this._IsSupported = false;\n      }\n    }\n\n    return this._IsSupported;\n  };\n\n  Object.defineProperty(ThinEngine, \"HasMajorPerformanceCaveat\", {\n    /**\r\n     * Gets a boolean indicating if the engine can be instanciated on a performant device (ie. if a webGL context can be found and it does not use a slow implementation)\r\n     */\n    get: function () {\n      if (this._HasMajorPerformanceCaveat === null) {\n        try {\n          var tempcanvas = CanvasGenerator.CreateCanvas(1, 1);\n          var gl = tempcanvas.getContext(\"webgl\", {\n            failIfMajorPerformanceCaveat: true\n          }) || tempcanvas.getContext(\"experimental-webgl\", {\n            failIfMajorPerformanceCaveat: true\n          });\n          this._HasMajorPerformanceCaveat = !gl;\n        } catch (e) {\n          this._HasMajorPerformanceCaveat = false;\n        }\n      }\n\n      return this._HasMajorPerformanceCaveat;\n    },\n    enumerable: false,\n    configurable: true\n  });\n  /**\r\n   * Find the next highest power of two.\r\n   * @param x Number to start search from.\r\n   * @return Next highest power of two.\r\n   */\n\n  ThinEngine.CeilingPOT = function (x) {\n    x--;\n    x |= x >> 1;\n    x |= x >> 2;\n    x |= x >> 4;\n    x |= x >> 8;\n    x |= x >> 16;\n    x++;\n    return x;\n  };\n  /**\r\n   * Find the next lowest power of two.\r\n   * @param x Number to start search from.\r\n   * @return Next lowest power of two.\r\n   */\n\n\n  ThinEngine.FloorPOT = function (x) {\n    x = x | x >> 1;\n    x = x | x >> 2;\n    x = x | x >> 4;\n    x = x | x >> 8;\n    x = x | x >> 16;\n    return x - (x >> 1);\n  };\n  /**\r\n   * Find the nearest power of two.\r\n   * @param x Number to start search from.\r\n   * @return Next nearest power of two.\r\n   */\n\n\n  ThinEngine.NearestPOT = function (x) {\n    var c = ThinEngine.CeilingPOT(x);\n    var f = ThinEngine.FloorPOT(x);\n    return c - x > x - f ? f : c;\n  };\n  /**\r\n   * Get the closest exponent of two\r\n   * @param value defines the value to approximate\r\n   * @param max defines the maximum value to return\r\n   * @param mode defines how to define the closest value\r\n   * @returns closest exponent of two of the given value\r\n   */\n\n\n  ThinEngine.GetExponentOfTwo = function (value, max, mode) {\n    if (mode === void 0) {\n      mode = 2;\n    }\n\n    var pot;\n\n    switch (mode) {\n      case 1:\n        pot = ThinEngine.FloorPOT(value);\n        break;\n\n      case 2:\n        pot = ThinEngine.NearestPOT(value);\n        break;\n\n      case 3:\n      default:\n        pot = ThinEngine.CeilingPOT(value);\n        break;\n    }\n\n    return Math.min(pot, max);\n  };\n  /**\r\n   * Queue a new function into the requested animation frame pool (ie. this function will be executed byt the browser for the next frame)\r\n   * @param func - the function to be called\r\n   * @param requester - the object that will request the next frame. Falls back to window.\r\n   * @returns frame number\r\n   */\n\n\n  ThinEngine.QueueNewFrame = function (func, requester) {\n    if (!DomManagement.IsWindowObjectExist()) {\n      if (typeof requestAnimationFrame !== \"undefined\") {\n        return requestAnimationFrame(func);\n      }\n\n      return setTimeout(func, 16);\n    }\n\n    if (!requester) {\n      requester = window;\n    }\n\n    if (requester.requestPostAnimationFrame) {\n      return requester.requestPostAnimationFrame(func);\n    } else if (requester.requestAnimationFrame) {\n      return requester.requestAnimationFrame(func);\n    } else if (requester.msRequestAnimationFrame) {\n      return requester.msRequestAnimationFrame(func);\n    } else if (requester.webkitRequestAnimationFrame) {\n      return requester.webkitRequestAnimationFrame(func);\n    } else if (requester.mozRequestAnimationFrame) {\n      return requester.mozRequestAnimationFrame(func);\n    } else if (requester.oRequestAnimationFrame) {\n      return requester.oRequestAnimationFrame(func);\n    } else {\n      return window.setTimeout(func, 16);\n    }\n  };\n  /**\r\n   * Gets host document\r\n   * @returns the host document object\r\n   */\n\n\n  ThinEngine.prototype.getHostDocument = function () {\n    if (this._renderingCanvas && this._renderingCanvas.ownerDocument) {\n      return this._renderingCanvas.ownerDocument;\n    }\n\n    return document;\n  };\n  /** Use this array to turn off some WebGL2 features on known buggy browsers version */\n\n\n  ThinEngine.ExceptionList = [{\n    key: \"Chrome\\/63\\.0\",\n    capture: \"63\\\\.0\\\\.3239\\\\.(\\\\d+)\",\n    captureConstraint: 108,\n    targets: [\"uniformBuffer\"]\n  }, {\n    key: \"Firefox\\/58\",\n    capture: null,\n    captureConstraint: null,\n    targets: [\"uniformBuffer\"]\n  }, {\n    key: \"Firefox\\/59\",\n    capture: null,\n    captureConstraint: null,\n    targets: [\"uniformBuffer\"]\n  }, {\n    key: \"Chrome\\/72.+?Mobile\",\n    capture: null,\n    captureConstraint: null,\n    targets: [\"vao\"]\n  }, {\n    key: \"Chrome\\/73.+?Mobile\",\n    capture: null,\n    captureConstraint: null,\n    targets: [\"vao\"]\n  }, {\n    key: \"Chrome\\/74.+?Mobile\",\n    capture: null,\n    captureConstraint: null,\n    targets: [\"vao\"]\n  }, {\n    key: \"Mac OS.+Chrome\\/71\",\n    capture: null,\n    captureConstraint: null,\n    targets: [\"vao\"]\n  }, {\n    key: \"Mac OS.+Chrome\\/72\",\n    capture: null,\n    captureConstraint: null,\n    targets: [\"vao\"]\n  }];\n  /** @hidden */\n\n  ThinEngine._TextureLoaders = []; // Updatable statics so stick with vars here\n\n  /**\r\n   * Gets or sets the epsilon value used by collision engine\r\n   */\n\n  ThinEngine.CollisionsEpsilon = 0.001; // Statics\n\n  ThinEngine._IsSupported = null;\n  ThinEngine._HasMajorPerformanceCaveat = null;\n  return ThinEngine;\n}();\n\nexport { ThinEngine };","map":{"version":3,"sources":["C:/Users/rober/Documents/Computer Science/Side Projects/arcade/node_modules/@babylonjs/core/Engines/thinEngine.js"],"names":["EngineStore","Effect","_DevTools","Observable","DepthCullingState","StencilState","AlphaState","InternalTexture","InternalTextureSource","Logger","DomManagement","WebGLShaderProcessor","WebGL2ShaderProcessor","WebGLDataBuffer","WebGLPipelineContext","CanvasGenerator","PerformanceConfigurator","BufferPointer","ThinEngine","canvasOrContext","antialias","options","adaptToDeviceRatio","_this","forcePOTTextures","isFullscreen","cullBackFaces","renderEvenInBackground","preventCacheWipeBetweenFrames","validateShaderPrograms","useReverseDepthBuffer","disableUniformBuffers","_uniformBuffers","Array","_webGLVersion","_windowIsBackground","_highPrecisionShadersAllowed","_badOS","_badDesktopOS","_renderingQueueLaunched","_activeRenderLoops","onContextLostObservable","onContextRestoredObservable","_contextWasLost","_doNotHandleContextLost","disableVertexArrayObjects","_colorWrite","_colorWriteChanged","_depthCullingState","_stencilState","_alphaState","_alphaMode","_alphaEquation","_internalTexturesCache","_activeChannel","_currentTextureChannel","_boundTexturesCache","_compiledEffects","_vertexAttribArraysEnabled","_uintIndicesCurrentlySet","_currentBoundBuffer","_currentFramebuffer","_dummyFramebuffer","_currentBufferPointers","_currentInstanceLocations","_currentInstanceBuffers","_vaoRecordInProgress","_mustWipeVertexAttributes","_nextFreeTextureSlots","_maxSimultaneousTextures","_activeRequests","_transformTextureUrl","hostInformation","isMobile","premultipliedAlpha","onBeforeTextureInitObservable","_viewportCached","x","y","z","w","_unpackFlipYCached","enableUnpackFlipYCached","_getDepthStencilBuffer","width","height","samples","internalFormat","msInternalFormat","attachment","gl","_gl","depthStencilBuffer","createRenderbuffer","bindRenderbuffer","RENDERBUFFER","renderbufferStorageMultisample","renderbufferStorage","framebufferRenderbuffer","FRAMEBUFFER","_boundUniforms","canvas","SetMatrixPrecision","useHighPrecisionMatrix","getContext","_renderingCanvas","deterministicLockstep","undefined","lockstepMaxSteps","timeStep","preserveDrawingBuffer","audioEngine","stencil","xrCompatible","doNotHandleContextLost","navigator","userAgent","ua","indexOf","_i","_a","ExceptionList","length","exception","key","targets","check","RegExp","test","capture","captureConstraint","constraint","regex","matches","exec","capturedValue","parseInt","_b","targets_1","target","_onContextLost","evt","preventDefault","Warn","notifyObservers","_onContextRestored","setTimeout","_initGLContext","_rebuildEffects","_rebuildInternalTextures","_rebuildBuffers","wipeCaches","addEventListener","powerPreference","disableWebGL2Support","deleteQuery","e","Error","attributes","getContextAttributes","pixelStorei","UNPACK_COLORSPACE_CONVERSION_WEBGL","NONE","useHighPrecisionFloats","devicePixelRatio","IsWindowObjectExist","window","limitDeviceRatio","_hardwareScalingLevel","Math","min","resize","_isStencilEnable","i","_caps","maxVertexAttribs","webGLVersion","_shaderProcessor","_creationOptions","console","log","Version","description","Object","defineProperty","get","enumerable","configurable","prototype","parallelShaderCompile","ShadersRepository","set","value","highPrecisionShaderSupported","dimensions","_framebufferDimensionsObject","_cachedViewport","_emptyTexture","createRawTexture","Uint8Array","_emptyTexture3D","createRawTexture3D","_emptyTexture2DArray","createRawTexture2DArray","_emptyCubeTexture","faceData","cubeData","createRawCubeTexture","currentState","slice","currentState_1","internalTexture","_rebuild","effect","_prepareEffect","ResetCache","areAllEffectsReady","isReady","uniformBuffer","maxTexturesImageUnits","getParameter","MAX_TEXTURE_IMAGE_UNITS","maxCombinedTexturesImageUnits","MAX_COMBINED_TEXTURE_IMAGE_UNITS","maxVertexTextureImageUnits","MAX_VERTEX_TEXTURE_IMAGE_UNITS","maxTextureSize","MAX_TEXTURE_SIZE","maxSamples","MAX_SAMPLES","maxCubemapTextureSize","MAX_CUBE_MAP_TEXTURE_SIZE","maxRenderTextureSize","MAX_RENDERBUFFER_SIZE","MAX_VERTEX_ATTRIBS","maxVaryingVectors","MAX_VARYING_VECTORS","maxFragmentUniformVectors","MAX_FRAGMENT_UNIFORM_VECTORS","maxVertexUniformVectors","MAX_VERTEX_UNIFORM_VECTORS","getExtension","standardDerivatives","maxAnisotropy","astc","bptc","s3tc","pvrtc","etc1","etc2","textureAnisotropicFilterExtension","uintIndices","fragmentDepthSupported","timerQuery","canUseTimestampForTimerQuery","drawBuffersExtension","maxMSAASamples","colorBufferFloat","textureFloat","textureHalfFloat","textureHalfFloatRender","textureFloatLinearFiltering","textureFloatRender","textureHalfFloatLinearFiltering","vertexArrayObject","instancedArrays","textureLOD","blendMinMax","multiview","oculusMultiview","depthTextureExtension","_glVersion","VERSION","rendererInfo","_glRenderer","UNMASKED_RENDERER_WEBGL","_glVendor","UNMASKED_VENDOR_WEBGL","HALF_FLOAT_OES","RGBA16F","RGBA32F","DEPTH24_STENCIL8","getQuery","getQueryEXT","bind","TIMESTAMP_EXT","QUERY_COUNTER_BITS_EXT","MAX_TEXTURE_MAX_ANISOTROPY_EXT","_canRenderToFloatFramebuffer","_canRenderToHalfFloatFramebuffer","drawBuffers","drawBuffersWEBGL","DRAW_FRAMEBUFFER","UNSIGNED_INT_24_8","UNSIGNED_INT_24_8_WEBGL","vertexArrayObjectExtension","createVertexArray","createVertexArrayOES","bindVertexArray","bindVertexArrayOES","deleteVertexArray","deleteVertexArrayOES","instanceExtension","drawArraysInstanced","drawArraysInstancedANGLE","drawElementsInstanced","drawElementsInstancedANGLE","vertexAttribDivisor","vertexAttribDivisorANGLE","getShaderPrecisionFormat","vertex_highp","VERTEX_SHADER","HIGH_FLOAT","fragment_highp","FRAGMENT_SHADER","precision","blendMinMaxExtension","MAX","MAX_EXT","MIN","MIN_EXT","depthTest","depthFunc","LEQUAL","depthMask","slot","push","getClassName","_prepareWorkingCanvas","_workingCanvas","CreateCanvas","context","_workingContext","resetTextureCache","hasOwnProperty","getGlInfo","vendor","renderer","version","setHardwareScalingLevel","level","getHardwareScalingLevel","getLoadedTexturesCache","getCaps","stopRenderLoop","renderFunction","index","splice","_renderLoop","shouldRender","beginFrame","endFrame","_frameHandler","_queueNewFrame","_boundRenderFunction","getHostWindow","getRenderingCanvas","ownerDocument","defaultView","getRenderWidth","useScreen","_currentRenderTarget","framebufferWidth","drawingBufferWidth","getRenderHeight","framebufferHeight","drawingBufferHeight","bindedRenderFunction","requester","QueueNewFrame","runRenderLoop","clear","color","backBuffer","depth","applyStates","mode","clearColor","r","g","b","a","COLOR_BUFFER_BIT","GREATER","clearDepth","DEPTH_BUFFER_BIT","clearStencil","STENCIL_BUFFER_BIT","_viewport","viewport","setViewport","requiredWidth","requiredHeight","flushFramebuffer","clientWidth","innerWidth","clientHeight","innerHeight","setSize","bindFramebuffer","texture","faceIndex","forceFullscreenViewport","lodLevel","layer","unBindFramebuffer","_bindUnboundFramebuffer","_MSAAFramebuffer","_framebuffer","is2DArray","framebufferTextureLayer","COLOR_ATTACHMENT0","_webGLTexture","isCube","framebufferTexture2D","TEXTURE_CUBE_MAP_POSITIVE_X","depthStencilTexture","_depthStencilTexture","_generateStencilBuffer","DEPTH_STENCIL_ATTACHMENT","DEPTH_ATTACHMENT","TEXTURE_2D","pow","framebuffer","disableGenerateMipMaps","onBeforeUnbind","_textureArray","unBindMultiColorAttachmentFramebuffer","READ_FRAMEBUFFER","blitFramebuffer","NEAREST","generateMipMaps","_bindTextureDirectly","generateMipmap","flush","restoreDefaultFramebuffer","_resetVertexBufferBinding","bindArrayBuffer","_cachedVertexBuffers","createVertexBuffer","data","_createVertexBuffer","STATIC_DRAW","usage","vbo","createBuffer","dataBuffer","bufferData","ARRAY_BUFFER","Float32Array","references","createDynamicVertexBuffer","DYNAMIC_DRAW","_resetIndexBufferBinding","bindIndexBuffer","_cachedIndexBuffer","createIndexBuffer","indices","updatable","_normalizeIndexData","ELEMENT_ARRAY_BUFFER","is32Bits","BYTES_PER_ELEMENT","Uint16Array","Uint32Array","buffer","_unbindVertexArrayObject","bindBuffer","bindUniformBlock","pipelineContext","blockName","program","uniformLocation","getUniformBlockIndex","uniformBlockBinding","underlyingResource","updateArrayBuffer","bufferSubData","_vertexAttribPointer","indx","size","type","normalized","stride","offset","pointer","changed","active","vertexAttribPointer","_bindIndexBufferWithCache","indexBuffer","_bindVertexBuffersAttributes","vertexBuffers","getAttributesNames","unbindAllAttributes","order","getAttributeLocation","vertexBuffer","enableVertexAttribArray","getBuffer","getSize","byteStride","byteOffset","getIsInstanced","getInstanceDivisor","recordVertexArrayObject","vao","bindVertexArrayObject","_cachedVertexArrayObject","bindBuffersDirectly","vertexDeclaration","vertexStrideSize","_cachedEffectForVertexBuffers","attributesCount","getAttributesCount","FLOAT","bindBuffers","unbindInstanceAttributes","boundBuffer","ul","instancesBuffer","offsetLocation","releaseVertexArrayObject","_releaseBuffer","_deleteBuffer","deleteBuffer","updateAndBindInstancesBuffer","offsetLocations","bindInstancesBuffer","attributesInfo","computeStride","ai","attributeSize","_currentEffect","getAttributeLocationByName","attributeName","attributeType","divisor","disableInstanceAttributeByName","name","attributeLocation","disableInstanceAttribute","shouldClean","disableAttributeByIndex","disableVertexAttribArray","draw","useTriangles","indexStart","indexCount","instancesCount","drawElementsType","drawPointClouds","verticesStart","verticesCount","drawArraysType","drawUnIndexed","fillMode","_reportDrawCall","drawMode","_drawMode","indexFormat","UNSIGNED_INT","UNSIGNED_SHORT","mult","drawElements","drawArrays","TRIANGLES","POINTS","LINES","LINE_LOOP","LINE_STRIP","TRIANGLE_STRIP","TRIANGLE_FAN","_releaseEffect","_key","_deletePipelineContext","getPipelineContext","webGLPipelineContext","__SPECTOR_rebuildProgram","deleteProgram","createEffect","baseName","attributesNamesOrOptions","uniformsNamesOrEngine","samplers","defines","fallbacks","onCompiled","onError","indexParameters","vertex","vertexElement","vertexToken","vertexSource","fragment","fragmentElement","fragmentToken","fragmentSource","compiledEffect","_ConcatenateShader","source","shaderVersion","_compileShader","_compileRawShader","shader","createShader","shaderSource","compileShader","_getShaderSource","getShaderSource","createRawShaderProgram","vertexCode","fragmentCode","transformFeedbackVaryings","vertexShader","fragmentShader","_createShaderProgram","createShaderProgram","createPipelineContext","engine","isParallelCompiled","shaderProgram","createProgram","attachShader","linkProgram","_finalizePipelineContext","linked","getProgramParameter","LINK_STATUS","getShaderParameter","COMPILE_STATUS","getShaderInfoLog","vertexCompilationError","fragmentCompilationError","error","getProgramInfoLog","programLinkError","validateProgram","validated","VALIDATE_STATUS","programValidationError","deleteShader","_preparePipelineContext","vertexSourceCode","fragmentSourceCode","createAsRaw","rebuildRebind","webGLRenderingState","_isRenderingStateCompiled","COMPLETION_STATUS_KHR","_executeWhenRenderingStateIsCompiled","action","oldHandler","getUniforms","uniformsNames","results","getUniformLocation","getAttributes","attributesNames","getAttribLocation","enableEffect","bindSamplers","onBind","_onBindObservable","setInt","uniform","uniform1i","setIntArray","array","uniform1iv","setIntArray2","uniform2iv","setIntArray3","uniform3iv","setIntArray4","uniform4iv","setArray","uniform1fv","setArray2","uniform2fv","setArray3","uniform3fv","setArray4","uniform4fv","setMatrices","matrices","uniformMatrix4fv","setMatrix3x3","matrix","uniformMatrix3fv","setMatrix2x2","uniformMatrix2fv","setFloat","uniform1f","setFloat2","uniform2f","setFloat3","uniform3f","setFloat4","uniform4f","apply","enable","colorMask","setColorWrite","getColorWrite","clearInternalTexturesCache","bruteForce","_currentProgram","reset","UNPACK_PREMULTIPLY_ALPHA_WEBGL","_getSamplingParameters","samplingMode","magFilter","minFilter","LINEAR","LINEAR_MIPMAP_NEAREST","LINEAR_MIPMAP_LINEAR","NEAREST_MIPMAP_LINEAR","NEAREST_MIPMAP_NEAREST","mag","_createTexture","createTexture","url","noMipmap","invertY","scene","onLoad","fallback","format","forcedExtension","mimeType","loaderOptions","fromData","substr","fromBlob","isBase64","Url","originalUrl","_originalUrl","lastDot","lastIndexOf","extension","substring","toLowerCase","loader","queryStringIndex","split","_TextureLoaders","availableLoader","canLoad","_addPendingData","_buffer","onLoadObserver","onLoadedObservable","add","onInternalError","message","_removePendingData","remove","UseFallbackTexture","FallbackTexture","callback_1","loadData","loadMipmap","isCompressed","done","loadFailed","_prepareWebGLTexture","_loadFile","offlineProvider","request","responseURL","ArrayBuffer","isView","onload_1","img","potWidth","potHeight","continuationCallback","isPot","_getInternalFormat","RGB","RGBA","texImage2D","UNSIGNED_BYTE","_supportsHardwareTextureRescaling","drawImage","source_1","Temp","_rescaleTexture","_releaseTexture","decoding","close","_FileToolsLoadImage","Blob","input","WarnImport","destination","onComplete","compression","textureType","_unpackFlipY","UNPACK_FLIP_Y_WEBGL","_getUnpackAlignement","UNPACK_ALIGNMENT","_getTextureTarget","TEXTURE_CUBE_MAP","is3D","TEXTURE_3D","isMultiview","TEXTURE_2D_ARRAY","updateTextureSamplingMode","filters","_setTextureParameterInteger","TEXTURE_MAG_FILTER","TEXTURE_MIN_FILTER","updateTextureWrappingMode","wrapU","wrapV","wrapR","TEXTURE_WRAP_S","_getTextureWrapMode","_cachedWrapU","TEXTURE_WRAP_T","_cachedWrapV","TEXTURE_WRAP_R","_cachedWrapR","_setupDepthStencilTexture","generateStencil","bilinearFiltering","comparisonFunction","layers","baseWidth","baseHeight","_generateDepthBuffer","_comparisonFunction","samplingParameters","texParameteri","CLAMP_TO_EDGE","TEXTURE_COMPARE_FUNC","TEXTURE_COMPARE_MODE","COMPARE_REF_TO_TEXTURE","_uploadCompressedDataToTextureDirectly","lod","compressedTexImage2D","_uploadDataToTextureDirectly","imageData","babylonInternalFormat","useTextureWidthAndHeight","_getWebGLTextureType","_getRGBABufferInternalSizedFormat","lodMaxWidth","round","LOG2E","lodMaxHeight","max","updateTextureData","xOffset","yOffset","texSubImage2D","_uploadArrayBufferViewToTexture","bindTarget","_prepareWebGLTextureContinuation","processFunction","needPOTTextures","GetExponentOfTwo","_setupFramebufferDepthAttachments","generateStencilBuffer","generateDepthBuffer","DEPTH_STENCIL","depthFormat","DEPTH_COMPONENT16","DEPTH_COMPONENT32F","STENCIL_INDEX8","STENCIL_ATTACHMENT","_releaseFramebufferObjects","deleteFramebuffer","_depthStencilBuffer","deleteRenderbuffer","_MSAARenderBuffer","_deleteTexture","unbindAllTextures","_lodTextureHigh","dispose","_lodTextureMid","_lodTextureLow","_irradianceTexture","deleteTexture","_setProgram","useProgram","getSamplers","getUniform","_activateCurrentTexture","activeTexture","TEXTURE0","forTextureDataUpdate","force","wasPreviouslyBound","isTextureForRendering","_associatedChannel","currentTextureBound","bindTexture","_colorTextureArray","_bindSamplerUniformToChannel","_bindTexture","channel","setTexture","_setTexture","sourceSlot","_currentState","REPEAT","MIRRORED_REPEAT","isPartOfTextureArray","video","update","delayLoadState","delayLoad","getInternalTexture","emptyCubeTexture","emptyTexture3D","emptyTexture2DArray","emptyTexture","needToBind","_cachedCoordinatesMode","coordinatesMode","textureWrapMode","_setAnisotropicLevel","anisotropicFilteringLevel","setTextureArray","textures","_textureUnits","Int32Array","anisotropicFilterExtension","_cachedAnisotropicFilteringLevel","_setTextureParameterFloat","TEXTURE_MAX_ANISOTROPY_EXT","parameter","texParameterf","releaseEffects","removeEventListener","abort","attachContextLostEvent","callback","attachContextRestoredEvent","getError","_canRenderToFramebuffer","NO_ERROR","successful","fb","createFramebuffer","status","checkFramebufferStatus","FRAMEBUFFER_COMPLETE","readFormat","readType","readPixels","UNSIGNED_SHORT_4_4_4_4","UNSIGNED_SHORT_5_5_5_1","UNSIGNED_SHORT_5_6_5","BYTE","SHORT","INT","HALF_FLOAT","UNSIGNED_INT_2_10_10_10_REV","UNSIGNED_INT_10F_11F_11F_REV","UNSIGNED_INT_5_9_9_9_REV","FLOAT_32_UNSIGNED_INT_24_8_REV","ALPHA","LUMINANCE","LUMINANCE_ALPHA","RED","RG","RED_INTEGER","RG_INTEGER","RGB_INTEGER","RGBA_INTEGER","R8_SNORM","RG8_SNORM","RGB8_SNORM","R8I","RG8I","RGB8I","RGBA8I","RGBA8_SNORM","R8","RG8","RGB8","RGBA8","R8UI","RG8UI","RGB8UI","RGBA8UI","R16I","RG16I","RGB16I","RGBA16I","R16UI","RG16UI","RGB16UI","RGBA16UI","R32I","RG32I","RGB32I","RGBA32I","R32UI","RG32UI","RGB32UI","RGBA32UI","R32F","RG32F","RGB32F","R16F","RG16F","RGB16F","RGB565","R11F_G11F_B10F","RGB9_E5","RGBA4","RGB5_A1","RGB10_A2","RGB10_A2UI","_getRGBAMultiSampleBufferFormat","onSuccess","onProgress","useArrayBuffer","_FileToolsLoadFile","onCompleteObservable","hasAlpha","numChannels","isSupported","_HasMajorPerformanceCaveat","_IsSupported","tempcanvas","WebGLRenderingContext","failIfMajorPerformanceCaveat","CeilingPOT","FloorPOT","NearestPOT","c","f","pot","func","requestAnimationFrame","requestPostAnimationFrame","msRequestAnimationFrame","webkitRequestAnimationFrame","mozRequestAnimationFrame","oRequestAnimationFrame","getHostDocument","document","CollisionsEpsilon"],"mappings":"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","sourcesContent":["import { EngineStore } from './engineStore';\r\nimport { Effect } from '../Materials/effect';\r\nimport { _DevTools } from '../Misc/devTools';\r\nimport { Observable } from '../Misc/observable';\r\nimport { DepthCullingState } from '../States/depthCullingState';\r\nimport { StencilState } from '../States/stencilState';\r\nimport { AlphaState } from '../States/alphaCullingState';\r\nimport { InternalTexture, InternalTextureSource } from '../Materials/Textures/internalTexture';\r\nimport { Logger } from '../Misc/logger';\r\nimport { DomManagement } from '../Misc/domManagement';\r\nimport { WebGLShaderProcessor } from './WebGL/webGLShaderProcessors';\r\nimport { WebGL2ShaderProcessor } from './WebGL/webGL2ShaderProcessors';\r\nimport { WebGLDataBuffer } from '../Meshes/WebGL/webGLDataBuffer';\r\nimport { WebGLPipelineContext } from './WebGL/webGLPipelineContext';\r\nimport { CanvasGenerator } from '../Misc/canvasGenerator';\r\nimport { PerformanceConfigurator } from './performanceConfigurator';\r\n/**\r\n * Keeps track of all the buffer info used in engine.\r\n */\r\nvar BufferPointer = /** @class */ (function () {\r\n    function BufferPointer() {\r\n    }\r\n    return BufferPointer;\r\n}());\r\n/**\r\n * The base engine class (root of all engines)\r\n */\r\nvar ThinEngine = /** @class */ (function () {\r\n    /**\r\n     * Creates a new engine\r\n     * @param canvasOrContext defines the canvas or WebGL context to use for rendering. If you provide a WebGL context, Babylon.js will not hook events on the canvas (like pointers, keyboards, etc...) so no event observables will be available. This is mostly used when Babylon.js is used as a plugin on a system which alreay used the WebGL context\r\n     * @param antialias defines enable antialiasing (default: false)\r\n     * @param options defines further options to be sent to the getContext() function\r\n     * @param adaptToDeviceRatio defines whether to adapt to the device's viewport characteristics (default: false)\r\n     */\r\n    function ThinEngine(canvasOrContext, antialias, options, adaptToDeviceRatio) {\r\n        var _this = this;\r\n        if (adaptToDeviceRatio === void 0) { adaptToDeviceRatio = false; }\r\n        /**\r\n         * Gets or sets a boolean that indicates if textures must be forced to power of 2 size even if not required\r\n         */\r\n        this.forcePOTTextures = false;\r\n        /**\r\n         * Gets a boolean indicating if the engine is currently rendering in fullscreen mode\r\n         */\r\n        this.isFullscreen = false;\r\n        /**\r\n         * Gets or sets a boolean indicating if back faces must be culled (true by default)\r\n         */\r\n        this.cullBackFaces = true;\r\n        /**\r\n         * Gets or sets a boolean indicating if the engine must keep rendering even if the window is not in foregroun\r\n         */\r\n        this.renderEvenInBackground = true;\r\n        /**\r\n         * Gets or sets a boolean indicating that cache can be kept between frames\r\n         */\r\n        this.preventCacheWipeBetweenFrames = false;\r\n        /** Gets or sets a boolean indicating if the engine should validate programs after compilation */\r\n        this.validateShaderPrograms = false;\r\n        /**\r\n         * Gets or sets a boolean indicating if depth buffer should be reverse, going from far to near.\r\n         * This can provide greater z depth for distant objects.\r\n         */\r\n        this.useReverseDepthBuffer = false;\r\n        // Uniform buffers list\r\n        /**\r\n         * Gets or sets a boolean indicating that uniform buffers must be disabled even if they are supported\r\n         */\r\n        this.disableUniformBuffers = false;\r\n        /** @hidden */\r\n        this._uniformBuffers = new Array();\r\n        /** @hidden */\r\n        this._webGLVersion = 1.0;\r\n        this._windowIsBackground = false;\r\n        this._highPrecisionShadersAllowed = true;\r\n        /** @hidden */\r\n        this._badOS = false;\r\n        /** @hidden */\r\n        this._badDesktopOS = false;\r\n        this._renderingQueueLaunched = false;\r\n        this._activeRenderLoops = new Array();\r\n        // Lost context\r\n        /**\r\n         * Observable signaled when a context lost event is raised\r\n         */\r\n        this.onContextLostObservable = new Observable();\r\n        /**\r\n         * Observable signaled when a context restored event is raised\r\n         */\r\n        this.onContextRestoredObservable = new Observable();\r\n        this._contextWasLost = false;\r\n        /** @hidden */\r\n        this._doNotHandleContextLost = false;\r\n        /**\r\n         * Gets or sets a boolean indicating that vertex array object must be disabled even if they are supported\r\n         */\r\n        this.disableVertexArrayObjects = false;\r\n        // States\r\n        /** @hidden */\r\n        this._colorWrite = true;\r\n        /** @hidden */\r\n        this._colorWriteChanged = true;\r\n        /** @hidden */\r\n        this._depthCullingState = new DepthCullingState();\r\n        /** @hidden */\r\n        this._stencilState = new StencilState();\r\n        /** @hidden */\r\n        this._alphaState = new AlphaState();\r\n        /** @hidden */\r\n        this._alphaMode = 1;\r\n        /** @hidden */\r\n        this._alphaEquation = 0;\r\n        // Cache\r\n        /** @hidden */\r\n        this._internalTexturesCache = new Array();\r\n        /** @hidden */\r\n        this._activeChannel = 0;\r\n        this._currentTextureChannel = -1;\r\n        /** @hidden */\r\n        this._boundTexturesCache = {};\r\n        this._compiledEffects = {};\r\n        this._vertexAttribArraysEnabled = [];\r\n        this._uintIndicesCurrentlySet = false;\r\n        this._currentBoundBuffer = new Array();\r\n        /** @hidden */\r\n        this._currentFramebuffer = null;\r\n        /** @hidden */\r\n        this._dummyFramebuffer = null;\r\n        this._currentBufferPointers = new Array();\r\n        this._currentInstanceLocations = new Array();\r\n        this._currentInstanceBuffers = new Array();\r\n        this._vaoRecordInProgress = false;\r\n        this._mustWipeVertexAttributes = false;\r\n        this._nextFreeTextureSlots = new Array();\r\n        this._maxSimultaneousTextures = 0;\r\n        this._activeRequests = new Array();\r\n        /** @hidden */\r\n        this._transformTextureUrl = null;\r\n        /**\r\n         * Gets information about the current host\r\n         */\r\n        this.hostInformation = {\r\n            isMobile: false\r\n        };\r\n        /**\r\n         * Defines whether the engine has been created with the premultipliedAlpha option on or not.\r\n         */\r\n        this.premultipliedAlpha = true;\r\n        /**\r\n         * Observable event triggered before each texture is initialized\r\n         */\r\n        this.onBeforeTextureInitObservable = new Observable();\r\n        this._viewportCached = { x: 0, y: 0, z: 0, w: 0 };\r\n        this._unpackFlipYCached = null;\r\n        /**\r\n         * In case you are sharing the context with other applications, it might\r\n         * be interested to not cache the unpack flip y state to ensure a consistent\r\n         * value would be set.\r\n         */\r\n        this.enableUnpackFlipYCached = true;\r\n        this._getDepthStencilBuffer = function (width, height, samples, internalFormat, msInternalFormat, attachment) {\r\n            var gl = _this._gl;\r\n            var depthStencilBuffer = gl.createRenderbuffer();\r\n            gl.bindRenderbuffer(gl.RENDERBUFFER, depthStencilBuffer);\r\n            if (samples > 1 && gl.renderbufferStorageMultisample) {\r\n                gl.renderbufferStorageMultisample(gl.RENDERBUFFER, samples, msInternalFormat, width, height);\r\n            }\r\n            else {\r\n                gl.renderbufferStorage(gl.RENDERBUFFER, internalFormat, width, height);\r\n            }\r\n            gl.framebufferRenderbuffer(gl.FRAMEBUFFER, attachment, gl.RENDERBUFFER, depthStencilBuffer);\r\n            gl.bindRenderbuffer(gl.RENDERBUFFER, null);\r\n            return depthStencilBuffer;\r\n        };\r\n        this._boundUniforms = {};\r\n        var canvas = null;\r\n        if (!canvasOrContext) {\r\n            return;\r\n        }\r\n        options = options || {};\r\n        PerformanceConfigurator.SetMatrixPrecision(!!options.useHighPrecisionMatrix);\r\n        if (canvasOrContext.getContext) {\r\n            canvas = canvasOrContext;\r\n            this._renderingCanvas = canvas;\r\n            if (antialias != null) {\r\n                options.antialias = antialias;\r\n            }\r\n            if (options.deterministicLockstep === undefined) {\r\n                options.deterministicLockstep = false;\r\n            }\r\n            if (options.lockstepMaxSteps === undefined) {\r\n                options.lockstepMaxSteps = 4;\r\n            }\r\n            if (options.timeStep === undefined) {\r\n                options.timeStep = 1 / 60;\r\n            }\r\n            if (options.preserveDrawingBuffer === undefined) {\r\n                options.preserveDrawingBuffer = false;\r\n            }\r\n            if (options.audioEngine === undefined) {\r\n                options.audioEngine = true;\r\n            }\r\n            if (options.stencil === undefined) {\r\n                options.stencil = true;\r\n            }\r\n            if (options.premultipliedAlpha === false) {\r\n                this.premultipliedAlpha = false;\r\n            }\r\n            if (options.xrCompatible === undefined) {\r\n                options.xrCompatible = true;\r\n            }\r\n            this._doNotHandleContextLost = options.doNotHandleContextLost ? true : false;\r\n            // Exceptions\r\n            if (navigator && navigator.userAgent) {\r\n                var ua = navigator.userAgent;\r\n                this.hostInformation.isMobile = ua.indexOf(\"Mobile\") !== -1;\r\n                for (var _i = 0, _a = ThinEngine.ExceptionList; _i < _a.length; _i++) {\r\n                    var exception = _a[_i];\r\n                    var key = exception.key;\r\n                    var targets = exception.targets;\r\n                    var check = new RegExp(key);\r\n                    if (check.test(ua)) {\r\n                        if (exception.capture && exception.captureConstraint) {\r\n                            var capture = exception.capture;\r\n                            var constraint = exception.captureConstraint;\r\n                            var regex = new RegExp(capture);\r\n                            var matches = regex.exec(ua);\r\n                            if (matches && matches.length > 0) {\r\n                                var capturedValue = parseInt(matches[matches.length - 1]);\r\n                                if (capturedValue >= constraint) {\r\n                                    continue;\r\n                                }\r\n                            }\r\n                        }\r\n                        for (var _b = 0, targets_1 = targets; _b < targets_1.length; _b++) {\r\n                            var target = targets_1[_b];\r\n                            switch (target) {\r\n                                case \"uniformBuffer\":\r\n                                    this.disableUniformBuffers = true;\r\n                                    break;\r\n                                case \"vao\":\r\n                                    this.disableVertexArrayObjects = true;\r\n                                    break;\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            // Context lost\r\n            if (!this._doNotHandleContextLost) {\r\n                this._onContextLost = function (evt) {\r\n                    evt.preventDefault();\r\n                    _this._contextWasLost = true;\r\n                    Logger.Warn(\"WebGL context lost.\");\r\n                    _this.onContextLostObservable.notifyObservers(_this);\r\n                };\r\n                this._onContextRestored = function () {\r\n                    // Adding a timeout to avoid race condition at browser level\r\n                    setTimeout(function () {\r\n                        // Rebuild gl context\r\n                        _this._initGLContext();\r\n                        // Rebuild effects\r\n                        _this._rebuildEffects();\r\n                        // Rebuild textures\r\n                        _this._rebuildInternalTextures();\r\n                        // Rebuild buffers\r\n                        _this._rebuildBuffers();\r\n                        // Cache\r\n                        _this.wipeCaches(true);\r\n                        Logger.Warn(\"WebGL context successfully restored.\");\r\n                        _this.onContextRestoredObservable.notifyObservers(_this);\r\n                        _this._contextWasLost = false;\r\n                    }, 0);\r\n                };\r\n                canvas.addEventListener(\"webglcontextlost\", this._onContextLost, false);\r\n                canvas.addEventListener(\"webglcontextrestored\", this._onContextRestored, false);\r\n                options.powerPreference = \"high-performance\";\r\n            }\r\n            // GL\r\n            if (!options.disableWebGL2Support) {\r\n                try {\r\n                    this._gl = (canvas.getContext(\"webgl2\", options) || canvas.getContext(\"experimental-webgl2\", options));\r\n                    if (this._gl) {\r\n                        this._webGLVersion = 2.0;\r\n                        // Prevent weird browsers to lie (yeah that happens!)\r\n                        if (!this._gl.deleteQuery) {\r\n                            this._webGLVersion = 1.0;\r\n                        }\r\n                    }\r\n                }\r\n                catch (e) {\r\n                    // Do nothing\r\n                }\r\n            }\r\n            if (!this._gl) {\r\n                if (!canvas) {\r\n                    throw new Error(\"The provided canvas is null or undefined.\");\r\n                }\r\n                try {\r\n                    this._gl = (canvas.getContext(\"webgl\", options) || canvas.getContext(\"experimental-webgl\", options));\r\n                }\r\n                catch (e) {\r\n                    throw new Error(\"WebGL not supported\");\r\n                }\r\n            }\r\n            if (!this._gl) {\r\n                throw new Error(\"WebGL not supported\");\r\n            }\r\n        }\r\n        else {\r\n            this._gl = canvasOrContext;\r\n            this._renderingCanvas = this._gl.canvas;\r\n            if (this._gl.renderbufferStorageMultisample) {\r\n                this._webGLVersion = 2.0;\r\n            }\r\n            var attributes = this._gl.getContextAttributes();\r\n            if (attributes) {\r\n                options.stencil = attributes.stencil;\r\n            }\r\n        }\r\n        // Ensures a consistent color space unpacking of textures cross browser.\r\n        this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL, this._gl.NONE);\r\n        if (options.useHighPrecisionFloats !== undefined) {\r\n            this._highPrecisionShadersAllowed = options.useHighPrecisionFloats;\r\n        }\r\n        // Viewport\r\n        var devicePixelRatio = DomManagement.IsWindowObjectExist() ? (window.devicePixelRatio || 1.0) : 1.0;\r\n        var limitDeviceRatio = options.limitDeviceRatio || devicePixelRatio;\r\n        this._hardwareScalingLevel = adaptToDeviceRatio ? 1.0 / Math.min(limitDeviceRatio, devicePixelRatio) : 1.0;\r\n        this.resize();\r\n        this._isStencilEnable = options.stencil ? true : false;\r\n        this._initGLContext();\r\n        // Prepare buffer pointers\r\n        for (var i = 0; i < this._caps.maxVertexAttribs; i++) {\r\n            this._currentBufferPointers[i] = new BufferPointer();\r\n        }\r\n        // Shader processor\r\n        if (this.webGLVersion > 1) {\r\n            this._shaderProcessor = new WebGL2ShaderProcessor();\r\n        }\r\n        else {\r\n            this._shaderProcessor = new WebGLShaderProcessor();\r\n        }\r\n        // Detect if we are running on a faulty buggy OS.\r\n        this._badOS = /iPad/i.test(navigator.userAgent) || /iPhone/i.test(navigator.userAgent);\r\n        // Starting with iOS 14, we can trust the browser\r\n        // let matches = navigator.userAgent.match(/Version\\/(\\d+)/);\r\n        // if (matches && matches.length === 2) {\r\n        //     if (parseInt(matches[1]) >= 14) {\r\n        //         this._badOS = false;\r\n        //     }\r\n        // }\r\n        // Detect if we are running on a faulty buggy desktop OS.\r\n        this._badDesktopOS = /^((?!chrome|android).)*safari/i.test(navigator.userAgent);\r\n        this._creationOptions = options;\r\n        console.log(\"Babylon.js v\" + ThinEngine.Version + \" - \" + this.description);\r\n    }\r\n    Object.defineProperty(ThinEngine, \"NpmPackage\", {\r\n        /**\r\n         * Returns the current npm package of the sdk\r\n         */\r\n        // Not mixed with Version for tooling purpose.\r\n        get: function () {\r\n            return \"babylonjs@4.2.0\";\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(ThinEngine, \"Version\", {\r\n        /**\r\n         * Returns the current version of the framework\r\n         */\r\n        get: function () {\r\n            return \"4.2.0\";\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(ThinEngine.prototype, \"description\", {\r\n        /**\r\n         * Returns a string describing the current engine\r\n         */\r\n        get: function () {\r\n            var description = \"WebGL\" + this.webGLVersion;\r\n            if (this._caps.parallelShaderCompile) {\r\n                description += \" - Parallel shader compilation\";\r\n            }\r\n            return description;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(ThinEngine, \"ShadersRepository\", {\r\n        /**\r\n         * Gets or sets the relative url used to load shaders if using the engine in non-minified mode\r\n         */\r\n        get: function () {\r\n            return Effect.ShadersRepository;\r\n        },\r\n        set: function (value) {\r\n            Effect.ShadersRepository = value;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(ThinEngine.prototype, \"supportsUniformBuffers\", {\r\n        /**\r\n         * Gets a boolean indicating that the engine supports uniform buffers\r\n         * @see https://doc.babylonjs.com/features/webgl2#uniform-buffer-objets\r\n         */\r\n        get: function () {\r\n            return this.webGLVersion > 1 && !this.disableUniformBuffers;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(ThinEngine.prototype, \"_shouldUseHighPrecisionShader\", {\r\n        /** @hidden */\r\n        get: function () {\r\n            return !!(this._caps.highPrecisionShaderSupported && this._highPrecisionShadersAllowed);\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(ThinEngine.prototype, \"needPOTTextures\", {\r\n        /**\r\n         * Gets a boolean indicating that only power of 2 textures are supported\r\n         * Please note that you can still use non power of 2 textures but in this case the engine will forcefully convert them\r\n         */\r\n        get: function () {\r\n            return this._webGLVersion < 2 || this.forcePOTTextures;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(ThinEngine.prototype, \"doNotHandleContextLost\", {\r\n        /**\r\n         * Gets or sets a boolean indicating if resources should be retained to be able to handle context lost events\r\n         * @see https://doc.babylonjs.com/how_to/optimizing_your_scene#handling-webgl-context-lost\r\n         */\r\n        get: function () {\r\n            return this._doNotHandleContextLost;\r\n        },\r\n        set: function (value) {\r\n            this._doNotHandleContextLost = value;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(ThinEngine.prototype, \"_supportsHardwareTextureRescaling\", {\r\n        get: function () {\r\n            return false;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(ThinEngine.prototype, \"framebufferDimensionsObject\", {\r\n        /**\r\n         * sets the object from which width and height will be taken from when getting render width and height\r\n         * Will fallback to the gl object\r\n         * @param dimensions the framebuffer width and height that will be used.\r\n         */\r\n        set: function (dimensions) {\r\n            this._framebufferDimensionsObject = dimensions;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(ThinEngine.prototype, \"currentViewport\", {\r\n        /**\r\n         * Gets the current viewport\r\n         */\r\n        get: function () {\r\n            return this._cachedViewport;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(ThinEngine.prototype, \"emptyTexture\", {\r\n        /**\r\n         * Gets the default empty texture\r\n         */\r\n        get: function () {\r\n            if (!this._emptyTexture) {\r\n                this._emptyTexture = this.createRawTexture(new Uint8Array(4), 1, 1, 5, false, false, 1);\r\n            }\r\n            return this._emptyTexture;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(ThinEngine.prototype, \"emptyTexture3D\", {\r\n        /**\r\n         * Gets the default empty 3D texture\r\n         */\r\n        get: function () {\r\n            if (!this._emptyTexture3D) {\r\n                this._emptyTexture3D = this.createRawTexture3D(new Uint8Array(4), 1, 1, 1, 5, false, false, 1);\r\n            }\r\n            return this._emptyTexture3D;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(ThinEngine.prototype, \"emptyTexture2DArray\", {\r\n        /**\r\n         * Gets the default empty 2D array texture\r\n         */\r\n        get: function () {\r\n            if (!this._emptyTexture2DArray) {\r\n                this._emptyTexture2DArray = this.createRawTexture2DArray(new Uint8Array(4), 1, 1, 1, 5, false, false, 1);\r\n            }\r\n            return this._emptyTexture2DArray;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(ThinEngine.prototype, \"emptyCubeTexture\", {\r\n        /**\r\n         * Gets the default empty cube texture\r\n         */\r\n        get: function () {\r\n            if (!this._emptyCubeTexture) {\r\n                var faceData = new Uint8Array(4);\r\n                var cubeData = [faceData, faceData, faceData, faceData, faceData, faceData];\r\n                this._emptyCubeTexture = this.createRawCubeTexture(cubeData, 1, 5, 0, false, false, 1);\r\n            }\r\n            return this._emptyCubeTexture;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    ThinEngine.prototype._rebuildInternalTextures = function () {\r\n        var currentState = this._internalTexturesCache.slice(); // Do a copy because the rebuild will add proxies\r\n        for (var _i = 0, currentState_1 = currentState; _i < currentState_1.length; _i++) {\r\n            var internalTexture = currentState_1[_i];\r\n            internalTexture._rebuild();\r\n        }\r\n    };\r\n    ThinEngine.prototype._rebuildEffects = function () {\r\n        for (var key in this._compiledEffects) {\r\n            var effect = this._compiledEffects[key];\r\n            effect._prepareEffect();\r\n        }\r\n        Effect.ResetCache();\r\n    };\r\n    /**\r\n     * Gets a boolean indicating if all created effects are ready\r\n     * @returns true if all effects are ready\r\n     */\r\n    ThinEngine.prototype.areAllEffectsReady = function () {\r\n        for (var key in this._compiledEffects) {\r\n            var effect = this._compiledEffects[key];\r\n            if (!effect.isReady()) {\r\n                return false;\r\n            }\r\n        }\r\n        return true;\r\n    };\r\n    ThinEngine.prototype._rebuildBuffers = function () {\r\n        // Uniforms\r\n        for (var _i = 0, _a = this._uniformBuffers; _i < _a.length; _i++) {\r\n            var uniformBuffer = _a[_i];\r\n            uniformBuffer._rebuild();\r\n        }\r\n    };\r\n    ThinEngine.prototype._initGLContext = function () {\r\n        // Caps\r\n        this._caps = {\r\n            maxTexturesImageUnits: this._gl.getParameter(this._gl.MAX_TEXTURE_IMAGE_UNITS),\r\n            maxCombinedTexturesImageUnits: this._gl.getParameter(this._gl.MAX_COMBINED_TEXTURE_IMAGE_UNITS),\r\n            maxVertexTextureImageUnits: this._gl.getParameter(this._gl.MAX_VERTEX_TEXTURE_IMAGE_UNITS),\r\n            maxTextureSize: this._gl.getParameter(this._gl.MAX_TEXTURE_SIZE),\r\n            maxSamples: this._webGLVersion > 1 ? this._gl.getParameter(this._gl.MAX_SAMPLES) : 1,\r\n            maxCubemapTextureSize: this._gl.getParameter(this._gl.MAX_CUBE_MAP_TEXTURE_SIZE),\r\n            maxRenderTextureSize: this._gl.getParameter(this._gl.MAX_RENDERBUFFER_SIZE),\r\n            maxVertexAttribs: this._gl.getParameter(this._gl.MAX_VERTEX_ATTRIBS),\r\n            maxVaryingVectors: this._gl.getParameter(this._gl.MAX_VARYING_VECTORS),\r\n            maxFragmentUniformVectors: this._gl.getParameter(this._gl.MAX_FRAGMENT_UNIFORM_VECTORS),\r\n            maxVertexUniformVectors: this._gl.getParameter(this._gl.MAX_VERTEX_UNIFORM_VECTORS),\r\n            parallelShaderCompile: this._gl.getExtension('KHR_parallel_shader_compile'),\r\n            standardDerivatives: this._webGLVersion > 1 || (this._gl.getExtension('OES_standard_derivatives') !== null),\r\n            maxAnisotropy: 1,\r\n            astc: this._gl.getExtension('WEBGL_compressed_texture_astc') || this._gl.getExtension('WEBKIT_WEBGL_compressed_texture_astc'),\r\n            bptc: this._gl.getExtension('EXT_texture_compression_bptc') || this._gl.getExtension('WEBKIT_EXT_texture_compression_bptc'),\r\n            s3tc: this._gl.getExtension('WEBGL_compressed_texture_s3tc') || this._gl.getExtension('WEBKIT_WEBGL_compressed_texture_s3tc'),\r\n            pvrtc: this._gl.getExtension('WEBGL_compressed_texture_pvrtc') || this._gl.getExtension('WEBKIT_WEBGL_compressed_texture_pvrtc'),\r\n            etc1: this._gl.getExtension('WEBGL_compressed_texture_etc1') || this._gl.getExtension('WEBKIT_WEBGL_compressed_texture_etc1'),\r\n            etc2: this._gl.getExtension('WEBGL_compressed_texture_etc') || this._gl.getExtension('WEBKIT_WEBGL_compressed_texture_etc') ||\r\n                this._gl.getExtension('WEBGL_compressed_texture_es3_0'),\r\n            textureAnisotropicFilterExtension: this._gl.getExtension('EXT_texture_filter_anisotropic') || this._gl.getExtension('WEBKIT_EXT_texture_filter_anisotropic') || this._gl.getExtension('MOZ_EXT_texture_filter_anisotropic'),\r\n            uintIndices: this._webGLVersion > 1 || this._gl.getExtension('OES_element_index_uint') !== null,\r\n            fragmentDepthSupported: this._webGLVersion > 1 || this._gl.getExtension('EXT_frag_depth') !== null,\r\n            highPrecisionShaderSupported: false,\r\n            timerQuery: this._gl.getExtension('EXT_disjoint_timer_query_webgl2') || this._gl.getExtension(\"EXT_disjoint_timer_query\"),\r\n            canUseTimestampForTimerQuery: false,\r\n            drawBuffersExtension: false,\r\n            maxMSAASamples: 1,\r\n            colorBufferFloat: this._webGLVersion > 1 && this._gl.getExtension('EXT_color_buffer_float'),\r\n            textureFloat: (this._webGLVersion > 1 || this._gl.getExtension('OES_texture_float')) ? true : false,\r\n            textureHalfFloat: (this._webGLVersion > 1 || this._gl.getExtension('OES_texture_half_float')) ? true : false,\r\n            textureHalfFloatRender: false,\r\n            textureFloatLinearFiltering: false,\r\n            textureFloatRender: false,\r\n            textureHalfFloatLinearFiltering: false,\r\n            vertexArrayObject: false,\r\n            instancedArrays: false,\r\n            textureLOD: (this._webGLVersion > 1 || this._gl.getExtension('EXT_shader_texture_lod')) ? true : false,\r\n            blendMinMax: false,\r\n            multiview: this._gl.getExtension('OVR_multiview2'),\r\n            oculusMultiview: this._gl.getExtension('OCULUS_multiview'),\r\n            depthTextureExtension: false\r\n        };\r\n        // Infos\r\n        this._glVersion = this._gl.getParameter(this._gl.VERSION);\r\n        var rendererInfo = this._gl.getExtension(\"WEBGL_debug_renderer_info\");\r\n        if (rendererInfo != null) {\r\n            this._glRenderer = this._gl.getParameter(rendererInfo.UNMASKED_RENDERER_WEBGL);\r\n            this._glVendor = this._gl.getParameter(rendererInfo.UNMASKED_VENDOR_WEBGL);\r\n        }\r\n        if (!this._glVendor) {\r\n            this._glVendor = \"Unknown vendor\";\r\n        }\r\n        if (!this._glRenderer) {\r\n            this._glRenderer = \"Unknown renderer\";\r\n        }\r\n        // Constants\r\n        if (this._gl.HALF_FLOAT_OES !== 0x8D61) {\r\n            this._gl.HALF_FLOAT_OES = 0x8D61; // Half floating-point type (16-bit).\r\n        }\r\n        if (this._gl.RGBA16F !== 0x881A) {\r\n            this._gl.RGBA16F = 0x881A; // RGBA 16-bit floating-point color-renderable internal sized format.\r\n        }\r\n        if (this._gl.RGBA32F !== 0x8814) {\r\n            this._gl.RGBA32F = 0x8814; // RGBA 32-bit floating-point color-renderable internal sized format.\r\n        }\r\n        if (this._gl.DEPTH24_STENCIL8 !== 35056) {\r\n            this._gl.DEPTH24_STENCIL8 = 35056;\r\n        }\r\n        // Extensions\r\n        if (this._caps.timerQuery) {\r\n            if (this._webGLVersion === 1) {\r\n                this._gl.getQuery = this._caps.timerQuery.getQueryEXT.bind(this._caps.timerQuery);\r\n            }\r\n            this._caps.canUseTimestampForTimerQuery = this._gl.getQuery(this._caps.timerQuery.TIMESTAMP_EXT, this._caps.timerQuery.QUERY_COUNTER_BITS_EXT) > 0;\r\n        }\r\n        this._caps.maxAnisotropy = this._caps.textureAnisotropicFilterExtension ? this._gl.getParameter(this._caps.textureAnisotropicFilterExtension.MAX_TEXTURE_MAX_ANISOTROPY_EXT) : 0;\r\n        this._caps.textureFloatLinearFiltering = this._caps.textureFloat && this._gl.getExtension('OES_texture_float_linear') ? true : false;\r\n        this._caps.textureFloatRender = this._caps.textureFloat && this._canRenderToFloatFramebuffer() ? true : false;\r\n        this._caps.textureHalfFloatLinearFiltering = (this._webGLVersion > 1 || (this._caps.textureHalfFloat && this._gl.getExtension('OES_texture_half_float_linear'))) ? true : false;\r\n        // Checks if some of the format renders first to allow the use of webgl inspector.\r\n        if (this._webGLVersion > 1) {\r\n            if (this._gl.HALF_FLOAT_OES !== 0x140B) {\r\n                this._gl.HALF_FLOAT_OES = 0x140B;\r\n            }\r\n        }\r\n        this._caps.textureHalfFloatRender = this._caps.textureHalfFloat && this._canRenderToHalfFloatFramebuffer();\r\n        // Draw buffers\r\n        if (this._webGLVersion > 1) {\r\n            this._caps.drawBuffersExtension = true;\r\n            this._caps.maxMSAASamples = this._gl.getParameter(this._gl.MAX_SAMPLES);\r\n        }\r\n        else {\r\n            var drawBuffersExtension = this._gl.getExtension('WEBGL_draw_buffers');\r\n            if (drawBuffersExtension !== null) {\r\n                this._caps.drawBuffersExtension = true;\r\n                this._gl.drawBuffers = drawBuffersExtension.drawBuffersWEBGL.bind(drawBuffersExtension);\r\n                this._gl.DRAW_FRAMEBUFFER = this._gl.FRAMEBUFFER;\r\n                for (var i = 0; i < 16; i++) {\r\n                    this._gl[\"COLOR_ATTACHMENT\" + i + \"_WEBGL\"] = drawBuffersExtension[\"COLOR_ATTACHMENT\" + i + \"_WEBGL\"];\r\n                }\r\n            }\r\n        }\r\n        // Depth Texture\r\n        if (this._webGLVersion > 1) {\r\n            this._caps.depthTextureExtension = true;\r\n        }\r\n        else {\r\n            var depthTextureExtension = this._gl.getExtension('WEBGL_depth_texture');\r\n            if (depthTextureExtension != null) {\r\n                this._caps.depthTextureExtension = true;\r\n                this._gl.UNSIGNED_INT_24_8 = depthTextureExtension.UNSIGNED_INT_24_8_WEBGL;\r\n            }\r\n        }\r\n        // Vertex array object\r\n        if (this.disableVertexArrayObjects) {\r\n            this._caps.vertexArrayObject = false;\r\n        }\r\n        else if (this._webGLVersion > 1) {\r\n            this._caps.vertexArrayObject = true;\r\n        }\r\n        else {\r\n            var vertexArrayObjectExtension = this._gl.getExtension('OES_vertex_array_object');\r\n            if (vertexArrayObjectExtension != null) {\r\n                this._caps.vertexArrayObject = true;\r\n                this._gl.createVertexArray = vertexArrayObjectExtension.createVertexArrayOES.bind(vertexArrayObjectExtension);\r\n                this._gl.bindVertexArray = vertexArrayObjectExtension.bindVertexArrayOES.bind(vertexArrayObjectExtension);\r\n                this._gl.deleteVertexArray = vertexArrayObjectExtension.deleteVertexArrayOES.bind(vertexArrayObjectExtension);\r\n            }\r\n        }\r\n        // Instances count\r\n        if (this._webGLVersion > 1) {\r\n            this._caps.instancedArrays = true;\r\n        }\r\n        else {\r\n            var instanceExtension = this._gl.getExtension('ANGLE_instanced_arrays');\r\n            if (instanceExtension != null) {\r\n                this._caps.instancedArrays = true;\r\n                this._gl.drawArraysInstanced = instanceExtension.drawArraysInstancedANGLE.bind(instanceExtension);\r\n                this._gl.drawElementsInstanced = instanceExtension.drawElementsInstancedANGLE.bind(instanceExtension);\r\n                this._gl.vertexAttribDivisor = instanceExtension.vertexAttribDivisorANGLE.bind(instanceExtension);\r\n            }\r\n            else {\r\n                this._caps.instancedArrays = false;\r\n            }\r\n        }\r\n        if (this._gl.getShaderPrecisionFormat) {\r\n            var vertex_highp = this._gl.getShaderPrecisionFormat(this._gl.VERTEX_SHADER, this._gl.HIGH_FLOAT);\r\n            var fragment_highp = this._gl.getShaderPrecisionFormat(this._gl.FRAGMENT_SHADER, this._gl.HIGH_FLOAT);\r\n            if (vertex_highp && fragment_highp) {\r\n                this._caps.highPrecisionShaderSupported = vertex_highp.precision !== 0 && fragment_highp.precision !== 0;\r\n            }\r\n        }\r\n        if (this._webGLVersion > 1) {\r\n            this._caps.blendMinMax = true;\r\n        }\r\n        else {\r\n            var blendMinMaxExtension = this._gl.getExtension('EXT_blend_minmax');\r\n            if (blendMinMaxExtension != null) {\r\n                this._caps.blendMinMax = true;\r\n                this._gl.MAX = blendMinMaxExtension.MAX_EXT;\r\n                this._gl.MIN = blendMinMaxExtension.MIN_EXT;\r\n            }\r\n        }\r\n        // Depth buffer\r\n        this._depthCullingState.depthTest = true;\r\n        this._depthCullingState.depthFunc = this._gl.LEQUAL;\r\n        this._depthCullingState.depthMask = true;\r\n        // Texture maps\r\n        this._maxSimultaneousTextures = this._caps.maxCombinedTexturesImageUnits;\r\n        for (var slot = 0; slot < this._maxSimultaneousTextures; slot++) {\r\n            this._nextFreeTextureSlots.push(slot);\r\n        }\r\n    };\r\n    Object.defineProperty(ThinEngine.prototype, \"webGLVersion\", {\r\n        /**\r\n         * Gets version of the current webGL context\r\n         */\r\n        get: function () {\r\n            return this._webGLVersion;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    /**\r\n     * Gets a string identifying the name of the class\r\n     * @returns \"Engine\" string\r\n     */\r\n    ThinEngine.prototype.getClassName = function () {\r\n        return \"ThinEngine\";\r\n    };\r\n    Object.defineProperty(ThinEngine.prototype, \"isStencilEnable\", {\r\n        /**\r\n         * Returns true if the stencil buffer has been enabled through the creation option of the context.\r\n         */\r\n        get: function () {\r\n            return this._isStencilEnable;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    /** @hidden */\r\n    ThinEngine.prototype._prepareWorkingCanvas = function () {\r\n        if (this._workingCanvas) {\r\n            return;\r\n        }\r\n        this._workingCanvas = CanvasGenerator.CreateCanvas(1, 1);\r\n        var context = this._workingCanvas.getContext(\"2d\");\r\n        if (context) {\r\n            this._workingContext = context;\r\n        }\r\n    };\r\n    /**\r\n     * Reset the texture cache to empty state\r\n     */\r\n    ThinEngine.prototype.resetTextureCache = function () {\r\n        for (var key in this._boundTexturesCache) {\r\n            if (!this._boundTexturesCache.hasOwnProperty(key)) {\r\n                continue;\r\n            }\r\n            this._boundTexturesCache[key] = null;\r\n        }\r\n        this._currentTextureChannel = -1;\r\n    };\r\n    /**\r\n     * Gets an object containing information about the current webGL context\r\n     * @returns an object containing the vender, the renderer and the version of the current webGL context\r\n     */\r\n    ThinEngine.prototype.getGlInfo = function () {\r\n        return {\r\n            vendor: this._glVendor,\r\n            renderer: this._glRenderer,\r\n            version: this._glVersion\r\n        };\r\n    };\r\n    /**\r\n     * Defines the hardware scaling level.\r\n     * By default the hardware scaling level is computed from the window device ratio.\r\n     * if level = 1 then the engine will render at the exact resolution of the canvas. If level = 0.5 then the engine will render at twice the size of the canvas.\r\n     * @param level defines the level to use\r\n     */\r\n    ThinEngine.prototype.setHardwareScalingLevel = function (level) {\r\n        this._hardwareScalingLevel = level;\r\n        this.resize();\r\n    };\r\n    /**\r\n     * Gets the current hardware scaling level.\r\n     * By default the hardware scaling level is computed from the window device ratio.\r\n     * if level = 1 then the engine will render at the exact resolution of the canvas. If level = 0.5 then the engine will render at twice the size of the canvas.\r\n     * @returns a number indicating the current hardware scaling level\r\n     */\r\n    ThinEngine.prototype.getHardwareScalingLevel = function () {\r\n        return this._hardwareScalingLevel;\r\n    };\r\n    /**\r\n     * Gets the list of loaded textures\r\n     * @returns an array containing all loaded textures\r\n     */\r\n    ThinEngine.prototype.getLoadedTexturesCache = function () {\r\n        return this._internalTexturesCache;\r\n    };\r\n    /**\r\n     * Gets the object containing all engine capabilities\r\n     * @returns the EngineCapabilities object\r\n     */\r\n    ThinEngine.prototype.getCaps = function () {\r\n        return this._caps;\r\n    };\r\n    /**\r\n     * stop executing a render loop function and remove it from the execution array\r\n     * @param renderFunction defines the function to be removed. If not provided all functions will be removed.\r\n     */\r\n    ThinEngine.prototype.stopRenderLoop = function (renderFunction) {\r\n        if (!renderFunction) {\r\n            this._activeRenderLoops = [];\r\n            return;\r\n        }\r\n        var index = this._activeRenderLoops.indexOf(renderFunction);\r\n        if (index >= 0) {\r\n            this._activeRenderLoops.splice(index, 1);\r\n        }\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._renderLoop = function () {\r\n        if (!this._contextWasLost) {\r\n            var shouldRender = true;\r\n            if (!this.renderEvenInBackground && this._windowIsBackground) {\r\n                shouldRender = false;\r\n            }\r\n            if (shouldRender) {\r\n                // Start new frame\r\n                this.beginFrame();\r\n                for (var index = 0; index < this._activeRenderLoops.length; index++) {\r\n                    var renderFunction = this._activeRenderLoops[index];\r\n                    renderFunction();\r\n                }\r\n                // Present\r\n                this.endFrame();\r\n            }\r\n        }\r\n        if (this._activeRenderLoops.length > 0) {\r\n            this._frameHandler = this._queueNewFrame(this._boundRenderFunction, this.getHostWindow());\r\n        }\r\n        else {\r\n            this._renderingQueueLaunched = false;\r\n        }\r\n    };\r\n    /**\r\n     * Gets the HTML canvas attached with the current webGL context\r\n     * @returns a HTML canvas\r\n     */\r\n    ThinEngine.prototype.getRenderingCanvas = function () {\r\n        return this._renderingCanvas;\r\n    };\r\n    /**\r\n     * Gets host window\r\n     * @returns the host window object\r\n     */\r\n    ThinEngine.prototype.getHostWindow = function () {\r\n        if (!DomManagement.IsWindowObjectExist()) {\r\n            return null;\r\n        }\r\n        if (this._renderingCanvas && this._renderingCanvas.ownerDocument && this._renderingCanvas.ownerDocument.defaultView) {\r\n            return this._renderingCanvas.ownerDocument.defaultView;\r\n        }\r\n        return window;\r\n    };\r\n    /**\r\n     * Gets the current render width\r\n     * @param useScreen defines if screen size must be used (or the current render target if any)\r\n     * @returns a number defining the current render width\r\n     */\r\n    ThinEngine.prototype.getRenderWidth = function (useScreen) {\r\n        if (useScreen === void 0) { useScreen = false; }\r\n        if (!useScreen && this._currentRenderTarget) {\r\n            return this._currentRenderTarget.width;\r\n        }\r\n        return this._framebufferDimensionsObject ? this._framebufferDimensionsObject.framebufferWidth : this._gl.drawingBufferWidth;\r\n    };\r\n    /**\r\n     * Gets the current render height\r\n     * @param useScreen defines if screen size must be used (or the current render target if any)\r\n     * @returns a number defining the current render height\r\n     */\r\n    ThinEngine.prototype.getRenderHeight = function (useScreen) {\r\n        if (useScreen === void 0) { useScreen = false; }\r\n        if (!useScreen && this._currentRenderTarget) {\r\n            return this._currentRenderTarget.height;\r\n        }\r\n        return this._framebufferDimensionsObject ? this._framebufferDimensionsObject.framebufferHeight : this._gl.drawingBufferHeight;\r\n    };\r\n    /**\r\n     * Can be used to override the current requestAnimationFrame requester.\r\n     * @hidden\r\n     */\r\n    ThinEngine.prototype._queueNewFrame = function (bindedRenderFunction, requester) {\r\n        return ThinEngine.QueueNewFrame(bindedRenderFunction, requester);\r\n    };\r\n    /**\r\n     * Register and execute a render loop. The engine can have more than one render function\r\n     * @param renderFunction defines the function to continuously execute\r\n     */\r\n    ThinEngine.prototype.runRenderLoop = function (renderFunction) {\r\n        if (this._activeRenderLoops.indexOf(renderFunction) !== -1) {\r\n            return;\r\n        }\r\n        this._activeRenderLoops.push(renderFunction);\r\n        if (!this._renderingQueueLaunched) {\r\n            this._renderingQueueLaunched = true;\r\n            this._boundRenderFunction = this._renderLoop.bind(this);\r\n            this._frameHandler = this._queueNewFrame(this._boundRenderFunction, this.getHostWindow());\r\n        }\r\n    };\r\n    /**\r\n     * Clear the current render buffer or the current render target (if any is set up)\r\n     * @param color defines the color to use\r\n     * @param backBuffer defines if the back buffer must be cleared\r\n     * @param depth defines if the depth buffer must be cleared\r\n     * @param stencil defines if the stencil buffer must be cleared\r\n     */\r\n    ThinEngine.prototype.clear = function (color, backBuffer, depth, stencil) {\r\n        if (stencil === void 0) { stencil = false; }\r\n        this.applyStates();\r\n        var mode = 0;\r\n        if (backBuffer && color) {\r\n            this._gl.clearColor(color.r, color.g, color.b, color.a !== undefined ? color.a : 1.0);\r\n            mode |= this._gl.COLOR_BUFFER_BIT;\r\n        }\r\n        if (depth) {\r\n            if (this.useReverseDepthBuffer) {\r\n                this._depthCullingState.depthFunc = this._gl.GREATER;\r\n                this._gl.clearDepth(0.0);\r\n            }\r\n            else {\r\n                this._gl.clearDepth(1.0);\r\n            }\r\n            mode |= this._gl.DEPTH_BUFFER_BIT;\r\n        }\r\n        if (stencil) {\r\n            this._gl.clearStencil(0);\r\n            mode |= this._gl.STENCIL_BUFFER_BIT;\r\n        }\r\n        this._gl.clear(mode);\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._viewport = function (x, y, width, height) {\r\n        if (x !== this._viewportCached.x ||\r\n            y !== this._viewportCached.y ||\r\n            width !== this._viewportCached.z ||\r\n            height !== this._viewportCached.w) {\r\n            this._viewportCached.x = x;\r\n            this._viewportCached.y = y;\r\n            this._viewportCached.z = width;\r\n            this._viewportCached.w = height;\r\n            this._gl.viewport(x, y, width, height);\r\n        }\r\n    };\r\n    /**\r\n     * Set the WebGL's viewport\r\n     * @param viewport defines the viewport element to be used\r\n     * @param requiredWidth defines the width required for rendering. If not provided the rendering canvas' width is used\r\n     * @param requiredHeight defines the height required for rendering. If not provided the rendering canvas' height is used\r\n     */\r\n    ThinEngine.prototype.setViewport = function (viewport, requiredWidth, requiredHeight) {\r\n        var width = requiredWidth || this.getRenderWidth();\r\n        var height = requiredHeight || this.getRenderHeight();\r\n        var x = viewport.x || 0;\r\n        var y = viewport.y || 0;\r\n        this._cachedViewport = viewport;\r\n        this._viewport(x * width, y * height, width * viewport.width, height * viewport.height);\r\n    };\r\n    /**\r\n     * Begin a new frame\r\n     */\r\n    ThinEngine.prototype.beginFrame = function () {\r\n    };\r\n    /**\r\n     * Enf the current frame\r\n     */\r\n    ThinEngine.prototype.endFrame = function () {\r\n        // Force a flush in case we are using a bad OS.\r\n        if (this._badOS) {\r\n            this.flushFramebuffer();\r\n        }\r\n    };\r\n    /**\r\n     * Resize the view according to the canvas' size\r\n     */\r\n    ThinEngine.prototype.resize = function () {\r\n        var width;\r\n        var height;\r\n        if (DomManagement.IsWindowObjectExist()) {\r\n            width = this._renderingCanvas ? (this._renderingCanvas.clientWidth || this._renderingCanvas.width) : window.innerWidth;\r\n            height = this._renderingCanvas ? (this._renderingCanvas.clientHeight || this._renderingCanvas.height) : window.innerHeight;\r\n        }\r\n        else {\r\n            width = this._renderingCanvas ? this._renderingCanvas.width : 100;\r\n            height = this._renderingCanvas ? this._renderingCanvas.height : 100;\r\n        }\r\n        this.setSize(width / this._hardwareScalingLevel, height / this._hardwareScalingLevel);\r\n    };\r\n    /**\r\n     * Force a specific size of the canvas\r\n     * @param width defines the new canvas' width\r\n     * @param height defines the new canvas' height\r\n     * @returns true if the size was changed\r\n     */\r\n    ThinEngine.prototype.setSize = function (width, height) {\r\n        if (!this._renderingCanvas) {\r\n            return false;\r\n        }\r\n        width = width | 0;\r\n        height = height | 0;\r\n        if (this._renderingCanvas.width === width && this._renderingCanvas.height === height) {\r\n            return false;\r\n        }\r\n        this._renderingCanvas.width = width;\r\n        this._renderingCanvas.height = height;\r\n        return true;\r\n    };\r\n    /**\r\n     * Binds the frame buffer to the specified texture.\r\n     * @param texture The texture to render to or null for the default canvas\r\n     * @param faceIndex The face of the texture to render to in case of cube texture\r\n     * @param requiredWidth The width of the target to render to\r\n     * @param requiredHeight The height of the target to render to\r\n     * @param forceFullscreenViewport Forces the viewport to be the entire texture/screen if true\r\n     * @param lodLevel defines the lod level to bind to the frame buffer\r\n     * @param layer defines the 2d array index to bind to frame buffer to\r\n     */\r\n    ThinEngine.prototype.bindFramebuffer = function (texture, faceIndex, requiredWidth, requiredHeight, forceFullscreenViewport, lodLevel, layer) {\r\n        if (faceIndex === void 0) { faceIndex = 0; }\r\n        if (lodLevel === void 0) { lodLevel = 0; }\r\n        if (layer === void 0) { layer = 0; }\r\n        if (this._currentRenderTarget) {\r\n            this.unBindFramebuffer(this._currentRenderTarget);\r\n        }\r\n        this._currentRenderTarget = texture;\r\n        this._bindUnboundFramebuffer(texture._MSAAFramebuffer ? texture._MSAAFramebuffer : texture._framebuffer);\r\n        var gl = this._gl;\r\n        if (texture.is2DArray) {\r\n            gl.framebufferTextureLayer(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, texture._webGLTexture, lodLevel, layer);\r\n        }\r\n        else if (texture.isCube) {\r\n            gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex, texture._webGLTexture, lodLevel);\r\n        }\r\n        var depthStencilTexture = texture._depthStencilTexture;\r\n        if (depthStencilTexture) {\r\n            var attachment = (depthStencilTexture._generateStencilBuffer) ? gl.DEPTH_STENCIL_ATTACHMENT : gl.DEPTH_ATTACHMENT;\r\n            if (texture.is2DArray) {\r\n                gl.framebufferTextureLayer(gl.FRAMEBUFFER, attachment, depthStencilTexture._webGLTexture, lodLevel, layer);\r\n            }\r\n            else if (texture.isCube) {\r\n                gl.framebufferTexture2D(gl.FRAMEBUFFER, attachment, gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex, depthStencilTexture._webGLTexture, lodLevel);\r\n            }\r\n            else {\r\n                gl.framebufferTexture2D(gl.FRAMEBUFFER, attachment, gl.TEXTURE_2D, depthStencilTexture._webGLTexture, lodLevel);\r\n            }\r\n        }\r\n        if (this._cachedViewport && !forceFullscreenViewport) {\r\n            this.setViewport(this._cachedViewport, requiredWidth, requiredHeight);\r\n        }\r\n        else {\r\n            if (!requiredWidth) {\r\n                requiredWidth = texture.width;\r\n                if (lodLevel) {\r\n                    requiredWidth = requiredWidth / Math.pow(2, lodLevel);\r\n                }\r\n            }\r\n            if (!requiredHeight) {\r\n                requiredHeight = texture.height;\r\n                if (lodLevel) {\r\n                    requiredHeight = requiredHeight / Math.pow(2, lodLevel);\r\n                }\r\n            }\r\n            this._viewport(0, 0, requiredWidth, requiredHeight);\r\n        }\r\n        this.wipeCaches();\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._bindUnboundFramebuffer = function (framebuffer) {\r\n        if (this._currentFramebuffer !== framebuffer) {\r\n            this._gl.bindFramebuffer(this._gl.FRAMEBUFFER, framebuffer);\r\n            this._currentFramebuffer = framebuffer;\r\n        }\r\n    };\r\n    /**\r\n     * Unbind the current render target texture from the webGL context\r\n     * @param texture defines the render target texture to unbind\r\n     * @param disableGenerateMipMaps defines a boolean indicating that mipmaps must not be generated\r\n     * @param onBeforeUnbind defines a function which will be called before the effective unbind\r\n     */\r\n    ThinEngine.prototype.unBindFramebuffer = function (texture, disableGenerateMipMaps, onBeforeUnbind) {\r\n        if (disableGenerateMipMaps === void 0) { disableGenerateMipMaps = false; }\r\n        this._currentRenderTarget = null;\r\n        // If MSAA, we need to bitblt back to main texture\r\n        var gl = this._gl;\r\n        if (texture._MSAAFramebuffer) {\r\n            if (texture._textureArray) {\r\n                // This texture is part of a MRT texture, we need to treat all attachments\r\n                this.unBindMultiColorAttachmentFramebuffer(texture._textureArray, disableGenerateMipMaps, onBeforeUnbind);\r\n                return;\r\n            }\r\n            gl.bindFramebuffer(gl.READ_FRAMEBUFFER, texture._MSAAFramebuffer);\r\n            gl.bindFramebuffer(gl.DRAW_FRAMEBUFFER, texture._framebuffer);\r\n            gl.blitFramebuffer(0, 0, texture.width, texture.height, 0, 0, texture.width, texture.height, gl.COLOR_BUFFER_BIT, gl.NEAREST);\r\n        }\r\n        if (texture.generateMipMaps && !disableGenerateMipMaps && !texture.isCube) {\r\n            this._bindTextureDirectly(gl.TEXTURE_2D, texture, true);\r\n            gl.generateMipmap(gl.TEXTURE_2D);\r\n            this._bindTextureDirectly(gl.TEXTURE_2D, null);\r\n        }\r\n        if (onBeforeUnbind) {\r\n            if (texture._MSAAFramebuffer) {\r\n                // Bind the correct framebuffer\r\n                this._bindUnboundFramebuffer(texture._framebuffer);\r\n            }\r\n            onBeforeUnbind();\r\n        }\r\n        this._bindUnboundFramebuffer(null);\r\n    };\r\n    /**\r\n     * Force a webGL flush (ie. a flush of all waiting webGL commands)\r\n     */\r\n    ThinEngine.prototype.flushFramebuffer = function () {\r\n        this._gl.flush();\r\n    };\r\n    /**\r\n     * Unbind the current render target and bind the default framebuffer\r\n     */\r\n    ThinEngine.prototype.restoreDefaultFramebuffer = function () {\r\n        if (this._currentRenderTarget) {\r\n            this.unBindFramebuffer(this._currentRenderTarget);\r\n        }\r\n        else {\r\n            this._bindUnboundFramebuffer(null);\r\n        }\r\n        if (this._cachedViewport) {\r\n            this.setViewport(this._cachedViewport);\r\n        }\r\n        this.wipeCaches();\r\n    };\r\n    // VBOs\r\n    /** @hidden */\r\n    ThinEngine.prototype._resetVertexBufferBinding = function () {\r\n        this.bindArrayBuffer(null);\r\n        this._cachedVertexBuffers = null;\r\n    };\r\n    /**\r\n     * Creates a vertex buffer\r\n     * @param data the data for the vertex buffer\r\n     * @returns the new WebGL static buffer\r\n     */\r\n    ThinEngine.prototype.createVertexBuffer = function (data) {\r\n        return this._createVertexBuffer(data, this._gl.STATIC_DRAW);\r\n    };\r\n    ThinEngine.prototype._createVertexBuffer = function (data, usage) {\r\n        var vbo = this._gl.createBuffer();\r\n        if (!vbo) {\r\n            throw new Error(\"Unable to create vertex buffer\");\r\n        }\r\n        var dataBuffer = new WebGLDataBuffer(vbo);\r\n        this.bindArrayBuffer(dataBuffer);\r\n        if (data instanceof Array) {\r\n            this._gl.bufferData(this._gl.ARRAY_BUFFER, new Float32Array(data), this._gl.STATIC_DRAW);\r\n        }\r\n        else {\r\n            this._gl.bufferData(this._gl.ARRAY_BUFFER, data, this._gl.STATIC_DRAW);\r\n        }\r\n        this._resetVertexBufferBinding();\r\n        dataBuffer.references = 1;\r\n        return dataBuffer;\r\n    };\r\n    /**\r\n     * Creates a dynamic vertex buffer\r\n     * @param data the data for the dynamic vertex buffer\r\n     * @returns the new WebGL dynamic buffer\r\n     */\r\n    ThinEngine.prototype.createDynamicVertexBuffer = function (data) {\r\n        return this._createVertexBuffer(data, this._gl.DYNAMIC_DRAW);\r\n    };\r\n    ThinEngine.prototype._resetIndexBufferBinding = function () {\r\n        this.bindIndexBuffer(null);\r\n        this._cachedIndexBuffer = null;\r\n    };\r\n    /**\r\n     * Creates a new index buffer\r\n     * @param indices defines the content of the index buffer\r\n     * @param updatable defines if the index buffer must be updatable\r\n     * @returns a new webGL buffer\r\n     */\r\n    ThinEngine.prototype.createIndexBuffer = function (indices, updatable) {\r\n        var vbo = this._gl.createBuffer();\r\n        var dataBuffer = new WebGLDataBuffer(vbo);\r\n        if (!vbo) {\r\n            throw new Error(\"Unable to create index buffer\");\r\n        }\r\n        this.bindIndexBuffer(dataBuffer);\r\n        var data = this._normalizeIndexData(indices);\r\n        this._gl.bufferData(this._gl.ELEMENT_ARRAY_BUFFER, data, updatable ? this._gl.DYNAMIC_DRAW : this._gl.STATIC_DRAW);\r\n        this._resetIndexBufferBinding();\r\n        dataBuffer.references = 1;\r\n        dataBuffer.is32Bits = (data.BYTES_PER_ELEMENT === 4);\r\n        return dataBuffer;\r\n    };\r\n    ThinEngine.prototype._normalizeIndexData = function (indices) {\r\n        if (indices instanceof Uint16Array) {\r\n            return indices;\r\n        }\r\n        // Check 32 bit support\r\n        if (this._caps.uintIndices) {\r\n            if (indices instanceof Uint32Array) {\r\n                return indices;\r\n            }\r\n            else {\r\n                // number[] or Int32Array, check if 32 bit is necessary\r\n                for (var index = 0; index < indices.length; index++) {\r\n                    if (indices[index] >= 65535) {\r\n                        return new Uint32Array(indices);\r\n                    }\r\n                }\r\n                return new Uint16Array(indices);\r\n            }\r\n        }\r\n        // No 32 bit support, force conversion to 16 bit (values greater 16 bit are lost)\r\n        return new Uint16Array(indices);\r\n    };\r\n    /**\r\n     * Bind a webGL buffer to the webGL context\r\n     * @param buffer defines the buffer to bind\r\n     */\r\n    ThinEngine.prototype.bindArrayBuffer = function (buffer) {\r\n        if (!this._vaoRecordInProgress) {\r\n            this._unbindVertexArrayObject();\r\n        }\r\n        this.bindBuffer(buffer, this._gl.ARRAY_BUFFER);\r\n    };\r\n    /**\r\n     * Bind a specific block at a given index in a specific shader program\r\n     * @param pipelineContext defines the pipeline context to use\r\n     * @param blockName defines the block name\r\n     * @param index defines the index where to bind the block\r\n     */\r\n    ThinEngine.prototype.bindUniformBlock = function (pipelineContext, blockName, index) {\r\n        var program = pipelineContext.program;\r\n        var uniformLocation = this._gl.getUniformBlockIndex(program, blockName);\r\n        this._gl.uniformBlockBinding(program, uniformLocation, index);\r\n    };\r\n    ThinEngine.prototype.bindIndexBuffer = function (buffer) {\r\n        if (!this._vaoRecordInProgress) {\r\n            this._unbindVertexArrayObject();\r\n        }\r\n        this.bindBuffer(buffer, this._gl.ELEMENT_ARRAY_BUFFER);\r\n    };\r\n    ThinEngine.prototype.bindBuffer = function (buffer, target) {\r\n        if (this._vaoRecordInProgress || this._currentBoundBuffer[target] !== buffer) {\r\n            this._gl.bindBuffer(target, buffer ? buffer.underlyingResource : null);\r\n            this._currentBoundBuffer[target] = buffer;\r\n        }\r\n    };\r\n    /**\r\n     * update the bound buffer with the given data\r\n     * @param data defines the data to update\r\n     */\r\n    ThinEngine.prototype.updateArrayBuffer = function (data) {\r\n        this._gl.bufferSubData(this._gl.ARRAY_BUFFER, 0, data);\r\n    };\r\n    ThinEngine.prototype._vertexAttribPointer = function (buffer, indx, size, type, normalized, stride, offset) {\r\n        var pointer = this._currentBufferPointers[indx];\r\n        if (!pointer) {\r\n            return;\r\n        }\r\n        var changed = false;\r\n        if (!pointer.active) {\r\n            changed = true;\r\n            pointer.active = true;\r\n            pointer.index = indx;\r\n            pointer.size = size;\r\n            pointer.type = type;\r\n            pointer.normalized = normalized;\r\n            pointer.stride = stride;\r\n            pointer.offset = offset;\r\n            pointer.buffer = buffer;\r\n        }\r\n        else {\r\n            if (pointer.buffer !== buffer) {\r\n                pointer.buffer = buffer;\r\n                changed = true;\r\n            }\r\n            if (pointer.size !== size) {\r\n                pointer.size = size;\r\n                changed = true;\r\n            }\r\n            if (pointer.type !== type) {\r\n                pointer.type = type;\r\n                changed = true;\r\n            }\r\n            if (pointer.normalized !== normalized) {\r\n                pointer.normalized = normalized;\r\n                changed = true;\r\n            }\r\n            if (pointer.stride !== stride) {\r\n                pointer.stride = stride;\r\n                changed = true;\r\n            }\r\n            if (pointer.offset !== offset) {\r\n                pointer.offset = offset;\r\n                changed = true;\r\n            }\r\n        }\r\n        if (changed || this._vaoRecordInProgress) {\r\n            this.bindArrayBuffer(buffer);\r\n            this._gl.vertexAttribPointer(indx, size, type, normalized, stride, offset);\r\n        }\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._bindIndexBufferWithCache = function (indexBuffer) {\r\n        if (indexBuffer == null) {\r\n            return;\r\n        }\r\n        if (this._cachedIndexBuffer !== indexBuffer) {\r\n            this._cachedIndexBuffer = indexBuffer;\r\n            this.bindIndexBuffer(indexBuffer);\r\n            this._uintIndicesCurrentlySet = indexBuffer.is32Bits;\r\n        }\r\n    };\r\n    ThinEngine.prototype._bindVertexBuffersAttributes = function (vertexBuffers, effect) {\r\n        var attributes = effect.getAttributesNames();\r\n        if (!this._vaoRecordInProgress) {\r\n            this._unbindVertexArrayObject();\r\n        }\r\n        this.unbindAllAttributes();\r\n        for (var index = 0; index < attributes.length; index++) {\r\n            var order = effect.getAttributeLocation(index);\r\n            if (order >= 0) {\r\n                var vertexBuffer = vertexBuffers[attributes[index]];\r\n                if (!vertexBuffer) {\r\n                    continue;\r\n                }\r\n                this._gl.enableVertexAttribArray(order);\r\n                if (!this._vaoRecordInProgress) {\r\n                    this._vertexAttribArraysEnabled[order] = true;\r\n                }\r\n                var buffer = vertexBuffer.getBuffer();\r\n                if (buffer) {\r\n                    this._vertexAttribPointer(buffer, order, vertexBuffer.getSize(), vertexBuffer.type, vertexBuffer.normalized, vertexBuffer.byteStride, vertexBuffer.byteOffset);\r\n                    if (vertexBuffer.getIsInstanced()) {\r\n                        this._gl.vertexAttribDivisor(order, vertexBuffer.getInstanceDivisor());\r\n                        if (!this._vaoRecordInProgress) {\r\n                            this._currentInstanceLocations.push(order);\r\n                            this._currentInstanceBuffers.push(buffer);\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    };\r\n    /**\r\n     * Records a vertex array object\r\n     * @see https://doc.babylonjs.com/features/webgl2#vertex-array-objects\r\n     * @param vertexBuffers defines the list of vertex buffers to store\r\n     * @param indexBuffer defines the index buffer to store\r\n     * @param effect defines the effect to store\r\n     * @returns the new vertex array object\r\n     */\r\n    ThinEngine.prototype.recordVertexArrayObject = function (vertexBuffers, indexBuffer, effect) {\r\n        var vao = this._gl.createVertexArray();\r\n        this._vaoRecordInProgress = true;\r\n        this._gl.bindVertexArray(vao);\r\n        this._mustWipeVertexAttributes = true;\r\n        this._bindVertexBuffersAttributes(vertexBuffers, effect);\r\n        this.bindIndexBuffer(indexBuffer);\r\n        this._vaoRecordInProgress = false;\r\n        this._gl.bindVertexArray(null);\r\n        return vao;\r\n    };\r\n    /**\r\n     * Bind a specific vertex array object\r\n     * @see https://doc.babylonjs.com/features/webgl2#vertex-array-objects\r\n     * @param vertexArrayObject defines the vertex array object to bind\r\n     * @param indexBuffer defines the index buffer to bind\r\n     */\r\n    ThinEngine.prototype.bindVertexArrayObject = function (vertexArrayObject, indexBuffer) {\r\n        if (this._cachedVertexArrayObject !== vertexArrayObject) {\r\n            this._cachedVertexArrayObject = vertexArrayObject;\r\n            this._gl.bindVertexArray(vertexArrayObject);\r\n            this._cachedVertexBuffers = null;\r\n            this._cachedIndexBuffer = null;\r\n            this._uintIndicesCurrentlySet = indexBuffer != null && indexBuffer.is32Bits;\r\n            this._mustWipeVertexAttributes = true;\r\n        }\r\n    };\r\n    /**\r\n     * Bind webGl buffers directly to the webGL context\r\n     * @param vertexBuffer defines the vertex buffer to bind\r\n     * @param indexBuffer defines the index buffer to bind\r\n     * @param vertexDeclaration defines the vertex declaration to use with the vertex buffer\r\n     * @param vertexStrideSize defines the vertex stride of the vertex buffer\r\n     * @param effect defines the effect associated with the vertex buffer\r\n     */\r\n    ThinEngine.prototype.bindBuffersDirectly = function (vertexBuffer, indexBuffer, vertexDeclaration, vertexStrideSize, effect) {\r\n        if (this._cachedVertexBuffers !== vertexBuffer || this._cachedEffectForVertexBuffers !== effect) {\r\n            this._cachedVertexBuffers = vertexBuffer;\r\n            this._cachedEffectForVertexBuffers = effect;\r\n            var attributesCount = effect.getAttributesCount();\r\n            this._unbindVertexArrayObject();\r\n            this.unbindAllAttributes();\r\n            var offset = 0;\r\n            for (var index = 0; index < attributesCount; index++) {\r\n                if (index < vertexDeclaration.length) {\r\n                    var order = effect.getAttributeLocation(index);\r\n                    if (order >= 0) {\r\n                        this._gl.enableVertexAttribArray(order);\r\n                        this._vertexAttribArraysEnabled[order] = true;\r\n                        this._vertexAttribPointer(vertexBuffer, order, vertexDeclaration[index], this._gl.FLOAT, false, vertexStrideSize, offset);\r\n                    }\r\n                    offset += vertexDeclaration[index] * 4;\r\n                }\r\n            }\r\n        }\r\n        this._bindIndexBufferWithCache(indexBuffer);\r\n    };\r\n    ThinEngine.prototype._unbindVertexArrayObject = function () {\r\n        if (!this._cachedVertexArrayObject) {\r\n            return;\r\n        }\r\n        this._cachedVertexArrayObject = null;\r\n        this._gl.bindVertexArray(null);\r\n    };\r\n    /**\r\n     * Bind a list of vertex buffers to the webGL context\r\n     * @param vertexBuffers defines the list of vertex buffers to bind\r\n     * @param indexBuffer defines the index buffer to bind\r\n     * @param effect defines the effect associated with the vertex buffers\r\n     */\r\n    ThinEngine.prototype.bindBuffers = function (vertexBuffers, indexBuffer, effect) {\r\n        if (this._cachedVertexBuffers !== vertexBuffers || this._cachedEffectForVertexBuffers !== effect) {\r\n            this._cachedVertexBuffers = vertexBuffers;\r\n            this._cachedEffectForVertexBuffers = effect;\r\n            this._bindVertexBuffersAttributes(vertexBuffers, effect);\r\n        }\r\n        this._bindIndexBufferWithCache(indexBuffer);\r\n    };\r\n    /**\r\n     * Unbind all instance attributes\r\n     */\r\n    ThinEngine.prototype.unbindInstanceAttributes = function () {\r\n        var boundBuffer;\r\n        for (var i = 0, ul = this._currentInstanceLocations.length; i < ul; i++) {\r\n            var instancesBuffer = this._currentInstanceBuffers[i];\r\n            if (boundBuffer != instancesBuffer && instancesBuffer.references) {\r\n                boundBuffer = instancesBuffer;\r\n                this.bindArrayBuffer(instancesBuffer);\r\n            }\r\n            var offsetLocation = this._currentInstanceLocations[i];\r\n            this._gl.vertexAttribDivisor(offsetLocation, 0);\r\n        }\r\n        this._currentInstanceBuffers.length = 0;\r\n        this._currentInstanceLocations.length = 0;\r\n    };\r\n    /**\r\n     * Release and free the memory of a vertex array object\r\n     * @param vao defines the vertex array object to delete\r\n     */\r\n    ThinEngine.prototype.releaseVertexArrayObject = function (vao) {\r\n        this._gl.deleteVertexArray(vao);\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._releaseBuffer = function (buffer) {\r\n        buffer.references--;\r\n        if (buffer.references === 0) {\r\n            this._deleteBuffer(buffer);\r\n            return true;\r\n        }\r\n        return false;\r\n    };\r\n    ThinEngine.prototype._deleteBuffer = function (buffer) {\r\n        this._gl.deleteBuffer(buffer.underlyingResource);\r\n    };\r\n    /**\r\n     * Update the content of a webGL buffer used with instanciation and bind it to the webGL context\r\n     * @param instancesBuffer defines the webGL buffer to update and bind\r\n     * @param data defines the data to store in the buffer\r\n     * @param offsetLocations defines the offsets or attributes information used to determine where data must be stored in the buffer\r\n     */\r\n    ThinEngine.prototype.updateAndBindInstancesBuffer = function (instancesBuffer, data, offsetLocations) {\r\n        this.bindArrayBuffer(instancesBuffer);\r\n        if (data) {\r\n            this._gl.bufferSubData(this._gl.ARRAY_BUFFER, 0, data);\r\n        }\r\n        if (offsetLocations[0].index !== undefined) {\r\n            this.bindInstancesBuffer(instancesBuffer, offsetLocations, true);\r\n        }\r\n        else {\r\n            for (var index = 0; index < 4; index++) {\r\n                var offsetLocation = offsetLocations[index];\r\n                if (!this._vertexAttribArraysEnabled[offsetLocation]) {\r\n                    this._gl.enableVertexAttribArray(offsetLocation);\r\n                    this._vertexAttribArraysEnabled[offsetLocation] = true;\r\n                }\r\n                this._vertexAttribPointer(instancesBuffer, offsetLocation, 4, this._gl.FLOAT, false, 64, index * 16);\r\n                this._gl.vertexAttribDivisor(offsetLocation, 1);\r\n                this._currentInstanceLocations.push(offsetLocation);\r\n                this._currentInstanceBuffers.push(instancesBuffer);\r\n            }\r\n        }\r\n    };\r\n    /**\r\n     * Bind the content of a webGL buffer used with instantiation\r\n     * @param instancesBuffer defines the webGL buffer to bind\r\n     * @param attributesInfo defines the offsets or attributes information used to determine where data must be stored in the buffer\r\n     * @param computeStride defines Whether to compute the strides from the info or use the default 0\r\n     */\r\n    ThinEngine.prototype.bindInstancesBuffer = function (instancesBuffer, attributesInfo, computeStride) {\r\n        if (computeStride === void 0) { computeStride = true; }\r\n        this.bindArrayBuffer(instancesBuffer);\r\n        var stride = 0;\r\n        if (computeStride) {\r\n            for (var i = 0; i < attributesInfo.length; i++) {\r\n                var ai = attributesInfo[i];\r\n                stride += ai.attributeSize * 4;\r\n            }\r\n        }\r\n        for (var i = 0; i < attributesInfo.length; i++) {\r\n            var ai = attributesInfo[i];\r\n            if (ai.index === undefined) {\r\n                ai.index = this._currentEffect.getAttributeLocationByName(ai.attributeName);\r\n            }\r\n            if (ai.index < 0) {\r\n                continue;\r\n            }\r\n            if (!this._vertexAttribArraysEnabled[ai.index]) {\r\n                this._gl.enableVertexAttribArray(ai.index);\r\n                this._vertexAttribArraysEnabled[ai.index] = true;\r\n            }\r\n            this._vertexAttribPointer(instancesBuffer, ai.index, ai.attributeSize, ai.attributeType || this._gl.FLOAT, ai.normalized || false, stride, ai.offset);\r\n            this._gl.vertexAttribDivisor(ai.index, ai.divisor === undefined ? 1 : ai.divisor);\r\n            this._currentInstanceLocations.push(ai.index);\r\n            this._currentInstanceBuffers.push(instancesBuffer);\r\n        }\r\n    };\r\n    /**\r\n     * Disable the instance attribute corresponding to the name in parameter\r\n     * @param name defines the name of the attribute to disable\r\n     */\r\n    ThinEngine.prototype.disableInstanceAttributeByName = function (name) {\r\n        if (!this._currentEffect) {\r\n            return;\r\n        }\r\n        var attributeLocation = this._currentEffect.getAttributeLocationByName(name);\r\n        this.disableInstanceAttribute(attributeLocation);\r\n    };\r\n    /**\r\n     * Disable the instance attribute corresponding to the location in parameter\r\n     * @param attributeLocation defines the attribute location of the attribute to disable\r\n     */\r\n    ThinEngine.prototype.disableInstanceAttribute = function (attributeLocation) {\r\n        var shouldClean = false;\r\n        var index;\r\n        while ((index = this._currentInstanceLocations.indexOf(attributeLocation)) !== -1) {\r\n            this._currentInstanceLocations.splice(index, 1);\r\n            this._currentInstanceBuffers.splice(index, 1);\r\n            shouldClean = true;\r\n            index = this._currentInstanceLocations.indexOf(attributeLocation);\r\n        }\r\n        if (shouldClean) {\r\n            this._gl.vertexAttribDivisor(attributeLocation, 0);\r\n            this.disableAttributeByIndex(attributeLocation);\r\n        }\r\n    };\r\n    /**\r\n     * Disable the attribute corresponding to the location in parameter\r\n     * @param attributeLocation defines the attribute location of the attribute to disable\r\n     */\r\n    ThinEngine.prototype.disableAttributeByIndex = function (attributeLocation) {\r\n        this._gl.disableVertexAttribArray(attributeLocation);\r\n        this._vertexAttribArraysEnabled[attributeLocation] = false;\r\n        this._currentBufferPointers[attributeLocation].active = false;\r\n    };\r\n    /**\r\n     * Send a draw order\r\n     * @param useTriangles defines if triangles must be used to draw (else wireframe will be used)\r\n     * @param indexStart defines the starting index\r\n     * @param indexCount defines the number of index to draw\r\n     * @param instancesCount defines the number of instances to draw (if instanciation is enabled)\r\n     */\r\n    ThinEngine.prototype.draw = function (useTriangles, indexStart, indexCount, instancesCount) {\r\n        this.drawElementsType(useTriangles ? 0 : 1, indexStart, indexCount, instancesCount);\r\n    };\r\n    /**\r\n     * Draw a list of points\r\n     * @param verticesStart defines the index of first vertex to draw\r\n     * @param verticesCount defines the count of vertices to draw\r\n     * @param instancesCount defines the number of instances to draw (if instanciation is enabled)\r\n     */\r\n    ThinEngine.prototype.drawPointClouds = function (verticesStart, verticesCount, instancesCount) {\r\n        this.drawArraysType(2, verticesStart, verticesCount, instancesCount);\r\n    };\r\n    /**\r\n     * Draw a list of unindexed primitives\r\n     * @param useTriangles defines if triangles must be used to draw (else wireframe will be used)\r\n     * @param verticesStart defines the index of first vertex to draw\r\n     * @param verticesCount defines the count of vertices to draw\r\n     * @param instancesCount defines the number of instances to draw (if instanciation is enabled)\r\n     */\r\n    ThinEngine.prototype.drawUnIndexed = function (useTriangles, verticesStart, verticesCount, instancesCount) {\r\n        this.drawArraysType(useTriangles ? 0 : 1, verticesStart, verticesCount, instancesCount);\r\n    };\r\n    /**\r\n     * Draw a list of indexed primitives\r\n     * @param fillMode defines the primitive to use\r\n     * @param indexStart defines the starting index\r\n     * @param indexCount defines the number of index to draw\r\n     * @param instancesCount defines the number of instances to draw (if instanciation is enabled)\r\n     */\r\n    ThinEngine.prototype.drawElementsType = function (fillMode, indexStart, indexCount, instancesCount) {\r\n        // Apply states\r\n        this.applyStates();\r\n        this._reportDrawCall();\r\n        // Render\r\n        var drawMode = this._drawMode(fillMode);\r\n        var indexFormat = this._uintIndicesCurrentlySet ? this._gl.UNSIGNED_INT : this._gl.UNSIGNED_SHORT;\r\n        var mult = this._uintIndicesCurrentlySet ? 4 : 2;\r\n        if (instancesCount) {\r\n            this._gl.drawElementsInstanced(drawMode, indexCount, indexFormat, indexStart * mult, instancesCount);\r\n        }\r\n        else {\r\n            this._gl.drawElements(drawMode, indexCount, indexFormat, indexStart * mult);\r\n        }\r\n    };\r\n    /**\r\n     * Draw a list of unindexed primitives\r\n     * @param fillMode defines the primitive to use\r\n     * @param verticesStart defines the index of first vertex to draw\r\n     * @param verticesCount defines the count of vertices to draw\r\n     * @param instancesCount defines the number of instances to draw (if instanciation is enabled)\r\n     */\r\n    ThinEngine.prototype.drawArraysType = function (fillMode, verticesStart, verticesCount, instancesCount) {\r\n        // Apply states\r\n        this.applyStates();\r\n        this._reportDrawCall();\r\n        var drawMode = this._drawMode(fillMode);\r\n        if (instancesCount) {\r\n            this._gl.drawArraysInstanced(drawMode, verticesStart, verticesCount, instancesCount);\r\n        }\r\n        else {\r\n            this._gl.drawArrays(drawMode, verticesStart, verticesCount);\r\n        }\r\n    };\r\n    ThinEngine.prototype._drawMode = function (fillMode) {\r\n        switch (fillMode) {\r\n            // Triangle views\r\n            case 0:\r\n                return this._gl.TRIANGLES;\r\n            case 2:\r\n                return this._gl.POINTS;\r\n            case 1:\r\n                return this._gl.LINES;\r\n            // Draw modes\r\n            case 3:\r\n                return this._gl.POINTS;\r\n            case 4:\r\n                return this._gl.LINES;\r\n            case 5:\r\n                return this._gl.LINE_LOOP;\r\n            case 6:\r\n                return this._gl.LINE_STRIP;\r\n            case 7:\r\n                return this._gl.TRIANGLE_STRIP;\r\n            case 8:\r\n                return this._gl.TRIANGLE_FAN;\r\n            default:\r\n                return this._gl.TRIANGLES;\r\n        }\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._reportDrawCall = function () {\r\n        // Will be implemented by children\r\n    };\r\n    // Shaders\r\n    /** @hidden */\r\n    ThinEngine.prototype._releaseEffect = function (effect) {\r\n        if (this._compiledEffects[effect._key]) {\r\n            delete this._compiledEffects[effect._key];\r\n            this._deletePipelineContext(effect.getPipelineContext());\r\n        }\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._deletePipelineContext = function (pipelineContext) {\r\n        var webGLPipelineContext = pipelineContext;\r\n        if (webGLPipelineContext && webGLPipelineContext.program) {\r\n            webGLPipelineContext.program.__SPECTOR_rebuildProgram = null;\r\n            this._gl.deleteProgram(webGLPipelineContext.program);\r\n        }\r\n    };\r\n    /**\r\n     * Create a new effect (used to store vertex/fragment shaders)\r\n     * @param baseName defines the base name of the effect (The name of file without .fragment.fx or .vertex.fx)\r\n     * @param attributesNamesOrOptions defines either a list of attribute names or an IEffectCreationOptions object\r\n     * @param uniformsNamesOrEngine defines either a list of uniform names or the engine to use\r\n     * @param samplers defines an array of string used to represent textures\r\n     * @param defines defines the string containing the defines to use to compile the shaders\r\n     * @param fallbacks defines the list of potential fallbacks to use if shader conmpilation fails\r\n     * @param onCompiled defines a function to call when the effect creation is successful\r\n     * @param onError defines a function to call when the effect creation has failed\r\n     * @param indexParameters defines an object containing the index values to use to compile shaders (like the maximum number of simultaneous lights)\r\n     * @returns the new Effect\r\n     */\r\n    ThinEngine.prototype.createEffect = function (baseName, attributesNamesOrOptions, uniformsNamesOrEngine, samplers, defines, fallbacks, onCompiled, onError, indexParameters) {\r\n        var vertex = baseName.vertexElement || baseName.vertex || baseName.vertexToken || baseName.vertexSource || baseName;\r\n        var fragment = baseName.fragmentElement || baseName.fragment || baseName.fragmentToken || baseName.fragmentSource || baseName;\r\n        var name = vertex + \"+\" + fragment + \"@\" + (defines ? defines : attributesNamesOrOptions.defines);\r\n        if (this._compiledEffects[name]) {\r\n            var compiledEffect = this._compiledEffects[name];\r\n            if (onCompiled && compiledEffect.isReady()) {\r\n                onCompiled(compiledEffect);\r\n            }\r\n            return compiledEffect;\r\n        }\r\n        var effect = new Effect(baseName, attributesNamesOrOptions, uniformsNamesOrEngine, samplers, this, defines, fallbacks, onCompiled, onError, indexParameters);\r\n        effect._key = name;\r\n        this._compiledEffects[name] = effect;\r\n        return effect;\r\n    };\r\n    ThinEngine._ConcatenateShader = function (source, defines, shaderVersion) {\r\n        if (shaderVersion === void 0) { shaderVersion = \"\"; }\r\n        return shaderVersion + (defines ? defines + \"\\n\" : \"\") + source;\r\n    };\r\n    ThinEngine.prototype._compileShader = function (source, type, defines, shaderVersion) {\r\n        return this._compileRawShader(ThinEngine._ConcatenateShader(source, defines, shaderVersion), type);\r\n    };\r\n    ThinEngine.prototype._compileRawShader = function (source, type) {\r\n        var gl = this._gl;\r\n        var shader = gl.createShader(type === \"vertex\" ? gl.VERTEX_SHADER : gl.FRAGMENT_SHADER);\r\n        if (!shader) {\r\n            throw new Error(\"Something went wrong while compile the shader.\");\r\n        }\r\n        gl.shaderSource(shader, source);\r\n        gl.compileShader(shader);\r\n        return shader;\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._getShaderSource = function (shader) {\r\n        return this._gl.getShaderSource(shader);\r\n    };\r\n    /**\r\n     * Directly creates a webGL program\r\n     * @param pipelineContext  defines the pipeline context to attach to\r\n     * @param vertexCode defines the vertex shader code to use\r\n     * @param fragmentCode defines the fragment shader code to use\r\n     * @param context defines the webGL context to use (if not set, the current one will be used)\r\n     * @param transformFeedbackVaryings defines the list of transform feedback varyings to use\r\n     * @returns the new webGL program\r\n     */\r\n    ThinEngine.prototype.createRawShaderProgram = function (pipelineContext, vertexCode, fragmentCode, context, transformFeedbackVaryings) {\r\n        if (transformFeedbackVaryings === void 0) { transformFeedbackVaryings = null; }\r\n        context = context || this._gl;\r\n        var vertexShader = this._compileRawShader(vertexCode, \"vertex\");\r\n        var fragmentShader = this._compileRawShader(fragmentCode, \"fragment\");\r\n        return this._createShaderProgram(pipelineContext, vertexShader, fragmentShader, context, transformFeedbackVaryings);\r\n    };\r\n    /**\r\n     * Creates a webGL program\r\n     * @param pipelineContext  defines the pipeline context to attach to\r\n     * @param vertexCode  defines the vertex shader code to use\r\n     * @param fragmentCode defines the fragment shader code to use\r\n     * @param defines defines the string containing the defines to use to compile the shaders\r\n     * @param context defines the webGL context to use (if not set, the current one will be used)\r\n     * @param transformFeedbackVaryings defines the list of transform feedback varyings to use\r\n     * @returns the new webGL program\r\n     */\r\n    ThinEngine.prototype.createShaderProgram = function (pipelineContext, vertexCode, fragmentCode, defines, context, transformFeedbackVaryings) {\r\n        if (transformFeedbackVaryings === void 0) { transformFeedbackVaryings = null; }\r\n        context = context || this._gl;\r\n        var shaderVersion = (this._webGLVersion > 1) ? \"#version 300 es\\n#define WEBGL2 \\n\" : \"\";\r\n        var vertexShader = this._compileShader(vertexCode, \"vertex\", defines, shaderVersion);\r\n        var fragmentShader = this._compileShader(fragmentCode, \"fragment\", defines, shaderVersion);\r\n        return this._createShaderProgram(pipelineContext, vertexShader, fragmentShader, context, transformFeedbackVaryings);\r\n    };\r\n    /**\r\n     * Creates a new pipeline context\r\n     * @returns the new pipeline\r\n     */\r\n    ThinEngine.prototype.createPipelineContext = function () {\r\n        var pipelineContext = new WebGLPipelineContext();\r\n        pipelineContext.engine = this;\r\n        if (this._caps.parallelShaderCompile) {\r\n            pipelineContext.isParallelCompiled = true;\r\n        }\r\n        return pipelineContext;\r\n    };\r\n    ThinEngine.prototype._createShaderProgram = function (pipelineContext, vertexShader, fragmentShader, context, transformFeedbackVaryings) {\r\n        if (transformFeedbackVaryings === void 0) { transformFeedbackVaryings = null; }\r\n        var shaderProgram = context.createProgram();\r\n        pipelineContext.program = shaderProgram;\r\n        if (!shaderProgram) {\r\n            throw new Error(\"Unable to create program\");\r\n        }\r\n        context.attachShader(shaderProgram, vertexShader);\r\n        context.attachShader(shaderProgram, fragmentShader);\r\n        context.linkProgram(shaderProgram);\r\n        pipelineContext.context = context;\r\n        pipelineContext.vertexShader = vertexShader;\r\n        pipelineContext.fragmentShader = fragmentShader;\r\n        if (!pipelineContext.isParallelCompiled) {\r\n            this._finalizePipelineContext(pipelineContext);\r\n        }\r\n        return shaderProgram;\r\n    };\r\n    ThinEngine.prototype._finalizePipelineContext = function (pipelineContext) {\r\n        var context = pipelineContext.context;\r\n        var vertexShader = pipelineContext.vertexShader;\r\n        var fragmentShader = pipelineContext.fragmentShader;\r\n        var program = pipelineContext.program;\r\n        var linked = context.getProgramParameter(program, context.LINK_STATUS);\r\n        if (!linked) { // Get more info\r\n            // Vertex\r\n            if (!this._gl.getShaderParameter(vertexShader, this._gl.COMPILE_STATUS)) {\r\n                var log = this._gl.getShaderInfoLog(vertexShader);\r\n                if (log) {\r\n                    pipelineContext.vertexCompilationError = log;\r\n                    throw new Error(\"VERTEX SHADER \" + log);\r\n                }\r\n            }\r\n            // Fragment\r\n            if (!this._gl.getShaderParameter(fragmentShader, this._gl.COMPILE_STATUS)) {\r\n                var log = this._gl.getShaderInfoLog(fragmentShader);\r\n                if (log) {\r\n                    pipelineContext.fragmentCompilationError = log;\r\n                    throw new Error(\"FRAGMENT SHADER \" + log);\r\n                }\r\n            }\r\n            var error = context.getProgramInfoLog(program);\r\n            if (error) {\r\n                pipelineContext.programLinkError = error;\r\n                throw new Error(error);\r\n            }\r\n        }\r\n        if (this.validateShaderPrograms) {\r\n            context.validateProgram(program);\r\n            var validated = context.getProgramParameter(program, context.VALIDATE_STATUS);\r\n            if (!validated) {\r\n                var error = context.getProgramInfoLog(program);\r\n                if (error) {\r\n                    pipelineContext.programValidationError = error;\r\n                    throw new Error(error);\r\n                }\r\n            }\r\n        }\r\n        context.deleteShader(vertexShader);\r\n        context.deleteShader(fragmentShader);\r\n        pipelineContext.vertexShader = undefined;\r\n        pipelineContext.fragmentShader = undefined;\r\n        if (pipelineContext.onCompiled) {\r\n            pipelineContext.onCompiled();\r\n            pipelineContext.onCompiled = undefined;\r\n        }\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._preparePipelineContext = function (pipelineContext, vertexSourceCode, fragmentSourceCode, createAsRaw, rebuildRebind, defines, transformFeedbackVaryings) {\r\n        var webGLRenderingState = pipelineContext;\r\n        if (createAsRaw) {\r\n            webGLRenderingState.program = this.createRawShaderProgram(webGLRenderingState, vertexSourceCode, fragmentSourceCode, undefined, transformFeedbackVaryings);\r\n        }\r\n        else {\r\n            webGLRenderingState.program = this.createShaderProgram(webGLRenderingState, vertexSourceCode, fragmentSourceCode, defines, undefined, transformFeedbackVaryings);\r\n        }\r\n        webGLRenderingState.program.__SPECTOR_rebuildProgram = rebuildRebind;\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._isRenderingStateCompiled = function (pipelineContext) {\r\n        var webGLPipelineContext = pipelineContext;\r\n        if (this._gl.getProgramParameter(webGLPipelineContext.program, this._caps.parallelShaderCompile.COMPLETION_STATUS_KHR)) {\r\n            this._finalizePipelineContext(webGLPipelineContext);\r\n            return true;\r\n        }\r\n        return false;\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._executeWhenRenderingStateIsCompiled = function (pipelineContext, action) {\r\n        var webGLPipelineContext = pipelineContext;\r\n        if (!webGLPipelineContext.isParallelCompiled) {\r\n            action();\r\n            return;\r\n        }\r\n        var oldHandler = webGLPipelineContext.onCompiled;\r\n        if (oldHandler) {\r\n            webGLPipelineContext.onCompiled = function () {\r\n                oldHandler();\r\n                action();\r\n            };\r\n        }\r\n        else {\r\n            webGLPipelineContext.onCompiled = action;\r\n        }\r\n    };\r\n    /**\r\n     * Gets the list of webGL uniform locations associated with a specific program based on a list of uniform names\r\n     * @param pipelineContext defines the pipeline context to use\r\n     * @param uniformsNames defines the list of uniform names\r\n     * @returns an array of webGL uniform locations\r\n     */\r\n    ThinEngine.prototype.getUniforms = function (pipelineContext, uniformsNames) {\r\n        var results = new Array();\r\n        var webGLPipelineContext = pipelineContext;\r\n        for (var index = 0; index < uniformsNames.length; index++) {\r\n            results.push(this._gl.getUniformLocation(webGLPipelineContext.program, uniformsNames[index]));\r\n        }\r\n        return results;\r\n    };\r\n    /**\r\n     * Gets the lsit of active attributes for a given webGL program\r\n     * @param pipelineContext defines the pipeline context to use\r\n     * @param attributesNames defines the list of attribute names to get\r\n     * @returns an array of indices indicating the offset of each attribute\r\n     */\r\n    ThinEngine.prototype.getAttributes = function (pipelineContext, attributesNames) {\r\n        var results = [];\r\n        var webGLPipelineContext = pipelineContext;\r\n        for (var index = 0; index < attributesNames.length; index++) {\r\n            try {\r\n                results.push(this._gl.getAttribLocation(webGLPipelineContext.program, attributesNames[index]));\r\n            }\r\n            catch (e) {\r\n                results.push(-1);\r\n            }\r\n        }\r\n        return results;\r\n    };\r\n    /**\r\n     * Activates an effect, mkaing it the current one (ie. the one used for rendering)\r\n     * @param effect defines the effect to activate\r\n     */\r\n    ThinEngine.prototype.enableEffect = function (effect) {\r\n        if (!effect || effect === this._currentEffect) {\r\n            return;\r\n        }\r\n        // Use program\r\n        this.bindSamplers(effect);\r\n        this._currentEffect = effect;\r\n        if (effect.onBind) {\r\n            effect.onBind(effect);\r\n        }\r\n        if (effect._onBindObservable) {\r\n            effect._onBindObservable.notifyObservers(effect);\r\n        }\r\n    };\r\n    /**\r\n     * Set the value of an uniform to a number (int)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param value defines the int number to store\r\n     * @returns true if the value was set\r\n     */\r\n    ThinEngine.prototype.setInt = function (uniform, value) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._gl.uniform1i(uniform, value);\r\n        return true;\r\n    };\r\n    /**\r\n     * Set the value of an uniform to an array of int32\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of int32 to store\r\n     * @returns true if the value was set\r\n     */\r\n    ThinEngine.prototype.setIntArray = function (uniform, array) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._gl.uniform1iv(uniform, array);\r\n        return true;\r\n    };\r\n    /**\r\n     * Set the value of an uniform to an array of int32 (stored as vec2)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of int32 to store\r\n     * @returns true if the value was set\r\n     */\r\n    ThinEngine.prototype.setIntArray2 = function (uniform, array) {\r\n        if (!uniform || array.length % 2 !== 0) {\r\n            return false;\r\n        }\r\n        this._gl.uniform2iv(uniform, array);\r\n        return true;\r\n    };\r\n    /**\r\n     * Set the value of an uniform to an array of int32 (stored as vec3)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of int32 to store\r\n     * @returns true if the value was set\r\n     */\r\n    ThinEngine.prototype.setIntArray3 = function (uniform, array) {\r\n        if (!uniform || array.length % 3 !== 0) {\r\n            return false;\r\n        }\r\n        this._gl.uniform3iv(uniform, array);\r\n        return true;\r\n    };\r\n    /**\r\n     * Set the value of an uniform to an array of int32 (stored as vec4)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of int32 to store\r\n     * @returns true if the value was set\r\n     */\r\n    ThinEngine.prototype.setIntArray4 = function (uniform, array) {\r\n        if (!uniform || array.length % 4 !== 0) {\r\n            return false;\r\n        }\r\n        this._gl.uniform4iv(uniform, array);\r\n        return true;\r\n    };\r\n    /**\r\n     * Set the value of an uniform to an array of number\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of number to store\r\n     * @returns true if the value was set\r\n     */\r\n    ThinEngine.prototype.setArray = function (uniform, array) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._gl.uniform1fv(uniform, array);\r\n        return true;\r\n    };\r\n    /**\r\n     * Set the value of an uniform to an array of number (stored as vec2)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of number to store\r\n     * @returns true if the value was set\r\n     */\r\n    ThinEngine.prototype.setArray2 = function (uniform, array) {\r\n        if (!uniform || array.length % 2 !== 0) {\r\n            return false;\r\n        }\r\n        this._gl.uniform2fv(uniform, array);\r\n        return true;\r\n    };\r\n    /**\r\n     * Set the value of an uniform to an array of number (stored as vec3)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of number to store\r\n     * @returns true if the value was set\r\n     */\r\n    ThinEngine.prototype.setArray3 = function (uniform, array) {\r\n        if (!uniform || array.length % 3 !== 0) {\r\n            return false;\r\n        }\r\n        this._gl.uniform3fv(uniform, array);\r\n        return true;\r\n    };\r\n    /**\r\n     * Set the value of an uniform to an array of number (stored as vec4)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param array defines the array of number to store\r\n     * @returns true if the value was set\r\n     */\r\n    ThinEngine.prototype.setArray4 = function (uniform, array) {\r\n        if (!uniform || array.length % 4 !== 0) {\r\n            return false;\r\n        }\r\n        this._gl.uniform4fv(uniform, array);\r\n        return true;\r\n    };\r\n    /**\r\n     * Set the value of an uniform to an array of float32 (stored as matrices)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param matrices defines the array of float32 to store\r\n     * @returns true if the value was set\r\n     */\r\n    ThinEngine.prototype.setMatrices = function (uniform, matrices) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._gl.uniformMatrix4fv(uniform, false, matrices);\r\n        return true;\r\n    };\r\n    /**\r\n     * Set the value of an uniform to a matrix (3x3)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param matrix defines the Float32Array representing the 3x3 matrix to store\r\n     * @returns true if the value was set\r\n     */\r\n    ThinEngine.prototype.setMatrix3x3 = function (uniform, matrix) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._gl.uniformMatrix3fv(uniform, false, matrix);\r\n        return true;\r\n    };\r\n    /**\r\n     * Set the value of an uniform to a matrix (2x2)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param matrix defines the Float32Array representing the 2x2 matrix to store\r\n     * @returns true if the value was set\r\n     */\r\n    ThinEngine.prototype.setMatrix2x2 = function (uniform, matrix) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._gl.uniformMatrix2fv(uniform, false, matrix);\r\n        return true;\r\n    };\r\n    /**\r\n     * Set the value of an uniform to a number (float)\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param value defines the float number to store\r\n     * @returns true if the value was transfered\r\n     */\r\n    ThinEngine.prototype.setFloat = function (uniform, value) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._gl.uniform1f(uniform, value);\r\n        return true;\r\n    };\r\n    /**\r\n     * Set the value of an uniform to a vec2\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param x defines the 1st component of the value\r\n     * @param y defines the 2nd component of the value\r\n     * @returns true if the value was set\r\n     */\r\n    ThinEngine.prototype.setFloat2 = function (uniform, x, y) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._gl.uniform2f(uniform, x, y);\r\n        return true;\r\n    };\r\n    /**\r\n     * Set the value of an uniform to a vec3\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param x defines the 1st component of the value\r\n     * @param y defines the 2nd component of the value\r\n     * @param z defines the 3rd component of the value\r\n     * @returns true if the value was set\r\n     */\r\n    ThinEngine.prototype.setFloat3 = function (uniform, x, y, z) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._gl.uniform3f(uniform, x, y, z);\r\n        return true;\r\n    };\r\n    /**\r\n     * Set the value of an uniform to a vec4\r\n     * @param uniform defines the webGL uniform location where to store the value\r\n     * @param x defines the 1st component of the value\r\n     * @param y defines the 2nd component of the value\r\n     * @param z defines the 3rd component of the value\r\n     * @param w defines the 4th component of the value\r\n     * @returns true if the value was set\r\n     */\r\n    ThinEngine.prototype.setFloat4 = function (uniform, x, y, z, w) {\r\n        if (!uniform) {\r\n            return false;\r\n        }\r\n        this._gl.uniform4f(uniform, x, y, z, w);\r\n        return true;\r\n    };\r\n    // States\r\n    /**\r\n     * Apply all cached states (depth, culling, stencil and alpha)\r\n     */\r\n    ThinEngine.prototype.applyStates = function () {\r\n        this._depthCullingState.apply(this._gl);\r\n        this._stencilState.apply(this._gl);\r\n        this._alphaState.apply(this._gl);\r\n        if (this._colorWriteChanged) {\r\n            this._colorWriteChanged = false;\r\n            var enable = this._colorWrite;\r\n            this._gl.colorMask(enable, enable, enable, enable);\r\n        }\r\n    };\r\n    /**\r\n     * Enable or disable color writing\r\n     * @param enable defines the state to set\r\n     */\r\n    ThinEngine.prototype.setColorWrite = function (enable) {\r\n        if (enable !== this._colorWrite) {\r\n            this._colorWriteChanged = true;\r\n            this._colorWrite = enable;\r\n        }\r\n    };\r\n    /**\r\n     * Gets a boolean indicating if color writing is enabled\r\n     * @returns the current color writing state\r\n     */\r\n    ThinEngine.prototype.getColorWrite = function () {\r\n        return this._colorWrite;\r\n    };\r\n    Object.defineProperty(ThinEngine.prototype, \"depthCullingState\", {\r\n        /**\r\n         * Gets the depth culling state manager\r\n         */\r\n        get: function () {\r\n            return this._depthCullingState;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(ThinEngine.prototype, \"alphaState\", {\r\n        /**\r\n         * Gets the alpha state manager\r\n         */\r\n        get: function () {\r\n            return this._alphaState;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    Object.defineProperty(ThinEngine.prototype, \"stencilState\", {\r\n        /**\r\n         * Gets the stencil state manager\r\n         */\r\n        get: function () {\r\n            return this._stencilState;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    // Textures\r\n    /**\r\n     * Clears the list of texture accessible through engine.\r\n     * This can help preventing texture load conflict due to name collision.\r\n     */\r\n    ThinEngine.prototype.clearInternalTexturesCache = function () {\r\n        this._internalTexturesCache = [];\r\n    };\r\n    /**\r\n     * Force the entire cache to be cleared\r\n     * You should not have to use this function unless your engine needs to share the webGL context with another engine\r\n     * @param bruteForce defines a boolean to force clearing ALL caches (including stencil, detoh and alpha states)\r\n     */\r\n    ThinEngine.prototype.wipeCaches = function (bruteForce) {\r\n        if (this.preventCacheWipeBetweenFrames && !bruteForce) {\r\n            return;\r\n        }\r\n        this._currentEffect = null;\r\n        this._viewportCached.x = 0;\r\n        this._viewportCached.y = 0;\r\n        this._viewportCached.z = 0;\r\n        this._viewportCached.w = 0;\r\n        // Done before in case we clean the attributes\r\n        this._unbindVertexArrayObject();\r\n        if (bruteForce) {\r\n            this._currentProgram = null;\r\n            this.resetTextureCache();\r\n            this._stencilState.reset();\r\n            this._depthCullingState.reset();\r\n            this._depthCullingState.depthFunc = this._gl.LEQUAL;\r\n            this._alphaState.reset();\r\n            this._alphaMode = 1;\r\n            this._alphaEquation = 0;\r\n            this._colorWrite = true;\r\n            this._colorWriteChanged = true;\r\n            this._unpackFlipYCached = null;\r\n            this._gl.pixelStorei(this._gl.UNPACK_COLORSPACE_CONVERSION_WEBGL, this._gl.NONE);\r\n            this._gl.pixelStorei(this._gl.UNPACK_PREMULTIPLY_ALPHA_WEBGL, 0);\r\n            this._mustWipeVertexAttributes = true;\r\n            this.unbindAllAttributes();\r\n        }\r\n        this._resetVertexBufferBinding();\r\n        this._cachedIndexBuffer = null;\r\n        this._cachedEffectForVertexBuffers = null;\r\n        this.bindIndexBuffer(null);\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._getSamplingParameters = function (samplingMode, generateMipMaps) {\r\n        var gl = this._gl;\r\n        var magFilter = gl.NEAREST;\r\n        var minFilter = gl.NEAREST;\r\n        switch (samplingMode) {\r\n            case 11:\r\n                magFilter = gl.LINEAR;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.LINEAR_MIPMAP_NEAREST;\r\n                }\r\n                else {\r\n                    minFilter = gl.LINEAR;\r\n                }\r\n                break;\r\n            case 3:\r\n                magFilter = gl.LINEAR;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.LINEAR_MIPMAP_LINEAR;\r\n                }\r\n                else {\r\n                    minFilter = gl.LINEAR;\r\n                }\r\n                break;\r\n            case 8:\r\n                magFilter = gl.NEAREST;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.NEAREST_MIPMAP_LINEAR;\r\n                }\r\n                else {\r\n                    minFilter = gl.NEAREST;\r\n                }\r\n                break;\r\n            case 4:\r\n                magFilter = gl.NEAREST;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.NEAREST_MIPMAP_NEAREST;\r\n                }\r\n                else {\r\n                    minFilter = gl.NEAREST;\r\n                }\r\n                break;\r\n            case 5:\r\n                magFilter = gl.NEAREST;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.LINEAR_MIPMAP_NEAREST;\r\n                }\r\n                else {\r\n                    minFilter = gl.LINEAR;\r\n                }\r\n                break;\r\n            case 6:\r\n                magFilter = gl.NEAREST;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.LINEAR_MIPMAP_LINEAR;\r\n                }\r\n                else {\r\n                    minFilter = gl.LINEAR;\r\n                }\r\n                break;\r\n            case 7:\r\n                magFilter = gl.NEAREST;\r\n                minFilter = gl.LINEAR;\r\n                break;\r\n            case 1:\r\n                magFilter = gl.NEAREST;\r\n                minFilter = gl.NEAREST;\r\n                break;\r\n            case 9:\r\n                magFilter = gl.LINEAR;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.NEAREST_MIPMAP_NEAREST;\r\n                }\r\n                else {\r\n                    minFilter = gl.NEAREST;\r\n                }\r\n                break;\r\n            case 10:\r\n                magFilter = gl.LINEAR;\r\n                if (generateMipMaps) {\r\n                    minFilter = gl.NEAREST_MIPMAP_LINEAR;\r\n                }\r\n                else {\r\n                    minFilter = gl.NEAREST;\r\n                }\r\n                break;\r\n            case 2:\r\n                magFilter = gl.LINEAR;\r\n                minFilter = gl.LINEAR;\r\n                break;\r\n            case 12:\r\n                magFilter = gl.LINEAR;\r\n                minFilter = gl.NEAREST;\r\n                break;\r\n        }\r\n        return {\r\n            min: minFilter,\r\n            mag: magFilter\r\n        };\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._createTexture = function () {\r\n        var texture = this._gl.createTexture();\r\n        if (!texture) {\r\n            throw new Error(\"Unable to create texture\");\r\n        }\r\n        return texture;\r\n    };\r\n    /**\r\n     * Usually called from Texture.ts.\r\n     * Passed information to create a WebGLTexture\r\n     * @param url defines a value which contains one of the following:\r\n     * * A conventional http URL, e.g. 'http://...' or 'file://...'\r\n     * * A base64 string of in-line texture data, e.g. 'data:image/jpg;base64,/...'\r\n     * * An indicator that data being passed using the buffer parameter, e.g. 'data:mytexture.jpg'\r\n     * @param noMipmap defines a boolean indicating that no mipmaps shall be generated.  Ignored for compressed textures.  They must be in the file\r\n     * @param invertY when true, image is flipped when loaded.  You probably want true. Certain compressed textures may invert this if their default is inverted (eg. ktx)\r\n     * @param scene needed for loading to the correct scene\r\n     * @param samplingMode mode with should be used sample / access the texture (Default: Texture.TRILINEAR_SAMPLINGMODE)\r\n     * @param onLoad optional callback to be called upon successful completion\r\n     * @param onError optional callback to be called upon failure\r\n     * @param buffer a source of a file previously fetched as either a base64 string, an ArrayBuffer (compressed or image format), HTMLImageElement (image format), or a Blob\r\n     * @param fallback an internal argument in case the function must be called again, due to etc1 not having alpha capabilities\r\n     * @param format internal format.  Default: RGB when extension is '.jpg' else RGBA.  Ignored for compressed textures\r\n     * @param forcedExtension defines the extension to use to pick the right loader\r\n     * @param mimeType defines an optional mime type\r\n     * @param loaderOptions options to be passed to the loader\r\n     * @returns a InternalTexture for assignment back into BABYLON.Texture\r\n     */\r\n    ThinEngine.prototype.createTexture = function (url, noMipmap, invertY, scene, samplingMode, onLoad, onError, buffer, fallback, format, forcedExtension, mimeType, loaderOptions) {\r\n        var _this = this;\r\n        if (samplingMode === void 0) { samplingMode = 3; }\r\n        if (onLoad === void 0) { onLoad = null; }\r\n        if (onError === void 0) { onError = null; }\r\n        if (buffer === void 0) { buffer = null; }\r\n        if (fallback === void 0) { fallback = null; }\r\n        if (format === void 0) { format = null; }\r\n        if (forcedExtension === void 0) { forcedExtension = null; }\r\n        url = url || \"\";\r\n        var fromData = url.substr(0, 5) === \"data:\";\r\n        var fromBlob = url.substr(0, 5) === \"blob:\";\r\n        var isBase64 = fromData && url.indexOf(\";base64,\") !== -1;\r\n        var texture = fallback ? fallback : new InternalTexture(this, InternalTextureSource.Url);\r\n        var originalUrl = url;\r\n        if (this._transformTextureUrl && !isBase64 && !fallback && !buffer) {\r\n            url = this._transformTextureUrl(url);\r\n        }\r\n        if (originalUrl !== url) {\r\n            texture._originalUrl = originalUrl;\r\n        }\r\n        // establish the file extension, if possible\r\n        var lastDot = url.lastIndexOf('.');\r\n        var extension = forcedExtension ? forcedExtension : (lastDot > -1 ? url.substring(lastDot).toLowerCase() : \"\");\r\n        var loader = null;\r\n        // Remove query string\r\n        var queryStringIndex = extension.indexOf(\"?\");\r\n        if (queryStringIndex > -1) {\r\n            extension = extension.split(\"?\")[0];\r\n        }\r\n        for (var _i = 0, _a = ThinEngine._TextureLoaders; _i < _a.length; _i++) {\r\n            var availableLoader = _a[_i];\r\n            if (availableLoader.canLoad(extension, mimeType)) {\r\n                loader = availableLoader;\r\n                break;\r\n            }\r\n        }\r\n        if (scene) {\r\n            scene._addPendingData(texture);\r\n        }\r\n        texture.url = url;\r\n        texture.generateMipMaps = !noMipmap;\r\n        texture.samplingMode = samplingMode;\r\n        texture.invertY = invertY;\r\n        if (!this._doNotHandleContextLost) {\r\n            // Keep a link to the buffer only if we plan to handle context lost\r\n            texture._buffer = buffer;\r\n        }\r\n        var onLoadObserver = null;\r\n        if (onLoad && !fallback) {\r\n            onLoadObserver = texture.onLoadedObservable.add(onLoad);\r\n        }\r\n        if (!fallback) {\r\n            this._internalTexturesCache.push(texture);\r\n        }\r\n        var onInternalError = function (message, exception) {\r\n            if (scene) {\r\n                scene._removePendingData(texture);\r\n            }\r\n            if (url === originalUrl) {\r\n                if (onLoadObserver) {\r\n                    texture.onLoadedObservable.remove(onLoadObserver);\r\n                }\r\n                if (EngineStore.UseFallbackTexture) {\r\n                    _this.createTexture(EngineStore.FallbackTexture, noMipmap, texture.invertY, scene, samplingMode, null, onError, buffer, texture);\r\n                }\r\n                if (onError) {\r\n                    onError((message || \"Unknown error\") + (EngineStore.UseFallbackTexture ? \" - Fallback texture was used\" : \"\"), exception);\r\n                }\r\n            }\r\n            else {\r\n                // fall back to the original url if the transformed url fails to load\r\n                Logger.Warn(\"Failed to load \" + url + \", falling back to \" + originalUrl);\r\n                _this.createTexture(originalUrl, noMipmap, texture.invertY, scene, samplingMode, onLoad, onError, buffer, texture, format, forcedExtension, mimeType, loaderOptions);\r\n            }\r\n        };\r\n        // processing for non-image formats\r\n        if (loader) {\r\n            var callback_1 = function (data) {\r\n                loader.loadData(data, texture, function (width, height, loadMipmap, isCompressed, done, loadFailed) {\r\n                    if (loadFailed) {\r\n                        onInternalError(\"TextureLoader failed to load data\");\r\n                    }\r\n                    else {\r\n                        _this._prepareWebGLTexture(texture, scene, width, height, texture.invertY, !loadMipmap, isCompressed, function () {\r\n                            done();\r\n                            return false;\r\n                        }, samplingMode);\r\n                    }\r\n                }, loaderOptions);\r\n            };\r\n            if (!buffer) {\r\n                this._loadFile(url, function (data) { return callback_1(new Uint8Array(data)); }, undefined, scene ? scene.offlineProvider : undefined, true, function (request, exception) {\r\n                    onInternalError(\"Unable to load \" + (request ? request.responseURL : url, exception));\r\n                });\r\n            }\r\n            else {\r\n                if (buffer instanceof ArrayBuffer) {\r\n                    callback_1(new Uint8Array(buffer));\r\n                }\r\n                else if (ArrayBuffer.isView(buffer)) {\r\n                    callback_1(buffer);\r\n                }\r\n                else {\r\n                    if (onError) {\r\n                        onError(\"Unable to load: only ArrayBuffer or ArrayBufferView is supported\", null);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n        else {\r\n            var onload_1 = function (img) {\r\n                if (fromBlob && !_this._doNotHandleContextLost) {\r\n                    // We need to store the image if we need to rebuild the texture\r\n                    // in case of a webgl context lost\r\n                    texture._buffer = img;\r\n                }\r\n                _this._prepareWebGLTexture(texture, scene, img.width, img.height, texture.invertY, noMipmap, false, function (potWidth, potHeight, continuationCallback) {\r\n                    var gl = _this._gl;\r\n                    var isPot = (img.width === potWidth && img.height === potHeight);\r\n                    var internalFormat = format ? _this._getInternalFormat(format) : ((extension === \".jpg\") ? gl.RGB : gl.RGBA);\r\n                    if (isPot) {\r\n                        gl.texImage2D(gl.TEXTURE_2D, 0, internalFormat, internalFormat, gl.UNSIGNED_BYTE, img);\r\n                        return false;\r\n                    }\r\n                    var maxTextureSize = _this._caps.maxTextureSize;\r\n                    if (img.width > maxTextureSize || img.height > maxTextureSize || !_this._supportsHardwareTextureRescaling) {\r\n                        _this._prepareWorkingCanvas();\r\n                        if (!_this._workingCanvas || !_this._workingContext) {\r\n                            return false;\r\n                        }\r\n                        _this._workingCanvas.width = potWidth;\r\n                        _this._workingCanvas.height = potHeight;\r\n                        _this._workingContext.drawImage(img, 0, 0, img.width, img.height, 0, 0, potWidth, potHeight);\r\n                        gl.texImage2D(gl.TEXTURE_2D, 0, internalFormat, internalFormat, gl.UNSIGNED_BYTE, _this._workingCanvas);\r\n                        texture.width = potWidth;\r\n                        texture.height = potHeight;\r\n                        return false;\r\n                    }\r\n                    else {\r\n                        // Using shaders when possible to rescale because canvas.drawImage is lossy\r\n                        var source_1 = new InternalTexture(_this, InternalTextureSource.Temp);\r\n                        _this._bindTextureDirectly(gl.TEXTURE_2D, source_1, true);\r\n                        gl.texImage2D(gl.TEXTURE_2D, 0, internalFormat, internalFormat, gl.UNSIGNED_BYTE, img);\r\n                        _this._rescaleTexture(source_1, texture, scene, internalFormat, function () {\r\n                            _this._releaseTexture(source_1);\r\n                            _this._bindTextureDirectly(gl.TEXTURE_2D, texture, true);\r\n                            continuationCallback();\r\n                        });\r\n                    }\r\n                    return true;\r\n                }, samplingMode);\r\n            };\r\n            if (!fromData || isBase64) {\r\n                if (buffer && (buffer.decoding || buffer.close)) {\r\n                    onload_1(buffer);\r\n                }\r\n                else {\r\n                    ThinEngine._FileToolsLoadImage(url, onload_1, onInternalError, scene ? scene.offlineProvider : null, mimeType);\r\n                }\r\n            }\r\n            else if (typeof buffer === \"string\" || buffer instanceof ArrayBuffer || ArrayBuffer.isView(buffer) || buffer instanceof Blob) {\r\n                ThinEngine._FileToolsLoadImage(buffer, onload_1, onInternalError, scene ? scene.offlineProvider : null, mimeType);\r\n            }\r\n            else if (buffer) {\r\n                onload_1(buffer);\r\n            }\r\n        }\r\n        return texture;\r\n    };\r\n    /**\r\n     * Loads an image as an HTMLImageElement.\r\n     * @param input url string, ArrayBuffer, or Blob to load\r\n     * @param onLoad callback called when the image successfully loads\r\n     * @param onError callback called when the image fails to load\r\n     * @param offlineProvider offline provider for caching\r\n     * @param mimeType optional mime type\r\n     * @returns the HTMLImageElement of the loaded image\r\n     * @hidden\r\n     */\r\n    ThinEngine._FileToolsLoadImage = function (input, onLoad, onError, offlineProvider, mimeType) {\r\n        throw _DevTools.WarnImport(\"FileTools\");\r\n    };\r\n    /**\r\n     * @hidden\r\n     */\r\n    ThinEngine.prototype._rescaleTexture = function (source, destination, scene, internalFormat, onComplete) {\r\n    };\r\n    /**\r\n     * Creates a raw texture\r\n     * @param data defines the data to store in the texture\r\n     * @param width defines the width of the texture\r\n     * @param height defines the height of the texture\r\n     * @param format defines the format of the data\r\n     * @param generateMipMaps defines if the engine should generate the mip levels\r\n     * @param invertY defines if data must be stored with Y axis inverted\r\n     * @param samplingMode defines the required sampling mode (Texture.NEAREST_SAMPLINGMODE by default)\r\n     * @param compression defines the compression used (null by default)\r\n     * @param type defines the type fo the data (Engine.TEXTURETYPE_UNSIGNED_INT by default)\r\n     * @returns the raw texture inside an InternalTexture\r\n     */\r\n    ThinEngine.prototype.createRawTexture = function (data, width, height, format, generateMipMaps, invertY, samplingMode, compression, type) {\r\n        if (compression === void 0) { compression = null; }\r\n        if (type === void 0) { type = 0; }\r\n        throw _DevTools.WarnImport(\"Engine.RawTexture\");\r\n    };\r\n    /**\r\n     * Creates a new raw cube texture\r\n     * @param data defines the array of data to use to create each face\r\n     * @param size defines the size of the textures\r\n     * @param format defines the format of the data\r\n     * @param type defines the type of the data (like Engine.TEXTURETYPE_UNSIGNED_INT)\r\n     * @param generateMipMaps  defines if the engine should generate the mip levels\r\n     * @param invertY defines if data must be stored with Y axis inverted\r\n     * @param samplingMode defines the required sampling mode (like Texture.NEAREST_SAMPLINGMODE)\r\n     * @param compression defines the compression used (null by default)\r\n     * @returns the cube texture as an InternalTexture\r\n     */\r\n    ThinEngine.prototype.createRawCubeTexture = function (data, size, format, type, generateMipMaps, invertY, samplingMode, compression) {\r\n        if (compression === void 0) { compression = null; }\r\n        throw _DevTools.WarnImport(\"Engine.RawTexture\");\r\n    };\r\n    /**\r\n     * Creates a new raw 3D texture\r\n     * @param data defines the data used to create the texture\r\n     * @param width defines the width of the texture\r\n     * @param height defines the height of the texture\r\n     * @param depth defines the depth of the texture\r\n     * @param format defines the format of the texture\r\n     * @param generateMipMaps defines if the engine must generate mip levels\r\n     * @param invertY defines if data must be stored with Y axis inverted\r\n     * @param samplingMode defines the required sampling mode (like Texture.NEAREST_SAMPLINGMODE)\r\n     * @param compression defines the compressed used (can be null)\r\n     * @param textureType defines the compressed used (can be null)\r\n     * @returns a new raw 3D texture (stored in an InternalTexture)\r\n     */\r\n    ThinEngine.prototype.createRawTexture3D = function (data, width, height, depth, format, generateMipMaps, invertY, samplingMode, compression, textureType) {\r\n        if (compression === void 0) { compression = null; }\r\n        if (textureType === void 0) { textureType = 0; }\r\n        throw _DevTools.WarnImport(\"Engine.RawTexture\");\r\n    };\r\n    /**\r\n     * Creates a new raw 2D array texture\r\n     * @param data defines the data used to create the texture\r\n     * @param width defines the width of the texture\r\n     * @param height defines the height of the texture\r\n     * @param depth defines the number of layers of the texture\r\n     * @param format defines the format of the texture\r\n     * @param generateMipMaps defines if the engine must generate mip levels\r\n     * @param invertY defines if data must be stored with Y axis inverted\r\n     * @param samplingMode defines the required sampling mode (like Texture.NEAREST_SAMPLINGMODE)\r\n     * @param compression defines the compressed used (can be null)\r\n     * @param textureType defines the compressed used (can be null)\r\n     * @returns a new raw 2D array texture (stored in an InternalTexture)\r\n     */\r\n    ThinEngine.prototype.createRawTexture2DArray = function (data, width, height, depth, format, generateMipMaps, invertY, samplingMode, compression, textureType) {\r\n        if (compression === void 0) { compression = null; }\r\n        if (textureType === void 0) { textureType = 0; }\r\n        throw _DevTools.WarnImport(\"Engine.RawTexture\");\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._unpackFlipY = function (value) {\r\n        if (this._unpackFlipYCached !== value) {\r\n            this._gl.pixelStorei(this._gl.UNPACK_FLIP_Y_WEBGL, value ? 1 : 0);\r\n            if (this.enableUnpackFlipYCached) {\r\n                this._unpackFlipYCached = value;\r\n            }\r\n        }\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._getUnpackAlignement = function () {\r\n        return this._gl.getParameter(this._gl.UNPACK_ALIGNMENT);\r\n    };\r\n    ThinEngine.prototype._getTextureTarget = function (texture) {\r\n        if (texture.isCube) {\r\n            return this._gl.TEXTURE_CUBE_MAP;\r\n        }\r\n        else if (texture.is3D) {\r\n            return this._gl.TEXTURE_3D;\r\n        }\r\n        else if (texture.is2DArray || texture.isMultiview) {\r\n            return this._gl.TEXTURE_2D_ARRAY;\r\n        }\r\n        return this._gl.TEXTURE_2D;\r\n    };\r\n    /**\r\n     * Update the sampling mode of a given texture\r\n     * @param samplingMode defines the required sampling mode\r\n     * @param texture defines the texture to update\r\n     * @param generateMipMaps defines whether to generate mipmaps for the texture\r\n     */\r\n    ThinEngine.prototype.updateTextureSamplingMode = function (samplingMode, texture, generateMipMaps) {\r\n        if (generateMipMaps === void 0) { generateMipMaps = false; }\r\n        var target = this._getTextureTarget(texture);\r\n        var filters = this._getSamplingParameters(samplingMode, texture.generateMipMaps || generateMipMaps);\r\n        this._setTextureParameterInteger(target, this._gl.TEXTURE_MAG_FILTER, filters.mag, texture);\r\n        this._setTextureParameterInteger(target, this._gl.TEXTURE_MIN_FILTER, filters.min);\r\n        if (generateMipMaps) {\r\n            texture.generateMipMaps = true;\r\n            this._gl.generateMipmap(target);\r\n        }\r\n        this._bindTextureDirectly(target, null);\r\n        texture.samplingMode = samplingMode;\r\n    };\r\n    /**\r\n     * Update the sampling mode of a given texture\r\n     * @param texture defines the texture to update\r\n     * @param wrapU defines the texture wrap mode of the u coordinates\r\n     * @param wrapV defines the texture wrap mode of the v coordinates\r\n     * @param wrapR defines the texture wrap mode of the r coordinates\r\n     */\r\n    ThinEngine.prototype.updateTextureWrappingMode = function (texture, wrapU, wrapV, wrapR) {\r\n        if (wrapV === void 0) { wrapV = null; }\r\n        if (wrapR === void 0) { wrapR = null; }\r\n        var target = this._getTextureTarget(texture);\r\n        if (wrapU !== null) {\r\n            this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_S, this._getTextureWrapMode(wrapU), texture);\r\n            texture._cachedWrapU = wrapU;\r\n        }\r\n        if (wrapV !== null) {\r\n            this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_T, this._getTextureWrapMode(wrapV), texture);\r\n            texture._cachedWrapV = wrapV;\r\n        }\r\n        if ((texture.is2DArray || texture.is3D) && (wrapR !== null)) {\r\n            this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_R, this._getTextureWrapMode(wrapR), texture);\r\n            texture._cachedWrapR = wrapR;\r\n        }\r\n        this._bindTextureDirectly(target, null);\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._setupDepthStencilTexture = function (internalTexture, size, generateStencil, bilinearFiltering, comparisonFunction) {\r\n        var width = size.width || size;\r\n        var height = size.height || size;\r\n        var layers = size.layers || 0;\r\n        internalTexture.baseWidth = width;\r\n        internalTexture.baseHeight = height;\r\n        internalTexture.width = width;\r\n        internalTexture.height = height;\r\n        internalTexture.is2DArray = layers > 0;\r\n        internalTexture.depth = layers;\r\n        internalTexture.isReady = true;\r\n        internalTexture.samples = 1;\r\n        internalTexture.generateMipMaps = false;\r\n        internalTexture._generateDepthBuffer = true;\r\n        internalTexture._generateStencilBuffer = generateStencil;\r\n        internalTexture.samplingMode = bilinearFiltering ? 2 : 1;\r\n        internalTexture.type = 0;\r\n        internalTexture._comparisonFunction = comparisonFunction;\r\n        var gl = this._gl;\r\n        var target = this._getTextureTarget(internalTexture);\r\n        var samplingParameters = this._getSamplingParameters(internalTexture.samplingMode, false);\r\n        gl.texParameteri(target, gl.TEXTURE_MAG_FILTER, samplingParameters.mag);\r\n        gl.texParameteri(target, gl.TEXTURE_MIN_FILTER, samplingParameters.min);\r\n        gl.texParameteri(target, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n        gl.texParameteri(target, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n        if (comparisonFunction === 0) {\r\n            gl.texParameteri(target, gl.TEXTURE_COMPARE_FUNC, 515);\r\n            gl.texParameteri(target, gl.TEXTURE_COMPARE_MODE, gl.NONE);\r\n        }\r\n        else {\r\n            gl.texParameteri(target, gl.TEXTURE_COMPARE_FUNC, comparisonFunction);\r\n            gl.texParameteri(target, gl.TEXTURE_COMPARE_MODE, gl.COMPARE_REF_TO_TEXTURE);\r\n        }\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._uploadCompressedDataToTextureDirectly = function (texture, internalFormat, width, height, data, faceIndex, lod) {\r\n        if (faceIndex === void 0) { faceIndex = 0; }\r\n        if (lod === void 0) { lod = 0; }\r\n        var gl = this._gl;\r\n        var target = gl.TEXTURE_2D;\r\n        if (texture.isCube) {\r\n            target = gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex;\r\n        }\r\n        this._gl.compressedTexImage2D(target, lod, internalFormat, width, height, 0, data);\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._uploadDataToTextureDirectly = function (texture, imageData, faceIndex, lod, babylonInternalFormat, useTextureWidthAndHeight) {\r\n        if (faceIndex === void 0) { faceIndex = 0; }\r\n        if (lod === void 0) { lod = 0; }\r\n        if (useTextureWidthAndHeight === void 0) { useTextureWidthAndHeight = false; }\r\n        var gl = this._gl;\r\n        var textureType = this._getWebGLTextureType(texture.type);\r\n        var format = this._getInternalFormat(texture.format);\r\n        var internalFormat = babylonInternalFormat === undefined ? this._getRGBABufferInternalSizedFormat(texture.type, texture.format) : this._getInternalFormat(babylonInternalFormat);\r\n        this._unpackFlipY(texture.invertY);\r\n        var target = gl.TEXTURE_2D;\r\n        if (texture.isCube) {\r\n            target = gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex;\r\n        }\r\n        var lodMaxWidth = Math.round(Math.log(texture.width) * Math.LOG2E);\r\n        var lodMaxHeight = Math.round(Math.log(texture.height) * Math.LOG2E);\r\n        var width = useTextureWidthAndHeight ? texture.width : Math.pow(2, Math.max(lodMaxWidth - lod, 0));\r\n        var height = useTextureWidthAndHeight ? texture.height : Math.pow(2, Math.max(lodMaxHeight - lod, 0));\r\n        gl.texImage2D(target, lod, internalFormat, width, height, 0, format, textureType, imageData);\r\n    };\r\n    /**\r\n     * Update a portion of an internal texture\r\n     * @param texture defines the texture to update\r\n     * @param imageData defines the data to store into the texture\r\n     * @param xOffset defines the x coordinates of the update rectangle\r\n     * @param yOffset defines the y coordinates of the update rectangle\r\n     * @param width defines the width of the update rectangle\r\n     * @param height defines the height of the update rectangle\r\n     * @param faceIndex defines the face index if texture is a cube (0 by default)\r\n     * @param lod defines the lod level to update (0 by default)\r\n     */\r\n    ThinEngine.prototype.updateTextureData = function (texture, imageData, xOffset, yOffset, width, height, faceIndex, lod) {\r\n        if (faceIndex === void 0) { faceIndex = 0; }\r\n        if (lod === void 0) { lod = 0; }\r\n        var gl = this._gl;\r\n        var textureType = this._getWebGLTextureType(texture.type);\r\n        var format = this._getInternalFormat(texture.format);\r\n        this._unpackFlipY(texture.invertY);\r\n        var target = gl.TEXTURE_2D;\r\n        if (texture.isCube) {\r\n            target = gl.TEXTURE_CUBE_MAP_POSITIVE_X + faceIndex;\r\n        }\r\n        gl.texSubImage2D(target, lod, xOffset, yOffset, width, height, format, textureType, imageData);\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._uploadArrayBufferViewToTexture = function (texture, imageData, faceIndex, lod) {\r\n        if (faceIndex === void 0) { faceIndex = 0; }\r\n        if (lod === void 0) { lod = 0; }\r\n        var gl = this._gl;\r\n        var bindTarget = texture.isCube ? gl.TEXTURE_CUBE_MAP : gl.TEXTURE_2D;\r\n        this._bindTextureDirectly(bindTarget, texture, true);\r\n        this._uploadDataToTextureDirectly(texture, imageData, faceIndex, lod);\r\n        this._bindTextureDirectly(bindTarget, null, true);\r\n    };\r\n    ThinEngine.prototype._prepareWebGLTextureContinuation = function (texture, scene, noMipmap, isCompressed, samplingMode) {\r\n        var gl = this._gl;\r\n        if (!gl) {\r\n            return;\r\n        }\r\n        var filters = this._getSamplingParameters(samplingMode, !noMipmap);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, filters.mag);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, filters.min);\r\n        if (!noMipmap && !isCompressed) {\r\n            gl.generateMipmap(gl.TEXTURE_2D);\r\n        }\r\n        this._bindTextureDirectly(gl.TEXTURE_2D, null);\r\n        // this.resetTextureCache();\r\n        if (scene) {\r\n            scene._removePendingData(texture);\r\n        }\r\n        texture.onLoadedObservable.notifyObservers(texture);\r\n        texture.onLoadedObservable.clear();\r\n    };\r\n    ThinEngine.prototype._prepareWebGLTexture = function (texture, scene, width, height, invertY, noMipmap, isCompressed, processFunction, samplingMode) {\r\n        var _this = this;\r\n        if (samplingMode === void 0) { samplingMode = 3; }\r\n        var maxTextureSize = this.getCaps().maxTextureSize;\r\n        var potWidth = Math.min(maxTextureSize, this.needPOTTextures ? ThinEngine.GetExponentOfTwo(width, maxTextureSize) : width);\r\n        var potHeight = Math.min(maxTextureSize, this.needPOTTextures ? ThinEngine.GetExponentOfTwo(height, maxTextureSize) : height);\r\n        var gl = this._gl;\r\n        if (!gl) {\r\n            return;\r\n        }\r\n        if (!texture._webGLTexture) {\r\n            //  this.resetTextureCache();\r\n            if (scene) {\r\n                scene._removePendingData(texture);\r\n            }\r\n            return;\r\n        }\r\n        this._bindTextureDirectly(gl.TEXTURE_2D, texture, true);\r\n        this._unpackFlipY(invertY === undefined ? true : (invertY ? true : false));\r\n        texture.baseWidth = width;\r\n        texture.baseHeight = height;\r\n        texture.width = potWidth;\r\n        texture.height = potHeight;\r\n        texture.isReady = true;\r\n        if (processFunction(potWidth, potHeight, function () {\r\n            _this._prepareWebGLTextureContinuation(texture, scene, noMipmap, isCompressed, samplingMode);\r\n        })) {\r\n            // Returning as texture needs extra async steps\r\n            return;\r\n        }\r\n        this._prepareWebGLTextureContinuation(texture, scene, noMipmap, isCompressed, samplingMode);\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._setupFramebufferDepthAttachments = function (generateStencilBuffer, generateDepthBuffer, width, height, samples) {\r\n        if (samples === void 0) { samples = 1; }\r\n        var gl = this._gl;\r\n        // Create the depth/stencil buffer\r\n        if (generateStencilBuffer && generateDepthBuffer) {\r\n            return this._getDepthStencilBuffer(width, height, samples, gl.DEPTH_STENCIL, gl.DEPTH24_STENCIL8, gl.DEPTH_STENCIL_ATTACHMENT);\r\n        }\r\n        if (generateDepthBuffer) {\r\n            var depthFormat = gl.DEPTH_COMPONENT16;\r\n            if (this._webGLVersion > 1) {\r\n                depthFormat = gl.DEPTH_COMPONENT32F;\r\n            }\r\n            return this._getDepthStencilBuffer(width, height, samples, depthFormat, depthFormat, gl.DEPTH_ATTACHMENT);\r\n        }\r\n        if (generateStencilBuffer) {\r\n            return this._getDepthStencilBuffer(width, height, samples, gl.STENCIL_INDEX8, gl.STENCIL_INDEX8, gl.STENCIL_ATTACHMENT);\r\n        }\r\n        return null;\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._releaseFramebufferObjects = function (texture) {\r\n        var gl = this._gl;\r\n        if (texture._framebuffer) {\r\n            gl.deleteFramebuffer(texture._framebuffer);\r\n            texture._framebuffer = null;\r\n        }\r\n        if (texture._depthStencilBuffer) {\r\n            gl.deleteRenderbuffer(texture._depthStencilBuffer);\r\n            texture._depthStencilBuffer = null;\r\n        }\r\n        if (texture._MSAAFramebuffer) {\r\n            gl.deleteFramebuffer(texture._MSAAFramebuffer);\r\n            texture._MSAAFramebuffer = null;\r\n        }\r\n        if (texture._MSAARenderBuffer) {\r\n            gl.deleteRenderbuffer(texture._MSAARenderBuffer);\r\n            texture._MSAARenderBuffer = null;\r\n        }\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._releaseTexture = function (texture) {\r\n        this._releaseFramebufferObjects(texture);\r\n        this._deleteTexture(texture._webGLTexture);\r\n        // Unbind channels\r\n        this.unbindAllTextures();\r\n        var index = this._internalTexturesCache.indexOf(texture);\r\n        if (index !== -1) {\r\n            this._internalTexturesCache.splice(index, 1);\r\n        }\r\n        // Integrated fixed lod samplers.\r\n        if (texture._lodTextureHigh) {\r\n            texture._lodTextureHigh.dispose();\r\n        }\r\n        if (texture._lodTextureMid) {\r\n            texture._lodTextureMid.dispose();\r\n        }\r\n        if (texture._lodTextureLow) {\r\n            texture._lodTextureLow.dispose();\r\n        }\r\n        // Integrated irradiance map.\r\n        if (texture._irradianceTexture) {\r\n            texture._irradianceTexture.dispose();\r\n        }\r\n    };\r\n    ThinEngine.prototype._deleteTexture = function (texture) {\r\n        this._gl.deleteTexture(texture);\r\n    };\r\n    ThinEngine.prototype._setProgram = function (program) {\r\n        if (this._currentProgram !== program) {\r\n            this._gl.useProgram(program);\r\n            this._currentProgram = program;\r\n        }\r\n    };\r\n    /**\r\n     * Binds an effect to the webGL context\r\n     * @param effect defines the effect to bind\r\n     */\r\n    ThinEngine.prototype.bindSamplers = function (effect) {\r\n        var webGLPipelineContext = effect.getPipelineContext();\r\n        this._setProgram(webGLPipelineContext.program);\r\n        var samplers = effect.getSamplers();\r\n        for (var index = 0; index < samplers.length; index++) {\r\n            var uniform = effect.getUniform(samplers[index]);\r\n            if (uniform) {\r\n                this._boundUniforms[index] = uniform;\r\n            }\r\n        }\r\n        this._currentEffect = null;\r\n    };\r\n    ThinEngine.prototype._activateCurrentTexture = function () {\r\n        if (this._currentTextureChannel !== this._activeChannel) {\r\n            this._gl.activeTexture(this._gl.TEXTURE0 + this._activeChannel);\r\n            this._currentTextureChannel = this._activeChannel;\r\n        }\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._bindTextureDirectly = function (target, texture, forTextureDataUpdate, force) {\r\n        if (forTextureDataUpdate === void 0) { forTextureDataUpdate = false; }\r\n        if (force === void 0) { force = false; }\r\n        var wasPreviouslyBound = false;\r\n        var isTextureForRendering = texture && texture._associatedChannel > -1;\r\n        if (forTextureDataUpdate && isTextureForRendering) {\r\n            this._activeChannel = texture._associatedChannel;\r\n        }\r\n        var currentTextureBound = this._boundTexturesCache[this._activeChannel];\r\n        if (currentTextureBound !== texture || force) {\r\n            this._activateCurrentTexture();\r\n            if (texture && texture.isMultiview) {\r\n                this._gl.bindTexture(target, texture ? texture._colorTextureArray : null);\r\n            }\r\n            else {\r\n                this._gl.bindTexture(target, texture ? texture._webGLTexture : null);\r\n            }\r\n            this._boundTexturesCache[this._activeChannel] = texture;\r\n            if (texture) {\r\n                texture._associatedChannel = this._activeChannel;\r\n            }\r\n        }\r\n        else if (forTextureDataUpdate) {\r\n            wasPreviouslyBound = true;\r\n            this._activateCurrentTexture();\r\n        }\r\n        if (isTextureForRendering && !forTextureDataUpdate) {\r\n            this._bindSamplerUniformToChannel(texture._associatedChannel, this._activeChannel);\r\n        }\r\n        return wasPreviouslyBound;\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._bindTexture = function (channel, texture) {\r\n        if (channel === undefined) {\r\n            return;\r\n        }\r\n        if (texture) {\r\n            texture._associatedChannel = channel;\r\n        }\r\n        this._activeChannel = channel;\r\n        var target = texture ? this._getTextureTarget(texture) : this._gl.TEXTURE_2D;\r\n        this._bindTextureDirectly(target, texture);\r\n    };\r\n    /**\r\n     * Unbind all textures from the webGL context\r\n     */\r\n    ThinEngine.prototype.unbindAllTextures = function () {\r\n        for (var channel = 0; channel < this._maxSimultaneousTextures; channel++) {\r\n            this._activeChannel = channel;\r\n            this._bindTextureDirectly(this._gl.TEXTURE_2D, null);\r\n            this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP, null);\r\n            if (this.webGLVersion > 1) {\r\n                this._bindTextureDirectly(this._gl.TEXTURE_3D, null);\r\n                this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY, null);\r\n            }\r\n        }\r\n    };\r\n    /**\r\n     * Sets a texture to the according uniform.\r\n     * @param channel The texture channel\r\n     * @param uniform The uniform to set\r\n     * @param texture The texture to apply\r\n     */\r\n    ThinEngine.prototype.setTexture = function (channel, uniform, texture) {\r\n        if (channel === undefined) {\r\n            return;\r\n        }\r\n        if (uniform) {\r\n            this._boundUniforms[channel] = uniform;\r\n        }\r\n        this._setTexture(channel, texture);\r\n    };\r\n    ThinEngine.prototype._bindSamplerUniformToChannel = function (sourceSlot, destination) {\r\n        var uniform = this._boundUniforms[sourceSlot];\r\n        if (!uniform || uniform._currentState === destination) {\r\n            return;\r\n        }\r\n        this._gl.uniform1i(uniform, destination);\r\n        uniform._currentState = destination;\r\n    };\r\n    ThinEngine.prototype._getTextureWrapMode = function (mode) {\r\n        switch (mode) {\r\n            case 1:\r\n                return this._gl.REPEAT;\r\n            case 0:\r\n                return this._gl.CLAMP_TO_EDGE;\r\n            case 2:\r\n                return this._gl.MIRRORED_REPEAT;\r\n        }\r\n        return this._gl.REPEAT;\r\n    };\r\n    ThinEngine.prototype._setTexture = function (channel, texture, isPartOfTextureArray, depthStencilTexture) {\r\n        if (isPartOfTextureArray === void 0) { isPartOfTextureArray = false; }\r\n        if (depthStencilTexture === void 0) { depthStencilTexture = false; }\r\n        // Not ready?\r\n        if (!texture) {\r\n            if (this._boundTexturesCache[channel] != null) {\r\n                this._activeChannel = channel;\r\n                this._bindTextureDirectly(this._gl.TEXTURE_2D, null);\r\n                this._bindTextureDirectly(this._gl.TEXTURE_CUBE_MAP, null);\r\n                if (this.webGLVersion > 1) {\r\n                    this._bindTextureDirectly(this._gl.TEXTURE_3D, null);\r\n                    this._bindTextureDirectly(this._gl.TEXTURE_2D_ARRAY, null);\r\n                }\r\n            }\r\n            return false;\r\n        }\r\n        // Video\r\n        if (texture.video) {\r\n            this._activeChannel = channel;\r\n            texture.update();\r\n        }\r\n        else if (texture.delayLoadState === 4) { // Delay loading\r\n            texture.delayLoad();\r\n            return false;\r\n        }\r\n        var internalTexture;\r\n        if (depthStencilTexture) {\r\n            internalTexture = texture.depthStencilTexture;\r\n        }\r\n        else if (texture.isReady()) {\r\n            internalTexture = texture.getInternalTexture();\r\n        }\r\n        else if (texture.isCube) {\r\n            internalTexture = this.emptyCubeTexture;\r\n        }\r\n        else if (texture.is3D) {\r\n            internalTexture = this.emptyTexture3D;\r\n        }\r\n        else if (texture.is2DArray) {\r\n            internalTexture = this.emptyTexture2DArray;\r\n        }\r\n        else {\r\n            internalTexture = this.emptyTexture;\r\n        }\r\n        if (!isPartOfTextureArray && internalTexture) {\r\n            internalTexture._associatedChannel = channel;\r\n        }\r\n        var needToBind = true;\r\n        if (this._boundTexturesCache[channel] === internalTexture) {\r\n            if (!isPartOfTextureArray) {\r\n                this._bindSamplerUniformToChannel(internalTexture._associatedChannel, channel);\r\n            }\r\n            needToBind = false;\r\n        }\r\n        this._activeChannel = channel;\r\n        var target = this._getTextureTarget(internalTexture);\r\n        if (needToBind) {\r\n            this._bindTextureDirectly(target, internalTexture, isPartOfTextureArray);\r\n        }\r\n        if (internalTexture && !internalTexture.isMultiview) {\r\n            // CUBIC_MODE and SKYBOX_MODE both require CLAMP_TO_EDGE.  All other modes use REPEAT.\r\n            if (internalTexture.isCube && internalTexture._cachedCoordinatesMode !== texture.coordinatesMode) {\r\n                internalTexture._cachedCoordinatesMode = texture.coordinatesMode;\r\n                var textureWrapMode = (texture.coordinatesMode !== 3 && texture.coordinatesMode !== 5) ? 1 : 0;\r\n                texture.wrapU = textureWrapMode;\r\n                texture.wrapV = textureWrapMode;\r\n            }\r\n            if (internalTexture._cachedWrapU !== texture.wrapU) {\r\n                internalTexture._cachedWrapU = texture.wrapU;\r\n                this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_S, this._getTextureWrapMode(texture.wrapU), internalTexture);\r\n            }\r\n            if (internalTexture._cachedWrapV !== texture.wrapV) {\r\n                internalTexture._cachedWrapV = texture.wrapV;\r\n                this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_T, this._getTextureWrapMode(texture.wrapV), internalTexture);\r\n            }\r\n            if (internalTexture.is3D && internalTexture._cachedWrapR !== texture.wrapR) {\r\n                internalTexture._cachedWrapR = texture.wrapR;\r\n                this._setTextureParameterInteger(target, this._gl.TEXTURE_WRAP_R, this._getTextureWrapMode(texture.wrapR), internalTexture);\r\n            }\r\n            this._setAnisotropicLevel(target, internalTexture, texture.anisotropicFilteringLevel);\r\n        }\r\n        return true;\r\n    };\r\n    /**\r\n     * Sets an array of texture to the webGL context\r\n     * @param channel defines the channel where the texture array must be set\r\n     * @param uniform defines the associated uniform location\r\n     * @param textures defines the array of textures to bind\r\n     */\r\n    ThinEngine.prototype.setTextureArray = function (channel, uniform, textures) {\r\n        if (channel === undefined || !uniform) {\r\n            return;\r\n        }\r\n        if (!this._textureUnits || this._textureUnits.length !== textures.length) {\r\n            this._textureUnits = new Int32Array(textures.length);\r\n        }\r\n        for (var i = 0; i < textures.length; i++) {\r\n            var texture = textures[i].getInternalTexture();\r\n            if (texture) {\r\n                this._textureUnits[i] = channel + i;\r\n                texture._associatedChannel = channel + i;\r\n            }\r\n            else {\r\n                this._textureUnits[i] = -1;\r\n            }\r\n        }\r\n        this._gl.uniform1iv(uniform, this._textureUnits);\r\n        for (var index = 0; index < textures.length; index++) {\r\n            this._setTexture(this._textureUnits[index], textures[index], true);\r\n        }\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._setAnisotropicLevel = function (target, internalTexture, anisotropicFilteringLevel) {\r\n        var anisotropicFilterExtension = this._caps.textureAnisotropicFilterExtension;\r\n        if (internalTexture.samplingMode !== 11\r\n            && internalTexture.samplingMode !== 3\r\n            && internalTexture.samplingMode !== 2) {\r\n            anisotropicFilteringLevel = 1; // Forcing the anisotropic to 1 because else webgl will force filters to linear\r\n        }\r\n        if (anisotropicFilterExtension && internalTexture._cachedAnisotropicFilteringLevel !== anisotropicFilteringLevel) {\r\n            this._setTextureParameterFloat(target, anisotropicFilterExtension.TEXTURE_MAX_ANISOTROPY_EXT, Math.min(anisotropicFilteringLevel, this._caps.maxAnisotropy), internalTexture);\r\n            internalTexture._cachedAnisotropicFilteringLevel = anisotropicFilteringLevel;\r\n        }\r\n    };\r\n    ThinEngine.prototype._setTextureParameterFloat = function (target, parameter, value, texture) {\r\n        this._bindTextureDirectly(target, texture, true, true);\r\n        this._gl.texParameterf(target, parameter, value);\r\n    };\r\n    ThinEngine.prototype._setTextureParameterInteger = function (target, parameter, value, texture) {\r\n        if (texture) {\r\n            this._bindTextureDirectly(target, texture, true, true);\r\n        }\r\n        this._gl.texParameteri(target, parameter, value);\r\n    };\r\n    /**\r\n     * Unbind all vertex attributes from the webGL context\r\n     */\r\n    ThinEngine.prototype.unbindAllAttributes = function () {\r\n        if (this._mustWipeVertexAttributes) {\r\n            this._mustWipeVertexAttributes = false;\r\n            for (var i = 0; i < this._caps.maxVertexAttribs; i++) {\r\n                this.disableAttributeByIndex(i);\r\n            }\r\n            return;\r\n        }\r\n        for (var i = 0, ul = this._vertexAttribArraysEnabled.length; i < ul; i++) {\r\n            if (i >= this._caps.maxVertexAttribs || !this._vertexAttribArraysEnabled[i]) {\r\n                continue;\r\n            }\r\n            this.disableAttributeByIndex(i);\r\n        }\r\n    };\r\n    /**\r\n     * Force the engine to release all cached effects. This means that next effect compilation will have to be done completely even if a similar effect was already compiled\r\n     */\r\n    ThinEngine.prototype.releaseEffects = function () {\r\n        for (var name in this._compiledEffects) {\r\n            var webGLPipelineContext = this._compiledEffects[name].getPipelineContext();\r\n            this._deletePipelineContext(webGLPipelineContext);\r\n        }\r\n        this._compiledEffects = {};\r\n    };\r\n    /**\r\n     * Dispose and release all associated resources\r\n     */\r\n    ThinEngine.prototype.dispose = function () {\r\n        this.stopRenderLoop();\r\n        // Clear observables\r\n        if (this.onBeforeTextureInitObservable) {\r\n            this.onBeforeTextureInitObservable.clear();\r\n        }\r\n        // Empty texture\r\n        if (this._emptyTexture) {\r\n            this._releaseTexture(this._emptyTexture);\r\n            this._emptyTexture = null;\r\n        }\r\n        if (this._emptyCubeTexture) {\r\n            this._releaseTexture(this._emptyCubeTexture);\r\n            this._emptyCubeTexture = null;\r\n        }\r\n        if (this._dummyFramebuffer) {\r\n            this._gl.deleteFramebuffer(this._dummyFramebuffer);\r\n        }\r\n        // Release effects\r\n        this.releaseEffects();\r\n        // Unbind\r\n        this.unbindAllAttributes();\r\n        this._boundUniforms = [];\r\n        // Events\r\n        if (DomManagement.IsWindowObjectExist()) {\r\n            if (this._renderingCanvas) {\r\n                if (!this._doNotHandleContextLost) {\r\n                    this._renderingCanvas.removeEventListener(\"webglcontextlost\", this._onContextLost);\r\n                    this._renderingCanvas.removeEventListener(\"webglcontextrestored\", this._onContextRestored);\r\n                }\r\n            }\r\n        }\r\n        this._workingCanvas = null;\r\n        this._workingContext = null;\r\n        this._currentBufferPointers = [];\r\n        this._renderingCanvas = null;\r\n        this._currentProgram = null;\r\n        this._boundRenderFunction = null;\r\n        Effect.ResetCache();\r\n        // Abort active requests\r\n        for (var _i = 0, _a = this._activeRequests; _i < _a.length; _i++) {\r\n            var request = _a[_i];\r\n            request.abort();\r\n        }\r\n    };\r\n    /**\r\n     * Attach a new callback raised when context lost event is fired\r\n     * @param callback defines the callback to call\r\n     */\r\n    ThinEngine.prototype.attachContextLostEvent = function (callback) {\r\n        if (this._renderingCanvas) {\r\n            this._renderingCanvas.addEventListener(\"webglcontextlost\", callback, false);\r\n        }\r\n    };\r\n    /**\r\n     * Attach a new callback raised when context restored event is fired\r\n     * @param callback defines the callback to call\r\n     */\r\n    ThinEngine.prototype.attachContextRestoredEvent = function (callback) {\r\n        if (this._renderingCanvas) {\r\n            this._renderingCanvas.addEventListener(\"webglcontextrestored\", callback, false);\r\n        }\r\n    };\r\n    /**\r\n     * Get the current error code of the webGL context\r\n     * @returns the error code\r\n     * @see https://developer.mozilla.org/en-US/docs/Web/API/WebGLRenderingContext/getError\r\n     */\r\n    ThinEngine.prototype.getError = function () {\r\n        return this._gl.getError();\r\n    };\r\n    ThinEngine.prototype._canRenderToFloatFramebuffer = function () {\r\n        if (this._webGLVersion > 1) {\r\n            return this._caps.colorBufferFloat;\r\n        }\r\n        return this._canRenderToFramebuffer(1);\r\n    };\r\n    ThinEngine.prototype._canRenderToHalfFloatFramebuffer = function () {\r\n        if (this._webGLVersion > 1) {\r\n            return this._caps.colorBufferFloat;\r\n        }\r\n        return this._canRenderToFramebuffer(2);\r\n    };\r\n    // Thank you : http://stackoverflow.com/questions/28827511/webgl-ios-render-to-floating-point-texture\r\n    ThinEngine.prototype._canRenderToFramebuffer = function (type) {\r\n        var gl = this._gl;\r\n        //clear existing errors\r\n        while (gl.getError() !== gl.NO_ERROR) { }\r\n        var successful = true;\r\n        var texture = gl.createTexture();\r\n        gl.bindTexture(gl.TEXTURE_2D, texture);\r\n        gl.texImage2D(gl.TEXTURE_2D, 0, this._getRGBABufferInternalSizedFormat(type), 1, 1, 0, gl.RGBA, this._getWebGLTextureType(type), null);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.NEAREST);\r\n        gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.NEAREST);\r\n        var fb = gl.createFramebuffer();\r\n        gl.bindFramebuffer(gl.FRAMEBUFFER, fb);\r\n        gl.framebufferTexture2D(gl.FRAMEBUFFER, gl.COLOR_ATTACHMENT0, gl.TEXTURE_2D, texture, 0);\r\n        var status = gl.checkFramebufferStatus(gl.FRAMEBUFFER);\r\n        successful = successful && (status === gl.FRAMEBUFFER_COMPLETE);\r\n        successful = successful && (gl.getError() === gl.NO_ERROR);\r\n        //try render by clearing frame buffer's color buffer\r\n        if (successful) {\r\n            gl.clear(gl.COLOR_BUFFER_BIT);\r\n            successful = successful && (gl.getError() === gl.NO_ERROR);\r\n        }\r\n        //try reading from frame to ensure render occurs (just creating the FBO is not sufficient to determine if rendering is supported)\r\n        if (successful) {\r\n            //in practice it's sufficient to just read from the backbuffer rather than handle potentially issues reading from the texture\r\n            gl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n            var readFormat = gl.RGBA;\r\n            var readType = gl.UNSIGNED_BYTE;\r\n            var buffer = new Uint8Array(4);\r\n            gl.readPixels(0, 0, 1, 1, readFormat, readType, buffer);\r\n            successful = successful && (gl.getError() === gl.NO_ERROR);\r\n        }\r\n        //clean up\r\n        gl.deleteTexture(texture);\r\n        gl.deleteFramebuffer(fb);\r\n        gl.bindFramebuffer(gl.FRAMEBUFFER, null);\r\n        //clear accumulated errors\r\n        while (!successful && (gl.getError() !== gl.NO_ERROR)) { }\r\n        return successful;\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._getWebGLTextureType = function (type) {\r\n        if (this._webGLVersion === 1) {\r\n            switch (type) {\r\n                case 1:\r\n                    return this._gl.FLOAT;\r\n                case 2:\r\n                    return this._gl.HALF_FLOAT_OES;\r\n                case 0:\r\n                    return this._gl.UNSIGNED_BYTE;\r\n                case 8:\r\n                    return this._gl.UNSIGNED_SHORT_4_4_4_4;\r\n                case 9:\r\n                    return this._gl.UNSIGNED_SHORT_5_5_5_1;\r\n                case 10:\r\n                    return this._gl.UNSIGNED_SHORT_5_6_5;\r\n            }\r\n            return this._gl.UNSIGNED_BYTE;\r\n        }\r\n        switch (type) {\r\n            case 3:\r\n                return this._gl.BYTE;\r\n            case 0:\r\n                return this._gl.UNSIGNED_BYTE;\r\n            case 4:\r\n                return this._gl.SHORT;\r\n            case 5:\r\n                return this._gl.UNSIGNED_SHORT;\r\n            case 6:\r\n                return this._gl.INT;\r\n            case 7: // Refers to UNSIGNED_INT\r\n                return this._gl.UNSIGNED_INT;\r\n            case 1:\r\n                return this._gl.FLOAT;\r\n            case 2:\r\n                return this._gl.HALF_FLOAT;\r\n            case 8:\r\n                return this._gl.UNSIGNED_SHORT_4_4_4_4;\r\n            case 9:\r\n                return this._gl.UNSIGNED_SHORT_5_5_5_1;\r\n            case 10:\r\n                return this._gl.UNSIGNED_SHORT_5_6_5;\r\n            case 11:\r\n                return this._gl.UNSIGNED_INT_2_10_10_10_REV;\r\n            case 12:\r\n                return this._gl.UNSIGNED_INT_24_8;\r\n            case 13:\r\n                return this._gl.UNSIGNED_INT_10F_11F_11F_REV;\r\n            case 14:\r\n                return this._gl.UNSIGNED_INT_5_9_9_9_REV;\r\n            case 15:\r\n                return this._gl.FLOAT_32_UNSIGNED_INT_24_8_REV;\r\n        }\r\n        return this._gl.UNSIGNED_BYTE;\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._getInternalFormat = function (format) {\r\n        var internalFormat = this._gl.RGBA;\r\n        switch (format) {\r\n            case 0:\r\n                internalFormat = this._gl.ALPHA;\r\n                break;\r\n            case 1:\r\n                internalFormat = this._gl.LUMINANCE;\r\n                break;\r\n            case 2:\r\n                internalFormat = this._gl.LUMINANCE_ALPHA;\r\n                break;\r\n            case 6:\r\n                internalFormat = this._gl.RED;\r\n                break;\r\n            case 7:\r\n                internalFormat = this._gl.RG;\r\n                break;\r\n            case 4:\r\n                internalFormat = this._gl.RGB;\r\n                break;\r\n            case 5:\r\n                internalFormat = this._gl.RGBA;\r\n                break;\r\n        }\r\n        if (this._webGLVersion > 1) {\r\n            switch (format) {\r\n                case 8:\r\n                    internalFormat = this._gl.RED_INTEGER;\r\n                    break;\r\n                case 9:\r\n                    internalFormat = this._gl.RG_INTEGER;\r\n                    break;\r\n                case 10:\r\n                    internalFormat = this._gl.RGB_INTEGER;\r\n                    break;\r\n                case 11:\r\n                    internalFormat = this._gl.RGBA_INTEGER;\r\n                    break;\r\n            }\r\n        }\r\n        return internalFormat;\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._getRGBABufferInternalSizedFormat = function (type, format) {\r\n        if (this._webGLVersion === 1) {\r\n            if (format !== undefined) {\r\n                switch (format) {\r\n                    case 0:\r\n                        return this._gl.ALPHA;\r\n                    case 1:\r\n                        return this._gl.LUMINANCE;\r\n                    case 2:\r\n                        return this._gl.LUMINANCE_ALPHA;\r\n                    case 4:\r\n                        return this._gl.RGB;\r\n                }\r\n            }\r\n            return this._gl.RGBA;\r\n        }\r\n        switch (type) {\r\n            case 3:\r\n                switch (format) {\r\n                    case 6:\r\n                        return this._gl.R8_SNORM;\r\n                    case 7:\r\n                        return this._gl.RG8_SNORM;\r\n                    case 4:\r\n                        return this._gl.RGB8_SNORM;\r\n                    case 8:\r\n                        return this._gl.R8I;\r\n                    case 9:\r\n                        return this._gl.RG8I;\r\n                    case 10:\r\n                        return this._gl.RGB8I;\r\n                    case 11:\r\n                        return this._gl.RGBA8I;\r\n                    default:\r\n                        return this._gl.RGBA8_SNORM;\r\n                }\r\n            case 0:\r\n                switch (format) {\r\n                    case 6:\r\n                        return this._gl.R8;\r\n                    case 7:\r\n                        return this._gl.RG8;\r\n                    case 4:\r\n                        return this._gl.RGB8; // By default. Other possibilities are RGB565, SRGB8.\r\n                    case 5:\r\n                        return this._gl.RGBA8; // By default. Other possibilities are RGB5_A1, RGBA4, SRGB8_ALPHA8.\r\n                    case 8:\r\n                        return this._gl.R8UI;\r\n                    case 9:\r\n                        return this._gl.RG8UI;\r\n                    case 10:\r\n                        return this._gl.RGB8UI;\r\n                    case 11:\r\n                        return this._gl.RGBA8UI;\r\n                    case 0:\r\n                        return this._gl.ALPHA;\r\n                    case 1:\r\n                        return this._gl.LUMINANCE;\r\n                    case 2:\r\n                        return this._gl.LUMINANCE_ALPHA;\r\n                    default:\r\n                        return this._gl.RGBA8;\r\n                }\r\n            case 4:\r\n                switch (format) {\r\n                    case 8:\r\n                        return this._gl.R16I;\r\n                    case 9:\r\n                        return this._gl.RG16I;\r\n                    case 10:\r\n                        return this._gl.RGB16I;\r\n                    case 11:\r\n                        return this._gl.RGBA16I;\r\n                    default:\r\n                        return this._gl.RGBA16I;\r\n                }\r\n            case 5:\r\n                switch (format) {\r\n                    case 8:\r\n                        return this._gl.R16UI;\r\n                    case 9:\r\n                        return this._gl.RG16UI;\r\n                    case 10:\r\n                        return this._gl.RGB16UI;\r\n                    case 11:\r\n                        return this._gl.RGBA16UI;\r\n                    default:\r\n                        return this._gl.RGBA16UI;\r\n                }\r\n            case 6:\r\n                switch (format) {\r\n                    case 8:\r\n                        return this._gl.R32I;\r\n                    case 9:\r\n                        return this._gl.RG32I;\r\n                    case 10:\r\n                        return this._gl.RGB32I;\r\n                    case 11:\r\n                        return this._gl.RGBA32I;\r\n                    default:\r\n                        return this._gl.RGBA32I;\r\n                }\r\n            case 7: // Refers to UNSIGNED_INT\r\n                switch (format) {\r\n                    case 8:\r\n                        return this._gl.R32UI;\r\n                    case 9:\r\n                        return this._gl.RG32UI;\r\n                    case 10:\r\n                        return this._gl.RGB32UI;\r\n                    case 11:\r\n                        return this._gl.RGBA32UI;\r\n                    default:\r\n                        return this._gl.RGBA32UI;\r\n                }\r\n            case 1:\r\n                switch (format) {\r\n                    case 6:\r\n                        return this._gl.R32F; // By default. Other possibility is R16F.\r\n                    case 7:\r\n                        return this._gl.RG32F; // By default. Other possibility is RG16F.\r\n                    case 4:\r\n                        return this._gl.RGB32F; // By default. Other possibilities are RGB16F, R11F_G11F_B10F, RGB9_E5.\r\n                    case 5:\r\n                        return this._gl.RGBA32F; // By default. Other possibility is RGBA16F.\r\n                    default:\r\n                        return this._gl.RGBA32F;\r\n                }\r\n            case 2:\r\n                switch (format) {\r\n                    case 6:\r\n                        return this._gl.R16F;\r\n                    case 7:\r\n                        return this._gl.RG16F;\r\n                    case 4:\r\n                        return this._gl.RGB16F; // By default. Other possibilities are R11F_G11F_B10F, RGB9_E5.\r\n                    case 5:\r\n                        return this._gl.RGBA16F;\r\n                    default:\r\n                        return this._gl.RGBA16F;\r\n                }\r\n            case 10:\r\n                return this._gl.RGB565;\r\n            case 13:\r\n                return this._gl.R11F_G11F_B10F;\r\n            case 14:\r\n                return this._gl.RGB9_E5;\r\n            case 8:\r\n                return this._gl.RGBA4;\r\n            case 9:\r\n                return this._gl.RGB5_A1;\r\n            case 11:\r\n                switch (format) {\r\n                    case 5:\r\n                        return this._gl.RGB10_A2; // By default. Other possibility is RGB5_A1.\r\n                    case 11:\r\n                        return this._gl.RGB10_A2UI;\r\n                    default:\r\n                        return this._gl.RGB10_A2;\r\n                }\r\n        }\r\n        return this._gl.RGBA8;\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._getRGBAMultiSampleBufferFormat = function (type) {\r\n        if (type === 1) {\r\n            return this._gl.RGBA32F;\r\n        }\r\n        else if (type === 2) {\r\n            return this._gl.RGBA16F;\r\n        }\r\n        return this._gl.RGBA8;\r\n    };\r\n    /** @hidden */\r\n    ThinEngine.prototype._loadFile = function (url, onSuccess, onProgress, offlineProvider, useArrayBuffer, onError) {\r\n        var _this = this;\r\n        var request = ThinEngine._FileToolsLoadFile(url, onSuccess, onProgress, offlineProvider, useArrayBuffer, onError);\r\n        this._activeRequests.push(request);\r\n        request.onCompleteObservable.add(function (request) {\r\n            _this._activeRequests.splice(_this._activeRequests.indexOf(request), 1);\r\n        });\r\n        return request;\r\n    };\r\n    /**\r\n     * Loads a file from a url\r\n     * @param url url to load\r\n     * @param onSuccess callback called when the file successfully loads\r\n     * @param onProgress callback called while file is loading (if the server supports this mode)\r\n     * @param offlineProvider defines the offline provider for caching\r\n     * @param useArrayBuffer defines a boolean indicating that date must be returned as ArrayBuffer\r\n     * @param onError callback called when the file fails to load\r\n     * @returns a file request object\r\n     * @hidden\r\n     */\r\n    ThinEngine._FileToolsLoadFile = function (url, onSuccess, onProgress, offlineProvider, useArrayBuffer, onError) {\r\n        throw _DevTools.WarnImport(\"FileTools\");\r\n    };\r\n    /**\r\n     * Reads pixels from the current frame buffer. Please note that this function can be slow\r\n     * @param x defines the x coordinate of the rectangle where pixels must be read\r\n     * @param y defines the y coordinate of the rectangle where pixels must be read\r\n     * @param width defines the width of the rectangle where pixels must be read\r\n     * @param height defines the height of the rectangle where pixels must be read\r\n     * @param hasAlpha defines whether the output should have alpha or not (defaults to true)\r\n     * @returns a Uint8Array containing RGBA colors\r\n     */\r\n    ThinEngine.prototype.readPixels = function (x, y, width, height, hasAlpha) {\r\n        if (hasAlpha === void 0) { hasAlpha = true; }\r\n        var numChannels = hasAlpha ? 4 : 3;\r\n        var format = hasAlpha ? this._gl.RGBA : this._gl.RGB;\r\n        var data = new Uint8Array(height * width * numChannels);\r\n        this._gl.readPixels(x, y, width, height, format, this._gl.UNSIGNED_BYTE, data);\r\n        return data;\r\n    };\r\n    Object.defineProperty(ThinEngine, \"IsSupported\", {\r\n        /**\r\n         * Gets a boolean indicating if the engine can be instanciated (ie. if a webGL context can be found)\r\n         */\r\n        get: function () {\r\n            return this.isSupported(); // Backward compat\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    /**\r\n     * Gets a boolean indicating if the engine can be instanciated (ie. if a webGL context can be found)\r\n     * @returns true if the engine can be created\r\n     * @ignorenaming\r\n     */\r\n    ThinEngine.isSupported = function () {\r\n        if (this._HasMajorPerformanceCaveat !== null) {\r\n            return !this._HasMajorPerformanceCaveat; // We know it is performant so WebGL is supported\r\n        }\r\n        if (this._IsSupported === null) {\r\n            try {\r\n                var tempcanvas = CanvasGenerator.CreateCanvas(1, 1);\r\n                var gl = tempcanvas.getContext(\"webgl\") || tempcanvas.getContext(\"experimental-webgl\");\r\n                this._IsSupported = gl != null && !!window.WebGLRenderingContext;\r\n            }\r\n            catch (e) {\r\n                this._IsSupported = false;\r\n            }\r\n        }\r\n        return this._IsSupported;\r\n    };\r\n    Object.defineProperty(ThinEngine, \"HasMajorPerformanceCaveat\", {\r\n        /**\r\n         * Gets a boolean indicating if the engine can be instanciated on a performant device (ie. if a webGL context can be found and it does not use a slow implementation)\r\n         */\r\n        get: function () {\r\n            if (this._HasMajorPerformanceCaveat === null) {\r\n                try {\r\n                    var tempcanvas = CanvasGenerator.CreateCanvas(1, 1);\r\n                    var gl = tempcanvas.getContext(\"webgl\", { failIfMajorPerformanceCaveat: true }) || tempcanvas.getContext(\"experimental-webgl\", { failIfMajorPerformanceCaveat: true });\r\n                    this._HasMajorPerformanceCaveat = !gl;\r\n                }\r\n                catch (e) {\r\n                    this._HasMajorPerformanceCaveat = false;\r\n                }\r\n            }\r\n            return this._HasMajorPerformanceCaveat;\r\n        },\r\n        enumerable: false,\r\n        configurable: true\r\n    });\r\n    /**\r\n     * Find the next highest power of two.\r\n     * @param x Number to start search from.\r\n     * @return Next highest power of two.\r\n     */\r\n    ThinEngine.CeilingPOT = function (x) {\r\n        x--;\r\n        x |= x >> 1;\r\n        x |= x >> 2;\r\n        x |= x >> 4;\r\n        x |= x >> 8;\r\n        x |= x >> 16;\r\n        x++;\r\n        return x;\r\n    };\r\n    /**\r\n     * Find the next lowest power of two.\r\n     * @param x Number to start search from.\r\n     * @return Next lowest power of two.\r\n     */\r\n    ThinEngine.FloorPOT = function (x) {\r\n        x = x | (x >> 1);\r\n        x = x | (x >> 2);\r\n        x = x | (x >> 4);\r\n        x = x | (x >> 8);\r\n        x = x | (x >> 16);\r\n        return x - (x >> 1);\r\n    };\r\n    /**\r\n     * Find the nearest power of two.\r\n     * @param x Number to start search from.\r\n     * @return Next nearest power of two.\r\n     */\r\n    ThinEngine.NearestPOT = function (x) {\r\n        var c = ThinEngine.CeilingPOT(x);\r\n        var f = ThinEngine.FloorPOT(x);\r\n        return (c - x) > (x - f) ? f : c;\r\n    };\r\n    /**\r\n     * Get the closest exponent of two\r\n     * @param value defines the value to approximate\r\n     * @param max defines the maximum value to return\r\n     * @param mode defines how to define the closest value\r\n     * @returns closest exponent of two of the given value\r\n     */\r\n    ThinEngine.GetExponentOfTwo = function (value, max, mode) {\r\n        if (mode === void 0) { mode = 2; }\r\n        var pot;\r\n        switch (mode) {\r\n            case 1:\r\n                pot = ThinEngine.FloorPOT(value);\r\n                break;\r\n            case 2:\r\n                pot = ThinEngine.NearestPOT(value);\r\n                break;\r\n            case 3:\r\n            default:\r\n                pot = ThinEngine.CeilingPOT(value);\r\n                break;\r\n        }\r\n        return Math.min(pot, max);\r\n    };\r\n    /**\r\n     * Queue a new function into the requested animation frame pool (ie. this function will be executed byt the browser for the next frame)\r\n     * @param func - the function to be called\r\n     * @param requester - the object that will request the next frame. Falls back to window.\r\n     * @returns frame number\r\n     */\r\n    ThinEngine.QueueNewFrame = function (func, requester) {\r\n        if (!DomManagement.IsWindowObjectExist()) {\r\n            if (typeof requestAnimationFrame !== \"undefined\") {\r\n                return requestAnimationFrame(func);\r\n            }\r\n            return setTimeout(func, 16);\r\n        }\r\n        if (!requester) {\r\n            requester = window;\r\n        }\r\n        if (requester.requestPostAnimationFrame) {\r\n            return requester.requestPostAnimationFrame(func);\r\n        }\r\n        else if (requester.requestAnimationFrame) {\r\n            return requester.requestAnimationFrame(func);\r\n        }\r\n        else if (requester.msRequestAnimationFrame) {\r\n            return requester.msRequestAnimationFrame(func);\r\n        }\r\n        else if (requester.webkitRequestAnimationFrame) {\r\n            return requester.webkitRequestAnimationFrame(func);\r\n        }\r\n        else if (requester.mozRequestAnimationFrame) {\r\n            return requester.mozRequestAnimationFrame(func);\r\n        }\r\n        else if (requester.oRequestAnimationFrame) {\r\n            return requester.oRequestAnimationFrame(func);\r\n        }\r\n        else {\r\n            return window.setTimeout(func, 16);\r\n        }\r\n    };\r\n    /**\r\n     * Gets host document\r\n     * @returns the host document object\r\n     */\r\n    ThinEngine.prototype.getHostDocument = function () {\r\n        if (this._renderingCanvas && this._renderingCanvas.ownerDocument) {\r\n            return this._renderingCanvas.ownerDocument;\r\n        }\r\n        return document;\r\n    };\r\n    /** Use this array to turn off some WebGL2 features on known buggy browsers version */\r\n    ThinEngine.ExceptionList = [\r\n        { key: \"Chrome\\/63\\.0\", capture: \"63\\\\.0\\\\.3239\\\\.(\\\\d+)\", captureConstraint: 108, targets: [\"uniformBuffer\"] },\r\n        { key: \"Firefox\\/58\", capture: null, captureConstraint: null, targets: [\"uniformBuffer\"] },\r\n        { key: \"Firefox\\/59\", capture: null, captureConstraint: null, targets: [\"uniformBuffer\"] },\r\n        { key: \"Chrome\\/72.+?Mobile\", capture: null, captureConstraint: null, targets: [\"vao\"] },\r\n        { key: \"Chrome\\/73.+?Mobile\", capture: null, captureConstraint: null, targets: [\"vao\"] },\r\n        { key: \"Chrome\\/74.+?Mobile\", capture: null, captureConstraint: null, targets: [\"vao\"] },\r\n        { key: \"Mac OS.+Chrome\\/71\", capture: null, captureConstraint: null, targets: [\"vao\"] },\r\n        { key: \"Mac OS.+Chrome\\/72\", capture: null, captureConstraint: null, targets: [\"vao\"] }\r\n    ];\r\n    /** @hidden */\r\n    ThinEngine._TextureLoaders = [];\r\n    // Updatable statics so stick with vars here\r\n    /**\r\n     * Gets or sets the epsilon value used by collision engine\r\n     */\r\n    ThinEngine.CollisionsEpsilon = 0.001;\r\n    // Statics\r\n    ThinEngine._IsSupported = null;\r\n    ThinEngine._HasMajorPerformanceCaveat = null;\r\n    return ThinEngine;\r\n}());\r\nexport { ThinEngine };\r\n"]},"metadata":{},"sourceType":"module"}